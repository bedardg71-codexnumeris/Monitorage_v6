<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Analyse R√†I vs Risque</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #0066cc;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .risque-faible {
            background: #d4edda;
            font-weight: bold;
            color: #155724;
        }
        .rai-2 {
            background: #fff3cd;
            font-weight: bold;
            color: #856404;
        }
        .highlight {
            background: #ffeaa7 !important;
            font-weight: bold;
        }
        h1 {
            color: #0066cc;
        }
        h2 {
            color: #333;
            margin-top: 30px;
        }
        .stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .explication {
            background: #fff9e6;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <h1>üîç Analyse : Pourquoi des √©tudiants avec Risque FAIBLE sont en R√†I Niveau 2</h1>

    <div class="stats" id="stats"></div>

    <h2>üìä Tableau complet : Tous les √©tudiants</h2>
    <table id="tableauComplet"></table>

    <h2>üéØ Cas sp√©cifiques : Risque FAIBLE + R√†I Niveau 2</h2>
    <div class="explication">
        <strong>Ces √©tudiants ont un bon dossier global (risque faible)</strong> mais n√©cessitent quand m√™me une intervention cibl√©e pour :
        <ul>
            <li>Corriger un d√©fi sp√©cifique identifi√© (ex: fran√ßais, structure)</li>
            <li>Pr√©venir une stagnation probl√©matique</li>
            <li>Intervenir sur un blocage √©mergent avant qu'il ne devienne critique</li>
        </ul>
    </div>
    <table id="tableauCiblee"></table>

    <script>
        // Charger les fonctions depuis profil-etudiant.js
        function chargerScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function analyser() {
            // Charger les modules n√©cessaires
            await chargerScript('js/config.js');
            await chargerScript('js/interpretation-config.js');
            await chargerScript('js/profil-etudiant.js');

            // Attendre que tout soit charg√©
            setTimeout(() => {
                const etudiants = JSON.parse(localStorage.getItem('etudiants') || '[]');

                let compteurs = {
                    total: etudiants.length,
                    risqueFaible: 0,
                    rai2: 0,
                    risqueFaibleEtRai2: 0
                };

                let resultats = [];

                etudiants.forEach(etudiant => {
                    const da = etudiant.da;

                    // Calculer les indices (utilise la fonction du profil-etudiant.js)
                    const indices = typeof calculerTousLesIndices === 'function'
                        ? calculerTousLesIndices(da)
                        : { A: 0, C: 0, P: 0, R: 0 };

                    // D√©terminer le niveau de risque
                    let niveauRisque = 'Inconnu';
                    if (indices.R <= 0.20) niveauRisque = 'Faible';
                    else if (indices.R <= 0.30) niveauRisque = 'Mod√©r√©';
                    else if (indices.R <= 0.40) niveauRisque = '√âlev√©';
                    else if (indices.R <= 0.50) niveauRisque = 'Tr√®s √©lev√©';
                    else niveauRisque = 'Critique';

                    // D√©terminer le niveau R√†I (utilise la fonction du profil-etudiant.js)
                    const cibleInfo = typeof determinerCibleIntervention === 'function'
                        ? determinerCibleIntervention(da)
                        : { niveau: 0, cible: 'Inconnu', pattern: 'Inconnu' };

                    // Compter
                    if (niveauRisque === 'Faible') compteurs.risqueFaible++;
                    if (cibleInfo.niveau === 2) compteurs.rai2++;
                    if (niveauRisque === 'Faible' && cibleInfo.niveau === 2) {
                        compteurs.risqueFaibleEtRai2++;
                    }

                    resultats.push({
                        nom: etudiant.nom,
                        prenom: etudiant.prenom,
                        da: da,
                        A: Math.round(indices.A),
                        C: Math.round(indices.C),
                        P: Math.round(indices.P),
                        R: (indices.R * 100).toFixed(1),
                        niveauRisque: niveauRisque,
                        pattern: cibleInfo.pattern,
                        niveauRai: cibleInfo.niveau,
                        cible: cibleInfo.cible,
                        highlight: niveauRisque === 'Faible' && cibleInfo.niveau === 2
                    });
                });

                // Afficher les statistiques
                document.getElementById('stats').innerHTML = `
                    <h3>üìà Statistiques</h3>
                    <p><strong>Total d'√©tudiants :</strong> ${compteurs.total}</p>
                    <p><strong>√âtudiants avec risque FAIBLE :</strong> ${compteurs.risqueFaible}</p>
                    <p><strong>√âtudiants en R√†I niveau 2 :</strong> ${compteurs.rai2}</p>
                    <p style="font-size: 1.2rem; color: #d35400;"><strong>‚ö†Ô∏è √âtudiants avec risque FAIBLE ET R√†I niveau 2 :</strong> ${compteurs.risqueFaibleEtRai2}</p>
                    <p style="font-size: 0.9rem; color: #666;">
                        ‚Üí Ces ${compteurs.risqueFaibleEtRai2} √©tudiants ont un bon dossier global mais n√©cessitent une intervention cibl√©e.
                    </p>
                `;

                // G√©n√©rer le tableau complet
                let htmlComplet = `
                    <tr>
                        <th>Nom</th>
                        <th>Pr√©nom</th>
                        <th>A%</th>
                        <th>C%</th>
                        <th>P%</th>
                        <th>R%</th>
                        <th>Niveau Risque</th>
                        <th>Pattern</th>
                        <th>R√†I</th>
                        <th>Cible d'intervention</th>
                    </tr>
                `;

                resultats.forEach(r => {
                    const rowClass = r.highlight ? 'highlight' : '';
                    const risqueClass = r.niveauRisque === 'Faible' ? 'risque-faible' : '';
                    const raiClass = r.niveauRai === 2 ? 'rai-2' : '';

                    htmlComplet += `
                        <tr class="${rowClass}">
                            <td>${r.nom}</td>
                            <td>${r.prenom}</td>
                            <td>${r.A}%</td>
                            <td>${r.C}%</td>
                            <td>${r.P}%</td>
                            <td>${r.R}%</td>
                            <td class="${risqueClass}">${r.niveauRisque}</td>
                            <td>${r.pattern}</td>
                            <td class="${raiClass}">Niveau ${r.niveauRai}</td>
                            <td style="font-size: 0.85rem;">${r.cible}</td>
                        </tr>
                    `;
                });

                document.getElementById('tableauComplet').innerHTML = htmlComplet;

                // G√©n√©rer le tableau cibl√© (seulement risque faible + R√†I 2)
                const casCibles = resultats.filter(r => r.highlight);

                let htmlCible = `
                    <tr>
                        <th>Nom</th>
                        <th>Pr√©nom</th>
                        <th>A%</th>
                        <th>C%</th>
                        <th>P%</th>
                        <th>R%</th>
                        <th>Pattern</th>
                        <th>Cible d'intervention (POURQUOI R√†I 2)</th>
                    </tr>
                `;

                casCibles.forEach(r => {
                    htmlCible += `
                        <tr>
                            <td><strong>${r.nom}</strong></td>
                            <td><strong>${r.prenom}</strong></td>
                            <td>${r.A}%</td>
                            <td>${r.C}%</td>
                            <td>${r.P}%</td>
                            <td style="color: green; font-weight: bold;">${r.R}%</td>
                            <td><strong>${r.pattern}</strong></td>
                            <td style="font-size: 0.9rem; background: #fff3cd;">
                                ${r.cible}
                            </td>
                        </tr>
                    `;
                });

                if (casCibles.length === 0) {
                    htmlCible += '<tr><td colspan="8" style="text-align: center; padding: 20px;">Aucun √©tudiant dans cette cat√©gorie</td></tr>';
                }

                document.getElementById('tableauCiblee').innerHTML = htmlCible;

            }, 1000);
        }

        // Lancer l'analyse au chargement
        analyser();
    </script>
</body>
</html>
