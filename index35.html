<!DOCTYPE html>
<html lang="fr-CA">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitorage p√©dagogique - 601-101-MQ</title>
    <meta name="author" content="Gr√©goire B√©dard">
    <meta name="description" content="Syst√®me de suivi automatis√© des apprentissages">

    <style>
        /* ===============================
           SYST√àME DE DESIGN - Beta 0.35
           Convention : 100% fran√ßais
           Derni√®re mise √† jour : 29-09-2025
           =============================== */

        :root {
            /* === PALETTE DE COULEURS === */

            /* Bleus - Couleurs principales */
            --bleu-principal: #032e5c;
            --bleu-fonce: #0f1e3a;
            --bleu-moyen: #2a4a8a;
            --bleu-clair: #065dbb;
            --bleu-leger: #6b85b3;
            --bleu-carte: #9fc5e8;
            --bleu-pale: #e8f2fd;
            --bleu-tres-pale: #f0f8ff;

            /* Couleurs d'accent */
            --orange-accent: #ff6b35;
            --vert-pale: #f8fef8;
            --vert-doux: #b8d4b8;
            --vert-leger: #2a8a6a;

            /* === NAVIGATION === */
            --nav-bg: #f8f9fa;
            --nav-normal: #04376f;
            --nav-hover: #3e98f9;
            --nav-actif: #054a95;
            --nav-bordure-actif: var(--orange-accent);

            /* === SOUS-NAVIGATION === */
            --sous-nav-bg: #e8f2fd;
            --sous-nav-normal: #054a95;
            --sous-nav-hover: #3e98f9;
            --sous-nav-actif: #065dbb;

            /* === BOUTONS D'ACTION === */
            --btn-principal: #065dbb;
            --btn-principal-hover: #054a95;
            --btn-ajouter: #2a8a6a;
            --btn-ajouter-hover: #228758;
            --btn-modifier: #6a2a8a;
            --btn-modifier-hover: #5a1a7a;
            --btn-confirmer: #2d8f52;
            --btn-confirmer-hover: #238742;
            --btn-annuler: #d4a50d;
            --btn-annuler-hover: #c49505;
            --btn-supprimer: #dc3545;
            --btn-supprimer-hover: #c82333;

            /* === INDICATEURS DE RISQUE === */
            --risque-nul: #065dbb;
            --risque-minimal: #28a745;
            --risque-faible: #90EE90;
            --risque-modere: #ffc107;
            --risque-eleve: #fd7e14;
            --risque-tres-eleve: #dc3545;
            --risque-critique: #721c24;

            /* === ESPACEMENT === */
            --espacement-petit: 10px;
            --espacement-moyen: 20px;
            --espacement-grand: 30px;
        }

        /* Notifications */
        .notification-succes {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--risque-minimal);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            animation: slideIn 0.3s ease;
            /* ‚Üê AJOUTE CETTE LIGNE */
        }

        /* Liste d'√©l√©ments sauvegard√©s */
        .element-sauvegarde {
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bleu-tres-pale);
            border-radius: 6px;
            border: 1px solid var(--bleu-leger);
        }

        .element-sauvegarde-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .element-sauvegarde-titre {
            margin: 0 0 8px 0;
            color: var(--bleu-principal);
        }

        .element-sauvegarde-info {
            font-size: 0.9rem;
            color: #666;
        }

        .element-sauvegarde-date {
            font-size: 0.85rem;
            color: #999;
            margin-top: 5px;
        }

        /* Bo√Æte de r√©troaction */
        .retroaction-critere {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bleu-tres-pale);
            border-left: 3px solid var(--bleu-moyen);
            border-radius: 4px;
        }

        .retroaction-titre {
            font-weight: 600;
            color: var(--bleu-principal);
        }

        .retroaction-texte {
            margin-top: 5px;
            margin-bottom: 0;
        }

        .notification-details {
            margin-top: 5px;
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 400;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* === LISTE D'√âL√âMENTS SAUVEGARD√âS === */

        /* Message quand liste vide */
        .liste-vide {
            padding: 20px;
            background: var(--bleu-tres-pale);
            border-radius: 6px;
            text-align: center;
            color: var(--bleu-leger);
        }

        /* Conteneur d'un √©l√©ment (grille/√©chelle) */
        .element-sauvegarde {
            padding: 15px;
            background: var(--bleu-tres-pale);
            border: 1px solid var(--bleu-leger);
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .element-sauvegarde-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .element-sauvegarde-titre {
            color: var(--bleu-principal);
        }

        .element-sauvegarde-date {
            color: var(--bleu-leger);
            margin-left: 10px;
            font-size: 0.85rem;
        }

        .element-sauvegarde-source {
            color: var(--orange-accent);
            margin-left: 10px;
            font-size: 0.85rem;
        }

        .element-sauvegarde-infos {
            color: #666;
            font-size: 0.85rem;
        }

        .element-sauvegarde-infos span:first-child {
            margin-right: 20px;
        }

        /* Boutons dans les √©l√©ments sauvegard√©s */
        .btn-compact {
            padding: 5px 12px;
            font-size: 0.85rem;
        }

        .btn-compact+.btn-compact {
            margin-left: 5px;
        }

        /* D√©tails d√©pliables */
        .element-details {
            margin-top: 10px;
        }

        .element-details summary {
            cursor: pointer;
            color: var(--bleu-moyen);
            font-size: 0.9rem;
        }

        .element-details-contenu {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .element-details-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--bleu-tres-pale);
        }

        .element-details-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .element-details-description {
            color: #666;
            font-size: 0.85rem;
        }

        /* === R√âTROACTIONS === */

        /* Blocs d'information p√©dagogique (vert) */
        .retroaction-info {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--vert-pale);
            border-left: 3px solid var(--vert-leger);
            border-radius: 4px;
        }

        .retroaction-info strong {
            display: block;
            color: var(--bleu-principal);
        }

        .retroaction-info p {
            margin-top: 5px;
            margin-bottom: 0;
        }

        /* Titre de section r√©troaction */
        .retroaction-titre-section {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--bleu-principal);
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Blocs de r√©troaction par crit√®re (bleu) */
        .retroaction-critere {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bleu-tres-pale);
            border-left: 3px solid var(--bleu-moyen);
            border-radius: 4px;
        }

        .retroaction-critere strong {
            color: var(--bleu-principal);
        }

        .retroaction-critere p {
            margin-top: 5px;
            margin-bottom: 0;
        }

        /* Message quand aucune r√©troaction */
        .retroaction-vide {
            color: #999;
            font-style: italic;
        }

        /* ===============================
           BASE ET TYPOGRAPHIE
           =============================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, var(--bleu-pale) 0%, var(--bleu-tres-pale) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ===============================
           CONTENEUR PRINCIPAL
           =============================== */

        .conteneur {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(3, 46, 92, 0.1);
            overflow: hidden;
        }

        /* ===============================
           EN-T√äTE
           =============================== */

        .entete {
            background: var(--bleu-principal);
            color: white;
            padding: var(--espacement-grand);
            text-align: center;
            position: relative;
        }

        .entete h1 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
            letter-spacing: 1px;
            font-style: strong;
        }

        .entete h2 {
            font-size: 1.2rem;
            font-weight: 300;
            color: var(--bleu-pale);
            margin-bottom: 15px;
        }

        .statut-sauvegarde {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .horodatage {
            font-size: 0.75rem;
            color: var(--bleu-pale);
            margin-top: 3px;
        }

        .version {
            font-size: 0.9rem;
            color: var(--bleu-pale);
            margin-top: 10px;
        }

        .credits {
            font-size: 0.8rem;
            color: var(--bleu-leger);
            margin-top: 15px;
            line-height: 1.4;
        }

        /* ===============================
           NAVIGATION PRINCIPALE
           =============================== */

        .navigation-principale {
            background: var(--bleu-principal);
            /* Chang√© de var(--nav-bg) */
            padding: 0;
            display: flex;
            justify-content: center;
            border-bottom: 3px solid var(--orange-accent);
            /* Chang√© pour orange */
        }

        .navigation-principale button {
            background: transparent;
            border: none;
            color: white;
            /* Chang√© de var(--nav-normal) */
            padding: 15px 25px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .navigation-principale button:hover {
            background: rgba(255, 255, 255, 0.1);
            /* Hover l√©ger blanc */
            color: white;
        }

        .navigation-principale button.actif {
            background: var(--bleu-moyen);
            /* Fond l√©g√®rement diff√©rent */
            border-bottom-color: var(--orange-accent);
            color: white;
        }

        /* ===============================
           SOUS-NAVIGATION
           =============================== */

        .sous-navigation {
            background: var(--sous-nav-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            /* AJOUT - Centre les boutons */
            gap: 10px;
            border-bottom: 1px solid var(--bleu-leger);
            min-height: 50px;
            align-items: center;
        }

        .sous-navigation button {
            background: white;
            border: 1px solid var(--bleu-leger);
            color: var(--sous-nav-normal);
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sous-navigation button:hover {
            background: var(--bleu-pale);
            color: var(--sous-nav-hover);
        }

        .sous-navigation button.actif {
            background: var(--sous-nav-actif);
            color: white;
            border-color: var(--sous-nav-actif);
        }

        .sous-navigation.vide {
            justify-content: center;
            color: var(--bleu-leger);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* ===============================
           CONTENU PRINCIPAL
           =============================== */

        .contenu {
            padding: var(--espacement-grand);
            min-height: 500px;
        }

        /* Sections et sous-sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .sous-section {
            display: none;
        }

        .sous-section.active {
            display: block;
        }

        #section-reglages .sous-section.active {
            display: block !important;
        }


        @keyframes apparition {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===============================
           CARTES
           =============================== */

        .carte {
            background: white;
            border: 1px solid var(--bleu-pale);
            border-radius: 8px;
            padding: var(--espacement-moyen);
            margin-bottom: var(--espacement-moyen);
            box-shadow: 0 2px 8px rgba(3, 46, 92, 0.05);
        }

        .carte h3 {
            color: var(--bleu-principal);
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bleu-pale);
        }

        /* ===============================
           GRILLES ET STATISTIQUES
           =============================== */

        .grille-statistiques {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--espacement-moyen);
            margin-bottom: var(--espacement-grand);
        }

        .carte-statistique {
            background: var(--bleu-pale);
            border: 1px solid var(--bleu-leger);
            border-radius: 8px;
            padding: var(--espacement-moyen);
            text-align: center;
            box-shadow: 0 3px 6px rgba(3, 46, 92, 0.1);
            transition: all 0.2s ease;
            margin-bottom: var(--espacement-moyen);
        }

        .carte-statistique:hover {
            box-shadow: 0 4px 8px rgba(3, 46, 92, 0.15);
            background: white;
            transform: translateY(-2px);
        }

        .carte-statistique .valeur {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--bleu-principal);
            margin-bottom: 8px;
        }

        .carte-statistique .label {
            font-size: 0.9rem;
            color: var(--bleu-leger);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===============================
           CARTES M√âTRIQUES - Petites statistiques
           =============================== */

        .carte-metrique {
            background: var(--bleu-carte);
            border: 1px solid var(--bleu-moyen);
            border-radius: 6px;
            padding: 12px 15px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 2px 4px rgba(3, 46, 92, 0.1);
            transition: all 0.2s ease;
            display: inline-block;
        }

        .carte-metrique:hover {
            box-shadow: 0 4px 8px rgba(3, 46, 92, 0.2);
            transform: translateY(-1px);
            background: white;
        }

        .carte-metrique strong {
            display: block;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--bleu-principal);
            margin-bottom: 4px;
        }

        .carte-metrique span {
            font-size: 0.85rem;
            color: var(--bleu-moyen);
            font-weight: 500;
        }

        /* ===============================
           TABLEAUX
           =============================== */

        .tableau {
            width: 100%;
            border-collapse: collapse;
            margin: var(--espacement-moyen) 0;
        }

        .tableau thead {
            background: var(--bleu-pale);
        }

        .tableau th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--bleu-principal);
            font-size: 0.9rem;
            border-bottom: 2px solid var(--bleu-leger);
        }

        .tableau td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--bleu-tres-pale);
        }

        .tableau tbody tr:hover {
            background: var(--bleu-tres-pale);
        }

        /* ===============================
           BADGES DE RISQUE
           =============================== */

        .badge-risque {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .risque-minimal {
            background: var(--risque-minimal);
            color: white;
        }

        .risque-faible {
            background: var(--risque-faible);
            color: #1a5f1a;
        }

        .risque-modere {
            background: var(--risque-modere);
            color: #7a5900;
        }

        .risque-eleve {
            background: var(--risque-eleve);
            color: white;
        }

        .risque-critique {
            background: var(--risque-critique);
            color: white;
        }

        /* ===============================
           FORMULAIRES
           =============================== */

        .groupe-form {
            margin-bottom: var(--espacement-moyen);
        }

        .groupe-form label {
            display: block;
            margin-bottom: 5px;
            color: var(--bleu-principal);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .controle-form {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--bleu-leger);
            border-radius: 4px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .controle-form:focus {
            outline: none;
            border-color: var(--bleu-clair);
            box-shadow: 0 0 0 3px rgba(6, 93, 187, 0.1);
        }

        /* ===============================
           BOUTONS
           =============================== */

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-principal {
            background: var(--btn-principal);
            color: white;
        }

        .btn-principal:hover {
            background: var(--btn-principal-hover);
        }

        .btn-ajouter {
            background: var(--btn-ajouter);
            color: white;
        }

        .btn-ajouter:hover {
            background: var(--btn-ajouter-hover);
        }

        .btn-modifier {
            background: var(--btn-modifier);
            color: white;
        }

        .btn-modifier:hover {
            background: var(--btn-modifier-hover);
        }

        .btn-confirmer {
            background: var(--btn-confirmer);
            color: white;
        }

        .btn-confirmer:hover {
            background: var(--btn-confirmer-hover);
        }

        .btn-annuler {
            background: var(--btn-annuler);
            color: white;
        }

        .btn-annuler:hover {
            background: var(--btn-annuler-hover);
        }

        .btn-supprimer {
            background: var(--btn-supprimer);
            color: white;
        }

        .btn-supprimer:hover {
            background: var(--btn-supprimer-hover);
        }

        .btn-groupe {
            display: flex;
            gap: 10px;
            margin-top: var(--espacement-moyen);
        }

        /* Style pour les inputs de pr√©sences */
        #tbody-saisie-presences input[type="number"]:placeholder-shown {
            background-color: #fff9e6;
            border: 1px dashed #ffc107;
        }

        #tbody-saisie-presences input[type="number"]:not(:placeholder-shown) {
            background-color: white;
            border: 1px solid var(--bleu-leger);
        }

        /* ===============================
           UTILITAIRES
           =============================== */

        .text-muted {
            color: var(--bleu-leger);
            font-size: 0.9rem;
            margin-bottom: var(--espacement-moyen);
        }

        .texte-centre {
            text-align: center;
        }

        .mt-1 {
            margin-top: 10px;
        }

        .mt-2 {
            margin-top: 20px;
        }

        .mt-3 {
            margin-top: 30px;
        }

        .mb-1 {
            margin-bottom: 10px;
        }

        .mb-2 {
            margin-bottom: 20px;
        }

        .mb-3 {
            margin-bottom: 30px;
        }

        /* ===============================
           IMPRESSION
           =============================== */

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .navigation-principale,
            .sous-navigation,
            .btn,
            .statut-sauvegarde {
                display: none !important;
            }

            .conteneur {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
            }

            .carte {
                break-inside: avoid;
            }
        }

        /* ===============================
           RESPONSIVE
           =============================== */

        @media (max-width: 768px) {
            .conteneur {
                border-radius: 0;
                margin: -20px;
            }

            .navigation-principale {
                flex-wrap: wrap;
            }

            .navigation-principale button {
                flex: 1;
                min-width: 150px;
            }

            .grille-statistiques {
                grid-template-columns: 1fr;
            }

            .tableau {
                font-size: 0.85rem;
            }
        }

        /* NOTIFICATIONS */
        .notification-succes {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--vert-leger);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* CALENDRIER - Classes de jours */
        .cal-jour-cours {
            background: white !important;
            color: #333 !important;
        }

        .cal-jour-cours.hover-semaine {
            background: var(--bleu-pale) !important;
        }

        /* üÜï NOUVELLE CLASSE pour les jours de cours r√©els */
        /* Jours de cours r√©els - BLEU LEGER */
        .cal-jour-cours-reel {
            background: var(--bleu-leger) !important;
            color: white !important;
        }

        /* Jours de reprise - MAUVE (btn-modifier) */
        .cal-reprise {
            background: #9370DB !important;
            color: white !important;
        }

        /* Jours de cong√© - ROUGE (btn-supprimer) */
        .cal-conge {
            background: #dc3545 !important;
            color: white !important;
        }

        /* Semaine de planification - RISQUE √âLEV√â */
        .cal-planification {
            background: var(--risque-eleve) !important;
            color: white !important;
        }

        /* Semaine d'examens */
        .cal-examens {
            background: var(--bleu-leger) !important;
            color: white !important;
        }

        .cal-weekend {
            background: var(--bleu-pale) !important;
            color: var(--bleu-leger) !important;
        }
    </style>
</head>

<body>
    <!-- Conteneur principal -->
    <div class="conteneur">

        <!-- En-t√™te -->
        <header class="entete">
            <div class="statut-sauvegarde">
                <span>Donn√©es sauvegard√©es</span>
                <div class="horodatage" id="horodatage-sauvegarde">--</div>
            </div>

            <h1>PRIMO</h1>
            <h2>Suivi automatis√© des apprentissages</h2>
            <p class="version">Beta 0.35-M5 - 10-10-2025a</p>
            <p class="credits">
                Gr√©goire B√©dard | codexnumeris.org<br><br>
                Licence CC BY-NC-SA 4.0 <br> Libre d'usage non commercial ‚Ä¢ Partage dans les m√™mes conditions ‚Ä¢
                Attribution requise
            </p>
        </header>

        <!-- Navigation principale -->
        <nav class="navigation-principale" id="navigation-principale">
            <button data-onglet="tableau-bord" class="actif">Tableaux de suivi</button>
            <button data-onglet="etudiants">√âtudiant¬∑es</button>
            <button data-onglet="presences">Pr√©sences</button>
            <button data-onglet="evaluations">√âvaluations</button>
            <button data-onglet="reglages">R√©glages</button>
        </nav>

        <!-- Sous-navigation -->
        <nav class="sous-navigation" id="sous-navigation">
            <!-- Le contenu sera g√©n√©r√© dynamiquement -->
        </nav>

        <!-- Contenu principal -->
        <main class="contenu" id="contenu-principal">

            <!-- ==========================================
                 SECTION : TABLEAU DE SUIVI
                 ========================================== -->
            <div id="section-tableau-bord" class="section active">

                <!-- Sous-section : Aper√ßu global -->
                <div id="tableau-bord-apercu-groupe" class="sous-section active">
                    <h2>Aper√ßu global</h2>
                    <p class="text-muted">Vue d'ensemble des indicateurs cl√©s</p>

                    <div class="grille-statistiques">
                        <div class="carte-statistique">
                            <div class="valeur">24</div>
                            <div class="label">√âtudiant¬∑es actifs</div>
                        </div>
                        <div class="carte-statistique">
                            <div class="valeur">87%</div>
                            <div class="label">Assiduit√© moyenne</div>
                        </div>
                        <div class="carte-statistique">
                            <div class="valeur">72%</div>
                            <div class="label">Performance moyenne</div>
                        </div>
                        <div class="carte-statistique">
                            <div class="valeur">3</div>
                            <div class="label">Interventions requises</div>
                        </div>
                    </div>

                    <div class="carte">
                        <h3>√âtudiant¬∑es n√©cessitant une attention</h3>
                        <table class="tableau">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Pr√©nom</th>
                                    <th>Niveau de risque</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Bergeron</td>
                                    <td>Rosalie</td>
                                    <td><span class="badge-risque risque-eleve">√âlev√©</span></td>
                                    <td><button class="btn btn-principal" onclick="afficherDetailEtudiant(3)">Voir
                                            d√©tail</button></td>
                                </tr>
                                <tr>
                                    <td>Dubois</td>
                                    <td>Thomas</td>
                                    <td><span class="badge-risque risque-modere">Mod√©r√©</span></td>
                                    <td><button class="btn btn-principal" onclick="afficherDetailEtudiant(7)">Voir
                                            d√©tail</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sous-section : Suivi du groupe -->
                <div id="tableau-bord-liste-groupe" class="sous-section">
                    <h2>Suivi du groupe</h2>
                    <p class="text-muted">Tous les √©tudiant¬∑es avec leurs indicateurs</p>

                    <div class="carte">
                        <table class="tableau">
                            <thead>
                                <tr>
                                    <th>Nom complet</th>
                                    <th>Assiduit√©</th>
                                    <th>Compl√©tion</th>
                                    <th>Performance</th>
                                    <th>Risque global</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-liste-complete">
                                <!-- Sera rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>

                    <div class="btn-groupe">
                        <button class="btn btn-principal">Imprimer la liste</button>
                        <button class="btn btn-principal">Exporter en CSV</button>
                    </div>
                </div>

                <!-- Sous-section : Suivi individuel -->
                <div id="tableau-bord-detail-individuel" class="sous-section">
                    <h2>Suivi individuel</h2>
                    <p class="text-muted">Profil complet d'un¬∑e √©tudiant¬∑e</p>

                    <div class="groupe-form">
                        <label for="select-etudiant">S√©lectionner un¬∑e √©tudiant¬∑e :</label>
                        <select id="select-etudiant" class="controle-form">
                            <option value="">-- Choisir --</option>
                            <option value="1">Beaulieu, Emma</option>
                            <option value="2">B√©langer, Jacob</option>
                            <option value="3">Bergeron, Rosalie</option>
                        </select>
                    </div>

                    <div id="detail-etudiant-contenu">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                </div>

                <!-- Sous-section : Tendances et patterns -->
                <div id="tableau-bord-tendances-patterns" class="sous-section">
                    <h2>Tendances et patterns</h2>
                    <p class="text-muted">Analyse des tendances du groupe</p>

                    <div class="carte">
                        <h3>√âvolution de l'assiduit√©</h3>
                        <div class="conteneur-graphique">
                            [Graphique d'√©volution]
                        </div>
                    </div>

                    <div class="carte">
                        <h3>Distribution des performances</h3>
                        <div class="conteneur-graphique">
                            [Graphique de distribution]
                        </div>
                    </div>
                </div>

            </div>

            <!-- ==========================================
                 SECTION : √âTUDIANT¬∑ES
                 ========================================== -->
            <div id="section-etudiants" class="section">

                <!-- Sous-section : Aper√ßu √©tudiants -->
                <div id="etudiants-apercu" class="sous-section active">
                    <h2>Aper√ßu individuel</h2>
                    <p class="text-muted">Vue d'ensemble rapide</p>

                    <div class="grille-statistiques">
                        <div class="carte-statistique">
                            <div class="valeur">24</div>
                            <div class="label">Inscrits</div>
                        </div>
                        <div class="carte-statistique">
                            <div class="valeur">22</div>
                            <div class="label">Actifs</div>
                        </div>
                        <div class="carte-statistique">
                            <div class="valeur">2</div>
                            <div class="label">Abandons</div>
                        </div>
                    </div>
                </div><!-- Fin sous-section aper√ßu -->

                <!-- Sous-section : Liste -->
                <div id="etudiants-liste" class="sous-section">
                    <h2>Liste des individus</h2>
                    <p class="text-muted">Gestion compl√®te des √©tudiant¬∑es</p>

                    <!-- S√©lecteur de groupe -->
                    <div class="carte" style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label style="font-weight: 600; white-space: nowrap;">Groupe affich√© :</label>
                            <select id="selectGroupe" class="controle-form" style="max-width: 300px;"
                                onchange="changerGroupeAffiche()">
                                <option value="">S√©lectionner un groupe...</option>
                                <!-- Les groupes seront charg√©s dynamiquement -->
                            </select>
                            <span id="nbEtudiantsGroupe" class="text-muted" style="font-size: 0.9rem;"></span>
                        </div>
                    </div>

                    <!-- LISTE DES √âTUDIANTS - DANS R√âGLAGES > GROUPE -->
                    <div class="carte">
                        <h3>üìã Les param√®tres de la cr√©ation du groupe sont dans l'onglet R√©glages
                            <label style="float: right; font-size: 0.85rem; font-weight: normal;">
                                <input type="checkbox" id="verrouillerGroupe" onchange="basculerVerrouillageGroupe()">
                                üîí
                            </label>
                        </h3>

                        <!-- Afficher uniquement si le groupe n'est pas vide -->
                        <div id="students-list-container" style="display: none;">
                            <table class="tableau" id="students-table">
                                <thead>
                                    <tr>
                                        <th>DA</th>
                                        <th>Groupe</th>
                                        <th>Nom</th>
                                        <th>Pr√©nom</th>
                                        <th>Programme</th>
                                        <th>SA</th>
                                        <th>CAF</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-tbody">
                                    <!-- Les √©tudiants seront ajout√©s ici -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Message si le groupe est vide (plus discret) -->
                        <p class="text-muted" id="no-students-msg"
                            style="display: none; text-align: center; margin: 20px 0;">
                            Le groupe est vide. Ajoutez des √©tudiant¬∑es ci-dessus.
                        </p>
                    </div><!--fin carte liste √©tudiants-->

                    <!--d√©but gestion donn√©es √©tudiants-->
                    <div class="btn-groupe mt-3">
                        <button onclick="exportStudentsData()" class="btn btn-principal">
                            üì• Exporter la liste
                        </button>
                        <button onclick="resetStudentsData()" class="btn btn-supprimer">
                            üóëÔ∏è R√©initialiser tout le groupe
                        </button>
                    </div><!--fin gestion des donn√©es √©tudiants-->

                </div><!-- Fin sous-section liste -->

                <!-- Sous-section : Profil -->
                <div id="etudiants-profil" class="sous-section">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-principal" onclick="afficherSousSection('etudiants-liste')"
                            style="padding: 8px 15px;">
                            ‚Üê Retour √† la liste
                        </button>
                    </div>

                    <div id="contenuProfilEtudiant">
                        <!-- Le contenu sera charg√© dynamiquement -->
                    </div>
                </div>

            </div> <!-- Fermeture de section etudiants -->

            <!-- ==========================================
                 SECTION : PR√âSENCES
                 ========================================== -->
            <div id="section-presences" class="section">

                <!-- Sous-section : Aper√ßu -->
                <div id="presences-apercu" class="sous-section active">
                    <h2>Aper√ßu des pr√©sences</h2>
                    <p class="text-muted">Vue d'ensemble de l'assiduit√©</p>

                    <div class="carte">
                        <table class="tableau">
                            <thead>
                                <tr>
                                    <th>Nom complet</th>
                                    <th>Pr√©sences</th>
                                    <th>Absences</th>
                                    <th>Retards</th>
                                    <th>Taux</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-presences-apercu">
                                <!-- Sera rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sous-section : Calendrier -->
                <div id="presences-calendrier" class="sous-section">
                    <h2>Calendrier des pr√©sences</h2>
                    <p class="text-muted">Vue calendaire des s√©ances</p>

                    <div class="carte">
                        <div id="conteneur-calendrier">
                            [Calendrier interactif]
                        </div>
                    </div>
                </div>

                <!-- Sous-section : Saisie -->
                <div id="presences-saisie" class="sous-section">
                    <h2>Saisie des pr√©sences</h2>
                    <p class="text-muted">Enregistrer les pr√©sences pour une s√©ance</p>

                    <!-- Avertissement si format non configur√© -->
                    <div id="alerteFormatHoraire"
                        style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong style="color: #856404;">‚ö†Ô∏è Configuration requise</strong>
                        <p style="margin: 8px 0 0 0; color: #856404; font-size: 0.95rem;">
                            Le format horaire n'est pas configur√©. La dur√©e par d√©faut est fix√©e √† <strong>2h par
                                s√©ance</strong>.
                            <br>Pour d√©finir le format exact (2√ó2h ou 1√ó4h), veuillez configurer l'horaire dans
                            <a href="#"
                                onclick="afficherSection('reglages'); afficherSousSection('reglages-horaire'); return false;"
                                style="color: #856404; text-decoration: underline; font-weight: 600;">R√©glages >
                                Horaire</a>.
                        </p>
                    </div>

                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div class="groupe-form" style="margin-bottom: 0;">
                            <label for="date-cours" style="font-weight: 600;">Date du cours :</label>
                            <input type="date" id="date-cours" class="controle-form"
                                onchange="initialiserSaisiePresences()">
                        </div>

                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label style="font-weight: 600; white-space: nowrap;">Groupe affich√© :</label>
                            <select id="selectGroupePresences" class="controle-form" style="max-width: 300px;"
                                onchange="initialiserSaisiePresences()">
                                <option value="">Tous les groupes</option>
                                <!-- Les groupes seront charg√©s dynamiquement -->
                            </select>
                            <span id="nbEtudiantsPresences" class="text-muted" style="font-size: 0.9rem;"></span>
                        </div>
                    </div>

                    <!-- En-t√™te dynamique -->
                    <div id="enteteDateSeance"
                        style="display: none; background: #fff9e6; border: 2px solid #ffc107; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; text-align: center;">
                        <h3 style="margin: 0; color: #856404; font-size: 1.1rem; font-weight: 600;">
                            <span id="texteDateSeance">Pr√©sences au cours</span>
                        </h3>
                    </div>

                    <div class="carte">
                        <table class="tableau">
                            <thead>
                                <tr>
                                    <th>DA</th>
                                    <th>Pr√©nom</th>
                                    <th>Nom</th>
                                    <th id="colonneHeuresTitre" style="text-align: center;">
                                        Heures (max. 2h)
                                        <div
                                            style="margin-top: 8px; display: flex; flex-direction: column; gap: 4px; align-items: center;">
                                            <button id="btn-tous-presents" onclick="remplirTousPresents()" style="padding: 4px 12px; font-size: 0.85rem; border: 1px solid var(--bleu-principal); 
                               background: var(--bleu-principal); color: white; border-radius: 4px; cursor: pointer;
                               font-weight: 600;">
                                                Tous 2h
                                            </button>
                                            <button id="btn-reinit-saisie" onclick="reinitialiserSaisie()" style="padding: 4px 12px; font-size: 1rem; border: 1px solid var(--gris-moyen); 
                               background: white; color: var(--gris-moyen); border-radius: 4px; cursor: pointer;">
                                                ‚Üª
                                            </button>
                                        </div>
                                    </th>
                                    <th>Notes</th>
                                    <th>Total heures</th>
                                    <th>Assiduit√©</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-saisie-presences">
                                <!-- Sera rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>

                    <div class="btn-groupe">
                        <button class="btn btn-confirmer" onclick="enregistrerPresences()">Enregistrer</button>
                        <button class="btn btn-annuler">Annuler</button>
                    </div>
                </div>

            </div><!-- fin pr√©sences-->

            <!-- ==========================================
                 SECTION : √âVALUATIONS
                 ========================================== -->
            <div id="section-evaluations" class="section">

                <!-- Sous-section : Aper√ßu -->
                <div id="evaluations-apercu" class="sous-section active">
                    <h2>Aper√ßu des √©valuations</h2>
                    <p class="text-muted">Performance globale du groupe</p>

                    <div class="carte">
                        <table class="tableau">
                            <thead>
                                <tr>
                                    <th>Nom complet</th>
                                    <th>Moyenne</th>
                                    <th>Compl√©t√©es</th>
                                    <th>En retard</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-evaluations-apercu">
                                <!-- Sera rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sous-section : √âvaluations et r√©troactions individuelles -->
                <div id="evaluations-individuelles" class="sous-section">
                    <h2>√âvaluation des productions et r√©troaction diff√©renci√©e automatique</h2>
                    <p class="text-muted">√âvaluation d√©taill√©e selon les crit√®res et les √©chelles de performance</p>

                    <!-- Conteneur principal en Layout L modifi√© -->
                    <div class="carte" style="margin-bottom: 20px;">

                        <!-- PARTIE HAUTE : 2 colonnes -->
                        <div style="display: grid; grid-template-columns: 320px 1fr; gap: 25px; margin-bottom: 20px;">

                            <!-- COLONNE GAUCHE : PARAM√àTRES DE L'√âVALUATION -->
                            <div style="padding: 15px; background: var(--gris-tres-clair); border-radius: 8px;">
                                <h4 style="margin: 0 0 15px 0; color: var(--gris-fonce);">Param√®tres de l'√©valuation
                                </h4>

                                <div class="groupe-form" style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Groupe
                                        :</label>
                                    <select id="selectGroupeEval" class="controle-form"
                                        onchange="filtrerEtudiantsParGroupe()">
                                        <option value="">Tous les groupes</option>
                                    </select>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">√âtudiant¬∑e
                                        :</label>
                                    <select id="selectEtudiantEval" class="controle-form"
                                        onchange="chargerEvaluationsEtudiant()">
                                        <option value="">-- Choisir un¬∑e √©tudiant¬∑e --</option>
                                    </select>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Production
                                        √©tudiante :</label>
                                    <select id="selectProduction1" class="controle-form"
                                        onchange="chargerProduction(1)">
                                        <option value="">-- Choisir une production --</option>
                                    </select>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Grille
                                        d'√©valuation :</label>
                                    <select id="selectGrille1" class="controle-form"
                                        onchange="chargerGrilleSelectionnee()">
                                        <option value="">-- Choisir une grille --</option>
                                    </select>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">√âchelle de
                                        performance :</label>
                                    <select id="selectEchelle1" class="controle-form"
                                        onchange="changerEchelleEvaluation(1)">
                                        <option value="">-- Choisir une √©chelle --</option>
                                    </select>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Cartouche de
                                        r√©troaction :</label>
                                    <select id="selectCartoucheEval" class="controle-form"
                                        onchange="cartoucheSelectionnee()">
                                        <option value="">-- Choisir une cartouche --</option>
                                    </select>
                                </div>

                                <div class="groupe-form"
                                    style="padding: 10px; background: white; border-radius: 5px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <label style="flex: 1;">Statut de remise :</label>
                                        <select id="remiseProduction1" class="controle-form" style="width: 120px;"
                                            onchange="changerStatutRemise(1)">
                                            <option value="non-remis">Non remis</option>
                                            <option value="remis">Remis</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Note finale -->
                                <div id="noteFinale1"
                                    style="padding: 12px; border-radius: 5px; text-align: center; background: var(--bleu-tres-pale); font-weight: bold;">
                                    <div>Note: <span id="noteProduction1">0.0</span>%</div>
                                    <div>Niveau: <span id="niveauProduction1">--</span></div>
                                </div>
                            </div>

                            <!-- COLONNE DROITE : CRIT√àRES AVEC R√âTROACTIONS -->
                            <div style="padding: 15px; background: var(--gris-tres-clair); border-radius: 8px;">
                                <h4 style="margin: 0 0 15px 0; color: var(--gris-fonce);">√âvaluation et pr√©visualisation
                                    de la r√©troaction</h4>

                                <div id="listeCriteresGrille1" style="max-height: 600px; overflow-y: auto;">
                                    <p style="color: #999; font-style: italic; font-size: 0.85rem;">
                                        S√©lectionnez une grille et une cartouche
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-principal" onclick="sauvegarderEvaluation()"
                            style="padding: 8px 20px; margin-left: 10px;">
                            üíæ Sauvegarder l'√©valuation
                        </button>

                        <button class="btn btn-ajouter" onclick="afficherListeEvaluations()"
                            style="padding: 8px 20px; margin-left: 10px;">
                            üìÇ Voir les √©valuations sauvegard√©es
                        </button>

                        <button class="btn btn-ajouter" onclick="nouvelleEvaluation()"
                            style="padding: 8px 20px; margin-left: 10px;">
                            ‚ûï √âvaluer un autre √©l√®ve
                        </button>

                        <!-- PARTIE BASSE : R√âTROACTION FINALE -->
                        <div style="padding: 15px; background: var(--gris-tres-clair); border-radius: 8px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: var(--gris-fonce);">R√©troaction finale</h4>
                            </div>

                            <!-- Options √† inclure -->
                            <div
                                style="padding: 12px; background: white; border-radius: 5px; margin-bottom: 15px; display: flex; gap: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="afficherDescription1" onchange="genererRetroaction(1)">
                                    <span>Description de l'√©valuation</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="afficherObjectif1" onchange="genererRetroaction(1)">
                                    <span>Objectif p√©dagogique</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="afficherTache1" onchange="genererRetroaction(1)">
                                    <span>T√¢che √† r√©aliser</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="afficherAdresse1" onchange="genererRetroaction(1)">
                                    <span>Adresse personnalis√©e</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="afficherContexte1" onchange="genererRetroaction(1)">
                                    <span>Contexte de la r√©troaction</span>
                                </label>
                            </div>

                            <!-- Zone de texte √©ditable -->
                            <textarea id="retroactionFinale1" style="width: 100%; height: 200px; padding: 12px; border-radius: 5px; 
                   border: 1px solid #ddd; font-family: inherit; resize: vertical; 
                   line-height: 1.6; background: white;"
                                placeholder="La r√©troaction finale appara√Ætra ici. Vous pourrez la modifier avant de la copier..."
                                onchange="sauvegarderRetroactionFinale(1)"></textarea>
                        </div>

                        <button class="btn btn-confirmer" onclick="copierRetroaction(1)" style="padding: 8px 20px;">
                            üìã Copier dans le presse-papier
                        </button>
                    </div>

                    <!-- Message si aucun √©tudiant s√©lectionn√© -->
                    <div id="aucunEtudiantEval" style="padding: 40px; background: var(--bleu-tres-pale); 
     border-radius: 8px; text-align: center; color: var(--bleu-leger);">
                        <p style="font-size: 1.2rem; margin: 0;">‚úèÔ∏è S√©lectionnez un¬∑e √©tudiant¬∑e pour commencer
                            l'√©valuation</p>
                    </div><!--fin √©valuations-individuelles-->
                </div><!--fin carte du layout √©valuation-->
            </div><!--fin section-evaluations-->

            <!-- ==========================================
     SECTION : R√âGLAGES
     ========================================== -->
            <div id="section-reglages" class="section">

                <!-- Sous-section : Aper√ßu -->
                <div id="reglages-apercu" class="sous-section active">
                    <h2>Aper√ßu des r√©glages</h2>
                    <p class="text-muted">Configuration g√©n√©rale du syst√®me</p>

                    <!-- Cartes statistiques dynamiques -->
                    <div class="grille-statistiques">
                        <div class="carte">
                            <h3>üìö Informations du cours</h3>
                            <p><strong>Code :</strong> <span id="stat-code-cours">‚Äî</span></p>
                            <p><strong>Trimestre :</strong> <span id="stat-trimestre">‚Äî</span></p>
                            <p><strong>Calendrier :</strong> <span id="stat-calendrier">‚Äî</span></p>
                            <p><strong>Horaire :</strong> <span id="stat-horaire">‚Äî</span></p>
                            <p><strong>Groupes :</strong> <span id="stat-nb-groupes">‚Äî</span></p>
                            <p><strong>√âl√®ves :</strong> <span id="stat-nb-eleves">‚Äî</span></p>
                        </div>
                        <div class="carte">
                            <h3>üõ†Ô∏è Mat√©riel configur√©</h3>
                            <p><strong>Pratique de notation :</strong> <span id="stat-pratique">‚Äî</span></p>
                            <p><strong>Productions :</strong> <span id="stat-productions">‚Äî</span></p>
                            <p><strong>Grilles de crit√®res :</strong> <span id="stat-grilles">‚Äî</span></p>
                            <p><strong>√âchelles de performance :</strong> <span id="stat-echelles">‚Äî</span></p>
                            <p><strong>Cartouches de r√©troaction :</strong> <span id="stat-cartouches">‚Äî</span></p>
                        </div>
                        <div class="carte">
                            <h3>‚öôÔ∏è Syst√®me</h3>
                            <p><strong>Version :</strong> <span id="stat-version">Beta 0.35</span></p>
                            <p><strong>Derni√®re MAJ :</strong> <span id="stat-derniere-maj">‚Äî</span></p>
                            <p><strong>Poids donn√©es :</strong> <span id="stat-poids">‚Äî</span></p>
                            <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--bleu-pale);">
                                <button class="btn btn-principal" onclick="ouvrirModalExport()"
                                    style="width: 100%; margin-bottom: 8px;">
                                    üì§ Exporter les donn√©es
                                </button>
                                <button class="btn btn-principal" onclick="ouvrirModalImport()" style="width: 100%;">
                                    üì• Importer les donn√©es
                                </button>
                            </p>
                        </div>
                    </div>
                </div><!--fin aper√ßu r√©glages-->

                <!-- Sous-section : Cours -->
                <div id="reglages-cours" class="sous-section">
                    <h2>Configuration du cours</h2>
                    <p class="text-muted">Informations techniques du cours : code, nom, comp√©tences,
                        enseignant¬∑e,
                        trimestre, format horaire</p>

                    <div class="carte">
                        <h3>üìö Cours configur√©s</h3>

                        <!-- VUE D'ENSEMBLE -->
                        <div class="grille-statistiques" style="margin-bottom: 20px;">
                            <div class="carte-metrique">
                                <strong id="nombreCours">0</strong>
                                <span>Configurations</span>
                            </div>
                            <div class="carte-metrique">
                                <strong id="sessionActive">H2025</strong>
                                <span>Session active</span>
                            </div>
                            <div class="carte-metrique" style="grid-column: span 2;">
                                <span id="resumeCours" style="font-size: 0.9rem;">
                                    Aucune configuration de cours
                                </span>
                            </div>
                        </div>

                        <!-- TABLEAU/CONTENEUR DES COURS -->
                        <div id="tableauCoursContainer" style="margin-bottom: 20px;">
                            <p class="text-muted" id="aucunCours" style="font-style: italic;">
                                Aucun cours configur√©.
                            </p>
                        </div>

                        <!-- FORMULAIRE D'AJOUT/MODIFICATION (cach√© par d√©faut) -->
                        <div id="formulaireCours" style="display: none; margin-top: 20px; padding: 15px; 
             background: var(--bleu-pale); border-radius: 6px;">

                            <h4 id="titreFormCours" style="color: var(--bleu-principal); margin-bottom: 15px;">
                                Nouvelle configuration de cours
                            </h4>

                            <h5>Informations g√©n√©rales</h5>
                            <div class="grille-statistiques">
                                <div class="groupe-form">
                                    <label>Code du cours</label>
                                    <input type="text" id="codeCours" value="601-101-MQ" class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>Nom du cours</label>
                                    <input type="text" id="nomCours" value="√âcriture et litt√©rature"
                                        class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>N¬∞ de la comp√©tence</label>
                                    <input type="text" id="numeroCompetence" value="4EF0" class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>Comp√©tence</label>
                                    <input type="text" id="competence" value="Analyser des textes litt√©raires"
                                        class="controle-form">
                                </div>
                            </div>

                            <div class="groupe-form mt-2">
                                <label>√âl√©ments de comp√©tence</label>
                                <textarea id="elementsCompetence" class="controle-form"
                                    rows="4">‚Ä¢ Reconna√Ætre le propos du texte</textarea>
                            </div>

                            <h5 class="mt-3">Enseignant¬∑e</h5>
                            <div class="grille-statistiques">
                                <div class="groupe-form">
                                    <label>Pr√©nom</label>
                                    <input type="text" id="prenomEnseignant" value="Gr√©goire" class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>Nom</label>
                                    <input type="text" id="nomEnseignant" value="B√©dard" class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>D√©partement</label>
                                    <input type="text" id="departement" value="Litt√©rature et communication"
                                        class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>Local</label>
                                    <input type="text" id="local" value="2314" class="controle-form">
                                </div>
                            </div>

                            <h5 class="mt-3">Trimestre</h5>
                            <div class="grille-statistiques">
                                <div class="groupe-form">
                                    <label>Session</label>
                                    <select id="session" class="controle-form">
                                        <option value="H" selected>Hiver (janvier √† mai)</option>
                                        <option value="A">Automne (ao√ªt √† d√©cembre)</option>
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label>Ann√©e</label>
                                    <input type="number" id="annee" value="2025" class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>Heures/semaine</label>
                                    <input type="number" id="heuresParSemaine" value="4" class="controle-form">
                                </div>
                                <div class="groupe-form">
                                    <label>Format horaire</label>
                                    <select id="formatHoraire" class="controle-form">
                                        <option value="2x2" selected>2 x 2h</option>
                                        <option value="1x4">1 x 4h</option>
                                        <option value="3x1.33">3 x 1h20</option>
                                        <option value="autre">Autre</option>
                                    </select>
                                </div>
                            </div>

                            <div class="btn-groupe mt-3" style="justify-content: flex-end;">
                                <button class="btn btn-annuler" onclick="annulerFormCours()">Annuler</button>
                                <button class="btn btn-confirmer" onclick="sauvegarderCours()">
                                    <span id="btnTexteCours">Ajouter</span>
                                </button>
                            </div>
                        </div>

                        <button id="btnAjouterCours" class="btn btn-ajouter mt-2" onclick="afficherFormCours()">
                            + Ajouter un cours
                        </button>

                    </div><!-- Fin de la carte -->
                </div><!-- fin cours-->

                <!-- Sous-section : Calendrier -->
                <div id="reglages-calendrier" class="sous-section">
                    <h2>Configuration du calendrier</h2>
                    <p class="text-muted">Afin de construire le calendrier du trimestre, indiquez ici le d√©but
                        et la
                        fin
                        des cours et du trimestre, les cong√©s pr√©vus par la direction des √©tudes, ajoutez les
                        cong√©s
                        impr√©vus qui
                        surviennent au cours du trimestre, etc.</p>

                    <!-- CADRE R√âGULIER -->
                    <div class="carte">
                        <h3>üìÜ Cadre r√©gulier</h3>

                        <!-- Petites m√©triques simples -->
                        <div class="grille-statistiques" style="margin-bottom: 20px;">
                            <div class="carte-metrique">
                                <strong id="nombreSemaines">15</strong>
                                <span>Semaines</span>
                            </div>
                            <div class="carte-metrique">
                                <strong id="totalConges">0</strong>
                                <span>Cong√©s</span>
                            </div>
                        </div>

                        <h4 class="mt-2">Bornes du trimestre</h4>
                        <div class="grille-statistiques">
                            <div class="groupe-form">
                                <label>D√©but du trimestre :</label>
                                <input type="date" class="controle-form" id="debutTrimestre" value="2025-08-21">
                            </div>
                            <div class="groupe-form">
                                <label>Fin des cours r√©guliers :</label>
                                <input type="date" class="controle-form" id="finCours" value="2025-12-12">
                            </div>
                            <div class="groupe-form">
                                <label>Fin du trimestre :</label>
                                <input type="date" class="controle-form" id="finTrimestre" value="2025-12-22">
                            </div>
                            <div class="groupe-form">
                                <label>Remise des notes :</label>
                                <input type="date" class="controle-form" id="remiseNotes" value="2025-12-22">
                            </div>
                        </div>

                        <!-- Semaine de Planification - RESTE IDENTIQUE -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                            <!-- COLONNE GAUCHE: Semaine de planification -->
                            <div>
                                <h4>Semaine de planification et de mise √† jour</h4>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div class="groupe-form" style="flex: 1;">
                                        <label>Du :</label>
                                        <input type="date" class="controle-form" id="semainePlanificationDebut"
                                            value="2025-10-13">
                                    </div>
                                    <span style="padding-top: 20px;">au</span>
                                    <div class="groupe-form" style="flex: 1;">
                                        <label>&nbsp;</label>
                                        <input type="date" class="controle-form" id="semainePlanificationFin"
                                            value="2025-10-17">
                                    </div>
                                </div>
                            </div>

                            <!-- COLONNE DROITE: Semaine d'examens -->
                            <div>
                                <h4>Semaine d'examens</h4>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div class="groupe-form" style="flex: 1;">
                                        <label>Du :</label>
                                        <input type="date" class="controle-form" id="semaineExamensDebut"
                                            value="2025-12-15">
                                    </div>
                                    <span style="padding-top: 20px;">au</span>
                                    <div class="groupe-form" style="flex: 1;">
                                        <label>&nbsp;</label>
                                        <input type="date" class="controle-form" id="semaineExamensFin"
                                            value="2025-12-22">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bouton de sauvegarde pour cette carte -->
                        <div class="btn-groupe mt-3">
                            <button class="btn btn-confirmer" onclick="sauvegarderCadreCalendrier()">
                                üíæ Sauvegarder les bornes
                            </button>
                        </div>
                    </div><!-- FIN de la carte "Cadre r√©gulier" -->

                    <!-- AM√âNAGEMENTS -->
                    <div class="carte mt-3">
                        <h3>üìÖ Am√©nagements</h3>

                        <h4 class="mt-2">Cong√©s f√©ri√©s et activit√©s institutionnelles</h4>
                        <p class="text-muted" style="font-size: 0.85rem;">Cong√©s f√©ri√©s, journ√©es p√©dagogiques,
                            journ√©e Carri√®re, etc. avec leurs reprises √©ventuelles</p>

                        <!-- Tableau des √©v√©nements pr√©vus avec les boutons standards -->
                        <div id="congesPrevusContainer" style="margin-bottom: 20px;">
                            <!-- Le tableau sera g√©n√©r√© ici dynamiquement -->
                        </div>



                        <button id="btnAjouterPrevu" class="btn btn-ajouter" onclick="afficherFormulaireAjoutPrevu()">
                            + Ajouter un √©v√©nement pr√©vu
                        </button>

                        <h4 class="mt-3">√âv√©nements impr√©vus</h4>
                        <p class="text-muted" style="font-size: 0.85rem;">Maladie, conditions m√©t√©orologiques,
                            urgence,
                            autre, etc.</p>

                        <!-- Tableau des √©v√©nements impr√©vus avec les boutons standards -->
                        <div id="evenementsImprevusContainer" style="margin-bottom: 20px;">
                            <!-- Le tableau sera g√©n√©r√© ici dynamiquement -->
                        </div>

                        <!-- FORMULAIRE √âV√âNEMENT IMPR√âVU RESTE IDENTIQUE -->
                        <div id="formAjoutEvenementImprevu"
                            style="display: none; padding: 15px; background: #fff4e6; border: 2px solid var(--orange-accent); border-radius: 6px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span
                                    style="color: var(--orange-accent); font-weight: bold; margin-right: 10px;">‚ö†</span>
                                <strong style="color: var(--orange-accent);">Nouvel √©v√©nement impr√©vu</strong>
                            </div>

                            <p style="font-size: 0.75rem; color: #666; margin-bottom: 10px;">
                                Pour les √©v√©nements impr√©vus, la reprise peut √™tre planifi√©e apr√®s coup selon
                                les
                                circonstances.
                            </p>

                            <div
                                style="display: grid; grid-template-columns: 1fr 1.5fr 1.5fr 1fr; gap: 10px; align-items: end;">
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Date √©v√©nement</label>
                                    <input type="date" class="controle-form" id="nouvelleDateImprevu">
                                </div>
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Description</label>
                                    <select class="controle-form" id="nouvelleDescriptionImprevu">
                                        <option>Choisir...</option>
                                        <option>Maladie</option>
                                        <option>M√©t√©o</option>
                                        <option>Urgence</option>
                                        <option>Autre</option>
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Reprise (optionnelle)</label>
                                    <select class="controle-form" id="nouvelHoraireRepriseImprevu">
                                        <option>Choisir...</option>
                                        <option>Le cours n'est pas repris</option>
                                        <option>Le cours est repris</option>
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Date reprise</label>
                                    <input type="date" class="controle-form" id="nouvelleDateRepriseImprevu">
                                </div>
                            </div>

                            <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                                <button class="btn btn-annuler"
                                    onclick="annulerAjoutEvenementImprevu()">Annuler</button>
                                <button class="btn btn-confirmer" onclick="confirmerAjoutEvenementImprevu()">Ajouter
                                    l'√©v√©nement</button>
                            </div>
                        </div>

                        <button id="btnAjouterEvenementImprevu" class="btn btn-ajouter"
                            onclick="afficherFormulaireAjoutEvenementImprevu()">
                            + Ajouter un √©v√©nement impr√©vu
                        </button>

                        <!-- Bouton de sauvegarde pour les am√©nagements -->
                        <div class="btn-groupe mt-3">
                            <button class="btn btn-confirmer" onclick="sauvegarderAmenagements()">
                                üíæ Sauvegarder les am√©nagements
                            </button>
                        </div>

                    </div><!--fin am√©nagement-->

                </div><!--fin calendrier-->

                <!-- Sous-section : Horaire -->
                <div id="reglages-horaire" class="sous-section">
                    <h2>Configuration de l'horaire</h2>
                    <p class="text-muted">D√©finissez le format horaire hebdomadaire de vos s√©ances de cours</p>

                    <!-- S√©lecteur de format horaire -->
                    <div class="carte" style="margin-bottom: 20px;">
                        <h3>Format des cours</h3>
                        <div style="display: flex; gap: 30px; margin-top: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="formatHoraire" value="2x2" id="format2x2"
                                    style="margin-right: 8px;">
                                <span>2 s√©ances de 2h s√©par√©es</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="formatHoraire" value="1x4" id="format1x4"
                                    style="margin-right: 8px;">
                                <span>1 s√©ance de 4h cons√©cutives</span>
                            </label>
                        </div>
                    </div><!--fin carte-->

                    <div class="carte">
                        <h3>Horaire des s√©ances</h3>

                        <!-- Conteneur pour les s√©ances existantes -->
                        <div id="seancesContainer" style="margin-bottom: 20px;">
                            <p class="text-muted" style="font-style: italic;">Aucune s√©ance configur√©e.</p>
                        </div>

                        <!-- Formulaire d'ajout (cach√© par d√©faut) -->
                        <div id="formAjoutSeance"
                            style="display: none; padding: 15px; background: var(--bleu-pale); border: 1px solid var(--bleu-leger); border-radius: 6px; margin-bottom: 20px;">
                            <strong style="color: var(--bleu-principal);">Nouvelle s√©ance de cours</strong>

                            <div id="seancesFormContainer" style="margin-top: 15px;">
                                <!-- Le contenu sera g√©n√©r√© dynamiquement selon le format horaire -->
                            </div>

                            <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                                <button class="btn btn-annuler" onclick="annulerAjoutSeance()">Annuler</button>
                                <button class="btn btn-confirmer" id="btnConfirmerSeances"
                                    onclick="confirmerAjoutSeances()">Ajouter les s√©ances</button>
                            </div>
                        </div>

                    </div><!--fin carte-->

                    <!-- Disponibilit√©s de l'enseignant -->
                    <div class="carte mt-3">
                        <h3>Disponibilit√©s de l'enseignant¬∑e</h3>
                        <p class="text-muted" style="font-size: 0.85rem;">P√©riodes o√π vous √™tes disponible pour
                            rencontrer les √©tudiant¬∑es</p>

                        <!-- Conteneur pour les disponibilit√©s existantes -->
                        <div id="disponibilitesContainer" style="margin-bottom: 20px;">
                            <p class="text-muted" style="font-style: italic;">Aucune disponibilit√© configur√©e.
                            </p>
                        </div>

                        <!-- Formulaire d'ajout disponibilit√© (cach√© par d√©faut) -->
                        <div id="formAjoutDisponibilite"
                            style="display: none; padding: 15px; background: var(--vert-pale); border: 1px solid var(--vert-leger); border-radius: 6px; margin-bottom: 20px;">
                            <strong style="color: var(--vert-leger);">Nouvelle p√©riode de disponibilit√©</strong>

                            <div
                                style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr; gap: 10px; margin-top: 15px; align-items: end;">
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Jour de la semaine</label>
                                    <select class="controle-form" id="jourDisponibilite">
                                        <option>Choisir...</option>
                                        <option>Lundi</option>
                                        <option>Mardi</option>
                                        <option>Mercredi</option>
                                        <option>Jeudi</option>
                                        <option>Vendredi</option>
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Heure d√©but</label>
                                    <select class="controle-form" id="debutDisponibilite">
                                        <!-- Options g√©n√©r√©es par JavaScript -->
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Heure fin</label>
                                    <select class="controle-form" id="finDisponibilite">
                                        <!-- Options g√©n√©r√©es par JavaScript -->
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label style="font-size: 0.85rem;">Local</label>
                                    <input type="text" class="controle-form" id="localDisponibilite"
                                        placeholder="Ex: Bureau local 2314">
                                </div>
                            </div>

                            <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                                <button class="btn btn-annuler" onclick="annulerAjoutDisponibilite()">Annuler</button>
                                <button class="btn btn-confirmer" onclick="confirmerAjoutDisponibilite()">Ajouter la
                                    disponibilit√©</button>
                            </div>
                        </div><!--fin formulaire dispo-->
                    </div><!--fin dispo-->
                    <button id="btnAjouterDisponibilite" class="btn btn-ajouter"
                        onclick="afficherFormulaireDisponibilite()">+ Ajouter une p√©riode de
                        disponibilit√©</button>
                </div><!--fin horaire-->

                <!-- Sous-section : Groupe -->
                <div id="reglages-groupe" class="sous-section">
                    <h2>Configuration du groupe</h2>
                    <p class="text-muted">Cr√©er et g√©rer le groupe d'√©tudiant¬∑es inscrit¬∑es au cours</p>

                    <!-- IMPORTATION PAR LOTS -->
                    <div class="carte">
                        <h3>üìÅ Importation par lots (liste d'√©tudiant¬∑es)</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <button onclick="importFromFile()" class="btn btn-principal" style="padding: 15px;">
                                üìÑ Importer un fichier CSV/TSV
                            </button>
                            <button onclick="importFromPaste()" class="btn btn-principal" style="padding: 15px;">
                                üìã Copier-coller une liste
                            </button>
                        </div>

                        <!-- Zone d'upload de fichier -->
                        <div id="fileUploadZone" style="display: none; margin-bottom: 20px;">
                            <p style="margin-bottom: 10px; color: #666; font-size: 0.9rem;">
                                Glissez votre fichier CSV/TSV ici ou cliquez pour le s√©lectionner
                            </p>
                            <div style="border: 2px dashed var(--bleu-leger); border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--bleu-tres-pale);"
                                id="dropZone" onclick="document.getElementById('fichierCsvEntree').click()">
                                <div style="font-size: 3rem; margin-bottom: 10px; color: var(--bleu-leger);">üìÅ
                                </div>
                                <p style="color: var(--bleu-moyen);">Cliquez ici pour choisir un fichier</p>
                                <p style="font-size: 0.8rem; color: var(--bleu-leger); margin-top: 5px;">Formats
                                    accept√©s: .csv, .tsv</p>
                            </div>
                            <input type="file" id="fichierCsvEntree" accept=".csv,.tsv,.txt" style="display: none;"
                                onchange="handleFileSelect(event)">
                        </div>

                        <!-- Zone de copier-coller -->
                        <div id="pasteZone" style="display: none; margin-bottom: 20px;">
                            <div class="groupe-form">
                                <label>Collez vos donn√©es ici (format CSV/TSV) :</label>
                                <textarea id="donneesCollees" class="controle-form" rows="8"
                                    placeholder="No de DA&#9;Groupe&#9;Nom de l'√©tudiant&#9;Pr√©nom de l'√©tudiant&#9;Prog.&#9;Services adapt√©s&#10;1234567&#9;1&#9;Beaulieu&#9;Emma&#9;180.B0&#9;&#10;1234570&#9;1&#9;B√©langer&#9;Jacob&#9;300.M0&#9;"
                                    style="font-family: monospace; font-size: 0.9rem;"></textarea>
                            </div>
                            <button onclick="parseDataFromTextarea()" class="btn btn-principal">
                                üîç Analyser les donn√©es
                            </button>
                        </div>

                        <!-- Zone de pr√©visualisation (MAINTENANT EN DEHORS DE pasteZone) -->
                        <div id="previewZone" style="display: none; margin-bottom: 20px;">
                            <h4>Pr√©visualisation des donn√©es √† importer :</h4>
                            <div id="previewTable"
                                style="background: var(--bleu-pale); padding: 15px; border-radius: 8px; overflow-x: auto; margin-bottom: 15px;">
                            </div>
                            <div class="btn-groupe" style="justify-content: flex-end;">
                                <button onclick="cancelImport()" class="btn btn-annuler">
                                    Annuler
                                </button>
                                <button onclick="confirmImport()" class="btn btn-confirmer">
                                    Importer (<span id="importCount">0</span> √©tudiant¬∑es)
                                </button>
                            </div>
                        </div>

                        <!-- Format attendu -->
                        <div style="background: var(--bleu-pale); padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <h5>Format attendu :</h5>
                            <p style="font-family: monospace; font-size: 0.85rem; margin-bottom: 10px;">
                                DA | Groupe | Nom, Pr√©nom | Programme | Services adapt√©s
                            </p>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: var(--bleu-principal); font-weight: 600;">
                                    üí° Voir le guide d'exportation depuis votre LMS
                                </summary>
                                <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                    <ol>
                                        <li>Connectez-vous √† L√©a (LMS)</li>
                                        <li>Allez dans votre cours ‚Üí Participants</li>
                                        <li>Cliquez sur "T√©l√©charger" ou "Exporter"</li>
                                        <li>Choisissez le format CSV ou Excel</li>
                                        <li>Importez le fichier ici</li>
                                    </ol>
                                </div>
                            </details>
                        </div><!--fin format attendu-->
                    </div><!--fin carte-->


                    <!-- AJOUT MANUEL -->
                    <div class="carte">
                        <h3>‚ûï Ajout manuel des √©tudiant¬∑es</h3>

                        <div
                            style="display: grid; grid-template-columns: 140px 80px 1fr 1fr 140px; gap: 15px; margin-bottom: 20px;">
                            <div class="groupe-form">
                                <label>Num√©ro de DA :</label>
                                <input type="text" id="etudiantDA" class="controle-form" placeholder="Ex: 1234567">
                            </div>
                            <div class="groupe-form">
                                <label>Groupe :</label>
                                <input type="text" id="etudiantGroupe" class="controle-form" placeholder="Ex: 1">
                            </div>
                            <div class="groupe-form">
                                <label>Nom de famille :</label>
                                <input type="text" id="etudiantNom" class="controle-form" placeholder="Nom de famille"
                                    required>
                            </div>
                            <div class="groupe-form">
                                <label>Pr√©nom :</label>
                                <input type="text" id="etudiantPrenom" class="controle-form" placeholder="Pr√©nom"
                                    required>
                            </div>
                            <div class="groupe-form">
                                <label>Programme :</label>
                                <input type="text" id="etudiantProgramme" class="controle-form"
                                    placeholder="Ex: 200.B0">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 200px 200px; gap: 15px; margin-bottom: 20px;">
                            <div class="groupe-form">
                                <label>Services adapt√©s :</label>
                                <select id="etudiantSA" class="controle-form">
                                    <option value="">Non</option>
                                    <option value="Oui">Oui</option>
                                </select>
                            </div>
                            <div class="groupe-form">
                                <label>Centre d'aide en fran√ßais :</label>
                                <select id="etudiantCAF" class="controle-form">
                                    <option value="">Non</option>
                                    <option value="Oui">Oui</option>
                                </select>
                            </div>
                        </div>

                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                            üí° Seuls le nom et pr√©nom sont obligatoires - les autres champs seront g√©n√©r√©s
                            automatiquement si laiss√©s vides.
                        </div>

                        <button onclick="addStudent()" class="btn btn-ajouter">+ Ajouter l'√©tudiant¬∑e</button>

                    </div><!--fin carte ajout manuel-->

                    <!-- Bouton pour voir la liste compl√®te -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="allerVersListeEtudiants()" class="btn btn-principal"
                            style="padding: 12px 30px;">
                            üë• Voir la liste compl√®te du groupe
                        </button>
                    </div>

                    <!--d√©but gestion donn√©es √©tudiants-->
                    <div class="btn-groupe mt-3">
                        <button onclick="exportStudentsData()" class="btn btn-principal">
                            üì• Exporter la liste
                        </button>
                        <button onclick="resetStudentsData()" class="btn btn-supprimer">
                            üóëÔ∏è R√©initialiser tout le groupe
                        </button>
                    </div><!--fin gestion des donn√©es √©tudiants-->

                </div><!--fin sous-section reglages-groupe-->

                <!-- Sous-section : Pratique de notation -->
                <div id="reglages-pratique-notation" class="sous-section">
                    <h2>Pratique de notation</h2>
                    <p class="text-muted">Configuration du syst√®me de notation du cours</p>

                    <!-- CONFIGURATION DE LA NOTATION -->
                    <div class="carte">
                        <h3>‚öôÔ∏è Configuration de la notation</h3>

                        <!-- NOTE RREC -->
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 20px; padding: 12px;
             background: var(--bleu-pale); border-radius: 6px; border-left: 3px solid var(--orange-accent);">
                            <strong>Note :</strong> Le R√®glement sur le r√©gime des √©tudes coll√©giales (RREC) exige une
                            note finale chiffr√©e en %.
                            Pendant l'apprentissage, vous pouvez mettre en place une pratique alternative de notation
                            (PAN),
                            mais celle-ci doit √™tre convertie en note chiffr√©e (%) √† la fin du trimestre.
                        </div>

                        <!-- FORMULAIRES C√îTE √Ä C√îTE -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Colonne gauche -->
                            <div class="groupe-form">
                                <label>Pratique de notation</label>
                                <select id="pratiqueNotation" class="controle-form"
                                    onchange="changerPratiqueNotation()">
                                    <option value="">Choisir une pratique de notation</option>
                                    <option value="sommative">Sommative traditionnelle (en %)</option>
                                    <option value="alternative">Alternative (PAN)</option>
                                </select>
                            </div>

                            <!-- Colonne droite -->
                            <div class="groupe-form" id="colonnePAN" style="display: none;">
                                <label>Type de pratique alternative</label>
                                <select id="typePAN" class="controle-form" onchange="afficherInfoPAN()">
                                    <option value="">Choisir un type de PAN...</option>
                                    <option value="maitrise">Notation bas√©e sur la ma√Ætrise</option>
                                    <option value="specifications">Notation par sp√©cifications</option>
                                    <option value="denotation">D√©notation (Ungrading)</option>
                                </select>
                            </div>
                        </div>

                        <!-- INFO PAN -->
                        <div id="infoPAN" style="display: none; margin-top: 15px; padding: 10px; 
             background: white; border-radius: 4px; font-size: 0.85rem; color: #666;">
                        </div>

                        <!-- STATUT + BOUTON GROUP√âS EN BAS -->
                        <div style="margin-top: 30px; padding: 15px; background: var(--bleu-tres-pale); 
                    border-radius: 6px; border-left: 4px solid var(--bleu-moyen);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <!-- Statut √† gauche -->
                                <div>
                                    <strong style="color: var(--bleu-principal);">Statut de configuration :</strong>
                                    <span id="statutModalites" style="margin-left: 10px; font-weight: bold;">
                                        <span style="color: var(--risque-critique);">‚úó √Ä configurer</span>
                                    </span>
                                </div>

                                <!-- Bouton √† droite -->
                                <button class="btn btn-confirmer" onclick="sauvegarderPratiqueNotation()">
                                    üíæ Sauvegarder la configuration
                                </button>
                            </div>
                        </div>

                    </div>
                </div><!--fin sous-section pratique-notation-->

                <!-- Sous-section : Productions -->
                <div id="reglages-productions" class="sous-section">
                    <h2>Productions</h2>
                    <p class="text-muted">D√©finir les √©valuations du cours et leurs pond√©rations</p>

                    <!-- D√âFINITION DES √âVALUATIONS -->
                    <div class="carte">
                        <h3>üìù Productions</h3>

                        <!-- VUE D'ENSEMBLE -->
                        <div class="grille-statistiques" style="margin-bottom: 20px;">
                            <div class="carte-metrique">
                                <strong id="nombreEvaluations">0</strong>
                                <span>Productions</span>
                            </div>
                            <div class="carte-metrique">
                                <strong id="ponderationTotale">0%</strong>
                                <span>Total</span>
                                <small id="statutPonderation" style="display: block; margin-top: 5px;"></small>
                            </div>
                            <div class="carte-metrique" style="grid-column: span 2;">
                                <span id="typesEvaluations" style="font-size: 0.9rem;">
                                    Aucune production configur√©e
                                </span>
                            </div>
                        </div>

                        <!-- TABLEAU/CONTENEUR DES √âVALUATIONS -->
                        <div id="tableauEvaluationsContainer" style="margin-bottom: 20px;">
                            <p class="text-muted" id="aucuneEvaluation" style="font-style: italic;">
                                Aucune √©valuation d√©finie.
                            </p>
                        </div>

                        <!-- FORMULAIRE D'AJOUT/MODIFICATION (cach√© par d√©faut) -->
                        <div id="formulaireProduction" style="display: none; margin-top: 20px; padding: 15px; 
             background: var(--bleu-pale); border-radius: 6px;">

                            <h4 id="titreFormEvaluation" style="color: var(--bleu-principal); margin-bottom: 15px;">
                                Nouvelle production
                            </h4>

                            <!-- Ligne 1 : Tous les champs principaux sur une ligne -->
                            <div
                                style="display: grid; grid-template-columns: 1.5fr 2fr 2fr 1.5fr 100px; gap: 10px; margin-bottom: 15px;">
                                <div class="groupe-form">
                                    <label>Description</label>
                                    <input type="text" id="productionDescription" class="controle-form"
                                        placeholder="Ex: Strat√©gies">
                                </div>
                                <div class="groupe-form">
                                    <label>Titre</label>
                                    <input type="text" id="productionTitre" class="controle-form"
                                        placeholder="Ex: Analyse #1">
                                </div>
                                <div class="groupe-form">
                                    <label>Type</label>
                                    <select id="productionType" class="controle-form"
                                        onchange="gererChangementTypeProduction()">
                                        <option value="">Choisir...</option>
                                        <option value="examen">Examen</option>
                                        <option value="travail">Travail √©crit</option>
                                        <option value="quiz">Quiz/Test</option>
                                        <option value="presentation">Pr√©sentation</option>
                                        <option value="portfolio">üìÅ Portfolio (conteneur d'artefacts)</option>
                                        <option value="artefact-portfolio">Artefact d'un portfolio</option>
                                        <option value="autre">Autre</option>
                                    </select>
                                </div>

                                <small id="msgPonderationArtefact"
                                    style="display: none; padding: 10px; background: var(--bleu-pale); border-radius: 4px; color: var(--bleu-principal); font-size: 0.85rem; margin-top: 10px;">
                                    ‚ÑπÔ∏è Les artefacts individuels n'ont pas de pond√©ration propre. C'est le Portfolio
                                    conteneur qui d√©finit la pond√©ration globale.
                                </small>

                                <div class="groupe-form">
                                    <label>Grille</label>
                                    <select id="productionGrille" class="controle-form">
                                        <option value="">Aucune</option>
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label>Pond. (%)</label>
                                    <input type="number" id="productionPonderation" class="controle-form" min="0"
                                        max="100" step="5" placeholder="20">
                                    <small id="msgPonderationArtefact"
                                        style="display: none; color: #666; font-size: 0.75rem; margin-top: 3px;">
                                        Les artefacts font partie du portfolio (60%)
                                    </small>
                                </div>
                            </div>

                            <!-- Ligne 2 : Objectif et T√¢che -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div class="groupe-form">
                                    <label>Objectif</label>
                                    <textarea id="productionObjectif" class="controle-form" rows="2"
                                        placeholder="Ex: D√©velopper sa capacit√©..."></textarea>
                                </div>
                                <div class="groupe-form">
                                    <label>T√¢che</label>
                                    <textarea id="productionTache" class="controle-form" rows="2"
                                        placeholder="Ex: Appliquer au moins trois strat√©gies de lecture diff√©rentes sur un texte litt√©raire et laisser des traces visibles et organis√©es de cette analyse."></textarea>
                                </div>
                            </div>

                            <!-- CHAMPS SP√âCIFIQUES AU PORTFOLIO (cach√©s par d√©faut) -->
                            <!-- CHAMPS SP√âCIFIQUES AU PORTFOLIO (cach√©s par d√©faut) -->
                            <div id="champsPortfolio" style="display: none; margin-top: 20px; padding: 15px; 
     background: var(--bleu-carte); border-radius: 6px; border: 2px solid var(--bleu-moyen);">

                                <h5 style="color: var(--bleu-principal); margin-bottom: 15px;">‚öôÔ∏è Configuration du
                                    portfolio</h5>

                                <!-- R√®gles du portfolio -->
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div class="groupe-form">
                                        <label>Nombre d'artefacts √† retenir (note finale)</label>
                                        <input type="number" id="portfolioNombreRetenir" class="controle-form" value="3"
                                            min="1" max="20">
                                        <small style="color: #666; font-size: 0.8rem;">Ex: Les 3 meilleurs</small>
                                    </div>
                                    <div class="groupe-form">
                                        <label>Minimum d'artefacts √† compl√©ter (requis)</label>
                                        <input type="number" id="portfolioMinimumCompleter" class="controle-form"
                                            value="7" min="1" max="30">
                                        <small style="color: #666; font-size: 0.8rem;">Ex: 7 obligatoires</small>
                                    </div>
                                    <div class="groupe-form">
                                        <label>Nombre total d'artefacts pr√©vus</label>
                                        <input type="number" id="portfolioNombreTotal" class="controle-form" value="9"
                                            min="1" max="50">
                                        <small style="color: #666; font-size: 0.8rem;">Ex: 9 au programme</small>
                                    </div>
                                </div>

                                <p
                                    style="background: var(--bleu-tres-pale); padding: 10px; border-radius: 4px; font-size: 0.9rem;">
                                    ‚ÑπÔ∏è Le portfolio inclura automatiquement tous les artefacts de type "Artefact d'un
                                    portfolio" cr√©√©s durant la session. Les artefacts non encore cr√©√©s appara√Ætront
                                    comme "√Ä venir".
                                </p>
                            </div>

                            <!-- Boutons du formulaire -->
                            <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                                <button class="btn btn-annuler" onclick="annulerFormProduction()">Annuler</button>
                                <button class="btn btn-confirmer" onclick="sauvegarderProduction()">
                                    <span id="btnTexteEvaluation">Ajouter</span>
                                </button>
                            </div>

                        </div><!-- Fin du formulaireProduction -->

                        <button id="btnajouterProduction" class="btn btn-ajouter mt-2"
                            onclick="afficherFormProduction()">
                            + Ajouter une production
                        </button>

                    </div><!-- Fin de la carte -->

                </div><!--fin sous-section productions-->

                <!-- Sous-section : Grilles de crit√®res -->
                <div id="reglages-grille-criteres" class="sous-section">
                    <h2>Crit√®res d'√©valuation et grilles</h2>
                    <p class="text-muted">Cr√©er des grilles de crit√®res r√©utilisables pour √©valuer diff√©rents
                        types
                        de
                        productions.</p>

                    <!-- CARTE 3 : GRILLES DE CRIT√àRES -->
                    <div class="carte">
                        <h3>üìä Gestion des grilles de crit√®res d'√©valuation</h3>

                        <!-- S√©lecteur d'√©valuation -->
                        <div class="groupe-form" style="max-width: 400px; margin-bottom: 20px;">
                            <label>Cr√©er ou modifier une grille d'√©valuation :</label>
                            <select id="selectGrilleTemplate" class="controle-form" onchange="chargerGrilleTemplate()">
                                <option value="">-- Nouvelle grille --</option>
                                <option value="new">‚ûï Cr√©er une nouvelle grille</option>
                            </select>
                        </div>

                        <!-- Nom de la grille (visible uniquement en cr√©ation/√©dition) -->
                        <div id="nomGrilleContainer" class="groupe-form"
                            style="max-width: 400px; margin-bottom: 20px; display: none;">
                            <label>Nom de la grille :</label>
                            <input type="text" id="nomGrilleTemplate" class="controle-form"
                                placeholder="Ex: Grille analyse litt√©raire" onchange="sauvegarderNomGrille()">
                        </div>

                        <!-- Message si aucune √©valuation s√©lectionn√©e -->
                        <div id="aucuneEvalSelectionnee" style="padding: 20px; background: var(--bleu-tres-pale); 
             border-radius: 6px; text-align: center; color: var(--bleu-leger);">
                            <p>Cr√©ez une nouvelle grille ou s√©lectionnez une grille existante √† modifier</p>
                        </div>

                        <!-- Conteneur des crit√®res (cach√© par d√©faut) -->
                        <div id="criteresContainer" style="display: none;">
                            <!-- Liste des crit√®res existants -->
                            <div id="listeCriteres" style="margin-bottom: 20px;">
                                <!-- Les crit√®res seront affich√©s ici -->
                            </div>

                            <!-- Formulaire d'ajout de crit√®re (cach√© par d√©faut) -->
                            <div id="formAjoutCritere" style="display: none; padding: 15px; background: var(--bleu-pale); 
                 border: 1px solid var(--bleu-leger); border-radius: 6px; margin-bottom: 20px;">

                                <h4 style="color: var(--bleu-principal); margin-bottom: 15px;">Nouveau crit√®re
                                </h4>

                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="groupe-form">
                                        <label>Nom du crit√®re *</label>
                                        <input type="text" id="critereNom" class="controle-form"
                                            placeholder="Ex: Qualit√© de l'argumentation">
                                    </div>
                                    <div class="groupe-form">
                                        <label>Pond√©ration relative (%)</label>
                                        <input type="number" id="criterePonderation" class="controle-form" min="0"
                                            max="100" placeholder="Ex: 25">
                                    </div>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 15px;">
                                    <label>Description</label>
                                    <textarea id="critereDescription" class="controle-form" rows="3"
                                        placeholder="Description d√©taill√©e du crit√®re..."></textarea>
                                </div>

                                <div class="groupe-form" style="margin-bottom: 15px;">
                                    <label>Type de crit√®re</label>
                                    <select id="critereType" class="controle-form" onchange="afficherChampFormule()">
                                        <option value="holistique">Holistique (jugement global)</option>
                                        <option value="analytique">Analytique (points par √©l√©ment)</option>
                                        <option value="algorithmique">Algorithmique (calcul automatique)
                                        </option>
                                    </select>
                                </div>

                                <!-- Champ formule (cach√© par d√©faut) -->
                                <div id="champFormule" class="groupe-form" style="display: none; margin-bottom: 15px;">
                                    <label>Formule de calcul</label>
                                    <input type="text" id="critereFormule" class="controle-form"
                                        placeholder="Ex: (nb_erreurs / nb_mots) * 100">
                                    <small style="color: var(--bleu-leger);">
                                        Pour le fran√ßais √©crit : nombre d'erreurs / nombre de mots
                                    </small>
                                </div>

                                <div class="btn-groupe" style="justify-content: flex-end;">
                                    <button class="btn btn-annuler" onclick="annulerAjoutCritere()">Fermer</button>
                                    <button class="btn btn-principal" onclick="sauvegarderEtFermer()"
                                        style="margin-left: 10px;">
                                        Ajouter et fermer
                                    </button>
                                    <button class="btn btn-confirmer" onclick="sauvegarderCritere()"> <span
                                            id="btnTexteCritere">Ajouter et continuer</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Boutons d'actions -->
                            <div class="btn-groupe" style="justify-content: space-between; margin-bottom: 20px;">
                                <div>
                                    <button id="btnAjouterCritere" class="btn btn-ajouter"
                                        onclick="afficherFormCritere()">
                                        + Ajouter un crit√®re
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-principal" onclick="afficherGrillesCriteres()"
                                        style="margin-right: 10px;">
                                        üìã Voir les grilles existantes
                                    </button>
                                    <button id="btnDupliquerGrille" class="btn btn-modifier"
                                        onclick="dupliquerGrilleActuelle()" style="margin-right: 10px; display: none;">
                                        üìë Dupliquer cette grille
                                    </button>
                                    <button class="btn btn-confirmer" onclick="enregistrerCommeGrille()">
                                        üíæ Sauvegarder cette grille
                                    </button>
                                </div>
                            </div>

                            <!-- Modal pour les mod√®les (cach√© par d√©faut) -->
                            <div id="modalGrilles" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                 background: rgba(0,0,0,0.5); z-index: 1000;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; 
                     max-height: 80vh; overflow-y: auto;">
                                    <h3 style="margin-bottom: 20px; color: var(--bleu-principal);">Grilles de
                                        crit√®res
                                        disponibles</h3>

                                    <div id="listeGrilles" style="margin-bottom: 20px;">
                                        <!-- Les mod√®les seront affich√©s ici -->
                                    </div>

                                    <div class="btn-groupe" style="justify-content: flex-end;">
                                        <button class="btn btn-annuler" onclick="fermerModalGrilles()">Fermer</button>
                                    </div>
                                </div>
                            </div>

                            <!-- R√©sum√© de la pond√©ration -->
                            <div style="margin-top: 20px; padding: 10px; background: var(--bleu-tres-pale); 
                 border-radius: 6px; text-align: right;">
                                <strong>Total des pond√©rations : </strong>
                                <span id="totalPonderationCriteres"
                                    style="font-size: 1.2rem; font-weight: bold;">0%</span>
                                <small id="statutPonderationCriteres" style="display: block; margin-top: 5px;"></small>
                            </div>
                        </div>
                    </div>

                </div><!--fin sous-section grille-criteres-->

                <!-- Sous-section : √âchelle de performance -->
                <div id="reglages-echelle-performance" class="sous-section">
                    <h2>√âchelle de performance</h2>
                    <p class="text-muted">Configuration de l'√©chelle de notation pour les PAN/SBG</p>

                    <!-- CARTE 4 : √âCHELLE DE PERFORMANCE PAN/SBG -->
                    <div class="carte">
                        <h3>üìà √âchelle de performance</h3>

                        <!-- S√©lecteur d'√©chelle -->
                        <div class="groupe-form" style="max-width: 400px; margin-bottom: 20px;">
                            <label>Cr√©er ou modifier une √©chelle de performance :</label>
                            <select id="selectEchelleTemplate" class="controle-form"
                                onchange="chargerEchelleTemplate()">
                                <option value="">-- Nouvelle √©chelle --</option>
                                <option value="new">‚ûï Cr√©er une nouvelle √©chelle</option>
                            </select>
                        </div>

                        <!-- Nom de l'√©chelle (visible uniquement en cr√©ation/√©dition) -->
                        <div id="nomEchelleContainer" class="groupe-form"
                            style="max-width: 400px; margin-bottom: 20px; display: none;">
                            <label>Nom de l'√©chelle :</label>
                            <input type="text" id="nomEchelleTemplate" class="controle-form"
                                placeholder="Ex: √âchelle standard A-F" onchange="sauvegarderNomEchelle()">
                        </div>

                        <!-- Note explicative -->
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 20px; padding: 12px;
             background: var(--bleu-pale); border-radius: 6px; border-left: 3px solid var(--bleu-moyen);">
                            <strong>Note :</strong> Cette √©chelle s'applique uniquement aux pratiques
                            alternatives
                            de
                            notation
                            (PAN).
                            La note finale sera convertie en pourcentage pour respecter le RREC.
                        </div>

                        <!-- CONFIGURATION GLOBALE -->
                        <div
                            style="background: var(--bleu-tres-pale); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="color: var(--bleu-principal); margin-bottom: 15px;">Configuration globale</h4>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="groupe-form">
                                    <label>Type d'√©chelle</label>
                                    <select id="typeEchelle" class="controle-form" onchange="changerTypeEchelle()">
                                        <option value="lettres">Lettres (A, B, C...)</option>
                                        <option value="pourcentage">Pourcentage (%)</option>
                                    </select>
                                </div>
                                <div class="groupe-form">
                                    <label>Seuil de r√©ussite (%)</label>
                                    <input type="number" id="seuilReussite" class="controle-form" value="60" min="0"
                                        max="100">
                                </div>
                            </div>
                        </div>

                        <!-- TABLEAU DES NIVEAUX -->
                        <div
                            style="background: white; border: 1px solid var(--bleu-leger); border-radius: 6px; padding: 15px;">
                            <h4 style="color: var(--bleu-principal); margin-bottom: 15px;">Niveaux de
                                performance
                            </h4>

                            <div id="tableauNiveaux">
                                <!-- Les niveaux seront g√©n√©r√©s ici -->
                            </div>

                            <!-- Boutons d'actions -->
                            <div class="btn-groupe mt-3" style="justify-content: space-between;">
                                <div>
                                    <button class="btn btn-principal" onclick="reinitialiserNiveauxDefaut()">
                                        üîÑ R√©initialiser aux valeurs par d√©faut
                                    </button>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-principal" onclick="afficherEchellesPerformance()">
                                        üìã Voir les √©chelles existantes
                                    </button>
                                    <button id="btnDupliquerEchelle" class="btn btn-modifier"
                                        onclick="dupliquerEchelleActuelle()">
                                        üìë Dupliquer cette √©chelle
                                    </button>
                                    <button class="btn btn-confirmer" onclick="enregistrerCommeEchelle()">
                                        üíæ Sauvegarder cette √©chelle
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal pour les √©chelles (cach√© par d√©faut) -->
                        <div id="modalEchelles" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
             background: rgba(0,0,0,0.5); z-index: 1000;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                 background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; 
                 max-height: 80vh; overflow-y: auto;">
                                <h3 style="margin-bottom: 20px; color: var(--bleu-principal);">√âchelles de
                                    performance
                                    disponibles</h3>

                                <div id="listeEchelles" style="margin-bottom: 20px;">
                                    <!-- Les √©chelles seront affich√©es ici -->
                                </div>

                                <div class="btn-groupe" style="justify-content: flex-end;">
                                    <button class="btn btn-annuler" onclick="fermerModalEchelles()">Fermer</button>
                                </div>
                            </div>
                        </div>

                        <!-- Visualisation de l'√©chelle -->
                        <div style="margin-top: 20px; padding: 15px; background: var(--vert-pale); 
             border-radius: 6px; border: 1px solid var(--vert-leger);">
                            <h5 style="color: var(--vert-leger); margin-bottom: 10px;">Aper√ßu de l'√©chelle</h5>
                            <div id="apercuEchelle" style="display: flex; justify-content: space-between; 
                 align-items: center; padding: 10px; background: white; border-radius: 4px;">
                                <!-- L'aper√ßu sera g√©n√©r√© ici -->
                            </div>
                        </div>
                    </div>

                </div><!--fin sous-section echelle-performance-->

                <!-- Sous-section : R√©troactions -->
                <div id="reglages-retroactions" class="sous-section">
                    <h2>Cartouches de r√©troactions</h2>
                    <p class="text-muted">Cr√©er des cartouches de r√©troaction bas√©es sur les crit√®res et
                        l'√©chelle
                        de
                        performance
                    </p>

                    <!-- CARTE : CARTOUCHES DE R√âTROACTION -->
                    <div class="carte">
                        <h3>üí¨ Les commentaires peuvent avoir entre 50 et 75 mots environ.
                        </h3>

                        <!-- Note explicative -->
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 20px; padding: 12px;
             background: var(--bleu-pale); border-radius: 6px; border-left: 3px solid var(--bleu-moyen);">
                            <strong>Note :</strong> Les r√©troactions seront g√©n√©r√©es automatiquement en assemblant
                            les
                            commentaires
                            pr√©r√©dig√©s par l'enseignant¬∑e
                            selon les crit√®res d'√©valuation et le niveau de performance atteint pour chaque
                            crit√®re.
                            Un ensemble complet de commentaires porte ici le nom de cartouche.
                        </div>

                        <!-- S√©lecteur de grille et cartouche -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="groupe-form">
                                <label>Grille de crit√®res :</label>
                                <select id="selectGrilleRetroaction" class="controle-form"
                                    onchange="chargerCartouchesRetroaction()">
                                    <option value="">-- Choisir une grille --</option>
                                </select>
                            </div>
                            <div class="groupe-form">
                                <label>Cartouche :</label>
                                <select id="selectCartouche" class="controle-form"
                                    onchange="chargerMatriceRetroaction()">
                                    <option value="">-- Nouvelle cartouche --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Informations de la cartouche -->
                        <div id="infoCartouche" style="display: none; margin-bottom: 20px;">
                            <div class="groupe-form" style="max-width: 500px;">
                                <label>Nom de la cartouche :</label>
                                <input type="text" id="nomCartouche" class="controle-form"
                                    placeholder="Ex: Description de personnage">
                            </div>

                            <div class="groupe-form" style="margin-top: 15px;">
                                <label>Contexte de la r√©troaction (optionnel) :</label>
                                <textarea id="contexteCartouche" class="controle-form" rows="3"
                                    placeholder="Ex: Cette production porte sur l'analyse d'un texte argumentatif..."></textarea>
                                <small style="color: #666; font-size: 0.85rem;">Ce texte appara√Ætra au d√©but de la
                                    r√©troaction si l'option est coch√©e.</small>
                            </div>

                            <!-- Liste des cartouches existantes -->
                            <div id="listeCartouchesExistants" style="display: none; margin-bottom: 20px;">
                                <h4 style="color: var(--bleu-principal); margin-bottom: 15px;">Cartouches
                                    enregistr√©es
                                </h4>
                                <div id="listeCartouchesContainer">
                                    <!-- Les cartouches seront affich√©es ici -->
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; 
                 margin-top: 15px; padding: 15px; background: var(--bleu-tres-pale); border-radius: 6px;">
                                <div class="carte-metrique">
                                    <strong id="nbCriteres">0</strong>
                                    <span>Crit√®res</span>
                                </div>
                                <div class="carte-metrique">
                                    <strong id="nbNiveaux">0</strong>
                                    <span>Niveaux</span>
                                </div>
                                <div class="carte-metrique">
                                    <strong id="nbCommentaires">0</strong>
                                    <span>Commentaires √† r√©diger</span>
                                </div>
                                <div class="carte-metrique">
                                    <strong id="pctComplete">0%</strong>
                                    <span>Compl√©t√©</span>
                                </div>
                            </div>
                        </div>

                        <!-- Message si aucune √©valuation s√©lectionn√©e -->
                        <div id="aucuneEvalRetroaction" style="padding: 20px; background: var(--bleu-tres-pale); 
             border-radius: 6px; text-align: center; color: var(--bleu-leger);">
                            <p>S√©lectionnez une grille de crit√®res pour cr√©er ou modifier une cartouche de
                                r√©troaction
                            </p>
                        </div>

                        <!-- IMPORTATION DES COMMENTAIRES -->
                        <div id="zoneImportCommentaires" style="display: none; margin-bottom: 20px;">
                            <div class="carte"
                                style="background: var(--vert-pale); border-left: 3px solid var(--vert-leger);">
                                <h4 style="color: var(--bleu-principal); margin-bottom: 15px;">
                                    üìã Importation rapide des commentaires
                                </h4>

                                <div class="groupe-form">
                                    <label>Collez vos commentaires ici (format Markdown) :</label>
                                    <textarea id="commentairesColles" class="controle-form" rows="12"
                                        placeholder="## STRUCTURE&#10;&#10;**STRUCTURE (I)** : Commentaire incomplet...&#10;&#10;**STRUCTURE (D)** : Commentaire en d√©veloppement...&#10;&#10;**STRUCTURE (M)** : Commentaire ma√Ætris√©...&#10;&#10;**STRUCTURE (E)** : Commentaire √©tendu..."
                                        style="font-family: monospace; font-size: 0.85rem;"></textarea>
                                </div>

                                <div class="btn-groupe">
                                    <button onclick="annulerImportCommentaires()" class="btn btn-annuler">
                                        Annuler
                                    </button>
                                    <button onclick="importerCommentaires()" class="btn btn-confirmer">
                                        üì• Importer les commentaires
                                    </button>
                                </div>

                                <div
                                    style="background: white; padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 0.85rem;">
                                    <strong>Format attendu :</strong>
                                    <pre style="margin-top: 8px; color: #666;">## NOM_DU_CRIT√àRE

**NOM_DU_CRIT√àRE (I)** : Texte du commentaire...

**NOM_DU_CRIT√àRE (D)** : Texte du commentaire...

**NOM_DU_CRIT√àRE (M)** : Texte du commentaire...

**NOM_DU_CRIT√àRE (E)** : Texte du commentaire...</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="btn-groupe">
                            <button class="btn btn-principal" onclick="afficherImportCommentaires()"
                                style="margin-right: auto;">
                                üìã Importer des commentaires
                            </button>
                        </div>

                        <!-- Matrice de r√©troaction (cach√©e par d√©faut) -->
                        <div id="matriceRetroaction" style="display: none;">
                            <h4 style="color: var(--bleu-principal); margin-bottom: 15px;">
                                Matrice des commentaires de r√©troaction
                            </h4>

                            <div id="matriceContainer" style="overflow-x: auto;">
                                <!-- La matrice sera g√©n√©r√©e dynamiquement ici -->
                            </div>

                            <!-- Boutons d'action -->

                            <div>
                                <button class="btn btn-confirmer" onclick="sauvegarderCartouche()">
                                    üíæ Sauvegarder la cartouche
                                </button>
                                <button class="btn btn-supprimer" onclick="supprimerCartouche()"
                                    style="margin-left: 10px;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>

                        <!-- Aper√ßu de r√©troaction -->
                        <div id="apercuRetroaction" style="display: none; margin-top: 20px; padding: 15px; 
             background: var(--vert-pale); border-radius: 6px;">
                            <h5 style="color: var(--vert-leger); margin-bottom: 10px;">
                                Aper√ßu d'une r√©troaction g√©n√©r√©e
                            </h5>
                            <div id="exempleRetroaction" style="padding: 15px; background: white; 
                 border-radius: 4px; font-size: 0.9rem; line-height: 1.6;">
                                <!-- L'aper√ßu sera g√©n√©r√© ici -->
                            </div>
                            <button class="btn btn-principal mt-2" onclick="genererApercuAleatoire()">
                                üé≤ G√©n√©rer un aper√ßu al√©atoire
                            </button>
                        </div>
                    </div>

                </div><!--fin sous-section retroactions-->

            </div><!--fin section-reglages-->

            <!-- D√âBUT MODALS -->
            <!-- Modal Export -->
            <div id="modalExport" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
     background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                <div
                    style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 90%;">
                    <h3 style="color: var(--bleu-principal); margin-bottom: 20px;">Exporter les donn√©es</h3>

                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: flex; align-items: center; padding: 10px; background: var(--bleu-pale); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="checkToutesLes" onchange="toggleToutesLesCles()"
                                style="margin-right: 10px; transform: scale(1.3);">
                            <strong>Toutes les cl√©s</strong>
                        </label>
                    </div>

                    <div id="listeClesExport"
                        style="max-height: 300px; overflow-y: auto; border: 1px solid var(--bleu-pale); border-radius: 6px; padding: 10px;">
                        <!-- Rempli dynamiquement -->
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-annuler" onclick="fermerModalExport()">Annuler</button>
                        <button class="btn btn-confirmer" onclick="executerExport()">üì§ Exporter</button>
                    </div>
                </div>
            </div>

            <!-- Modal Import -->
            <div id="modalImport" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
     background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%;">
                    <h3 style="color: var(--bleu-principal); margin-bottom: 20px;">Importer les donn√©es</h3>

                    <div
                        style="margin-bottom: 20px; padding: 20px; background: var(--bleu-tres-pale); border-radius: 6px; border-left: 4px solid var(--orange-accent);">
                        <p style="margin: 0; color: var(--bleu-principal);">
                            <strong>‚ö†Ô∏è Attention :</strong> L'importation √©crasera les donn√©es existantes pour les
                            cl√©s
                            import√©es.
                        </p>
                    </div>

                    <input type="file" id="fichierImport" accept=".json"
                        style="margin-bottom: 20px; padding: 10px; width: 100%; border: 2px dashed var(--bleu-leger); border-radius: 6px; cursor: pointer;">

                    <div id="apercu-import"
                        style="display: none; margin-bottom: 20px; padding: 15px; background: var(--vert-pale); border-radius: 6px; border-left: 4px solid var(--vert-leger);">
                        <!-- Rempli apr√®s s√©lection du fichier -->
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-annuler" onclick="fermerModalImport()">Annuler</button>
                        <button class="btn btn-confirmer" id="btnExecuterImport" onclick="executerImport()" disabled
                            style="opacity: 0.5;">üì• Importer</button>
                    </div>
                </div>
            </div>
            <!--- FIN MODALS -->
        </main>
    </div>




    <!-- ==========================================
         JAVASCRIPT
         ========================================== -->
    <script>
        /* ===============================
           SYST√àME DE NAVIGATION - V3.0
           100% fran√ßais, propre et organis√©
           =============================== */

        // Configuration des sous-menus pour chaque section
        const configurationsOnglets = {
            'tableau-bord': [
                { id: 'apercu-groupe', label: 'Aper√ßu global' },
                { id: 'liste-groupe', label: 'Suivi du groupe' },
                { id: 'detail-individuel', label: 'Suivi individuel' },
                { id: 'tendances-patterns', label: 'Tendances et patterns' }
            ],
            'etudiants': [
                { id: 'apercu', label: 'Aper√ßu' },
                { id: 'liste', label: 'Liste des individus' },
                { id: 'profil', label: 'Profil' }
            ],
            'presences': [
                { id: 'apercu', label: 'Aper√ßu' },
                { id: 'calendrier', label: 'Vue calendaire' },
                { id: 'saisie', label: 'Saisie' }
            ],
            'evaluations': [
                { id: 'apercu', label: 'Aper√ßu' },
                { id: 'individuelles', label: '√âvaluations et r√©troactions individuelles' }
            ],
            'reglages': [
                { id: 'apercu', label: 'Aper√ßu' },
                { id: 'cours', label: 'Cours' },
                { id: 'calendrier', label: 'Calendrier' },
                { id: 'horaire', label: 'Horaire' },
                { id: 'groupe', label: 'Groupe' },
                { id: 'pratique-notation', label: 'Pratique de notation' },
                { id: 'productions', label: 'Productions' },
                { id: 'grille-criteres', label: 'Grilles de crit√®res' },
                { id: 'echelle-performance', label: '√âchelle de performance' },
                { id: 'retroactions', label: 'R√©troactions' }
            ]
        };

        // ====== FONCTION DE S√âCURIT√â AJOUT√âE ======
        function echapperHtml(texte) {
            if (!texte) return '';
            const div = document.createElement('div');
            div.textContent = texte;
            return div.innerHTML;
        }

        // Variables globales pour le suivi de l'√©tat
        let sectionActive = 'tableau-bord';
        let sousSectionActive = null;

        /**
         * Affiche une section principale
         * @param {string} nomSection - L'identifiant de la section
         */
        function afficherSection(nomSection) {
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // D√©sactiver tous les boutons de navigation
            document.querySelectorAll('.navigation-principale button').forEach(bouton => {
                bouton.classList.remove('actif');
            });

            // Afficher la section demand√©e
            const sectionCible = document.getElementById(`section-${nomSection}`);
            if (sectionCible) {
                sectionCible.classList.add('active');
                sectionActive = nomSection;
            }

            // Activer le bouton correspondant
            const boutonActif = document.querySelector(`button[data-onglet="${nomSection}"]`);
            if (boutonActif) {
                boutonActif.classList.add('actif');
            }

            // Afficher la sous-navigation appropri√©e
            afficherSousNavigation(nomSection);
        }

        /**
         * Affiche la sous-navigation pour une section
         * @param {string} nomOnglet - L'identifiant de la section parent
         */
        /**
 * Affiche la sous-navigation pour une section
 * @param {string} nomOnglet - L'identifiant de la section parent
 */
        function afficherSousNavigation(nomOnglet) {
            const conteneurSousNav = document.getElementById('sous-navigation');
            const configuration = configurationsOnglets[nomOnglet];

            if (!configuration || configuration.length === 0) {
                // Pas de sous-navigation pour cette section
                conteneurSousNav.innerHTML = '<div class="vide">Pas de sous-sections pour cette page</div>';
                conteneurSousNav.className = 'sous-navigation vide';
                sousSectionActive = null;
            } else {
                // Cr√©er les boutons de sous-navigation
                const boutonsHtml = configuration.map((item, index) => {
                    const classeActive = index === 0 ? ' class="actif"' : '';
                    return `<button data-sous-onglet="${nomOnglet}-${item.id}"${classeActive}>${item.label}</button>`;
                }).join('');

                conteneurSousNav.innerHTML = boutonsHtml;
                conteneurSousNav.className = 'sous-navigation';

                // Ajouter les √©v√©nements aux sous-boutons
                conteneurSousNav.querySelectorAll('button').forEach(bouton => {
                    bouton.addEventListener('click', function () {
                        const idSousOnglet = this.getAttribute('data-sous-onglet');
                        afficherSousSection(idSousOnglet);

                        // Mettre √† jour l'√©tat actif
                        conteneurSousNav.querySelectorAll('button').forEach(b => {
                            b.classList.remove('actif');
                        });
                        this.classList.add('actif');
                    });
                });

                // Afficher la premi√®re sous-section par d√©faut
                if (configuration.length > 0) {
                    const premiereSousSection = `${nomOnglet}-${configuration[0].id}`;
                    afficherSousSection(premiereSousSection);
                }
            }
        }  // ‚Üê CETTE ACCOLADE DE FERMETURE EST ESSENTIELLE !

        /**
     * Affiche une sous-section sp√©cifique et met √† jour les boutons
     * @param {string} idSousSection - L'identifiant complet de la sous-section (ex: 'presences-saisie')
     */

        function afficherSousSection(idSousSection) {
            console.log('üîµ afficherSousSection appel√©e avec:', idSousSection);

            // Extraire la section parente (ex: 'presences-saisie' ‚Üí 'presences')
            const section = idSousSection.split('-')[0];

            console.log('   Section:', section);

            // Masquer toutes les sous-sections de cette section
            document.querySelectorAll(`#section-${section} .sous-section`).forEach(ss => {
                ss.classList.remove('active');
            });

            // Afficher la sous-section demand√©e
            const sousSection = document.getElementById(idSousSection);
            if (sousSection) {
                sousSection.classList.add('active');
                sousSectionActive = idSousSection;
                console.log('   ‚úÖ Sous-section affich√©e');
            } else {
                console.error('   ‚ùå Sous-section introuvable:', idSousSection);
            }

            // Mettre √† jour les boutons de sous-navigation
            // IMPORTANT: Comparer avec l'ID COMPLET, pas l'ID court
            const boutons = document.querySelectorAll('.sous-navigation button');
            console.log('   Nombre de boutons trouv√©s:', boutons.length);

            let boutonTrouve = false;
            boutons.forEach(btn => {
                const dataSousOnglet = btn.getAttribute('data-sous-onglet');

                btn.classList.remove('actif');

                // Comparer avec l'ID COMPLET
                if (dataSousOnglet === idSousSection) {
                    btn.classList.add('actif');
                    boutonTrouve = true;
                    console.log('   ‚úÖ Bouton activ√©:', dataSousOnglet);
                }
            });

            if (!boutonTrouve) {
                console.warn('   ‚ö†Ô∏è Aucun bouton correspondant trouv√© pour:', idSousSection);
            }

            // Charger les √©v√©nements quand on affiche le calendrier
            if (idSousSection === 'reglages-calendrier') {
                setTimeout(() => {
                    console.log('üìÖ Chargement des √©v√©nements du calendrier...');
                    chargerCadreCalendrier();
                    chargerEvenementsPrevus();
                    chargerEvenementsImprevus();
                }, 100);
            }
            // Charger automatiquement les donn√©es selon la sous-section
            if (idSousSection === 'etudiants-liste') {
                afficherListeEtudiants();
            }

            if (idSousSection === 'reglages-productions') {
                afficherTableauProductions();
            }

            if (idSousSection === 'reglages-echelle-performance') {
                chargerEchellesTemplates();
                initialiserEchelle();
            }
        }

        /**
         * Affiche le d√©tail d'un √©tudiant sp√©cifique
         * @param {number} id - L'identifiant de l'√©tudiant
         */
        function afficherDetailEtudiant(id) {
            // Naviguer vers le tableau de suivi
            afficherSection('tableau-bord');

            // Apr√®s un court d√©lai, activer la sous-section d√©tail
            setTimeout(() => {
                const boutonDetail = document.querySelector('[data-sous-onglet="tableau-bord-detail-individuel"]');
                if (boutonDetail) {
                    boutonDetail.click();
                }

                // S√©lectionner l'√©tudiant dans le dropdown
                const selectEtudiant = document.getElementById('select-etudiant');
                if (selectEtudiant) {
                    selectEtudiant.value = id;
                    // D√©clencher l'√©v√©nement change pour charger les donn√©es
                    selectEtudiant.dispatchEvent(new Event('change'));
                }
            }, 100);
        }

        /**
         * Mettre √† jour l'horodatage de sauvegarde
         */
        function mettreAJourHorodatage() {
            const maintenant = new Date();
            const horodatage = maintenant.toLocaleDateString('fr-CA') + ' ' +
                maintenant.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const elementHorodatage = document.getElementById('horodatage-sauvegarde');
            if (elementHorodatage) {
                elementHorodatage.textContent = horodatage;
            }
        }

        // === GESTION DES √âV√âNEMENTS PR√âVUS ===

        function afficherFormulaireAjoutPrevu() {
            document.getElementById('formAjoutPrevu').style.display = 'block';
            document.getElementById('btnAjouterPrevu').style.display = 'none';
        }

        function annulerAjoutPrevu() {
            document.getElementById('formAjoutPrevu').style.display = 'none';
            document.getElementById('btnAjouterPrevu').style.display = 'inline-block';
            // R√©initialiser les champs
            document.getElementById('nouvelleDatePrevu').value = '';
            document.getElementById('nouvelleDescriptionPrevu').selectedIndex = 0;
            document.getElementById('nouvelHoraireReprisePrevu').selectedIndex = 0;
            document.getElementById('nouvelleDateReprisePrevu').value = '';
        }

        function confirmerAjoutPrevu() {
            // R√©cup√©rer les valeurs
            const dateEvenement = document.getElementById('nouvelleDatePrevu').value;
            const description = document.getElementById('nouvelleDescriptionPrevu').value;
            const horaireReprise = document.getElementById('nouvelHoraireReprisePrevu').value;
            const dateReprise = document.getElementById('nouvelleDateReprisePrevu').value;

            if (!dateEvenement || description === 'Choisir...') {
                alert('Veuillez remplir au minimum la date et la description');
                return;
            }

            // Cr√©er l'objet √©v√©nement
            const evenement = {
                id: Date.now(),
                dateEvenement,
                description,
                horaireReprise: horaireReprise === 'Choisir...' ? '' : horaireReprise,
                dateReprise: dateReprise || '',
                verrouille: true
            };

            // Sauvegarder dans localStorage
            let evenementsPrevus = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            evenementsPrevus.push(evenement);
            localStorage.setItem('evenementsPrevus', JSON.stringify(evenementsPrevus));

            // Fermer le formulaire
            annulerAjoutPrevu();

            // Recharger l'affichage
            chargerEvenementsPrevus();
        }

        function chargerEvenementsPrevus() {
            const container = document.getElementById('congesPrevusContainer');
            const evenements = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');

            if (evenements.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucun √©v√©nement pr√©vu d√©clar√©.</p>';
                return;
            }

            container.innerHTML = evenements.map(evt => {
                // Si en mode √©dition
                if (evt.modeEdition) {
                    return `
                <div style="padding: 15px; background: var(--vert-pale); border: 1px solid var(--vert-leger); border-radius: 6px; margin-bottom: 20px;">
                    <strong style="color: var(--vert-leger);">Modifier l'√©v√©nement</strong>
                    
                    <div style="display: grid; grid-template-columns: 1fr 2fr 1.5fr 1fr; gap: 10px; margin-top: 15px; align-items: end;">
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Date √©v√©nement</label>
                            <input type="date" class="controle-form" id="editDatePrevu-${evt.id}" value="${evt.dateEvenement}">
                        </div>
                        <div class="groupe-form">
                            <label>Description :</label>
                            <select class="controle-form" id="editDescriptionPrevu-${evt.id}">
                                <option ${evt.description === 'Choisir...' ? 'selected' : ''}>Choisir...</option>
                                <option ${evt.description === 'F√™te du travail (f√©ri√©)' ? 'selected' : ''}>F√™te du travail (f√©ri√©)</option>
                                <option ${evt.description === 'Action de gr√¢ce (f√©ri√©)' ? 'selected' : ''}>Action de gr√¢ce (f√©ri√©)</option>
                                <option ${evt.description === 'Journ√©e carri√®re' ? 'selected' : ''}>Journ√©e carri√®re</option>
                                <option ${evt.description === 'Vendredi saint (f√©ri√©)' ? 'selected' : ''}>Vendredi saint (f√©ri√©)</option>
                                <option ${evt.description === 'Lundi de P√¢ques (f√©ri√©)' ? 'selected' : ''}>Lundi de P√¢ques (f√©ri√©)</option>
                                <option ${evt.description === 'F√™te de la Saint-Patrick (f√©ri√©)' ? 'selected' : ''}>F√™te de la Saint-Patrick (f√©ri√©)</option>
                            </select>
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Reprise pr√©vue</label>
                            <select class="controle-form" id="editHoraireReprisePrevu-${evt.id}">
                                <option ${evt.horaireReprise === '' ? 'selected' : ''}>Choisir...</option>
                                <option ${evt.horaireReprise === 'Horaire du lundi' ? 'selected' : ''}>Horaire du lundi</option>
                                <option ${evt.horaireReprise === 'Horaire du mardi' ? 'selected' : ''}>Horaire du mardi</option>
                                <option ${evt.horaireReprise === 'Horaire du mercredi' ? 'selected' : ''}>Horaire du mercredi</option>
                                <option ${evt.horaireReprise === 'Horaire du jeudi' ? 'selected' : ''}>Horaire du jeudi</option>
                                <option ${evt.horaireReprise === 'Horaire du vendredi' ? 'selected' : ''}>Horaire du vendredi</option>
                            </select>
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Date reprise</label>
                            <input type="date" class="controle-form" id="editDateReprisePrevu-${evt.id}" value="${evt.dateReprise}">
                        </div>
                    </div>
                    
                    <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                        <button class="btn btn-annuler" onclick="annulerModificationPrevu(${evt.id})">Annuler</button>
                        <button class="btn btn-confirmer" onclick="sauvegarderModificationPrevu(${evt.id})">Sauvegarder</button>
                    </div>
                </div>
            `;
                }

                // Mode affichage normal
                return `
            <div style="padding: 12px; background: var(--bleu-tres-pale); border: 1px solid var(--bleu-leger); border-radius: 6px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: var(--bleu-principal);">${evt.description}</strong>
                    <div>
                        <label style="font-size: 0.85rem; margin-right: 10px;">
                            <input type="checkbox" id="unlock-${evt.id}" onchange="basculerVerrouillage(${evt.id}, 'prevu')" ${evt.verrouille ? 'checked' : ''}>
                            üîí
                        </label>
                        <button class="btn btn-modifier" onclick="modifierEvenementPrevu(${evt.id})" 
                            style="padding: 5px 12px; font-size: 0.85rem; opacity: ${evt.verrouille ? '0.5' : '1'};">Modifier</button>
                        <button class="btn btn-supprimer" onclick="supprimerEvenementPrevu(${evt.id})" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px; opacity: ${evt.verrouille ? '0.5' : '1'};">Supprimer</button>
                    </div>
                </div>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Date √©v√©nement</label>
                        <input type="date" value="${evt.dateEvenement}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Description</label>
                        <input type="text" value="${evt.description}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Horaire reprise</label>
                        <input type="text" value="${evt.horaireReprise}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Date reprise</label>
                        <input type="date" value="${evt.dateReprise}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

        function basculerVerrouillage(id, type) {
            const storageKey = type === 'prevu' ? 'evenementsPrevus' : 'evenementsImprevus';
            let evenements = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const index = evenements.findIndex(evt => evt.id === id);

            if (index !== -1) {
                evenements[index].verrouille = document.getElementById(`unlock-${id}`).checked;
                localStorage.setItem(storageKey, JSON.stringify(evenements));

                if (type === 'prevu') {
                    chargerEvenementsPrevus();
                } else {
                    chargerEvenementsImprevus();
                }
            }
        }

        function modifierEvenementPrevu(id) {
            let evenements = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            const evt = evenements.find(e => e.id === id);

            if (evt && evt.verrouille) {
                alert('D√©cochez "üîí" avant de modifier');
                return;
            }

            evenements = evenements.map(e => {
                if (e.id === id) {
                    return { ...e, modeEdition: true };
                }
                return e;
            });

            localStorage.setItem('evenementsPrevus', JSON.stringify(evenements));
            chargerEvenementsPrevus();
        }

        function annulerModificationPrevu(id) {
            let evenements = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            evenements = evenements.map(e => {
                if (e.id === id) {
                    return { ...e, modeEdition: false, verrouille: true };
                }
                return e;
            });

            localStorage.setItem('evenementsPrevus', JSON.stringify(evenements));
            chargerEvenementsPrevus();
        }

        function sauvegarderModificationPrevu(id) {
            const dateEvenement = document.getElementById(`editDatePrevu-${id}`).value;
            const description = document.getElementById(`editDescriptionPrevu-${id}`).value;
            const horaireReprise = document.getElementById(`editHoraireReprisePrevu-${id}`).value;
            const dateReprise = document.getElementById(`editDateReprisePrevu-${id}`).value;

            if (!dateEvenement || description === 'Choisir...') {
                alert('Veuillez remplir au minimum la date et la description');
                return;
            }

            let evenements = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            evenements = evenements.map(e => {
                if (e.id === id) {
                    return {
                        ...e,
                        dateEvenement,
                        description,
                        horaireReprise: horaireReprise === 'Choisir...' ? '' : horaireReprise,
                        dateReprise,
                        modeEdition: false,
                        verrouille: true
                    };
                }
                return e;
            });

            localStorage.setItem('evenementsPrevus', JSON.stringify(evenements));
            chargerEvenementsPrevus();
        }

        function supprimerEvenementPrevu(id) {
            let evenements = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            const evt = evenements.find(e => e.id === id);

            if (evt && evt.verrouille) {
                alert('D√©cochez "üîí" avant de supprimer');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) {
                evenements = evenements.filter(e => e.id !== id);
                localStorage.setItem('evenementsPrevus', JSON.stringify(evenements));
                chargerEvenementsPrevus();
            }
        }

        // === GESTION DES √âV√âNEMENTS IMPR√âVUS ===

        function afficherFormulaireAjoutEvenementImprevu() {
            document.getElementById('formAjoutEvenementImprevu').style.display = 'block';
            document.getElementById('btnAjouterEvenementImprevu').style.display = 'none';
        }

        function annulerAjoutEvenementImprevu() {
            document.getElementById('formAjoutEvenementImprevu').style.display = 'none';
            document.getElementById('btnAjouterEvenementImprevu').style.display = 'inline-block';
            // R√©initialiser les champs
            document.getElementById('nouvelleDateImprevu').value = '';
            document.getElementById('nouvelleDescriptionImprevu').selectedIndex = 0;
            document.getElementById('nouvelHoraireRepriseImprevu').selectedIndex = 0;
            document.getElementById('nouvelleDateRepriseImprevu').value = '';
        }

        function confirmerAjoutEvenementImprevu() {
            const dateEvenement = document.getElementById('nouvelleDateImprevu').value;
            const description = document.getElementById('nouvelleDescriptionImprevu').value;
            const horaireReprise = document.getElementById('nouvelHoraireRepriseImprevu').value;
            const dateReprise = document.getElementById('nouvelleDateRepriseImprevu').value;

            if (!dateEvenement || description === 'Choisir...') {
                alert('Veuillez remplir au minimum la date et la description');
                return;
            }

            const evenement = {
                id: Date.now(),
                dateEvenement,
                description,
                horaireReprise: horaireReprise === 'Choisir...' ? '' : horaireReprise,
                dateReprise: dateReprise || '',
                verrouille: true
            };

            let evenementsImprevus = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');
            evenementsImprevus.push(evenement);
            localStorage.setItem('evenementsImprevus', JSON.stringify(evenementsImprevus));

            annulerAjoutEvenementImprevu();
            chargerEvenementsImprevus();
        }

        function chargerEvenementsImprevus() {
            const container = document.getElementById('evenementsImprevusContainer');
            const evenements = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');

            if (evenements.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucun √©v√©nement impr√©vu d√©clar√©.</p>';
                return;
            }

            container.innerHTML = evenements.map(evt => {
                // Si en mode √©dition
                if (evt.modeEdition) {
                    return `
                <div style="padding: 15px; background: #fff4e6; border: 2px solid var(--orange-accent); border-radius: 6px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="color: var(--orange-accent); font-weight: bold; margin-right: 10px;">‚ö†</span>
                        <strong style="color: var(--orange-accent);">Modifier l'√©v√©nement impr√©vu</strong>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr 1.5fr 1fr; gap: 10px; align-items: end;">
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Date √©v√©nement</label>
                            <input type="date" class="controle-form" id="editDateImprevu-${evt.id}" value="${evt.dateEvenement}">
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Description</label>
                            <select class="controle-form" id="editDescriptionImprevu-${evt.id}">
                                <option ${evt.description === 'Choisir...' ? 'selected' : ''}>Choisir...</option>
                                <option ${evt.description === 'Maladie' ? 'selected' : ''}>Maladie</option>
                                <option ${evt.description === 'M√©t√©o' ? 'selected' : ''}>M√©t√©o</option>
                                <option ${evt.description === 'Urgence' ? 'selected' : ''}>Urgence</option>
                                <option ${evt.description === 'Autre' ? 'selected' : ''}>Autre</option>
                            </select>
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Reprise (optionnelle)</label>
                            <select class="controle-form" id="editHoraireRepriseImprevu-${evt.id}">
                                <option ${evt.horaireReprise === '' ? 'selected' : ''}>Choisir...</option>
                                <option ${evt.horaireReprise === 'Le cours n\'est pas repris' ? 'selected' : ''}>Le cours n'est pas repris</option>
                                <option ${evt.horaireReprise === 'Le cours est repris' ? 'selected' : ''}>Le cours est repris</option>
                            </select>
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Date reprise</label>
                            <input type="date" class="controle-form" id="editDateRepriseImprevu-${evt.id}" value="${evt.dateReprise}">
                        </div>
                    </div>
                    
                    <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                        <button class="btn btn-annuler" onclick="annulerModificationImprevu(${evt.id})">Annuler</button>
                        <button class="btn btn-confirmer" onclick="sauvegarderModificationImprevu(${evt.id})">Sauvegarder</button>
                    </div>
                </div>
            `;
                }

                // Mode affichage normal
                return `
            <div style="padding: 12px; background: #fff8f0; border: 1px solid var(--orange-accent); border-radius: 6px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: var(--orange-accent);">‚ö† ${evt.description}</strong>
                    <div>
                        <label style="font-size: 0.85rem; margin-right: 10px;">
                            <input type="checkbox" id="unlock-${evt.id}" onchange="basculerVerrouillage(${evt.id}, 'imprevu')" ${evt.verrouille ? 'checked' : ''}>
                            üîí
                        </label>
                        <button class="btn btn-modifier" onclick="modifierEvenementImprevu(${evt.id})" 
                            style="padding: 5px 12px; font-size: 0.85rem; opacity: ${evt.verrouille ? '0.5' : '1'};">Modifier</button>
                        <button class="btn btn-supprimer" onclick="supprimerEvenementImprevu(${evt.id})" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px; opacity: ${evt.verrouille ? '0.5' : '1'};">Supprimer</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--orange-accent);">Date √©v√©nement</label>
                        <input type="date" value="${evt.dateEvenement}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--orange-accent);">Description</label>
                        <input type="text" value="${evt.description}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--orange-accent);">Reprise</label>
                        <input type="text" value="${evt.horaireReprise}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--orange-accent);">Date reprise</label>
                        <input type="date" value="${evt.dateReprise}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

        function modifierEvenementImprevu(id) {
            let evenements = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');
            const evt = evenements.find(e => e.id === id);

            if (evt && evt.verrouille) {
                alert('D√©cochez "üîí" avant de modifier');
                return;
            }

            evenements = evenements.map(e => {
                if (e.id === id) {
                    return { ...e, modeEdition: true };
                }
                return e;
            });

            localStorage.setItem('evenementsImprevus', JSON.stringify(evenements));
            chargerEvenementsImprevus();
        }

        function annulerModificationImprevu(id) {
            let evenements = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');
            evenements = evenements.map(e => {
                if (e.id === id) {
                    return { ...e, modeEdition: false, verrouille: true };
                }
                return e;
            });

            localStorage.setItem('evenementsImprevus', JSON.stringify(evenements));
            chargerEvenementsImprevus();
        }

        function sauvegarderModificationImprevu(id) {
            const dateEvenement = document.getElementById(`editDateImprevu-${id}`).value;
            const description = document.getElementById(`editDescriptionImprevu-${id}`).value;
            const horaireReprise = document.getElementById(`editHoraireRepriseImprevu-${id}`).value;
            const dateReprise = document.getElementById(`editDateRepriseImprevu-${id}`).value;

            if (!dateEvenement || description === 'Choisir...') {
                alert('Veuillez remplir au minimum la date et la description');
                return;
            }

            let evenements = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');
            evenements = evenements.map(e => {
                if (e.id === id) {
                    return {
                        ...e,
                        dateEvenement,
                        description,
                        horaireReprise: horaireReprise === 'Choisir...' ? '' : horaireReprise,
                        dateReprise,
                        modeEdition: false,
                        verrouille: true
                    };
                }
                return e;
            });

            localStorage.setItem('evenementsImprevus', JSON.stringify(evenements));
            chargerEvenementsImprevus();
        }

        function supprimerEvenementImprevu(id) {
            let evenements = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');
            const evt = evenements.find(e => e.id === id);

            if (evt && evt.verrouille) {
                alert('D√©cochez "üîí" avant de supprimer');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) {
                evenements = evenements.filter(e => e.id !== id);
                localStorage.setItem('evenementsImprevus', JSON.stringify(evenements));
                chargerEvenementsImprevus();
            }
        }

        // Fonction pour sauvegarder le cadre du calendrier
        // ========================================
        // CORRECTION - sauvegarderCadreCalendrier()
        // Ajouter notification de succ√®s
        // ========================================
        function sauvegarderCadreCalendrier() {
            // R√©cup√©rer toutes les valeurs
            const cadreCalendrier = {
                dateDebut: document.getElementById('debutTrimestre').value,
                dateFin: document.getElementById('finTrimestre').value,
                finCours: document.getElementById('finCours').value,
                finTrimestre: document.getElementById('finTrimestre').value,
                remiseNotes: document.getElementById('remiseNotes').value,
                semainePlanificationDebut: document.getElementById('semainePlanificationDebut').value,
                semainePlanificationFin: document.getElementById('semainePlanificationFin').value,
                semaineExamensDebut: document.getElementById('semaineExamensDebut').value,
                semaineExamensFin: document.getElementById('semaineExamensFin').value
            };

            // Calculer le nombre de semaines si dates disponibles
            if (cadreCalendrier.dateDebut && cadreCalendrier.dateFin) {
                const dateDebut = new Date(cadreCalendrier.dateDebut);
                const dateFin = new Date(cadreCalendrier.dateFin);
                const diffJours = Math.ceil((dateFin - dateDebut) / (1000 * 60 * 60 * 24));
                cadreCalendrier.nombreSemaines = Math.ceil(diffJours / 7);
            }

            // Sauvegarder dans localStorage
            localStorage.setItem('cadreCalendrier', JSON.stringify(cadreCalendrier));

            // ========================================
            // AJOUT - Notification de succ√®s
            // ========================================
            afficherNotification('Am√©nagements du calendrier sauvegard√©s avec succ√®s !');

            // Mettre √† jour l'aper√ßu si la fonction existe
            if (typeof chargerStatistiquesApercu === 'function') {
                chargerStatistiquesApercu();
            }
        }

        // SauvegarderAmenagements() pour le bouton "Sauvegarder les am√©nagements"
        function sauvegarderAmenagements() {
            // Les √©v√©nements pr√©vus et impr√©vus sont d√©j√† sauvegard√©s individuellement
            // via les fonctions confirmerAjoutEvenement() et confirmerAjoutEvenementImprevu()
            // Cette fonction sert juste √† confirmer que tout est bien sauvegard√©

            // V√©rifier que les donn√©es existent
            const evenementsPrevus = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            const evenementsImprevus = JSON.parse(localStorage.getItem('evenementsImprevus') || '[]');

            const totalEvenements = evenementsPrevus.length + evenementsImprevus.length;

            if (totalEvenements === 0) {
                afficherNotification('Aucun am√©nagement √† sauvegarder');
            } else {
                afficherNotification(`Am√©nagements sauvegard√©s : ${evenementsPrevus.length} √©v√©nement(s) pr√©vu(s) et ${evenementsImprevus.length} √©v√©nement(s) impr√©vu(s)`);
            }

            // Mettre √† jour l'aper√ßu si n√©cessaire
            if (typeof chargerStatistiquesApercu === 'function') {
                chargerStatistiquesApercu();
            }
        }

        // chargerCadreCalendrier() - Charger les donn√©es au d√©marrage
        function chargerCadreCalendrier() {
            const cadre = JSON.parse(localStorage.getItem('cadreCalendrier') || 'null');

            if (!cadre) {
                return; // Rien √† charger
            }

            // Remplir les champs du formulaire
            if (document.getElementById('debutTrimestre')) {
                document.getElementById('debutTrimestre').value = cadre.dateDebut || '';
            }
            if (document.getElementById('finCours')) {
                document.getElementById('finCours').value = cadre.finCours || '';
            }
            if (document.getElementById('finTrimestre')) {
                document.getElementById('finTrimestre').value = cadre.finTrimestre || '';
            }
            if (document.getElementById('remiseNotes')) {
                document.getElementById('remiseNotes').value = cadre.remiseNotes || '';
            }
            if (document.getElementById('semainePlanificationDebut')) {
                document.getElementById('semainePlanificationDebut').value = cadre.semainePlanificationDebut || '';
            }
            if (document.getElementById('semainePlanificationFin')) {
                document.getElementById('semainePlanificationFin').value = cadre.semainePlanificationFin || '';
            }
            if (document.getElementById('semaineExamensDebut')) {
                document.getElementById('semaineExamensDebut').value = cadre.semaineExamensDebut || '';
            }
            if (document.getElementById('semaineExamensFin')) {
                document.getElementById('semaineExamensFin').value = cadre.semaineExamensFin || '';
            }
        }

        // === GESTION DE L'HORAIRE DES COURS ===

        // Fonctions pour g√©n√©rer les options d'heures
        function genererOptionsHeureDebut() {
            let options = '<option value="">Choisir...</option>';
            for (let h = 8; h <= 22; h++) {
                const heure = h < 10 ? `0${h}:00` : `${h}:00`;
                const affichage = `${h}h00`;
                options += `<option value="${heure}">${affichage}</option>`;
            }
            return options;
        }

        function genererOptionsHeureFin() {
            let options = '<option value="">Choisir...</option>';
            for (let h = 8; h <= 22; h++) {
                const heure = h < 10 ? `0${h}:50` : `${h}:50`;
                const affichage = `${h}h50`;
                options += `<option value="${heure}">${affichage}</option>`;
            }
            return options;
        }

        function afficherFormulaireSeances() {
            const formatChecked = document.querySelector('input[name="formatHoraire"]:checked');

            if (!formatChecked) {
                // Si aucun format s√©lectionn√©, cacher le formulaire
                document.getElementById('formAjoutSeance').style.display = 'none';
                return;
            }

            const format = formatChecked.value;
            const container = document.getElementById('seancesFormContainer');

            // Afficher directement le formulaire
            document.getElementById('formAjoutSeance').style.display = 'block';

            let html = '';

            if (format === '2x2') {
                document.getElementById('btnConfirmerSeances').textContent = 'Ajouter les s√©ances';
                html = `
            <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                <strong style="color: var(--bleu-moyen);">S√©ance A</strong>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr; gap: 10px; margin-top: 10px; align-items: end;">
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Jour de la semaine</label>
                        <select class="controle-form" id="jourSeanceA">
                            <option>Choisir...</option>
                            <option>Lundi</option>
                            <option>Mardi</option>
                            <option>Mercredi</option>
                            <option>Jeudi</option>
                            <option>Vendredi</option>
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Heure d√©but</label>
                        <select class="controle-form" id="debutSeanceA">
                            ${genererOptionsHeureDebut()}
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Heure fin</label>
                        <select class="controle-form" id="finSeanceA">
                            ${genererOptionsHeureFin()}
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Local</label>
                        <input type="text" class="controle-form" id="localSeanceA" placeholder="Ex: 1709">
                    </div>
                </div>
            </div>
            
            <div style="background: white; padding: 10px; border-radius: 6px;">
                <strong style="color: var(--bleu-moyen);">S√©ance B</strong>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr; gap: 10px; margin-top: 10px; align-items: end;">
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Jour de la semaine</label>
                        <select class="controle-form" id="jourSeanceB">
                            <option>Choisir...</option>
                            <option>Lundi</option>
                            <option>Mardi</option>
                            <option>Mercredi</option>
                            <option>Jeudi</option>
                            <option>Vendredi</option>
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Heure d√©but</label>
                        <select class="controle-form" id="debutSeanceB">
                            ${genererOptionsHeureDebut()}
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Heure fin</label>
                        <select class="controle-form" id="finSeanceB">
                            ${genererOptionsHeureFin()}
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Local</label>
                        <input type="text" class="controle-form" id="localSeanceB" placeholder="Ex: 1709">
                    </div>
                </div>
            </div>
        `;
            } else if (format === '1x4') {
                document.getElementById('btnConfirmerSeances').textContent = 'Ajouter la s√©ance';
                html = `
            <div style="background: white; padding: 10px; border-radius: 6px;">
                <strong style="color: var(--bleu-moyen);">S√©ance unique (4h)</strong>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr; gap: 10px; margin-top: 10px; align-items: end;">
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Jour de la semaine</label>
                        <select class="controle-form" id="jourSeanceUnique">
                            <option>Choisir...</option>
                            <option>Lundi</option>
                            <option>Mardi</option>
                            <option>Mercredi</option>
                            <option>Jeudi</option>
                            <option>Vendredi</option>
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Heure d√©but</label>
                        <select class="controle-form" id="debutSeanceUnique">
                            ${genererOptionsHeureDebut()}
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Heure fin</label>
                        <select class="controle-form" id="finSeanceUnique">
                            ${genererOptionsHeureFin()}
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label style="font-size: 0.85rem;">Local</label>
                        <input type="text" class="controle-form" id="localSeanceUnique" placeholder="Ex: 1709">
                    </div>
                </div>
            </div>
        `;
            }

            // Injecter le HTML dans le container
            container.innerHTML = html;
        }

        function annulerAjoutSeance() {
            document.getElementById('formAjoutSeance').style.display = 'none';
        }

        function confirmerAjoutSeances() {
            const formatChecked = document.querySelector('input[name="formatHoraire"]:checked');
            if (!formatChecked) return;
            const formatHoraire = formatChecked.value;
            let seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');

            if (formatHoraire === '2x2') {
                // Valider et sauvegarder les 2 s√©ances
                const seanceA = {
                    id: Date.now(),
                    nom: 'A',
                    jour: document.getElementById('jourSeanceA').value,
                    debut: document.getElementById('debutSeanceA').value,
                    fin: document.getElementById('finSeanceA').value,
                    local: document.getElementById('localSeanceA').value,
                    verrouille: true
                };

                const seanceB = {
                    id: Date.now() + 1,
                    nom: 'B',
                    jour: document.getElementById('jourSeanceB').value,
                    debut: document.getElementById('debutSeanceB').value,
                    fin: document.getElementById('finSeanceB').value,
                    local: document.getElementById('localSeanceB').value,
                    verrouille: true
                };

                if (seanceA.jour === 'Choisir...' || !seanceA.debut || !seanceA.fin ||
                    seanceB.jour === 'Choisir...' || !seanceB.debut || !seanceB.fin) {
                    alert('Veuillez remplir tous les champs obligatoires pour les deux s√©ances');
                    return;
                }

                seances.push(seanceA, seanceB);
            } else {
                // Valider et sauvegarder 1 s√©ance
                const seance = {
                    id: Date.now(),
                    nom: '',
                    jour: document.getElementById('jourSeanceUnique').value,
                    debut: document.getElementById('debutSeanceUnique').value,
                    fin: document.getElementById('finSeanceUnique').value,
                    local: document.getElementById('localSeanceUnique').value,
                    verrouille: true
                };

                if (seance.jour === 'Choisir...' || !seance.debut || !seance.fin) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                seances.push(seance);
            }

            localStorage.setItem('seancesHoraire', JSON.stringify(seances));
            localStorage.setItem('formatHoraire', formatHoraire);
            annulerAjoutSeance();
            chargerSeances();
            afficherNotificationSucces('Horaire sauvegard√© avec succ√®s !');
        }

        function chargerSeances() {
            const container = document.getElementById('seancesContainer');
            const seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');

            if (seances.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucune s√©ance configur√©e.</p>';
                return;
            }

            container.innerHTML = seances.map(seance => `
        <div style="padding: 12px; background: var(--bleu-pale); border: 1px solid var(--bleu-leger); border-radius: 6px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="color: var(--bleu-principal);">
                    ${seance.nom ? 'S√©ance ' + seance.nom : 'S√©ance unique'}
                </strong>
                <div>
                    <label style="font-size: 0.85rem; margin-right: 10px;">
                        <input type="checkbox" 
                               id="verrou-seance-${seance.id}" 
                               ${seance.verrouille ? 'checked' : ''}
                               onchange="basculerVerrouillageSeance(${seance.id})">
                        üîí
                    </label>
                    <button class="btn btn-modifier btn-sm" 
                            onclick="modifierSeance(${seance.id})"
                            ${seance.verrouille ? 'disabled' : ''}
                            style="opacity: ${seance.verrouille ? '0.5' : '1'}">
                        Modifier
                    </button>
                    <button class="btn btn-supprimer btn-sm" 
                            onclick="supprimerSeance(${seance.id})"
                            ${seance.verrouille ? 'disabled' : ''}
                            style="opacity: ${seance.verrouille ? '0.5' : '1'}">
                        Supprimer
                    </button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.9rem;">
                <div><strong>Jour:</strong> ${seance.jour}</div>
                <div><strong>D√©but:</strong> ${seance.debut}</div>
                <div><strong>Fin:</strong> ${seance.fin}</div>
                <div><strong>Local:</strong> ${seance.local || 'Non sp√©cifi√©'}</div>
            </div>
        </div>
    `).join('');
        }

        function basculerVerrouillageSeance(id) {
            let seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');
            const index = seances.findIndex(s => s.id === id);

            if (index !== -1) {
                seances[index].verrouille = document.getElementById(`verrou-seance-${id}`).checked;
                localStorage.setItem('seancesHoraire', JSON.stringify(seances));
                chargerSeances();
            }
        }

        function modifierSeance(id) {
            let seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');
            const seance = seances.find(s => s.id === id);

            if (!seance) return;

            // Pour simplifier, on supprime la s√©ance et on laisse l'utilisateur en cr√©er une nouvelle
            if (confirm('Pour modifier, la s√©ance actuelle sera supprim√©e et vous pourrez en cr√©er une nouvelle. Continuer ?')) {
                supprimerSeance(id);
                // Le formulaire est d√©j√† visible gr√¢ce au bouton radio
            }
        }

        function supprimerSeance(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette s√©ance ?')) {
                let seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');
                seances = seances.filter(s => s.id !== id);
                localStorage.setItem('seancesHoraire', JSON.stringify(seances));
                chargerSeances();

                // Si plus aucune s√©ance, r√©afficher le formulaire
                if (seances.length === 0) {
                    afficherFormulaireSeances();
                }
            }
        }

        // REMPLACER la fonction changerFormatHoraire()
        function changerFormatHoraire() {
            const formatSelect = document.getElementById('formatHoraire');
            const format = formatSelect.value;
            const ancienFormatStock = localStorage.getItem('formatHoraire'); // Ajoute cette ligne

            console.log('Format s√©lectionn√©:', format);
            console.log('Format stock√© avant:', ancienFormatStock); // Ajoute cette ligne
            console.log('Valeur r√©elle du select:', formatSelect.value); // Ajoute cette ligne

            // Si aucun format s√©lectionn√©, ne rien faire
            if (!format || format === '') {
                return;
            }

            const seancesExistantes = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');

            // Si des s√©ances existent d√©j√†, demander confirmation
            if (seancesExistantes.length > 0) {
                if (confirm('Le changement de format va supprimer les s√©ances existantes. Continuer ?')) {
                    localStorage.setItem('seancesHoraire', '[]');
                    chargerSeances();
                } else {
                    // ICI EST LE PROBL√àME - Cette ligne remet l'ancienne valeur!
                    const ancienFormat = localStorage.getItem('formatHoraire');
                    formatSelect.value = ancienFormat || '';
                    return; // Et on sort de la fonction sans actualiser
                }
            }

            localStorage.setItem('formatHoraire', format);

            // Mettre √† jour le bouton d'ajout selon le format
            const btnAjouterSeance = document.getElementById('btnAjouterSeance');
            if (btnAjouterSeance) {
                btnAjouterSeance.textContent = format === '2x2'
                    ? '+ Ajouter les s√©ances de cours'
                    : '+ Ajouter la s√©ance de cours';
            }

            // FORCER L'ACTUALISATION si un formulaire existe
            const formAjout = document.getElementById('formAjoutSeance');
            const container = document.getElementById('seancesFormContainer');

            // Si le conteneur du formulaire contient du HTML, c'est qu'il est affich√©
            if (formAjout && container && container.innerHTML.trim() !== '') {
                console.log('Actualisation forc√©e du formulaire...');
                afficherFormulaireSeances();
            }
        }

        // === GESTION DES DISPONIBILIT√âS ===

        function afficherFormulaireDisponibilite() {
            document.getElementById('formAjoutDisponibilite').style.display = 'block';
            document.getElementById('btnAjouterDisponibilite').style.display = 'none';
        }

        function annulerAjoutDisponibilite() {
            document.getElementById('formAjoutDisponibilite').style.display = 'none';
            document.getElementById('btnAjouterDisponibilite').style.display = 'inline-block';
            // R√©initialiser les champs
            document.getElementById('jourDisponibilite').selectedIndex = 0;
            document.getElementById('debutDisponibilite').value = '';
            document.getElementById('finDisponibilite').value = '';
            document.getElementById('localDisponibilite').value = '';
        }

        function confirmerAjoutDisponibilite() {
            const jour = document.getElementById('jourDisponibilite').value;
            const debut = document.getElementById('debutDisponibilite').value;
            const fin = document.getElementById('finDisponibilite').value;
            const local = document.getElementById('localDisponibilite').value;

            if (jour === 'Choisir...' || !debut || !fin) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            const disponibilite = {
                id: Date.now(),
                jour,
                debut,
                fin,
                local: local || 'Non sp√©cifi√©',
                verrouille: true
            };

            let disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');
            disponibilites.push(disponibilite);
            localStorage.setItem('disponibilites', JSON.stringify(disponibilites));

            annulerAjoutDisponibilite();
            chargerDisponibilites();
            afficherNotificationSucces('Disponibilit√© ajout√©e avec succ√®s !');
        }

        function chargerDisponibilites() {
            const container = document.getElementById('disponibilitesContainer');
            const disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');

            if (disponibilites.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucune disponibilit√© configur√©e.</p>';
                return;
            }

            container.innerHTML = disponibilites.map(dispo => {
                // Si en mode √©dition
                if (dispo.modeEdition) {
                    return `
                <div style="padding: 15px; background: var(--vert-pale); border: 1px solid var(--vert-leger); border-radius: 6px; margin-bottom: 20px;">
                    <strong style="color: var(--vert-leger);">Modifier la disponibilit√©</strong>
                    
                    <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr; gap: 10px; margin-top: 15px; align-items: end;">
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Jour</label>
                            <select class="controle-form" id="editJourDispo-${dispo.id}">
                                <option ${dispo.jour === 'Lundi' ? 'selected' : ''}>Lundi</option>
                                <option ${dispo.jour === 'Mardi' ? 'selected' : ''}>Mardi</option>
                                <option ${dispo.jour === 'Mercredi' ? 'selected' : ''}>Mercredi</option>
                                <option ${dispo.jour === 'Jeudi' ? 'selected' : ''}>Jeudi</option>
                                <option ${dispo.jour === 'Vendredi' ? 'selected' : ''}>Vendredi</option>
                            </select>
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">D√©but</label>
                            <input type="time" class="controle-form" id="editDebutDispo-${dispo.id}" value="${dispo.debut}">
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Fin</label>
                            <input type="time" class="controle-form" id="editFinDispo-${dispo.id}" value="${dispo.fin}">
                        </div>
                        <div class="groupe-form">
                            <label style="font-size: 0.85rem;">Local</label>
                            <input type="text" class="controle-form" id="editLocalDispo-${dispo.id}" value="${dispo.local}">
                        </div>
                    </div>
                    
                    <div class="btn-groupe mt-2" style="justify-content: flex-end;">
                        <button class="btn btn-annuler" onclick="annulerModificationDispo(${dispo.id})">Annuler</button>
                        <button class="btn btn-confirmer" onclick="sauvegarderModificationDispo(${dispo.id})">Sauvegarder</button>
                    </div>
                </div>
            `;
                }

                // Mode affichage normal
                return `
            <div style="padding: 12px; background: var(--vert-pale); border: 1px solid var(--vert-leger); border-radius: 6px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: var(--vert-leger);">${dispo.jour}</strong>
                    <div>
                        <label style="font-size: 0.85rem; margin-right: 10px;">
                            <input type="checkbox" id="unlock-dispo-${dispo.id}" onchange="basculerVerrouillageDispo(${dispo.id})" ${dispo.verrouille ? 'checked' : ''}>
                            üîí
                        </label>
                        <button class="btn btn-modifier" onclick="modifierDisponibilite(${dispo.id})" 
                            style="padding: 5px 12px; font-size: 0.85rem; opacity: ${dispo.verrouille ? '0.5' : '1'};">Modifier</button>
                        <button class="btn btn-supprimer" onclick="supprimerDisponibilite(${dispo.id})" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px; opacity: ${dispo.verrouille ? '0.5' : '1'};">Supprimer</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--vert-leger);">Horaire</label>
                        <input type="text" value="${dispo.debut} - ${dispo.fin}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--vert-leger);">Local</label>
                        <input type="text" value="${dispo.local}" class="controle-form" readonly style="font-size: 0.85rem;">
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

        function basculerVerrouillageDispo(id) {
            let disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');
            const index = disponibilites.findIndex(d => d.id === id);

            if (index !== -1) {
                disponibilites[index].verrouille = document.getElementById(`unlock-dispo-${id}`).checked;
                localStorage.setItem('disponibilites', JSON.stringify(disponibilites));
                chargerDisponibilites();
            }
        }

        function modifierDisponibilite(id) {
            let disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');
            const dispo = disponibilites.find(d => d.id === id);

            if (dispo && dispo.verrouille) {
                alert('D√©cochez "üîí" avant de modifier');
                return;
            }

            disponibilites = disponibilites.map(d => {
                if (d.id === id) {
                    return { ...d, modeEdition: true };
                }
                return d;
            });

            localStorage.setItem('disponibilites', JSON.stringify(disponibilites));
            chargerDisponibilites();
        }

        function annulerModificationDispo(id) {
            let disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');
            disponibilites = disponibilites.map(d => {
                if (d.id === id) {
                    return { ...d, modeEdition: false, verrouille: true };
                }
                return d;
            });

            localStorage.setItem('disponibilites', JSON.stringify(disponibilites));
            chargerDisponibilites();
        }

        function sauvegarderModificationDispo(id) {
            const jour = document.getElementById(`editJourDispo-${id}`).value;
            const debut = document.getElementById(`editDebutDispo-${id}`).value;
            const fin = document.getElementById(`editFinDispo-${id}`).value;
            const local = document.getElementById(`editLocalDispo-${id}`).value;

            let disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');
            disponibilites = disponibilites.map(d => {
                if (d.id === id) {
                    return {
                        ...d,
                        jour,
                        debut,
                        fin,
                        local: local || 'Non sp√©cifi√©',
                        modeEdition: false,
                        verrouille: true
                    };
                }
                return d;
            });

            localStorage.setItem('disponibilites', JSON.stringify(disponibilites));
            chargerDisponibilites();
            afficherNotificationSucces('Disponibilit√© modifi√©e avec succ√®s !');
        }

        function supprimerDisponibilite(id) {
            let disponibilites = JSON.parse(localStorage.getItem('disponibilites') || '[]');
            const dispo = disponibilites.find(d => d.id === id);

            if (dispo && dispo.verrouille) {
                alert('D√©cochez "üîí" avant de supprimer');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette disponibilit√© ?')) {
                disponibilites = disponibilites.filter(d => d.id !== id);
                localStorage.setItem('disponibilites', JSON.stringify(disponibilites));
                chargerDisponibilites();
            }
        }

        // === FONCTIONS DE MODIFICATION ET VERROUILLAGE ===

        function basculerVerrouillageGroupe() {
            const verrouille = document.getElementById('verrouillerGroupe').checked;
            localStorage.setItem('groupeVerrouille', JSON.stringify(verrouille));
            afficherListeEtudiants();
        }

        function modifierEtudiant(id) {
            const verrouille = JSON.parse(localStorage.getItem('groupeVerrouille') || 'false');
            if (verrouille) {
                alert('D√©cochez "üîí" avant de modifier');
                return;
            }

            const students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const student = students.find(s => (s.id == id || s.da == id));

            if (!student) {
                alert('√âtudiant¬∑e non trouv√©¬∑e');
                return;
            }

            // Cr√©er un formulaire de modification modal
            const modalHTML = `
        <div id="modalModification" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%;">
                <h3 style="margin-bottom: 20px; color: var(--bleu-principal);">Modifier l'√©tudiant¬∑e</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="groupe-form">
                        <label>DA :</label>
                        <input type="text" id="modif-da" class="controle-form" value="${student.da}">
                    </div>
                    <div class="groupe-form">
                        <label>Groupe :</label>
                        <input type="text" id="modif-groupe" class="controle-form" value="${student.groupe}">
                    </div>
                    <div class="groupe-form">
                        <label>Nom :</label>
                        <input type="text" id="modif-nom" class="controle-form" value="${student.nom}">
                    </div>
                    <div class="groupe-form">
                        <label>Pr√©nom :</label>
                        <input type="text" id="modif-prenom" class="controle-form" value="${student.prenom}">
                    </div>
                    <div class="groupe-form">
                        <label>Programme :</label>
                        <input type="text" id="modif-programme" class="controle-form" value="${student.programme}">
                    </div>
                    <div class="groupe-form">
                        <label>Services adapt√©s :</label>
                        <select id="modif-sa" class="controle-form">
                            <option value="" ${student.sa !== 'Oui' ? 'selected' : ''}>Non</option>
                            <option value="Oui" ${student.sa === 'Oui' ? 'selected' : ''}>Oui</option>
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label>Centre d'aide en fran√ßais :</label>
                        <select id="modif-caf" class="controle-form">
                            <option value="" ${student.caf !== 'Oui' ? 'selected' : ''}>Non</option>
                            <option value="Oui" ${student.caf === 'Oui' ? 'selected' : ''}>Oui</option>
                        </select>
                    </div>
                </div>
                
                <div class="btn-groupe" style="justify-content: flex-end;">
                    <button class="btn btn-annuler" onclick="fermerModalModification()">Annuler</button>
                    <button class="btn btn-confirmer" onclick="sauvegarderModificationEtudiant('${id}')">Sauvegarder</button>
                </div>
            </div>
        </div>
    `;

            // Ajouter le modal au body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
        }

        function fermerModalModification() {
            const modal = document.getElementById('modalModification');
            if (modal) {
                modal.parentElement.remove();
            }
        }

        function sauvegarderModificationEtudiant(id) {
            let students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const index = students.findIndex(s => (s.id == id || s.da == id));

            if (index !== -1) {
                students[index] = {
                    ...students[index],
                    da: document.getElementById('modif-da').value,
                    groupe: document.getElementById('modif-groupe').value,
                    nom: document.getElementById('modif-nom').value,
                    prenom: document.getElementById('modif-prenom').value,
                    programme: document.getElementById('modif-programme').value,
                    sa: document.getElementById('modif-sa').value,
                    caf: document.getElementById('modif-caf').value
                };

                localStorage.setItem('groupeEtudiants', JSON.stringify(students));
                fermerModalModification();
                afficherListeEtudiants();
                afficherNotificationSucces('√âtudiant¬∑e modifi√©¬∑e avec succ√®s !');
            }
        }

        function supprimerEtudiant(id) {
            const verrouille = JSON.parse(localStorage.getItem('groupeVerrouille') || 'false');
            if (verrouille) {
                alert('D√©cochez "üîí" avant de supprimer');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet¬∑te √©tudiant¬∑e ?')) {
                let students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
                students = students.filter(s => (s.id != id && s.da != id));
                localStorage.setItem('groupeEtudiants', JSON.stringify(students));
                afficherListeEtudiants();
                afficherNotificationSucces('√âtudiant¬∑e supprim√©¬∑e');
            }
        }

        // Variables pour la gestion des productions
        let productionEnEdition = null;

        function afficherFormProduction(id = null) {
            const formulaire = document.getElementById('formulaireProduction');
            const btnAjouter = document.getElementById('btnajouterProduction');
            const titre = document.getElementById('titreFormEvaluation');
            const btnTexte = document.getElementById('btnTexteEvaluation');

            formulaire.style.display = 'block';
            btnAjouter.style.display = 'none';

            // Charger les grilles disponibles (dans tous les cas)
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const selectGrille = document.getElementById('productionGrille');

            selectGrille.innerHTML = '<option value="">-- Aucune grille --</option>';
            grilles.forEach(grille => {
                selectGrille.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
            });

            if (id) {
                // Mode √©dition
                const evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
                const eval = evaluations.find(e => e.id === id);

                if (eval) {
                    productionEnEdition = id;
                    titre.textContent = 'Modifier l\'√©valuation';
                    btnTexte.textContent = 'Sauvegarder';

                    document.getElementById('productionTitre').value = eval.titre;
                    document.getElementById('productionDescription').value = eval.description || '';
                    document.getElementById('productionType').value = eval.type;
                    document.getElementById('productionPonderation').value = eval.ponderation;
                    document.getElementById('productionGrille').value = eval.grilleId || '';  // AJOUTER
                    document.getElementById('productionObjectif').value = eval.objectif || '';
                    document.getElementById('productionTache').value = eval.tache || '';
                }
            } else {
                // Mode ajout
                productionEnEdition = null;
                titre.textContent = 'Nouvelle production';
                btnTexte.textContent = 'Ajouter';

                // R√©initialiser les champs
                document.getElementById('productionTitre').value = '';
                document.getElementById('productionDescription').value = '';
                document.getElementById('productionType').value = '';
                document.getElementById('productionPonderation').value = '';
                document.getElementById('productionGrille').value = '';  // AJOUTER
                document.getElementById('productionObjectif').value = '';
                document.getElementById('productionTache').value = '';
            }
        }

        function gererChangementTypeProduction() {
            const type = document.getElementById('productionType').value;
            const champsPortfolio = document.getElementById('champsPortfolio');
            const divPonderation = document.getElementById('productionPonderation').parentElement;
            const divGrille = document.getElementById('productionGrille').parentElement;
            const msgPonderation = document.getElementById('msgPonderationArtefact');

            // R√©initialiser tout d'abord
            champsPortfolio.style.display = 'none';
            divPonderation.style.display = 'block';
            divGrille.style.display = 'block';
            if (msgPonderation) msgPonderation.style.display = 'none';

            // Appliquer selon le type
            if (type === 'portfolio') {
                // Portfolio conteneur : afficher config, masquer grille
                champsPortfolio.style.display = 'block';
                divGrille.style.display = 'none';
            } else if (type === 'artefact-portfolio') {
                // Artefact individuel : masquer pond√©ration, afficher message
                divPonderation.style.display = 'none';
                if (msgPonderation) msgPonderation.style.display = 'block';
            }
        }

        function chargerArtefactsDisponibles() {
            const evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const artefacts = evaluations.filter(e => e.type === 'artefact-portfolio');
            const container = document.getElementById('listeArtefactsDisponibles');

            if (artefacts.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucun artefact de type "Artefact d\'un portfolio" n\'existe encore. Cr√©e-les d\'abord.</p>';
                return;
            }

            container.innerHTML = artefacts.map(art => `
        <label style="display: block; padding: 8px; margin-bottom: 5px; 
               background: var(--bleu-tres-pale); border-radius: 4px; cursor: pointer;">
            <input type="checkbox" name="artefactPortfolio" value="${art.id}" 
                   style="margin-right: 10px;">
            <strong>${art.titre}</strong>${art.description ? ' - ' + art.description : ''}
        </label>
    `).join('');
        }

        function annulerFormProduction() {
            // Cacher le formulaire
            document.getElementById('formulaireProduction').style.display = 'none';
            // R√©afficher le bouton d'ajout
            document.getElementById('btnajouterProduction').style.display = 'inline-block';
            // R√©initialiser la variable d'√©dition
            productionEnEdition = null;
        }

        function sauvegarderProductionProduction(productionNum) {
            const titre = document.getElementById('productionTitre').value.trim();
            const description = document.getElementById('productionDescription').value.trim();
            const type = document.getElementById('productionType').value;
            const ponderation = parseInt(document.getElementById('productionPonderation').value) || 0;
            const objectif = document.getElementById('productionObjectif').value.trim();
            const tache = document.getElementById('productionTache').value.trim();

            if (!titre || !type || ponderation === 0) {
                alert('Veuillez remplir tous les champs obligatoires (Titre, Type et Pond√©ration)');
                return;
            }

            let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            if (productionEnEdition) {
                // Modifier la production existante
                const index = evaluations.findIndex(e => e.id === productionEnEdition);
                if (index !== -1) {
                    evaluations[index] = {
                        ...evaluations[index],
                        titre,
                        description,
                        type,
                        ponderation,
                        objectif,
                        tache
                    };
                }
            } else {
                // Ajouter Nouvelle grille d'√©valuation
                const nouvelleEval = {
                    id: 'PROD' + Date.now(), // Utiliser timestamp pour ID unique
                    titre,
                    description,
                    type,
                    ponderation,
                    objectif,
                    tache,
                    verrouille: false
                };
                evaluations.push(nouvelleEval);
            }

            localStorage.setItem('listeGrilles', JSON.stringify(evaluations));

            annulerFormProduction();
            afficherTableauProductions();
            mettreAJourPonderationTotale();

            // Afficher la notification de succ√®s si la fonction existe
            if (typeof afficherNotificationSucces === 'function') {
                afficherNotificationSucces(productionEnEdition ? 'Production modifi√©e avec succ√®s !' : 'Production ajout√©e avec succ√®s !');
            }

            // Mettre √† jour le statut des modalit√©s si la fonction existe
            if (typeof mettreAJourStatutModalites === 'function') {
                mettreAJourStatutModalites();
            }

            productionEnEdition = null;
        }

        function afficherTableauProductions() {
            const evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const container = document.getElementById('tableauEvaluationsContainer');

            if (evaluations.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucune √©valuation d√©finie.</p>';
                document.getElementById('typesEvaluations').innerHTML =
                    '<span style="color: var(--bleu-leger);">Aucune √©valuation configur√©e</span>';
                document.getElementById('nombreEvaluations').textContent = '0';
                return;
            }

            container.innerHTML = evaluations.map((eval, index) => {
                const grilleAssociee = grilles.find(g => g.id === eval.grilleId);
                const nomGrille = grilleAssociee ? grilleAssociee.nom : 'Aucune grille';

                // Style sp√©cial pour Portfolio
                const estPortfolio = eval.type === 'portfolio';
                const bgColor = estPortfolio ? 'var(--bleu-carte)' : 'var(--bleu-tres-pale)';
                const borderColor = estPortfolio ? 'var(--bleu-moyen)' : 'var(--bleu-leger)';

                return `
        <div style="padding: 12px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 6px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="color: var(--bleu-principal);">
                    ${estPortfolio ? 'üìÅ ' : ''}${eval.titre}${eval.description ? ' - ' + eval.description : ''}
                </strong>
                <div>
                    ${index > 0 ?
                        `<button onclick="monterEvaluation('${eval.id}')" class="btn btn-principal" 
                         style="padding: 5px 10px; font-size: 0.85rem; margin-right: 5px;" 
                         ${eval.verrouille ? 'disabled' : ''}>‚Üë</button>` : ''}
                    ${index < evaluations.length - 1 ?
                        `<button onclick="descendreEvaluation('${eval.id}')" class="btn btn-principal" 
                         style="padding: 5px 10px; font-size: 0.85rem; margin-right: 10px;" 
                         ${eval.verrouille ? 'disabled' : ''}>‚Üì</button>` : ''}
                    <label style="font-size: 0.85rem; margin-right: 10px;">
                        <input type="checkbox" id="unlock-eval-${eval.id}" 
                               onchange="basculerVerrouillageEval('${eval.id}')" 
                               ${eval.verrouille ? 'checked' : ''}>
                        üîí
                    </label>
                    ${estPortfolio ?
                        `<button class="btn btn-principal" onclick="gererPortfolio('${eval.id}')" 
                                style="padding: 5px 12px; font-size: 0.85rem; margin-right: 5px;">
                            üìä G√©rer le portfolio
                        </button>` : ''}
                    <button class="btn btn-modifier" onclick="modifierEvaluation('${eval.id}')" 
                            style="padding: 5px 12px; font-size: 0.85rem; 
                                   opacity: ${eval.verrouille ? '0.5' : '1'};"
                            ${eval.verrouille ? 'disabled' : ''}>
                        Modifier
                    </button>
                    <button class="btn btn-supprimer" onclick="supprimerProduction('${eval.id}')" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px; 
                                   opacity: ${eval.verrouille ? '0.5' : '1'};"
                            ${eval.verrouille ? 'disabled' : ''}>
                        Supprimer
                    </button>
                </div>
            </div>
<div style="display: grid; grid-template-columns: ${eval.type === 'artefact-portfolio' || estPortfolio ? '1fr 1fr' : '1fr 1fr 1fr'}; gap: 15px;">
                <div>
                    <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Type</label>
                    <input type="text" value="${getTypeLabel(eval.type)}" class="controle-form" 
                           readonly style="font-size: 0.85rem;">
                </div>
                ${eval.type !== 'artefact-portfolio' ? `
                <div>
                    <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Pond√©ration</label>
                    <input type="text" value="${eval.ponderation}%" class="controle-form" 
                           readonly style="font-size: 0.85rem; font-weight: bold;">
                </div>
                ` : ''}
                ${!estPortfolio ? `
                <div>
                    <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Grilles de crit√®res</label>
                    <input type="text" value="${nomGrille}" class="controle-form" 
                           readonly style="font-size: 0.85rem; ${!grilleAssociee ? 'color: var(--bleu-leger); font-style: italic;' : ''}">
                </div>
                ` : ''}
            </div>
            ${estPortfolio && eval.artefactsIds && eval.artefactsIds.length > 0 ? `
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
                    <strong style="font-size: 0.85rem; color: var(--bleu-principal);">
                        ${eval.artefactsIds.length} artefacts s√©lectionn√©s
                    </strong> ¬∑ 
                    ${eval.regles.nombreARetenir} √† retenir pour note finale ¬∑ 
                    Min. ${eval.regles.minimumCompletion} compl√©t√©s requis
                </div>
            ` : ''}
            ${eval.objectif || eval.tache ? `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bleu-tres-pale);">
                    ${eval.objectif ? `<p style="font-size: 0.85rem; margin-bottom: 5px;"><strong>Objectif:</strong> ${eval.objectif}</p>` : ''}
                    ${eval.tache ? `<p style="font-size: 0.85rem; margin-bottom: 0;"><strong>T√¢che:</strong> ${eval.tache}</p>` : ''}
                </div>
            ` : ''}
        </div>
        `;
            }).join('');

            document.getElementById('nombreEvaluations').textContent = evaluations.length;
            mettreAJourResumeTypes(evaluations);
        }

        function getTypeLabel(type) {
            const labels = {
                'examen': 'Examen',
                'travail': 'Travail √©crit',
                'quiz': 'Quiz/Test',
                'presentation': 'Pr√©sentation',
                'portfolio': 'üìÅ Portfolio (conteneur d\'artefacts)',
                'artefact-portfolio': 'Artefact d\'un portfolio',
                'autre': 'Autre'
            };
            return labels[type] || type;
        }

        function gererPortfolio(id) {
            alert('Fonctionnalit√© "G√©rer le portfolio" √† venir. ID: ' + id);
            // TODO: Cr√©er une page d√©di√©e pour s√©lectionner les 3 artefacts finaux
        }

        function mettreAJourResumeTypes(evaluations) {
            const compteurTypes = {};
            evaluations.forEach(eval => {
                compteurTypes[eval.type] = (compteurTypes[eval.type] || 0) + 1;
            });

            const resume = Object.entries(compteurTypes)
                .map(([type, count]) => `${count} ${getTypeLabel(type).toLowerCase()}${count > 1 ? 's' : ''}`)
                .join(', ');

            document.getElementById('typesEvaluations').textContent = resume || 'Aucune √©valuation';
        }

        function modifierEvaluation(id) {
            afficherFormProduction(id);
        }

        function supprimerProduction(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette production ?')) {
                let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
                evaluations = evaluations.filter(e => e.id !== id);

                localStorage.setItem('listeGrilles', JSON.stringify(evaluations));
                afficherTableauProductions();
                mettreAJourPonderationTotale();
                mettreAJourStatutModalites();
            }
        }

        function verrouillerEvaluation(id) {
            let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const index = evaluations.findIndex(e => e.id === id);

            if (index !== -1) {
                evaluations[index].verrouille = !evaluations[index].verrouille;
                localStorage.setItem('listeGrilles', JSON.stringify(evaluations));
                afficherTableauProductions();
            }
        }

        function basculerVerrouillageEval(id) {
            let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const index = evaluations.findIndex(e => e.id === id);

            if (index !== -1) {
                evaluations[index].verrouille = document.getElementById(`unlock-eval-${id}`).checked;
                localStorage.setItem('listeGrilles', JSON.stringify(evaluations));
                afficherTableauProductions();
            }
        }

        // ========================================
        // G√âN√âRATEUR DE CALENDRIER SCOLAIRE
        // ========================================
        // √Ä ajouter dans la section <script> de index35, apr√®s les fonctions existantes

        // === FONCTIONS UTILITAIRES POUR LE CALENDRIER ===

        function creerDateLocale(dateStr) {
            const [annee, mois, jour] = dateStr.split('-').map(Number);
            return new Date(annee, mois - 1, jour);
        }

        function formaterDate(date) {
            const annee = date.getFullYear();
            const mois = String(date.getMonth() + 1).padStart(2, '0');
            const jour = String(date.getDate()).padStart(2, '0');
            return `${annee}-${mois}-${jour}`;
        }

        function estWeekend(date) {
            const jour = date.getDay();
            return jour === 0 || jour === 6;
        }

        function obtenirNomJour(date) {
            const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            return jours[date.getDay()];
        }

        function estSemainePlanification(dateStr, config) {
            return dateStr >= config.semainePlanification.debut &&
                dateStr <= config.semainePlanification.fin;
        }

        function estSemaineExamens(dateStr, config) {
            return dateStr >= config.semaineExamens.debut &&
                dateStr <= config.semaineExamens.fin;
        }

        function estConge(dateStr, config) {
            return config.conges.some(c => c.date === dateStr);
        }

        function estReprise(dateStr, config) {
            return config.conges.some(c => c.reprise === dateStr);
        }

        // === G√âN√âRATEUR DES SEMAINES SCOLAIRES ===

        function genererSemainesScolaires(config) {
            let dateActuelle = creerDateLocale(config.debutTrimestre);
            const dateFin = creerDateLocale(config.finCours);
            const joursOuvrables = [];
            let compteurJoursScolaires = 0;

            while (dateActuelle <= dateFin) {
                const dateStr = formaterDate(dateActuelle);

                if (estWeekend(dateActuelle)) {
                    dateActuelle.setDate(dateActuelle.getDate() + 1);
                    continue;
                }

                if (estSemainePlanification(dateStr, config)) {
                    dateActuelle.setDate(dateActuelle.getDate() + 1);
                    continue;
                }

                if (estConge(dateStr, config)) {
                    dateActuelle.setDate(dateActuelle.getDate() + 1);
                    continue;
                }

                compteurJoursScolaires++;

                joursOuvrables.push({
                    date: dateStr,
                    nomJour: obtenirNomJour(dateActuelle),
                    numeroJour: compteurJoursScolaires,
                    estReprise: estReprise(dateStr, config)
                });

                dateActuelle.setDate(dateActuelle.getDate() + 1);
            }

            // Grouper par semaines
            const semaines = [];
            for (let i = 0; i < joursOuvrables.length; i += 5) {
                const joursSemaine = joursOuvrables.slice(i, i + 5);
                if (joursSemaine.length > 0) {
                    semaines.push({
                        numero: semaines.length + 1,
                        jours: joursSemaine
                    });
                }
            }

            return { joursOuvrables, semaines };
        }

        // === FONCTION : D√âTERMINER LE STATUT D'UN JOUR ===

        function obtenirStatutJour(dateStr, config, mapSemaines) {
            const date = creerDateLocale(dateStr);

            if (estWeekend(date)) {
                return { type: 'weekend', classe: 'cal-weekend', label: '' };
            }

            if (estSemaineExamens(dateStr, config)) {
                return { type: 'examens', classe: 'cal-examens', label: 'Examen' };
            }

            if (estSemainePlanification(dateStr, config)) {
                return { type: 'planification', classe: 'cal-planification', label: 'Planif.' };
            }

            if (estConge(dateStr, config)) {
                return { type: 'conge', classe: 'cal-conge', label: '' };
            }

            if (estReprise(dateStr, config)) {
                const numSemaine = mapSemaines[dateStr];
                return { type: 'reprise', classe: 'cal-reprise', label: `Sem. ${numSemaine}` };
            }

            if (mapSemaines[dateStr]) {
                const numSemaine = mapSemaines[dateStr];

                if (estJourDeCoursReel(dateStr)) {
                    return { type: 'cours-reel', classe: 'cal-jour-cours-reel', label: `Sem. ${numSemaine}` };
                }

                return { type: 'cours', classe: 'cal-jour-cours', label: '' };
            }

            return { type: 'vide', classe: '', label: '' };
        }


        // ========================================
        // CALENDRIER - COULEURS NUANC√âES VERSION CSS
        // Utilise les variables CSS 
        // ========================================

        // REMPLACER LA FONCTION genererHtmlMois PAR CELLE-CI :

        function genererHtmlMois(annee, mois, config, mapSemaines) {
            const nomsJours = ['DIM', 'LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM'];
            const nomsMois = ['', 'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

            const premierJour = new Date(annee, mois - 1, 1);
            const dernierJour = new Date(annee, mois, 0);
            const jourSemaineDebut = premierJour.getDay();
            const nombreJours = dernierJour.getDate();

            // üÜï CARTES PLUS GRANDES (padding augment√©)
            let html = `
      <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
        <h3 style="text-align: center; color: var(--bleu-principal); margin: 0 0 15px 0; font-size: 1.1rem; font-weight: 600;">
          ${nomsMois[mois]} ${annee}
        </h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--bleu-principal); color: white;">
    `;

            nomsJours.forEach(jour => {
                html += `<th style="padding: 10px; text-align: center; font-size: 0.85rem; font-weight: 500;">${jour}</th>`;
            });

            html += `</tr></thead><tbody>`;

            let jourActuel = 1;
            let finMois = false;

            while (!finMois) {
                html += '<tr>';

                for (let i = 0; i < 7; i++) {
                    if ((jourActuel === 1 && i < jourSemaineDebut) || jourActuel > nombreJours) {
                        html += '<td style="padding: 14px; text-align: center; background: var(--bleu-tres-pale);"></td>';
                        if (jourActuel > nombreJours) finMois = true;
                    } else {
                        const dateStr = `${annee}-${String(mois).padStart(2, '0')}-${String(jourActuel).padStart(2, '0')}`;
                        const statut = obtenirStatutJour(dateStr, config, mapSemaines);
                        const numSemaine = mapSemaines[dateStr];

                        let classeCSS = statut.classe;
                        let tooltip = '';
                        let afficherBadge = false;

                        if (statut.type === 'cours-reel') {
                            tooltip = `Semaine ${numSemaine} - Cours`;
                            afficherBadge = true;
                        } else if (statut.type === 'cours') {
                            tooltip = `Semaine ${numSemaine}`;
                            afficherBadge = false;
                        } else if (statut.type === 'reprise') {
                            tooltip = `Semaine ${numSemaine} - Reprise`;
                            afficherBadge = true;
                        } else if (statut.type === 'examens') {
                            tooltip = 'Semaine d\'examens';
                            afficherBadge = true;
                        } else if (statut.type === 'planification') {
                            tooltip = 'Semaine de planification';
                            afficherBadge = true;
                        } else if (statut.type === 'conge') {
                            tooltip = 'Cong√©';
                        } else if (statut.type === 'weekend') {
                            tooltip = 'Weekend';
                        }

                        // üÜï PADDING (12px)
                        html += `
  <td class="jour-calendrier ${classeCSS}" 
      data-semaine="${numSemaine || ''}" 
      data-date="${dateStr}"
      data-type="${statut.type}"
      style="padding: 14px; text-align: center; border: 1px solid #e8e8e8; 
             position: relative; cursor: pointer; transition: all 0.2s ease; vertical-align: center;"
      onmouseenter="illuminerSemaineAm√©lior√©e('${dateStr}')" 
      onmouseleave="desilluminerSemaines()"
      ${statut.type === 'cours-reel' ? `onclick="ouvrirSaisiePresence('${dateStr}')"` : ''}
      title="${tooltip}">
                    <div style="font-size: 1rem; font-weight: 400;">${jourActuel}</div>
                    ${afficherBadge && statut.label ?
                                `<div style="font-size: 0.7rem; font-weight: 600; margin-top: 4px; padding: 2px 6px; background: var(--bleu-moyen); color: white; border-radius: 4px; display: inline-block;">${statut.label}</div>` : ''}
                  </td>
                `;

                        jourActuel++;
                    }
                }

                html += '</tr>';
            }

            html += '</tbody></table></div>';

            return html;
        }


        // NOUVELLE FONCTION : V√©rifier si c'est le premier jour d'une semaine
        function estPremierJourSemaine(dateStr, mapSemaines) {
            const numSemaine = mapSemaines[dateStr];
            if (!numSemaine) return false;

            // Trouver tous les jours de cette semaine
            const joursSemaine = Object.keys(mapSemaines).filter(d => mapSemaines[d] === numSemaine).sort();

            // V√©rifier si c'est le premier
            return joursSemaine[0] === dateStr;
        }

        // NOUVELLE FONCTION : G√©n√©rer le titre tooltip
        function genererTitreTooltip(dateStr, statut, numSemaine, config, mapSemaines) {
            if (statut.type === 'weekend') return 'Weekend';
            if (statut.type === 'conge') return 'Cong√©';
            if (statut.type === 'planification') return 'Semaine de planification';
            if (statut.type === 'examens') return 'Semaine d\'examens';

            if (numSemaine) {
                // Trouver tous les jours de cette semaine
                const joursSemaine = Object.keys(mapSemaines)
                    .filter(d => mapSemaines[d] === numSemaine)
                    .sort();

                if (joursSemaine.length > 0) {
                    const premierJour = creerDateLocale(joursSemaine[0]);
                    const dernierJour = creerDateLocale(joursSemaine[joursSemaine.length - 1]);

                    const premierJourNom = obtenirNomJour(premierJour);
                    const dernierJourNom = obtenirNomJour(dernierJour);

                    const premierJourDate = joursSemaine[0].split('-')[2];
                    const dernierJourDate = joursSemaine[joursSemaine.length - 1].split('-')[2];

                    return `Semaine ${numSemaine} : du ${premierJourDate} (${premierJourNom}) au ${dernierJourDate} (${dernierJourNom})`;
                }
            }

            return statut.type === 'reprise' ? 'Reprise' : 'Jour de cours';
        }


        function illuminerSemaineAm√©lior√©e(dateStr) {
            const cellule = document.querySelector(`[data-date="${dateStr}"]`);
            if (!cellule) return;

            const numSemaine = cellule.getAttribute('data-semaine');
            if (!numSemaine) return;

            const joursSemaine = document.querySelectorAll(`[data-semaine="${numSemaine}"]`);
            joursSemaine.forEach(jour => {
                const type = jour.getAttribute('data-type');

            });
        }

        function desilluminerSemaines() {
            // Retire la classe 'hover-semaine'
        }

        // NOUVELLE FONCTION : D√©silluminer toutes les semaines
        function desilluminerSemaines() {
            const tousLesJours = document.querySelectorAll('.jour-calendrier');
            tousLesJours.forEach(jour => {
                jour.style.boxShadow = '';
                jour.style.transform = '';
                jour.style.zIndex = '';
            });
        }

        // === FONCTION PRINCIPALE : AFFICHER LE CALENDRIER ===

        function afficherCalendrierScolaire() {
            console.log('üîµ G√©n√©ration du calendrier scolaire...');

            // R√©cup√©rer les param√®tres depuis localStorage
            const cadreCalendrier = JSON.parse(localStorage.getItem('cadreCalendrier') || '{}');
            const congesEtReprises = JSON.parse(localStorage.getItem('congesEtReprises') || '[]');

            // Configuration par d√©faut (valeurs du calendrier officiel automne 2025)
            const config = {
                debutTrimestre: cadreCalendrier.debutTrimestre || '2025-08-21',
                finCours: cadreCalendrier.finCours || '2025-12-12',
                semainePlanification: {
                    debut: cadreCalendrier.semainePlanificationDebut || '2025-10-13',
                    fin: cadreCalendrier.semainePlanificationFin || '2025-10-17'
                },
                semaineExamens: {
                    debut: cadreCalendrier.semaineExamensDebut || '2025-12-15',
                    fin: cadreCalendrier.semaineExamensFin || '2025-12-22'
                },
                conges: congesEtReprises.length > 0 ? congesEtReprises : [
                    { date: '2025-09-01', reprise: '2025-09-04', motif: 'F√™te du travail' },
                    { date: '2025-11-10', reprise: '2025-11-14', motif: 'Journ√©e Carri√®re' }
                ]
            };

            // G√©n√©rer les semaines scolaires
            const { joursOuvrables, semaines } = genererSemainesScolaires(config);

            // Cr√©er la map dates -> num√©ros de semaines
            const mapDateVersNumeroSemaine = {};
            semaines.forEach(sem => {
                sem.jours.forEach(j => {
                    mapDateVersNumeroSemaine[j.date] = sem.numero;
                });
            });

            // G√©n√©rer le HTML du calendrier complet
            let htmlCalendrier = `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin: 16px 0;">
    `;

            // D√©terminer les mois √† afficher selon la session
            const session = cadreCalendrier.session || 'A'; // A = Automne, H = Hiver
            const annee = parseInt(cadreCalendrier.annee || '2025');
            const moisAAfficher = session === 'A' ? [8, 9, 10, 11, 12] : [1, 2, 3, 4, 5];

            moisAAfficher.forEach(m => {
                htmlCalendrier += genererHtmlMois(annee, m, config, mapDateVersNumeroSemaine);
            });

            htmlCalendrier += '</div>';

            // Ajouter la l√©gende
            htmlCalendrier += `
<div style="margin-top: 30px; padding: 20px; background: var(--bleu-tres-pale); border-radius: 8px; 
            border: 2px solid var(--bleu-pale);">
  <h4 style="margin: 0 0 15px 0; color: var(--bleu-principal);">üìç L√©gende</h4>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 28px; height: 28px; background: var(--bleu-leger); border-radius: 4px;"></div>
      <span style="color: var(--bleu-principal);"><strong>Jour de cours r√©gulier</strong></span>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 28px; height: 28px; background: white; border-radius: 4px; 
                  border: 2px solid #e8e8e8;"></div>
      <span style="color: var(--bleu-principal);">Jour ouvrable</span>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 28px; height: 28px; background: #9370DB; border-radius: 4px;"></div>
      <span style="color: var(--bleu-principal);">Reprise</span>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 28px; height: 28px; background: #dc3545; border-radius: 4px;"></div>
      <span style="color: var(--bleu-principal);">Cong√© pr√©vu au calendrier</span>
    </div>
  </div>
</div>
`;

            // Statistiques
            htmlCalendrier = `
    <div style="margin-bottom: 20px;">
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <div style="background: var(--bleu-pale); padding: 20px; border-radius: 8px; text-align: center; 
                    border: 2px solid var(--bleu-carte);">
          <div style="font-size: 2rem; font-weight: 600; color: var(--bleu-principal);">${semaines.length}</div>
          <div style="color: var(--bleu-moyen); font-size: 0.9rem; margin-top: 5px;">Semaines scolaires</div>
        </div>
        <div style="background: var(--bleu-pale); padding: 20px; border-radius: 8px; text-align: center; 
                    border: 2px solid var(--bleu-carte);">
          <div style="font-size: 2rem; font-weight: 600; color: var(--bleu-principal);">${joursOuvrables.length}</div>
          <div style="color: var(--bleu-moyen); font-size: 0.9rem; margin-top: 5px;">Jours de cours</div>
        </div>
        <div style="background: var(--bleu-pale); padding: 20px; border-radius: 8px; text-align: center; 
                    border: 2px solid var(--bleu-carte);">
          <div style="font-size: 2rem; font-weight: 600; color: var(--bleu-principal);">${config.conges.length}</div>
          <div style="color: var(--bleu-moyen); font-size: 0.9rem; margin-top: 5px;">Cong√©s avec reprises</div>
        </div>
      </div>
    </div>
    ` + htmlCalendrier;

            // Injecter dans le DOM
            const conteneurCalendrier = document.getElementById('presences-calendrier');
            if (conteneurCalendrier) {
                const carteCalendrier = conteneurCalendrier.querySelector('.carte') || conteneurCalendrier;
                const conteneur = carteCalendrier.querySelector('#conteneur-calendrier');

                if (conteneur) {
                    conteneur.innerHTML = htmlCalendrier;
                    console.log('‚úÖ Calendrier scolaire affich√© avec succ√®s');
                    console.log(`   - ${semaines.length} semaines | ${joursOuvrables.length} jours`);
                } else {
                    console.error('‚ùå √âl√©ment #conteneur-calendrier introuvable');
                }
            } else {
                console.error('‚ùå Section #presences-calendrier introuvable');
            }
        }

        /* ===============================
           INITIALISATION
           =============================== */

        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Initialisation du syst√®me de monitorage v3.0');

            // ========================================
            // NAVIGATION PRINCIPALE
            // ========================================
            document.querySelectorAll('.navigation-principale button').forEach(bouton => {
                bouton.addEventListener('click', function () {
                    const onglet = this.getAttribute('data-onglet');
                    afficherSection(onglet);
                });
            });

            // Afficher la premi√®re section par d√©faut
            afficherSection('tableau-bord');

            // ========================================
            // CHARGEMENTS CONDITIONNELS PAR SECTION
            // ========================================

            // Aper√ßu des r√©glages
            if (document.getElementById('reglages-apercu')) {
                chargerStatistiquesApercu();
            }

            // Calendrier
            if (document.getElementById('reglages-calendrier')) {
                chargerCadreCalendrier();
                chargerEvenementsPrevus();
                chargerEvenementsImprevus();
            }

            // Pratique de notation
            if (document.getElementById('reglages-pratique-notation')) {
                chargerModalites();
            }

            // ========================================
            // CHARGEMENTS GLOBAUX
            // ========================================
            initialiserDonneesDemonstration();
            chargerSeances();
            chargerDisponibilites();
            afficherListeEtudiants();
            afficherTableauProductions();
            mettreAJourPonderationTotale();
            chargerListeGrillesTemplates();
            initialiserEchelle();
            initialiserRetroactions();
            initialiserEvaluationsIndividuelles();
            chargerGrillesDansSelect();
            chargerEchellePerformance();
            chargerEchellesTemplates();
            chargerListeGroupes();
            chargerGroupesEvaluation();
            filtrerEtudiantsParGroupe();
            afficherCalendrierScolaire();
            chargerGroupesPresences();
            initialiserSaisiePresences();
            mettreAJourHorodatage();

            // ========================================
            // GESTION FORMAT HORAIRE
            // ========================================
            const radios = document.querySelectorAll('input[name="formatHoraire"]');
            if (radios.length > 0) {
                const formatSauvegarde = localStorage.getItem('formatHoraire') || '';
                if (formatSauvegarde) {
                    const radioToCheck = document.querySelector(`input[name="formatHoraire"][value="${formatSauvegarde}"]`);
                    if (radioToCheck) radioToCheck.checked = true;
                }

                radios.forEach(radio => {
                    radio.addEventListener('change', function () {
                        if (this.checked) {
                            localStorage.setItem('formatHoraire', this.value);
                            afficherFormulaireSeances();
                        }
                    });
                });
            }

            // ========================================
            // √âV√âNEMENTS
            // ========================================

            // S√©lecteur d'√©tudiant
            const selectEtudiant = document.getElementById('select-etudiant');
            if (selectEtudiant) {
                selectEtudiant.addEventListener('change', function () {
                    chargerDetailEtudiant(this.value);
                });
            }

            // Affichage des cours
            document.addEventListener('click', function (e) {
                if (e.target.matches('[data-sous-onglet="reglages-cours"]')) {
                    setTimeout(() => afficherTableauCours(), 50);
                }
            });

            console.log('‚úÖ Syst√®me initialis√© avec succ√®s');
        });

        /* ===============================
           DONN√âES DE D√âMONSTRATION
           =============================== */

        // Liste des √©tudiants (donn√©es de d√©monstration)
        const listeEtudiants = [
            { id: 1, da: '1234567', nom: 'Beaulieu', prenom: 'Emma', statut: 'actif' },
            { id: 2, da: '1234568', nom: 'B√©langer', prenom: 'Jacob', statut: 'actif' },
            { id: 3, da: '1234569', nom: 'Bergeron', prenom: 'Rosalie', statut: 'actif' },
            { id: 4, da: '1234570', nom: 'Bouchard', prenom: 'Thomas', statut: 'actif' },
            { id: 5, da: '1234571', nom: 'Boucher', prenom: 'Charles', statut: 'actif' },
            { id: 6, da: '1234572', nom: 'C√¥t√©', prenom: 'Florence', statut: 'actif' },
            { id: 7, da: '1234573', nom: 'Dubois', prenom: 'Olivier', statut: 'actif' }
        ];

        /**
         * Initialise les donn√©es de d√©monstration dans les tableaux
         */
        function initialiserDonneesDemonstration() {
            // Remplir la Liste des √©tudiant¬∑es
            const tbodyListeComplete = document.getElementById('tbody-liste-complete');
            if (tbodyListeComplete) {
                tbodyListeComplete.innerHTML = listeEtudiants.map(etudiant => `
                    <tr>
                        <td>${etudiant.nom}, ${etudiant.prenom}</td>
                        <td>87%</td>
                        <td>75%</td>
                        <td>72%</td>
                        <td><span class="badge-risque risque-faible">Faible</span></td>
                        <td><button class="btn btn-principal" onclick="afficherDetailEtudiant(${etudiant.id})">D√©tails</button></td>
                    </tr>
                `).join('');
            }

            // Remplir la liste des √©tudiants
            const tbodyEtudiants = document.getElementById('tbody-etudiants');
            if (tbodyEtudiants) {
                tbodyEtudiants.innerHTML = listeEtudiants.map(etudiant => `
                    <tr>
                        <td>${echapperHtml(etudiant.nom)}</td>
                        <td>${echapperHtml(etudiant.prenom)}</td>
                        <td>${echapperHtml(etudiant.da)}</td>
                        <td><span class="badge-risque risque-minimal">Actif</span></td>
                        <td>
                            <button class="btn btn-modifier">Modifier</button>
                            <button class="btn btn-supprimer">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        /**
         * Charge les d√©tails d'un √©tudiant
         * @param {string} id - L'identifiant de l'√©tudiant
         */
        function chargerDetailEtudiant(id) {
            const conteneurDetail = document.getElementById('detail-etudiant-contenu');
            if (!conteneurDetail || !id) {
                if (conteneurDetail) {
                    conteneurDetail.innerHTML = '<p class="text-muted">S√©lectionnez un¬∑e √©tudiant¬∑e pour voir ses d√©tails.</p>';
                }
                return;
            }

            // Trouver l'√©tudiant
            const etudiant = listeEtudiants.find(e => e.id == id);
            if (etudiant) {
                conteneurDetail.innerHTML = `
                    <div class="carte">
                        <h3>${etudiant.nom}, ${etudiant.prenom}</h3>
                        <p><strong>DA :</strong> ${etudiant.da}</p>
                        <p><strong>Statut :</strong> Actif</p>
                        
                        <div class="grille-statistiques mt-3">
                            <div class="carte-statistique">
                                <div class="valeur">87%</div>
                                <div class="label">Assiduit√©</div>
                            </div>
                            <div class="carte-statistique">
                                <div class="valeur">75%</div>
                                <div class="label">Compl√©tion</div>
                            </div>
                            <div class="carte-statistique">
                                <div class="valeur">72%</div>
                                <div class="label">Performance</div>
                            </div>
                        </div>

                        <h4 class="mt-3">Derni√®res √©valuations</h4>
                        <table class="tableau">
                            <thead>
                                <tr>
                                    <th>√âvaluation</th>
                                    <th>Date</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Analyse litt√©raire 1</td>
                                    <td>2025-09-15</td>
                                    <td>78%</td>
                                </tr>
                                <tr>
                                    <td>Quiz de lecture</td>
                                    <td>2025-09-10</td>
                                    <td>85%</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="btn-groupe mt-3">
                            <button class="btn btn-principal">Imprimer le profil</button>
                            <button class="btn btn-modifier">Modifier les informations</button>
                        </div>
                    </div>
                `;
            }
        }

        // === GESTION DU GROUPE D'√âTUDIANTS ===

        // Variable temporaire pour stocker les donn√©es d'importation
        let tempImportData = [];

        // Fonction pour afficher les notifications de succ√®s
        function afficherNotificationSucces(message, details = null) {
            // Cr√©er l'√©l√©ment notification
            const notification = document.createElement('div');
            notification.className = 'notification-succes';

            let contenu = `‚úì ${message}`;
            if (details) {
                contenu += `<div class="notification-details">${details}</div>`;
            }
            notification.innerHTML = contenu;

            // Ajouter au body
            document.body.appendChild(notification);

            // Retirer apr√®s 7 secondes (plus long si d√©tails)
            const duree = details ? 7000 : 5000;
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease';

                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, duree);
        }

        function afficherNotification(message, details = null) {
            afficherNotificationSucces(message, details);
        }

        // Fonction pour afficher les notifications d'erreur
        function afficherNotificationErreur(message, details = null) {
            // Cr√©er l'√©l√©ment notification
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--risque-critique);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;

            let contenu = `‚úó ${message}`;
            if (details) {
                contenu += `<div style="margin-top: 5px; font-size: 0.9rem; opacity: 0.9;">${details}</div>`;
            }
            notification.innerHTML = contenu;

            // Ajouter au body
            document.body.appendChild(notification);

            // Retirer apr√®s 8 secondes (plus long pour les erreurs)
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease';

                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 8000);
        }

        // Fonction pour afficher un modal de pr√©visualisation
        function afficherPrevisualisation(etudiants, titre = "Pr√©visualisation") {
            const modalHTML = `
        <div id="modalPrevisualisation" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
             background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 8px; max-width: 800px; 
                 width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 20px; color: var(--bleu-principal);">${titre}</h3>
                
                <div style="margin-bottom: 15px; padding: 10px; background: var(--vert-pale); 
                     border-radius: 6px; border: 1px solid var(--vert-leger);">
                    <strong style="color: var(--vert-leger);">‚úì ${etudiants.length} √©tudiant¬∑e(s) ajout√©¬∑e(s) avec succ√®s</strong>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="tableau" style="width: 100%; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: var(--bleu-principal); color: white; position: sticky; top: 0;">
                                <th style="padding: 8px;">DA</th>
                                <th style="padding: 8px;">Groupe</th>
                                <th style="padding: 8px;">Nom</th>
                                <th style="padding: 8px;">Pr√©nom</th>
                                <th style="padding: 8px;">Programme</th>
                                <th style="padding: 8px;">SA</th>
                                <th style="padding: 8px;">CAF</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${etudiants.map((s, index) => `
                                <tr style="background: ${index % 2 === 0 ? 'white' : 'var(--bleu-tres-pale)'};">
                                    <td style="padding: 6px;">${s.da}</td>
                                    <td style="padding: 6px; text-align: center;">${s.groupe}</td>
                                    <td style="padding: 6px;">${s.nom}</td>
                                    <td style="padding: 6px;">${s.prenom}</td>
                                    <td style="padding: 6px;">${s.programme}</td>
                                    <td style="padding: 6px; text-align: center;">${s.sa === 'Oui' ? '‚úì' : ''}</td>
                                    <td style="padding: 6px; text-align: center;">${s.caf === 'Oui' ? '‚úì' : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.9rem; color: var(--bleu-moyen);">
                        Total dans le groupe : <strong>${JSON.parse(localStorage.getItem('groupeEtudiants') || '[]').length} √©tudiant¬∑es</strong>
                    </div>
                    <button class="btn btn-principal" onclick="fermerModalPrevisualisation()">Fermer</button>
                </div>
            </div>
        </div>
    `;

            // Ajouter le modal au body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
        }

        function fermerModalPrevisualisation() {
            const modal = document.getElementById('modalPrevisualisation');
            if (modal) {
                modal.remove();
            }
        }

        // Fonction pour basculer le verrouillage du groupe
        function basculerVerrouillageGroupe() {
            const verrouille = document.getElementById('verrouillerGroupe').checked;
            localStorage.setItem('groupeVerrouille', JSON.stringify(verrouille));
            afficherListeEtudiants();
        }

        // Fonctions d'importation
        function importFromFile() {
            document.getElementById('pasteZone').style.display = 'none';
            document.getElementById('fileUploadZone').style.display = 'block';
            document.getElementById('previewZone').style.display = 'none';
        }

        function importFromPaste() {
            document.getElementById('fileUploadZone').style.display = 'none';
            document.getElementById('pasteZone').style.display = 'block';
            document.getElementById('previewZone').style.display = 'none';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                try {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            // Au lieu d'analyser directement, charger dans le textarea
                            const fileContent = e.target.result;

                            // Basculer vers la zone de copier-coller
                            document.getElementById('fileUploadZone').style.display = 'none';
                            document.getElementById('pasteZone').style.display = 'block';
                            document.getElementById('previewZone').style.display = 'none';

                            // Remplir le textarea avec le contenu du fichier
                            document.getElementById('donneesCollees').value = fileContent;

                            // Notification pour informer l'utilisateur
                            afficherNotificationSucces(
                                'Fichier charg√© avec succ√®s',
                                'Vous pouvez maintenant v√©rifier et modifier les donn√©es avant de les analyser'
                            );

                            // Focus sur le textarea pour montrer qu'on peut √©diter
                            document.getElementById('donneesCollees').focus();

                        } catch (error) {
                            afficherNotificationErreur(
                                'Erreur lors de la lecture du fichier',
                                `Le fichier semble corrompu ou dans un format non support√©. Erreur: ${error.message}`
                            );
                            console.error('Erreur parsing:', error);
                        }
                    };
                    reader.onerror = function () {
                        afficherNotificationErreur(
                            'Impossible de lire le fichier',
                            'V√©rifiez que le fichier n\'est pas corrompu'
                        );
                    };
                    reader.readAsText(file);
                } catch (error) {
                    afficherNotificationErreur(
                        'Erreur lors du chargement',
                        error.message
                    );
                }
            }
        }

        function parseDataFromTextarea() {
            const data = document.getElementById('donneesCollees').value;
            if (!data || data.trim() === '') {
                afficherNotificationErreur(
                    'Aucune donn√©e √† analyser',
                    'Veuillez coller des donn√©es dans le champ texte'
                );
                return;
            }

            try {
                console.log('Donn√©es √† analyser:', data); // Pour debug
                parseCSVData(data);
            } catch (error) {
                afficherNotificationErreur(
                    'Erreur lors de l\'analyse des donn√©es',
                    `Format non reconnu. Erreur: ${error.message}`
                );
                console.error('Erreur parsing:', error);
            }
        }

        // Fonction principale de parsing CSV
        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const students = [];
            let lignesIgnorees = 0;
            let erreurs = [];

            // Fonction pour nettoyer les valeurs
            function cleanValue(value) {
                if (!value) return '';
                // Enlever les = et les guillemets en d√©but et fin
                return value.toString()
                    .replace(/^="?/, '')  // Enlever = et " au d√©but
                    .replace(/"?$/, '')   // Enlever " √† la fin
                    .replace(/^"/, '')    // Enlever " restant au d√©but
                    .replace(/"$/, '')    // Enlever " restant √† la fin
                    .trim();
            }

            // D√©terminer le s√©parateur (tab, virgule, point-virgule)
            let separator = '\t';
            if (lines[0].includes('\t')) {
                separator = '\t';
            } else if (lines[0].includes(';')) {
                separator = ';';
            } else if (lines[0].includes(',')) {
                separator = ',';
            } else {
                separator = /\s{2,}/;
            }

            // Ignorer l'en-t√™te si pr√©sent
            let startIndex = 0;
            const firstLine = lines[0].toLowerCase();
            if (firstLine.includes('da') || firstLine.includes('nom') || firstLine.includes('√©tudiant')) {
                startIndex = 1;
            }

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) {
                    lignesIgnorees++;
                    continue;
                }

                try {
                    const parts = line.split(separator).map(p => cleanValue(p)); // Nettoyer chaque valeur

                    if (parts.length >= 2) {
                        let da = '', groupe = '', nom = '', prenom = '', programme = '', sa = '';

                        // Format avec toutes les colonnes
                        if (parts.length >= 4) {
                            da = parts[0] || '';
                            groupe = parts[1] || '1';
                            nom = parts[2] || '';
                            prenom = parts[3] || '';
                            programme = parts[4] || '';
                            sa = parts[5] || '';
                        }
                        // Format nom complet dans une colonne
                        else if (parts.length === 3) {
                            da = parts[0] || '';
                            groupe = '1';
                            const nomComplet = parts[1].split(',');
                            if (nomComplet.length === 2) {
                                nom = nomComplet[0].trim();
                                prenom = nomComplet[1].trim();
                            } else {
                                const espaces = parts[1].split(' ');
                                nom = espaces[0] || '';
                                prenom = espaces.slice(1).join(' ') || '';
                            }
                            programme = parts[2] || '';
                        }
                        else {
                            da = parts[0] || '';
                            nom = parts[1] || '';
                            groupe = '1';
                            prenom = '';
                            programme = '';
                        }

                        // Ajouter seulement si on a au moins un DA ou un nom
                        if (da || nom) {
                            students.push({
                                id: Date.now() + i,
                                da: da || `AUTO-${Date.now() + i}`,
                                groupe: groupe,
                                nom: nom,
                                prenom: prenom,
                                programme: programme || '---',
                                sa: sa,
                                caf: ''
                            });
                        } else {
                            erreurs.push(`Ligne ${i + 1}: Donn√©es incompl√®tes (ni DA ni nom)`);
                            lignesIgnorees++;
                        }
                    } else {
                        erreurs.push(`Ligne ${i + 1}: Format invalide (moins de 2 colonnes)`);
                        lignesIgnorees++;
                    }
                } catch (error) {
                    erreurs.push(`Ligne ${i + 1}: Erreur de traitement`);
                    lignesIgnorees++;
                }
            }

            if (students.length > 0) {
                tempImportData = students;
                showPreview(students);  // AJOUT : Afficher la pr√©visualisation
                afficherNotificationSucces(
                    `${students.length} √©tudiant¬∑e(s) analys√©¬∑e(s) avec succ√®s`,
                    lignesIgnorees > 0 ? `${lignesIgnorees} lignes ignor√©es` : null
                );
            } else {
                afficherNotificationErreur(
                    'Aucune donn√©e valide trouv√©e',
                    erreurs.length > 0 ? `Erreurs: ${erreurs.slice(0, 3).join(', ')}...` : 'V√©rifiez le format des donn√©es'
                );
            }
        }


        function showPreview(students) {
            const previewDiv = document.getElementById('previewTable');

            if (!students || students.length === 0) {
                previewDiv.innerHTML = '<p style="color: red;">Aucune donn√©e √† afficher</p>';
                return;
            }

            const html = `
    <div style="padding: 10px; background: var(--vert-pale); border: 1px solid var(--vert-leger); 
         border-radius: 6px; margin-bottom: 10px;">
        <strong style="color: var(--vert-leger);">‚úì ${students.length} √©tudiant¬∑e(s) pr√™t¬∑e(s) √† importer</strong>
    </div>
    <p style="margin-bottom: 10px; font-weight: bold;">V√©rifiez les donn√©es avant l'importation :</p>
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="tableau" style="font-size: 0.85rem;">
                <thead>
                    <tr style="background: var(--bleu-principal); color: white;">
                        <th style="padding: 8px;">#</th>
                        <th style="padding: 8px;">DA</th>
                        <th style="padding: 8px;">Groupe</th>
                        <th style="padding: 8px;">Nom</th>
                        <th style="padding: 8px;">Pr√©nom</th>
                        <th style="padding: 8px;">Programme</th>
                        <th style="padding: 8px;">Services adapt√©s</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map((s, index) => `
                        <tr style="background: ${index % 2 === 0 ? 'white' : 'var(--bleu-tres-pale)'};">
                            <td style="padding: 6px; text-align: center;">${index + 1}</td>
                            <td style="padding: 6px;">${s.da || '‚Äî'}</td>
                            <td style="padding: 6px; text-align: center;">${s.groupe || '1'}</td>
                            <td style="padding: 6px;">${s.nom || '‚Äî'}</td>
                            <td style="padding: 6px;">${s.prenom || '‚Äî'}</td>
                            <td style="padding: 6px;">${s.programme || '‚Äî'}</td>
                            <td style="padding: 6px; text-align: center;">${s.sa || '‚Äî'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

            previewDiv.innerHTML = html;
            document.getElementById('importCount').textContent = students.length;
            document.getElementById('previewZone').style.display = 'block';
        }

        function cancelImport() {
            tempImportData = [];
            document.getElementById('previewZone').style.display = 'none';
            // On ne r√©initialise PAS les champs pour permettre de corriger
            afficherNotificationSucces('Importation annul√©e - Vous pouvez corriger et r√©essayer');
        }

        function confirmImport() {
            try {
                let students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
                const ancienTotal = students.length;
                const nouveauxEtudiants = [...tempImportData]; // Copie pour la pr√©visualisation

                // V√©rifier les doublons
                let doublons = 0;
                tempImportData.forEach(newStudent => {
                    const existe = students.find(s => s.da === newStudent.da && newStudent.da !== '');
                    if (existe) {
                        doublons++;
                    }
                });

                if (doublons > 0) {
                    if (!confirm(`Attention : ${doublons} √©tudiant¬∑e(s) avec le m√™me DA existe(nt) d√©j√†. Continuer quand m√™me ?`)) {
                        return;
                    }
                }

                students = students.concat(tempImportData);
                localStorage.setItem('groupeEtudiants', JSON.stringify(students));

                // Afficher pr√©visualisation
                afficherPrevisualisation(nouveauxEtudiants, 'Importation r√©ussie');

                // Notification de succ√®s avec d√©tails
                const details = `Groupe : ${ancienTotal} ‚Üí ${students.length} √©tudiant¬∑es (+ ${tempImportData.length})`;
                afficherNotificationSucces('Importation r√©ussie !', details);

                // Nettoyer et r√©initialiser
                tempImportData = [];
                document.getElementById('previewZone').style.display = 'none';
                document.getElementById('donneesCollees').value = '';
                document.getElementById('fichierCsvEntree').value = '';

                // Rafra√Æchir la liste imm√©diatement
                afficherListeEtudiants();

            } catch (error) {
                afficherNotificationErreur(
                    'Erreur lors de l\'importation',
                    `Les donn√©es n'ont pas pu √™tre sauvegard√©es. Erreur: ${error.message}`
                );
                console.error('Erreur importation:', error);
            }
        }

        // Ajout manuel d'un √©tudiant
        function addStudent() {
            const nom = document.getElementById('etudiantNom').value.trim();
            const prenom = document.getElementById('etudiantPrenom').value.trim();

            if (!nom || !prenom) {
                afficherNotificationErreur(
                    'Informations manquantes',
                    'Le nom et le pr√©nom sont obligatoires'
                );
                return;
            }

            try {
                const student = {
                    id: Date.now(),
                    da: document.getElementById('etudiantDA').value || `AUTO-${Date.now()}`,
                    groupe: document.getElementById('etudiantGroupe').value || '1',
                    nom: nom,
                    prenom: prenom,
                    programme: document.getElementById('etudiantProgramme').value || '---',
                    sa: document.getElementById('etudiantSA').value || '',
                    caf: document.getElementById('etudiantCAF').value || ''
                };

                let students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

                // V√©rifier les doublons
                if (student.da !== '' && !student.da.startsWith('AUTO-')) {
                    const existe = students.find(s => s.da === student.da);
                    if (existe) {
                        if (!confirm(`Un¬∑e √©tudiant¬∑e avec le DA ${student.da} existe d√©j√†. Continuer quand m√™me ?`)) {
                            return;
                        }
                    }
                }

                students.push(student);
                localStorage.setItem('groupeEtudiants', JSON.stringify(students));

                // Afficher pr√©visualisation de l'√©tudiant ajout√©
                afficherPrevisualisation([student], '√âtudiant¬∑e ajout√©¬∑e');

                // R√©initialiser le formulaire
                document.getElementById('etudiantDA').value = '';
                document.getElementById('etudiantGroupe').value = '';
                document.getElementById('etudiantNom').value = '';
                document.getElementById('etudiantPrenom').value = '';
                document.getElementById('etudiantProgramme').value = '';
                document.getElementById('etudiantSA').value = '';
                document.getElementById('etudiantCAF').value = '';

                const details = `${student.nom}, ${student.prenom} (DA: ${student.da})`;
                afficherNotificationSucces('√âtudiant¬∑e ajout√©¬∑e avec succ√®s !', details);
                afficherListeEtudiants();
                chargerListeGroupes(); // Recharger la liste des groupes

            } catch (error) {
                afficherNotificationErreur(
                    'Erreur lors de l\'ajout',
                    `L'√©tudiant¬∑e n'a pas pu √™tre ajout√©¬∑e. Erreur: ${error.message}`
                );
                console.error('Erreur ajout:', error);
            }
        }

        // Affichage de la liste des √©tudiants
        function afficherListeEtudiants() {
            try {
                const students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
                const verrouille = JSON.parse(localStorage.getItem('groupeVerrouille') || 'false');
                const tbody = document.getElementById('students-tbody');
                const table = document.getElementById('students-table');
                const container = document.getElementById('students-list-container');
                const noMsg = document.getElementById('no-students-msg');

                if (students.length === 0) {
                    // Masquer le container de la table et afficher le message
                    if (container) container.style.display = 'none';
                    if (noMsg) noMsg.style.display = 'block';
                    return;
                }

                // Afficher le container et masquer le message
                if (container) container.style.display = 'block';
                if (noMsg) noMsg.style.display = 'none';

                tbody.innerHTML = students.map(s => `
            <tr>
                <td>${s.da}</td>
                <td style="text-align: center;">${s.groupe}</td>
                <td>${s.nom}</td>
                <td>${s.prenom}</td>
                <td>${s.programme}</td>
                <td style="text-align: center;">${s.sa === 'Oui' ? '‚úì' : ''}</td>
                <td style="text-align: center;">${s.caf === 'Oui' ? '‚úì' : ''}</td>
                <td>
    <button class="btn btn-principal" onclick="afficherProfilEtudiant('${s.da}')" 
        style="padding: 5px 10px; font-size: 0.85rem; margin-right: 5px;">
        üìä Portfolio
    </button>
    <button class="btn btn-modifier" onclick="modifierEtudiant('${s.id || s.da}')" 
        style="padding: 5px 10px; font-size: 0.85rem; opacity: ${verrouille ? '0.5' : '1'};"
        ${verrouille ? 'disabled' : ''}>
        Modifier
    </button>
    <button class="btn btn-supprimer" onclick="supprimerEtudiant('${s.id || s.da}')" 
        style="padding: 5px 10px; font-size: 0.85rem; opacity: ${verrouille ? '0.5' : '1'};"
        ${verrouille ? 'disabled' : ''}>
        Supprimer
    </button>
</td>
            </tr>
        `).join('');

            } catch (error) {
                console.error('Erreur affichage liste:', error);
            }
        }

        // Modifier un √©tudiant
        function modifierEtudiant(id) {
            const verrouille = JSON.parse(localStorage.getItem('groupeVerrouille') || 'false');
            if (verrouille) {
                afficherNotificationErreur(
                    'Modification impossible',
                    'D√©cochez "üîí" avant de modifier'
                );
                return;
            }

            const students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const student = students.find(s => (s.id == id || s.da == id));

            if (!student) {
                afficherNotificationErreur('√âtudiant¬∑e non trouv√©¬∑e');
                return;
            }

            // Cr√©er un formulaire de modification modal
            const modalHTML = `
        <div id="modalModification" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%;">
                <h3 style="margin-bottom: 20px; color: var(--bleu-principal);">Modifier l'√©tudiant¬∑e</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="groupe-form">
                        <label>DA :</label>
                        <input type="text" id="modif-da" class="controle-form" value="${student.da}">
                    </div>
                    <div class="groupe-form">
                        <label>Groupe :</label>
                        <input type="text" id="modif-groupe" class="controle-form" value="${student.groupe}">
                    </div>
                    <div class="groupe-form">
                        <label>Nom :</label>
                        <input type="text" id="modif-nom" class="controle-form" value="${student.nom}">
                    </div>
                    <div class="groupe-form">
                        <label>Pr√©nom :</label>
                        <input type="text" id="modif-prenom" class="controle-form" value="${student.prenom}">
                    </div>
                    <div class="groupe-form">
                        <label>Programme :</label>
                        <input type="text" id="modif-programme" class="controle-form" value="${student.programme}">
                    </div>
                    <div class="groupe-form">
                        <label>Services adapt√©s :</label>
                        <select id="modif-sa" class="controle-form">
                            <option value="" ${student.sa !== 'Oui' ? 'selected' : ''}>Non</option>
                            <option value="Oui" ${student.sa === 'Oui' ? 'selected' : ''}>Oui</option>
                        </select>
                    </div>
                    <div class="groupe-form">
                        <label>Centre d'aide en fran√ßais :</label>
                        <select id="modif-caf" class="controle-form">
                            <option value="" ${student.caf !== 'Oui' ? 'selected' : ''}>Non</option>
                            <option value="Oui" ${student.caf === 'Oui' ? 'selected' : ''}>Oui</option>
                        </select>
                    </div>
                </div>
                
                <div class="btn-groupe" style="justify-content: flex-end;">
                    <button class="btn btn-annuler" onclick="fermerModalModification()">Annuler</button>
                    <button class="btn btn-confirmer" onclick="sauvegarderModificationEtudiant('${id}')">Sauvegarder</button>
                </div>
            </div>
        </div>
    `;

            // Ajouter le modal au body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
        }

        function fermerModalModification() {
            const modal = document.getElementById('modalModification');
            if (modal) {
                modal.parentElement.remove();
            }
        }

        function sauvegarderModificationEtudiant(id) {
            try {
                let students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
                const index = students.findIndex(s => (s.id == id || s.da == id));

                if (index !== -1) {
                    const ancienEtudiant = { ...students[index] };

                    students[index] = {
                        ...students[index],
                        da: document.getElementById('modif-da').value,
                        groupe: document.getElementById('modif-groupe').value,
                        nom: document.getElementById('modif-nom').value,
                        prenom: document.getElementById('modif-prenom').value,
                        programme: document.getElementById('modif-programme').value,
                        sa: document.getElementById('modif-sa').value,
                        caf: document.getElementById('modif-caf').value
                    };

                    localStorage.setItem('groupeEtudiants', JSON.stringify(students));
                    fermerModalModification();
                    afficherListeEtudiants();

                    const details = `${ancienEtudiant.nom}, ${ancienEtudiant.prenom} ‚Üí ${students[index].nom}, ${students[index].prenom}`;
                    afficherNotificationSucces('√âtudiant¬∑e modifi√©¬∑e avec succ√®s !', details);
                }
            } catch (error) {
                afficherNotificationErreur(
                    'Erreur lors de la modification',
                    error.message
                );
            }
        }

        // Supprimer un √©tudiant
        function supprimerEtudiant(id) {
            const verrouille = JSON.parse(localStorage.getItem('groupeVerrouille') || 'false');
            if (verrouille) {
                afficherNotificationErreur(
                    'Suppression impossible',
                    'D√©cochez "üîí" avant de supprimer'
                );
                return;
            }

            let students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const etudiantASupprimer = students.find(s => (s.id == id || s.da == id));

            if (!etudiantASupprimer) {
                afficherNotificationErreur('√âtudiant¬∑e non trouv√©¬∑e');
                return;
            }

            if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${etudiantASupprimer.nom}, ${etudiantASupprimer.prenom} ?`)) {
                try {
                    students = students.filter(s => !(s.id == id || s.da == id));
                    localStorage.setItem('groupeEtudiants', JSON.stringify(students));
                    afficherListeEtudiants();

                    const details = `${etudiantASupprimer.nom}, ${etudiantASupprimer.prenom} (DA: ${etudiantASupprimer.da})`;
                    afficherNotificationSucces('√âtudiant¬∑e supprim√©¬∑e', details);
                } catch (error) {
                    afficherNotificationErreur(
                        'Erreur lors de la suppression',
                        error.message
                    );
                }
            }
        }

        // Export des donn√©es
        function exportStudentsData() {
            try {
                const students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

                if (students.length === 0) {
                    afficherNotificationErreur(
                        'Aucune donn√©e √† exporter',
                        'Le groupe est vide'
                    );
                    return;
                }

                const csv = 'DA,Groupe,Nom,Pr√©nom,Programme,Services adapt√©s,CAF\n' +
                    students.map(s => `${s.da},${s.groupe},${s.nom},${s.prenom},${s.programme},${s.sa || ''},${s.caf || ''}`).join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateExport = new Date().toISOString().split('T')[0];
                a.download = `groupe_etudiants_${dateExport}.csv`;
                a.click();

                const details = `${students.length} √©tudiant¬∑es export√©¬∑es dans groupe_etudiants_${dateExport}.csv`;
                afficherNotificationSucces('Export r√©ussi !', details);
            } catch (error) {
                afficherNotificationErreur(
                    'Erreur lors de l\'export',
                    error.message
                );
            }
        }

        // R√©initialisation compl√®te du groupe
        function resetStudentsData() {
            const verrouille = JSON.parse(localStorage.getItem('groupeVerrouille') || 'false');
            if (verrouille) {
                afficherNotificationErreur(
                    'R√©initialisation impossible',
                    'D√©cochez "üîí" avant de r√©initialiser le groupe'
                );
                return;
            }

            const students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            if (students.length === 0) {
                afficherNotificationErreur(
                    'Groupe d√©j√† vide',
                    'Il n\'y a aucun¬∑e √©tudiant¬∑e √† supprimer'
                );
                return;
            }

            const confirmation = prompt(`Cette action supprimera TOUS les ${students.length} √©tudiant¬∑es du groupe.\n\nTapez "SUPPRIMER" pour confirmer :`);

            if (confirmation === 'SUPPRIMER') {
                try {
                    localStorage.setItem('groupeEtudiants', '[]');
                    afficherListeEtudiants();
                    afficherNotificationSucces(
                        'Groupe r√©initialis√©',
                        `${students.length} √©tudiant¬∑es supprim√©¬∑es d√©finitivement`
                    );
                } catch (error) {
                    afficherNotificationErreur(
                        'Erreur lors de la r√©initialisation',
                        error.message
                    );
                }
            } else if (confirmation !== null) {
                afficherNotificationErreur(
                    'R√©initialisation annul√©e',
                    'Vous devez taper exactement "SUPPRIMER" pour confirmer'
                );
            }
        }

        // === GESTION DES MODALIT√âS D'√âVALUATION ===

        function changerPratiqueNotation() {
            const pratique = document.getElementById('pratiqueNotation').value;
            const colonnePAN = document.getElementById('colonnePAN');
            const selectPAN = document.getElementById('typePAN');
            const infoPAN = document.getElementById('infoPAN');

            if (pratique === 'alternative') {
                // Afficher le menu PAN
                colonnePAN.style.display = 'block';
            } else {
                // Masquer le menu PAN
                colonnePAN.style.display = 'none';
                selectPAN.value = '';
                infoPAN.style.display = 'none';
            }

            // Sauvegarder dans modalitesEvaluation
            let modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
            modalites.pratique = pratique;
            localStorage.setItem('modalitesEvaluation', JSON.stringify(modalites));

            mettreAJourStatutModalites();
        }

        function mettreAJourResumeModalites() {
            const nombre = document.getElementById('nombreEvaluations').value;

            // Sauvegarder
            let modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
            modalites.nombreEvaluations = parseInt(nombre);
            localStorage.setItem('modalitesEvaluation', JSON.stringify(modalites));

            mettreAJourStatutModalites();
        }

        function mettreAJourStatutModalites() {
            const modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
            const statutDiv = document.getElementById('statutModalites');

            if (!statutDiv) {
                console.error('Element #statutModalites non trouv√©');
                return;
            }

            // V√©rifier le statut selon la pratique choisie
            if (!modalites.pratique) {
                statutDiv.innerHTML = '<span style="color: var(--risque-critique);">‚úó √Ä configurer</span>';
            } else if (modalites.pratique === 'sommative') {
                statutDiv.innerHTML = '<span style="color: var(--risque-minimal);">‚úì Sommative traditionnelle (en %)</span>';
            } else if (modalites.pratique === 'alternative' && modalites.typePAN) {
                const types = {
                    'maitrise': 'Ma√Ætrise',
                    'specifications': 'Sp√©cifications',
                    'denotation': 'D√©notation'
                };
                statutDiv.innerHTML = `<span style="color: var(--risque-minimal);">‚úì Alternative (${types[modalites.typePAN]})</span>`;
            } else if (modalites.pratique === 'alternative' && !modalites.typePAN) {
                statutDiv.innerHTML = '<span style="color: var(--risque-modere);">‚ö† Choisir un type de PAN</span>';
            }
        }

        function chargerModalites() {
            const modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');

            const selectPratique = document.getElementById('pratiqueNotation');
            const colonnePAN = document.getElementById('colonnePAN');
            const selectPAN = document.getElementById('typePAN');

            // S'assurer que les √©l√©ments existent avant de continuer
            if (!selectPratique || !colonnePAN || !selectPAN) {
                console.warn('√âl√©ments de formulaire non trouv√©s');
                return;
            }

            // Si pas de donn√©es sauvegard√©es, tout remettre √† z√©ro
            if (!modalites.pratique) {
                selectPratique.value = '';
                colonnePAN.style.display = 'none';
                selectPAN.value = '';
                mettreAJourStatutModalites();
                return;
            }

            // Charger la pratique de notation
            selectPratique.value = modalites.pratique;

            // G√©rer l'affichage du menu PAN
            if (modalites.pratique === 'alternative') {
                colonnePAN.style.display = 'block';

                // Charger le type de PAN si disponible
                if (modalites.typePAN) {
                    selectPAN.value = modalites.typePAN;
                    afficherInfoPAN();
                } else {
                    // Alternative choisie mais pas de type : forcer "Choisir..."
                    selectPAN.value = '';
                }
            } else {
                colonnePAN.style.display = 'none';
                selectPAN.value = '';
            }

            // Mettre √† jour le statut
            mettreAJourStatutModalites();
        }

        // Ajouter les fonctions de r√©organisation
        function monterEvaluation(id) {
            let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const index = evaluations.findIndex(e => e.id === id);

            if (index > 0) {
                [evaluations[index - 1], evaluations[index]] = [evaluations[index], evaluations[index - 1]];
                localStorage.setItem('listeGrilles', JSON.stringify(evaluations));
                afficherTableauProductions();
            }
        }

        function descendreEvaluation(id) {
            let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const index = evaluations.findIndex(e => e.id === id);

            if (index < evaluations.length - 1) {
                [evaluations[index], evaluations[index + 1]] = [evaluations[index + 1], evaluations[index]];
                localStorage.setItem('listeGrilles', JSON.stringify(evaluations));
                afficherTableauProductions();
            }
        }

        // Modifier mettreAJourPonderationTotale() pour utiliser les nouveaux IDs
        function mettreAJourPonderationTotale() {
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            // Ignorer les artefacts-portfolio dans le calcul (ils font partie du Portfolio)
            const productionsComptees = productions.filter(p => p.type !== 'artefact-portfolio');

            const total = productionsComptees.reduce((sum, prod) => sum + (prod.ponderation || 0), 0);

            document.getElementById('ponderationTotale').textContent = total + '%';

            const statut = document.getElementById('statutPonderation');
            if (total === 100) {
                statut.textContent = '‚úì Pond√©ration correcte';
                statut.style.color = 'green';
            } else if (total > 100) {
                statut.textContent = `${total - 100}% en trop`;
                statut.style.color = 'red';
            } else {
                statut.textContent = `${100 - total}% manquant`;
                statut.style.color = 'orange';
            }
        }

        function afficherInfoPAN() {
            const typePAN = document.getElementById('typePAN').value;
            const infoPAN = document.getElementById('infoPAN');

            const descriptions = {
                'maitrise': 'La notation est bas√©e sur l\'√©valuation du degr√© d\'atteinte des cibles d\'apprentissage (ex. : En d√©veloppement, Acquis, Avanc√©...). En anglais on l\'appelle <em>Standard Based Grading</em>.',
                'specifications': 'L\'√©tudiant¬∑e doit satisfaire √† des crit√®res pr√©cis et binaires (r√©ussi/non r√©ussi) pour chaque comp√©tence. En anglais on l\'appelle <em>Specifications Grading</em>.',
                'denotation': 'Approche sans notes chiffr√©es pendant le trimestre. L\'accent est mis sur la r√©troaction descriptive et l\'auto√©valuation. En anglais on l\'appelle <em>Ungrading</em>.'
            };

            if (typePAN && descriptions[typePAN]) {
                infoPAN.innerHTML = descriptions[typePAN];
                infoPAN.style.display = 'block';

                // Sauvegarder le type de PAN
                let modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
                modalites.typePAN = typePAN;
                localStorage.setItem('modalitesEvaluation', JSON.stringify(modalites));

                mettreAJourStatutModalites();
            } else {
                infoPAN.style.display = 'none';
            }
        }

        // Fonction appel√©e par le bouton Sauvegarder
        function sauvegarderPratiqueNotation() {
            const pratique = document.getElementById('pratiqueNotation').value;
            const typePAN = document.getElementById('typePAN').value;

            if (!pratique) {
                alert('Veuillez choisir une pratique de notation');
                return;
            }

            if (pratique === 'alternative' && !typePAN) {
                alert('Veuillez choisir un type de pratique alternative');
                return;
            }

            // D√©j√† sauvegard√© via changerPratiqueNotation() et afficherInfoPAN()
            // mais on confirme ici
            let modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
            modalites.pratique = pratique;
            modalites.typePAN = pratique === 'alternative' ? typePAN : null;
            modalites.dateConfiguration = new Date().toISOString();
            localStorage.setItem('modalitesEvaluation', JSON.stringify(modalites));

            afficherNotification('Configuration de la pratique de notation sauvegard√©e !');

            if (typeof chargerStatistiquesApercu === 'function') {
                chargerStatistiquesApercu();
            }
        }

        function chargerPratiqueNotation() {
            chargerModalites(); // Utiliser la fonction existante
        }

        // === GESTION DES CRIT√àRES D'√âVALUATION ===

        let critereEnEdition = null;
        let grilleTemplateActuelle = null;

        function chargerListeGrillesTemplates() {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const select = document.getElementById('selectGrilleTemplate');

            select.innerHTML = '<option value="">-- Nouvelle grille --</option>';
            select.innerHTML += '<option value="new">‚ûï Cr√©er une nouvelle grille</option>';
            grilles.forEach(grille => {
                select.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
            });
        }

        function chargerGrilleTemplate() {
            const grilleId = document.getElementById('selectGrilleTemplate').value;
            const nomContainer = document.getElementById('nomGrilleContainer');
            const nomInput = document.getElementById('nomGrilleTemplate');
            const btnDupliquer = document.getElementById('btnDupliquerGrille');

            if (!grilleId || grilleId === 'new') {
                // Mode cr√©ation nouvelle grille
                nomContainer.style.display = 'block';
                nomInput.value = '';
                document.getElementById('aucuneEvalSelectionnee').style.display = 'none';
                document.getElementById('criteresContainer').style.display = 'block';
                grilleTemplateActuelle = null;
                afficherListeCriteres([], null);
                btnDupliquer.style.display = 'none';  // Cacher le bouton dupliquer
            } else if (grilleId) {
                // Mode √©dition grille existante
                nomContainer.style.display = 'block';
                document.getElementById('aucuneEvalSelectionnee').style.display = 'none';
                document.getElementById('criteresContainer').style.display = 'block';
                btnDupliquer.style.display = 'inline-block';  // Montrer le bouton dupliquer

                const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
                grilleTemplateActuelle = grilles.find(g => g.id === grilleId);

                if (grilleTemplateActuelle) {
                    nomInput.value = grilleTemplateActuelle.nom;
                    afficherListeCriteres(grilleTemplateActuelle.criteres || [], grilleId);
                }
            } else {
                // Aucune s√©lection
                nomContainer.style.display = 'none';
                document.getElementById('aucuneEvalSelectionnee').style.display = 'block';
                document.getElementById('criteresContainer').style.display = 'none';
                btnDupliquer.style.display = 'none';
            }
        }

        function dupliquerGrilleActuelle() {
            if (!grilleTemplateActuelle) {
                alert('Aucune grille √† dupliquer');
                return;
            }

            // Demander le nom de la nouvelle grille
            const nouveauNom = prompt('Nom de la nouvelle grille :', grilleTemplateActuelle.nom + ' (copie)');

            if (!nouveauNom || nouveauNom.trim() === '') {
                return;
            }

            // Cr√©er la nouvelle grille avec les m√™mes crit√®res
            const nouvelleGrille = {
                id: 'GRILLE' + Date.now(),
                nom: nouveauNom.trim(),
                criteres: grilleTemplateActuelle.criteres.map(c => ({
                    ...c,
                    id: 'CR' + Date.now() + Math.random()  // Nouveaux IDs pour les crit√®res
                })),
                dateCreation: new Date().toISOString(),
                dateModification: new Date().toISOString(),
                baseSur: grilleTemplateActuelle.nom  // R√©f√©rence √† la grille d'origine
            };

            // Sauvegarder la nouvelle grille
            let grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            grilles.push(nouvelleGrille);
            localStorage.setItem('grillesTemplates', JSON.stringify(grilles));

            // Mettre √† jour l'interface
            grilleTemplateActuelle = nouvelleGrille;
            chargerListeGrillesTemplates();
            document.getElementById('selectGrilleTemplate').value = nouvelleGrille.id;
            document.getElementById('nomGrilleTemplate').value = nouvelleGrille.nom;
            afficherListeCriteres(nouvelleGrille.criteres, nouvelleGrille.id);

            // Montrer le bouton dupliquer pour la nouvelle grille
            document.getElementById('btnDupliquerGrille').style.display = 'inline-block';

            // Notification
            afficherNotificationSucces(`Grille "${nouvelleGrille.nom}" cr√©√©e √† partir de "${grilleTemplateActuelle.baseSur}" !`);
        }

        // Ajouter aussi un bouton dupliquer dans le modal des grilles existantes
        function afficherGrillesCriteres() {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const listeDiv = document.getElementById('listeGrilles');

            if (grilles.length === 0) {
                listeDiv.innerHTML = `
            <div class="liste-vide">
                <p>Aucune grille de crit√®res disponible</p>
                <small>Cr√©ez d'abord une grille de crit√®res pour pouvoir la r√©utiliser</small>
            </div>
        `;
            } else {
                listeDiv.innerHTML = grilles.map(grille => `
            <div class="element-sauvegarde">
                <div class="element-sauvegarde-header">
                    <div>
                        <strong class="element-sauvegarde-titre">${grille.nom}</strong>
                        <small class="element-sauvegarde-date">
                            ${new Date(grille.dateCreation).toLocaleDateString()}
                        </small>
                        ${grille.baseSur ? `<small class="element-sauvegarde-source">
                            (bas√© sur ${grille.baseSur})</small>` : ''}
                    </div>
                    <div>
                        <button class="btn btn-principal btn-compact" onclick="chargerGrilleEnEdition('${grille.id}')">
                            Modifier
                        </button>
                        <button class="btn btn-modifier btn-compact" onclick="dupliquerGrille('${grille.id}')">
                            Dupliquer
                        </button>
                        <button class="btn btn-supprimer btn-compact" onclick="supprimerGrille('${grille.id}')">
                            Supprimer
                        </button>
                    </div>
                </div>
                <div class="element-sauvegarde-infos">
                    <span>üìù ${grille.criteres?.length || 0} crit√®res</span>
                    <span>‚öñÔ∏è Pond√©ration totale : ${grille.criteres?.reduce((sum, c) => sum + (parseInt(c.ponderation) || 0), 0) || 0}%</span>
                </div>
                <details class="element-details">
                    <summary>
                        Voir les crit√®res
                    </summary>
                    <div class="element-details-contenu">
                        ${(grille.criteres || []).map(c => `
                            <div class="element-details-item">
                                <strong>${c.nom}</strong> (${c.ponderation}% - ${getTypeCritereLabel(c.type)})
                                ${c.description ? `<br><small class="element-details-description">${c.description}</small>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `).join('');
            }

            document.getElementById('modalGrilles').style.display = 'block';
        }

        function dupliquerGrille(grilleId) {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grilleOriginale = grilles.find(g => g.id === grilleId);

            if (!grilleOriginale) {
                alert('Grille introuvable');
                return;
            }

            // Fermer le modal
            fermerModalGrilles();

            // Demander le nom de la nouvelle grille
            const nouveauNom = prompt('Nom de la nouvelle grille :', grilleOriginale.nom + ' (copie)');

            if (!nouveauNom || nouveauNom.trim() === '') {
                return;
            }

            // Cr√©er la nouvelle grille
            const nouvelleGrille = {
                id: 'GRILLE' + Date.now(),
                nom: nouveauNom.trim(),
                criteres: grilleOriginale.criteres.map(c => ({
                    ...c,
                    id: 'CR' + Date.now() + Math.random()
                })),
                dateCreation: new Date().toISOString(),
                dateModification: new Date().toISOString(),
                baseSur: grilleOriginale.nom
            };

            // Sauvegarder
            grilles.push(nouvelleGrille);
            localStorage.setItem('grillesTemplates', JSON.stringify(grilles));

            // Charger la nouvelle grille en √©dition
            grilleTemplateActuelle = nouvelleGrille;
            chargerListeGrillesTemplates();
            document.getElementById('selectGrilleTemplate').value = nouvelleGrille.id;
            chargerGrilleTemplate();

            afficherNotificationSucces(`Grille "${nouvelleGrille.nom}" cr√©√©e √† partir de "${grilleOriginale.nom}" !`);
        }

        function afficherListeCriteres(criteres, grilleId) {
            const container = document.getElementById('listeCriteres');

            if (criteres.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucun crit√®re d√©fini pour cette grille.</p>';
                document.getElementById('totalPonderationCriteres').textContent = '0%';
                document.getElementById('statutPonderationCriteres').textContent = '';
                return;
            }

            container.innerHTML = criteres.map(critere => `
        <div style="padding: 12px; background: white; border: 1px solid var(--bleu-leger); 
             border-radius: 6px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="color: var(--bleu-principal);">${critere.nom}</strong>
                <div>
                    <label style="font-size: 0.85rem; margin-right: 10px;">
                        <input type="checkbox" id="unlock-critere-${critere.id}" 
                               onchange="basculerVerrouillageCritere('${critere.id}')" 
                               ${critere.verrouille ? 'checked' : ''}>
                        üîí
                    </label>
                    <button class="btn btn-modifier" onclick="modifierCritere('${critere.id}')" 
                            style="padding: 5px 12px; font-size: 0.85rem;
                                   opacity: ${critere.verrouille ? '0.5' : '1'};"
                            ${critere.verrouille ? 'disabled' : ''}>
                        Modifier
                    </button>
                    <button class="btn btn-supprimer" onclick="supprimerCritere('${critere.id}')" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;
                                   opacity: ${critere.verrouille ? '0.5' : '1'};"
                            ${critere.verrouille ? 'disabled' : ''}>
                        Supprimer
                    </button>
                </div>
            </div>
            ${critere.description ? `<p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">${critere.description}</p>` : ''}
            <div style="display: grid; grid-template-columns: 1fr 1fr ${critere.type === 'algorithmique' ? '2fr' : ''}; gap: 15px;">
                <div>
                    <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Type</label>
                    <input type="text" value="${getTypeCritereLabel(critere.type)}" 
                           class="controle-form" readonly style="font-size: 0.85rem;">
                </div>
                <div>
                    <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Pond√©ration</label>
                    <input type="text" value="${critere.ponderation || 0}%" 
                           class="controle-form" readonly style="font-size: 0.85rem; font-weight: bold;">
                </div>
                ${critere.type === 'algorithmique' && critere.formule ?
                    `<div>
                        <label style="font-size: 0.75rem; color: var(--bleu-moyen);">Formule</label>
                        <input type="text" value="${critere.formule}" 
                               class="controle-form" readonly style="font-size: 0.85rem; font-family: monospace;">
                    </div>` : ''}
            </div>
        </div>
    `).join('');

            calculerTotalPonderationCriteres(criteres);
        }

        function getTypeCritereLabel(type) {
            const labels = {
                'holistique': 'Holistique',
                'analytique': 'Analytique',
                'algorithmique': 'Algorithmique'
            };
            return labels[type] || type;
        }

        function calculerTotalPonderationCriteres(criteres) {
            const total = criteres.reduce((sum, c) => sum + (parseInt(c.ponderation) || 0), 0);
            const totalSpan = document.getElementById('totalPonderationCriteres');
            const statutSpan = document.getElementById('statutPonderationCriteres');

            totalSpan.textContent = total + '%';

            if (total === 100) {
                totalSpan.style.color = 'var(--risque-minimal)';
                statutSpan.innerHTML = '<span style="color: var(--risque-minimal);">‚úì Pond√©ration compl√®te</span>';
            } else if (total < 100) {
                totalSpan.style.color = 'var(--risque-modere)';
                statutSpan.innerHTML = `<span style="color: var(--risque-modere);">${100 - total}% manquant</span>`;
            } else {
                totalSpan.style.color = 'var(--risque-critique)';
                statutSpan.innerHTML = `<span style="color: var(--risque-critique);">${total - 100}% en trop</span>`;
            }
        }

        function afficherFormCritere(id = null) {
            const form = document.getElementById('formAjoutCritere');
            const btnAjouter = document.getElementById('btnAjouterCritere');
            const btnTexte = document.getElementById('btnTexteCritere');

            form.style.display = 'block';
            btnAjouter.style.display = 'none';

            if (id) {
                // Mode √©dition - adapter pour les templates
                if (grilleTemplateActuelle) {
                    const critere = grilleTemplateActuelle.criteres.find(c => c.id === id);
                    if (critere) {
                        critereEnEdition = id;
                        btnTexte.textContent = 'Sauvegarder';
                        document.getElementById('critereNom').value = critere.nom;
                        document.getElementById('criterePonderation').value = critere.ponderation || '';
                        document.getElementById('critereDescription').value = critere.description || '';
                        document.getElementById('critereType').value = critere.type;
                        document.getElementById('critereFormule').value = critere.formule || '';
                        afficherChampFormule();
                    }
                }
            } else {
                // Mode ajout
                critereEnEdition = null;
                btnTexte.textContent = 'Ajouter et continuer';
                document.getElementById('critereNom').value = '';
                document.getElementById('criterePonderation').value = '';
                document.getElementById('critereDescription').value = '';
                document.getElementById('critereType').value = 'holistique';
                document.getElementById('critereFormule').value = '';
                afficherChampFormule();
            }
        }

        function afficherChampFormule() {
            const type = document.getElementById('critereType').value;
            const champFormule = document.getElementById('champFormule');

            if (type === 'algorithmique') {
                champFormule.style.display = 'block';
            } else {
                champFormule.style.display = 'none';
            }
        }

        function annulerAjoutCritere() {
            document.getElementById('formAjoutCritere').style.display = 'none';
            document.getElementById('btnAjouterCritere').style.display = 'inline-block';
            critereEnEdition = null;
        }

        function sauvegarderCritere() {
            const nom = document.getElementById('critereNom')?.value?.trim();
            if (!nom) {
                alert('Le nom du crit√®re est obligatoire');
                return;
            }

            // V√©rifier qu'on a un nom de grille
            const nomGrille = document.getElementById('nomGrilleTemplate')?.value?.trim();
            if (!nomGrille) {
                alert('Veuillez d\'abord donner un nom √† la grille');
                document.getElementById('nomGrilleTemplate').focus();
                return;
            }

            // Cr√©er l'objet crit√®re
            const critere = {
                nom: nom,
                description: document.getElementById('critereDescription')?.value?.trim() || '',
                ponderation: parseInt(document.getElementById('criterePonderation')?.value) || 0,
                type: document.getElementById('critereType')?.value || 'holistique',
                formule: document.getElementById('critereFormule')?.value?.trim() || '',
                verrouille: false
            };

            // Si on est en √©dition de grille existante
            if (grilleTemplateActuelle) {
                if (!grilleTemplateActuelle.criteres) {
                    grilleTemplateActuelle.criteres = [];
                }

                if (critereEnEdition) {
                    // Modifier le crit√®re existant
                    const index = grilleTemplateActuelle.criteres.findIndex(c => c.id === critereEnEdition);
                    if (index !== -1) {
                        grilleTemplateActuelle.criteres[index] = { ...grilleTemplateActuelle.criteres[index], ...critere };
                    }
                } else {
                    // Ajouter nouveau crit√®re
                    critere.id = 'CR' + Date.now();
                    grilleTemplateActuelle.criteres.push(critere);
                }

                // Sauvegarder automatiquement la grille
                sauvegarderGrilleTemplate(true);  // true = sauvegarde silencieuse

            } else {
                // Mode cr√©ation nouvelle grille - cr√©er la grille si elle n'existe pas
                const nouvelleGrille = {
                    id: 'GRILLE' + Date.now(),
                    nom: nomGrille,
                    criteres: [],
                    dateCreation: new Date().toISOString()
                };

                if (critereEnEdition && window.tempCriteres) {
                    const index = window.tempCriteres.findIndex(c => c.id === critereEnEdition);
                    if (index !== -1) {
                        window.tempCriteres[index] = { ...window.tempCriteres[index], ...critere };
                    }
                    nouvelleGrille.criteres = window.tempCriteres;
                } else {
                    critere.id = 'CR' + Date.now();
                    if (window.tempCriteres) {
                        window.tempCriteres.push(critere);
                        nouvelleGrille.criteres = window.tempCriteres;
                    } else {
                        window.tempCriteres = [critere];
                        nouvelleGrille.criteres = [critere];
                    }
                }

                // Sauvegarder la nouvelle grille
                let grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
                const existingIndex = grilles.findIndex(g => g.nom === nomGrille);

                if (existingIndex >= 0) {
                    // Mise √† jour de la grille existante avec le m√™me nom
                    grilles[existingIndex].criteres = nouvelleGrille.criteres;
                    grilleTemplateActuelle = grilles[existingIndex];
                } else {
                    // Nouvelle grille
                    grilles.push(nouvelleGrille);
                    grilleTemplateActuelle = nouvelleGrille;
                }

                localStorage.setItem('grillesTemplates', JSON.stringify(grilles));

                // Mettre √† jour le s√©lecteur
                chargerListeGrillesTemplates();
                document.getElementById('selectGrilleTemplate').value = grilleTemplateActuelle.id;

                // Nettoyer tempCriteres
                window.tempCriteres = [];
            }

            // Afficher les crit√®res mis √† jour
            afficherListeCriteres(grilleTemplateActuelle.criteres, grilleTemplateActuelle.id);

            // R√©initialiser le formulaire
            document.getElementById('critereNom').value = '';
            document.getElementById('critereDescription').value = '';
            document.getElementById('criterePonderation').value = '';
            document.getElementById('critereType').value = 'holistique';
            afficherChampFormule();

            critereEnEdition = null;

            // Notification
            afficherNotificationSucces(`Crit√®re "${nom}" ajout√© et grille "${nomGrille}" sauvegard√©e !`);
        }

        function sauvegarderGrilleTemplate(silencieux = false) {
            const nomGrille = document.getElementById('nomGrilleTemplate')?.value?.trim();

            if (!nomGrille) {
                if (!silencieux) {
                    alert('Le nom de la grille est obligatoire');
                }
                return;
            }

            let grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');

            if (grilleTemplateActuelle) {
                // Mode √©dition
                grilleTemplateActuelle.nom = nomGrille;
                grilleTemplateActuelle.dateModification = new Date().toISOString();

                const index = grilles.findIndex(g => g.id === grilleTemplateActuelle.id);
                if (index !== -1) {
                    grilles[index] = grilleTemplateActuelle;
                }
            } else {
                // Mode cr√©ation
                const nouvelleGrille = {
                    id: 'GRILLE' + Date.now(),
                    nom: nomGrille,
                    criteres: window.tempCriteres || [],
                    dateCreation: new Date().toISOString(),
                    dateModification: new Date().toISOString()
                };
                grilles.push(nouvelleGrille);
                grilleTemplateActuelle = nouvelleGrille;

                // Nettoyer les crit√®res temporaires
                window.tempCriteres = [];
            }

            localStorage.setItem('grillesTemplates', JSON.stringify(grilles));

            // Recharger la liste des grilles
            chargerListeGrillesTemplates();

            // S√©lectionner la grille actuelle
            document.getElementById('selectGrilleTemplate').value = grilleTemplateActuelle.id;

            if (!silencieux) {
                afficherNotificationSucces(`Grille "${nomGrille}" sauvegard√©e !`);
            }
        }

        // Ajouter aussi la sauvegarde automatique quand on change le nom de la grille
        function sauvegarderNomGrille() {
            if (grilleTemplateActuelle) {
                sauvegarderGrilleTemplate(true);
            }
        }

        function sauvegarderEtFermer() {
            sauvegarderCritere();
            setTimeout(() => {
                annulerAjoutCritere();
            }, 500);
        }

        function modifierCritere(id) {
            if (!grilleTemplateActuelle && (!window.tempCriteres || window.tempCriteres.length === 0)) {
                alert('Aucune grille en cours de modification');
                return;
            }

            let critere;
            if (grilleTemplateActuelle) {
                critere = grilleTemplateActuelle.criteres.find(c => c.id === id);
            } else {
                critere = window.tempCriteres.find(c => c.id === id);
            }

            if (critere && critere.verrouille) {
                alert('D√©cochez "üîí" avant de modifier ce crit√®re');
                return;
            }

            afficherFormCritere(id);
        }

        function supprimerCritere(id) {
            if (!grilleTemplateActuelle && (!window.tempCriteres || window.tempCriteres.length === 0)) {
                alert('Aucune grille en cours de modification');
                return;
            }

            let critere;
            if (grilleTemplateActuelle) {
                critere = grilleTemplateActuelle.criteres.find(c => c.id === id);
            } else {
                critere = window.tempCriteres.find(c => c.id === id);
            }

            if (critere && critere.verrouille) {
                alert('D√©cochez "üîí" avant de supprimer ce crit√®re');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce crit√®re ?')) {
                if (grilleTemplateActuelle) {
                    grilleTemplateActuelle.criteres = grilleTemplateActuelle.criteres.filter(c => c.id !== id);
                    sauvegarderGrilleTemplate();
                    afficherListeCriteres(grilleTemplateActuelle.criteres, grilleTemplateActuelle.id);
                } else {
                    window.tempCriteres = window.tempCriteres.filter(c => c.id !== id);
                    afficherListeCriteres(window.tempCriteres, null);
                }
            }
        }

        // === GESTION DES GRILLES DE CRIT√àRES ===

        function enregistrerCommeGrille() {
            // Cette fonction devient maintenant "Sauvegarder la grille"
            sauvegarderGrilleTemplate();
            if (typeof initialiserEvaluationsIndividuelles === 'function') {
                initialiserEvaluationsIndividuelles();
            }
        }

        function sauvegarderGrilleTemplate() {
            const nomGrille = document.getElementById('nomGrilleTemplate')?.value?.trim();

            if (!nomGrille) {
                alert('Le nom de la grille est obligatoire');
                return;
            }

            let grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');

            if (grilleTemplateActuelle) {
                // Mode √©dition
                grilleTemplateActuelle.nom = nomGrille;
                const index = grilles.findIndex(g => g.id === grilleTemplateActuelle.id);
                if (index !== -1) {
                    grilles[index] = grilleTemplateActuelle;
                }
            } else {
                // Mode cr√©ation
                const nouvelleGrille = {
                    id: 'GRILLE' + Date.now(),
                    nom: nomGrille,
                    criteres: window.tempCriteres || [],
                    dateCreation: new Date().toISOString()
                };
                grilles.push(nouvelleGrille);
                grilleTemplateActuelle = nouvelleGrille;

                // Nettoyer les crit√®res temporaires
                window.tempCriteres = [];
            }

            localStorage.setItem('grillesTemplates', JSON.stringify(grilles));

            // Recharger la liste des grilles
            chargerListeGrillesTemplates();

            // S√©lectionner la grille actuelle
            document.getElementById('selectGrilleTemplate').value = grilleTemplateActuelle.id;

            afficherNotificationSucces(`Grille "${nomGrille}" sauvegard√©e !`);

            if (typeof initialiserEvaluationsIndividuelles === 'function') {
                initialiserEvaluationsIndividuelles();
            }
        }

        function afficherGrillesCriteres() {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const listeDiv = document.getElementById('listeGrilles');

            if (grilles.length === 0) {
                listeDiv.innerHTML = `
            <div style="padding: 20px; background: var(--bleu-tres-pale); border-radius: 6px; 
                 text-align: center; color: var(--bleu-leger);">
                <p>Aucune grille de crit√®res disponible</p>
                <small>Cr√©ez d'abord une grille de crit√®res pour pouvoir la r√©utiliser</small>
            </div>
        `;
            } else {
                listeDiv.innerHTML = grilles.map(grille => `
            <div style="padding: 15px; background: var(--bleu-tres-pale); border: 1px solid var(--bleu-leger); 
                 border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <strong style="color: var(--bleu-principal);">${grille.nom}</strong>
                        <small style="color: var(--bleu-leger); margin-left: 10px;">
                            ${new Date(grille.dateCreation).toLocaleDateString()}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-principal" onclick="chargerGrilleEnEdition('${grille.id}')"
                                style="padding: 5px 12px; font-size: 0.85rem;">
                            Utiliser
                        </button>
                        <button class="btn btn-supprimer" onclick="supprimerGrille('${grille.id}')"
                                style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;">
                            Supprimer
                        </button>
                    </div>
                </div>
                <div style="color: #666; font-size: 0.85rem;">
                    <span style="margin-right: 20px;">üìù ${grille.criteres?.length || 0} crit√®res</span>
                    <span>‚öñÔ∏è Pond√©ration totale : ${grille.criteres?.reduce((sum, c) => sum + (parseInt(c.ponderation) || 0), 0) || 0}%</span>
                </div>
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: var(--bleu-moyen); font-size: 0.9rem;">
                        Voir les crit√®res
                    </summary>
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
                        ${(grille.criteres || []).map(c => `
                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--bleu-tres-pale);">
                                <strong>${c.nom}</strong> (${c.ponderation}% - ${getTypeCritereLabel(c.type)})
                                ${c.description ? `<br><small style="color: #666;">${c.description}</small>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `).join('');
            }

            document.getElementById('modalGrilles').style.display = 'block';
        }

        function fermerModalGrilles() {
            document.getElementById('modalGrilles').style.display = 'none';
        }

        function chargerGrilleEnEdition(grilleId) {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grille = grilles.find(g => g.id === grilleId);

            if (grille) {
                document.getElementById('selectGrilleTemplate').value = grilleId;
                chargerGrilleTemplate();
                fermerModalGrilles();
            }
        }

        function supprimerGrille(grilleId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette grille ?')) return;

            let grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            grilles = grilles.filter(g => g.id !== grilleId);
            localStorage.setItem('grillesTemplates', JSON.stringify(grilles));

            afficherGrillesCriteres();
            afficherNotificationSucces('Grille supprim√©e');
        }

        // === GESTION DE L'√âCHELLE DE PERFORMANCE ===

        const niveauxDefaut = [
            { code: 'I', nom: 'Incomplet ou insuffisant', description: 'Pr√©structurel, unistructurel', min: 0, max: 64, couleur: 'var(--risque-critique)' },
            { code: 'D', nom: 'En D√©veloppement', description: 'Multistructurel', min: 65, max: 74, couleur: 'var(risque-modere)' },
            { code: 'M', nom: 'Ma√Ætris√©', description: 'Relationnel acquis', min: 75, max: 84, couleur: 'var(risque-minimal)' },
            { code: 'E', nom: '√âtendu', description: 'Abstrait √©tendu', min: 85, max: 100, couleur: 'var(--risque-nul)' }
        ];

        function initialiserEchelle() {
            // V√©rifier que les √©l√©ments existent (on est dans la bonne section)
            const elementTypeEchelle = document.getElementById('typeEchelle');
            if (!elementTypeEchelle) {
                return; // Sortir silencieusement si on n'est pas dans la section √âchelles
            }

            const config = JSON.parse(localStorage.getItem('configEchelle') || '{}');

            // Charger la configuration
            if (config.typeEchelle) {
                elementTypeEchelle.value = config.typeEchelle;
            }

            const elementSeuilReussite = document.getElementById('seuilReussite');
            if (config.seuilReussite !== undefined && elementSeuilReussite) {
                elementSeuilReussite.value = config.seuilReussite;
            }

            const elementCodesPersonnalises = document.getElementById('codesPersonnalises');
            if (config.codesPersonnalises && elementCodesPersonnalises) {
                elementCodesPersonnalises.value = config.codesPersonnalises;
            }

            changerTypeEchelle();

            // Charger les niveaux
            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify(niveauxDefaut));
            afficherTableauNiveaux(niveaux);
            afficherApercuEchelle(niveaux);
        }

        function changerTypeEchelle() {
            const elementType = document.getElementById('typeEchelle');
            if (!elementType) return; // Sortir si on n'est pas dans la section √âchelle

            const type = elementType.value;
            const champAutre = document.getElementById('champAutreEchelle');
            const notePassageContainer = document.getElementById('notePassageContainer');

            if (!champAutre || !notePassageContainer) return; // Sortir si les √©l√©ments n'existent pas

            if (type === 'autre') {
                champAutre.style.display = 'block';
                notePassageContainer.innerHTML = `
            <input type="text" id="notePassage" class="controle-form" 
                   placeholder="Ex: Comp√©tent" onchange="sauvegarderConfigEchelle()">
        `;
            } else {
                champAutre.style.display = 'none';

                if (type === 'lettres') {
                    notePassageContainer.innerHTML = `
                <select id="notePassage" class="controle-form" onchange="sauvegarderConfigEchelle()">
                    <option value="D">D (65%)</option>
                    <option value="C">C (si √©chelle A-F)</option>
                </select>
            `;
                } else {
                    notePassageContainer.innerHTML = `
                <input type="number" id="notePassage" class="controle-form" 
                       value="60" min="0" max="100" placeholder="60"
                       onchange="sauvegarderConfigEchelle()">
            `;
                }
            }

            sauvegarderConfigEchelle();
        }

        function afficherTableauNiveaux(niveaux) {
            const container = document.getElementById('tableauNiveaux');

            container.innerHTML = `
        <table class="tableau" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width: 80px;">Code</th>
                    <th>Nom complet</th>
                    <th>Description</th>
                    <th style="width: 100px;">Min (%)</th>
                    <th style="width: 100px;">Max (%)</th>
                    <th style="width: 50px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${niveaux.map((niveau, index) => `
                    <tr>
                        <td>
                            <input type="text" value="${niveau.code}" 
                                   class="controle-form" style="font-weight: bold; text-align: center;"
                                   onchange="modifierNiveau(${index}, 'code', this.value)">
                        </td>
                        <td>
                            <input type="text" value="${niveau.nom}" 
                                   class="controle-form"
                                   onchange="modifierNiveau(${index}, 'nom', this.value)">
                        </td>
                        <td>
                            <input type="text" value="${niveau.description || ''}" 
                                   class="controle-form" style="font-size: 0.85rem;"
                                   onchange="modifierNiveau(${index}, 'description', this.value)">
                        </td>
                        <td>
                            <input type="number" value="${niveau.min}" 
                                   class="controle-form" style="text-align: center;"
                                   min="0" max="100"
                                   onchange="modifierNiveau(${index}, 'min', this.value)">
                        </td>
                        <td>
                            <input type="number" value="${niveau.max}" 
                                   class="controle-form" style="text-align: center;"
                                   min="0" max="100"
                                   onchange="modifierNiveau(${index}, 'max', this.value)">
                        </td>
                        <td style="text-align: center;">
                            ${niveaux.length > 1 ?
                    `<button class="btn btn-supprimer" 
                                         onclick="supprimerNiveau(${index})"
                                         style="padding: 3px 8px; font-size: 0.8rem;">‚úñ</button>`
                    : ''}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <button class="btn btn-ajouter mt-2" onclick="ajouterNiveau()">
            + Ajouter un niveau
        </button>
    `;
        }

        function modifierNiveau(index, champ, valeur) {
            let niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify(niveauxDefaut));

            if (champ === 'min' || champ === 'max') {
                niveaux[index][champ] = parseInt(valeur) || 0;
            } else {
                niveaux[index][champ] = valeur;
            }

            localStorage.setItem('niveauxEchelle', JSON.stringify(niveaux));
            afficherApercuEchelle(niveaux);
        }

        function ajouterNiveau() {
            let niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify(niveauxDefaut));

            const nouveauNiveau = {
                code: 'N' + (niveaux.length + 1),
                nom: 'Nouveau niveau',
                description: '',
                min: 0,
                max: 100,
                couleur: 'var(--bleu-moyen)'
            };

            niveaux.push(nouveauNiveau);
            localStorage.setItem('niveauxEchelle', JSON.stringify(niveaux));
            afficherTableauNiveaux(niveaux);
            afficherApercuEchelle(niveaux);
        }

        function supprimerNiveau(index) {
            if (!confirm('Supprimer ce niveau ?')) return;

            let niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify(niveauxDefaut));
            niveaux.splice(index, 1);
            localStorage.setItem('niveauxEchelle', JSON.stringify(niveaux));
            afficherTableauNiveaux(niveaux);
            afficherApercuEchelle(niveaux);
        }

        function reinitialiserNiveauxDefaut() {
            if (!confirm('R√©initialiser aux niveaux par d√©faut ? Les modifications seront perdues.')) return;

            localStorage.setItem('niveauxEchelle', JSON.stringify(niveauxDefaut));
            afficherTableauNiveaux(niveauxDefaut);
            afficherApercuEchelle(niveauxDefaut);
            afficherNotificationSucces('√âchelle r√©initialis√©e aux valeurs par d√©faut');
        }

        function afficherApercuEchelle(niveaux) {
            const container = document.getElementById('apercuEchelle');

            container.innerHTML = niveaux.map(niveau => `
        <div style="text-align: center; flex: 1; padding: 10px; 
             background: ${niveau.couleur}20; border-radius: 4px; margin: 0 2px;">
            <strong style="font-size: 1.2rem; color: ${niveau.couleur};">${niveau.code}</strong>
            <div style="font-size: 0.75rem; margin-top: 5px;">${niveau.min}%-${niveau.max}%</div>
        </div>
    `).join('');
        }

        function sauvegarderConfigEchelle() {
            const config = {
                typeEchelle: document.getElementById('typeEchelle').value,
                seuilReussite: parseInt(document.getElementById('seuilReussite').value) || 60,
                notePassage: document.getElementById('notePassage').value,
                codesPersonnalises: document.getElementById('codesPersonnalises')?.value || ''
            };

            localStorage.setItem('configEchelle', JSON.stringify(config));
        }

        function sauvegarderNiveaux() {
            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify(niveauxDefaut));

            // V√©rifier la coh√©rence
            let erreurs = [];
            niveaux.forEach((niveau, i) => {
                if (!niveau.code || !niveau.nom) {
                    erreurs.push(`Niveau ${i + 1}: Code et nom obligatoires`);
                }
                if (niveau.min >= niveau.max) {
                    erreurs.push(`Niveau ${i + 1}: Min doit √™tre < Max`);
                }
            });

            if (erreurs.length > 0) {
                alert('Erreurs √† corriger:\n' + erreurs.join('\n'));
                return;
            }

            afficherNotificationSucces('√âchelle de performance sauvegard√©e !');
        }

        // Variable globale pour l'√©chelle en cours d'√©dition
        let echelleTemplateActuelle = null;

        // Charger la liste des √©chelles dans le select
        function chargerEchellesTemplates() {
            const select = document.getElementById('selectEchelleTemplate');
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');

            let options = '<option value="">-- Nouvelle √©chelle --</option>';
            options += '<option value="new">‚ûï Cr√©er une nouvelle √©chelle</option>';

            echelles.forEach(echelle => {
                options += `<option value="${echelle.id}">${echelle.nom}</option>`;
            });

            select.innerHTML = options;
        }

        // Charger une √©chelle template s√©lectionn√©e
        function chargerEchelleTemplate() {
            const selectValue = document.getElementById('selectEchelleTemplate').value;
            const nomContainer = document.getElementById('nomEchelleContainer');
            const nomInput = document.getElementById('nomEchelleTemplate');
            const btnDupliquer = document.getElementById('btnDupliquerEchelle');

            if (!selectValue || selectValue === 'new') {
                // Mode cr√©ation nouvelle √©chelle
                nomContainer.style.display = 'block';
                nomInput.value = '';
                echelleTemplateActuelle = null;
                btnDupliquer.style.display = 'none';

                // R√©initialiser aux valeurs par d√©faut
                reinitialiserNiveauxDefaut();
            } else {
                // Mode √©dition √©chelle existante
                nomContainer.style.display = 'block';
                btnDupliquer.style.display = 'inline-block';

                const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
                echelleTemplateActuelle = echelles.find(e => e.id === selectValue);

                if (echelleTemplateActuelle) {
                    nomInput.value = echelleTemplateActuelle.nom;

                    // Charger les niveaux de l'√©chelle
                    localStorage.setItem('niveauxEchelle', JSON.stringify(echelleTemplateActuelle.niveaux));
                    afficherTableauNiveaux(echelleTemplateActuelle.niveaux);
                    afficherApercuEchelle(echelleTemplateActuelle.niveaux);

                    // Charger la configuration
                    if (echelleTemplateActuelle.config) {
                        localStorage.setItem('configEchelle', JSON.stringify(echelleTemplateActuelle.config));
                        const config = echelleTemplateActuelle.config;

                        if (config.typeEchelle) {
                            document.getElementById('typeEchelle').value = config.typeEchelle;
                        }
                        if (config.seuilReussite !== undefined) {
                            document.getElementById('seuilReussite').value = config.seuilReussite;
                        }
                        if (config.codesPersonnalises) {
                            document.getElementById('codesPersonnalises').value = config.codesPersonnalises;
                        }
                        changerTypeEchelle();
                    }
                }
            }
        }

        // Sauvegarder le nom de l'√©chelle en cours
        function sauvegarderNomEchelle() {
            const nom = document.getElementById('nomEchelleTemplate').value;
            if (echelleTemplateActuelle && nom) {
                echelleTemplateActuelle.nom = nom;
            }
        }

        // Enregistrer l'√©chelle comme template
        function enregistrerCommeEchelle() {
            const nomEchelle = document.getElementById('nomEchelleTemplate')?.value?.trim();

            if (!nomEchelle) {
                alert('Le nom de l\'√©chelle est obligatoire');
                return;
            }

            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify(niveauxDefaut));
            const config = JSON.parse(localStorage.getItem('configEchelle') || '{}');

            let echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');

            if (echelleTemplateActuelle) {
                // Mode √©dition - mise √† jour de l'√©chelle existante
                echelleTemplateActuelle.nom = nomEchelle;
                echelleTemplateActuelle.niveaux = niveaux;
                echelleTemplateActuelle.config = config;
                echelleTemplateActuelle.dateModification = new Date().toISOString();

                const index = echelles.findIndex(e => e.id === echelleTemplateActuelle.id);
                if (index !== -1) {
                    echelles[index] = echelleTemplateActuelle;
                }
            } else {
                // Mode cr√©ation - nouvelle √©chelle
                const nouvelleEchelle = {
                    id: 'ECHELLE' + Date.now(),
                    nom: nomEchelle,
                    niveaux: niveaux,
                    config: config,
                    dateCreation: new Date().toISOString(),
                    dateModification: new Date().toISOString()
                };
                echelles.push(nouvelleEchelle);
                echelleTemplateActuelle = nouvelleEchelle;
            }

            localStorage.setItem('echellesTemplates', JSON.stringify(echelles));

            // Recharger le select avec l'√©chelle s√©lectionn√©e
            chargerEchellesTemplates();
            if (echelleTemplateActuelle) {
                document.getElementById('selectEchelleTemplate').value = echelleTemplateActuelle.id;
            }

            // Afficher le bouton dupliquer
            document.getElementById('btnDupliquerEchelle').style.display = 'inline-block';

            // Notification de succ√®s
            afficherNotificationSucces(`‚úÖ √âchelle ¬´ ${nomEchelle} ¬ª sauvegard√©e avec succ√®s !`);

            if (typeof initialiserEvaluationsIndividuelles === 'function') {
                initialiserEvaluationsIndividuelles();
            }
        }

        // Afficher la modal avec la liste des √©chelles existantes
        function afficherEchellesPerformance() {
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            const listeDiv = document.getElementById('listeEchelles');

            if (echelles.length === 0) {
                listeDiv.innerHTML = `
            <div style="padding: 20px; background: var(--bleu-tres-pale); 
                        border-radius: 6px; text-align: center; color: var(--bleu-leger);">
                <p>Aucune √©chelle sauvegard√©e</p>
            </div>
        `;
            } else {
                listeDiv.innerHTML = echelles.map(echelle => {
                    const niveauxStr = echelle.niveaux.map(n => n.code).join('-');

                    return `
            <div style="margin-bottom: 15px; padding: 15px; background: var(--bleu-tres-pale); 
                        border-radius: 6px; border: 1px solid var(--bleu-leger);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; color: var(--bleu-principal);">${echelle.nom}</h4>
                        <div style="font-size: 0.9rem; color: #666;">
                            <strong>√âchelle :</strong> ${niveauxStr}
                        </div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">
                            Cr√©√©e le ${new Date(echelle.dateCreation).toLocaleDateString('fr-CA')}
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--bleu-moyen); font-size: 0.9rem;">
                                Voir les niveaux
                            </summary>
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
                                ${echelle.niveaux.map(n => `
                                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--bleu-tres-pale);">
                                        <strong>${n.code}</strong> - ${n.nom} (${n.min}%-${n.max}%)
                                        ${n.description ? `<br><small style="color: #666;">${n.description}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-principal" onclick="chargerEchelleEnEdition('${echelle.id}')"
                                style="padding: 5px 12px; font-size: 0.85rem;">
                            Utiliser
                        </button>
                        <button class="btn btn-supprimer" onclick="supprimerEchelle('${echelle.id}')"
                                style="padding: 5px 12px; font-size: 0.85rem;">
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>
        `}).join('');
            }

            document.getElementById('modalEchelles').style.display = 'block';
        }

        // Fermer la modal des √©chelles
        function fermerModalEchelles() {
            document.getElementById('modalEchelles').style.display = 'none';
        }

        // Charger une √©chelle depuis la modal pour √©dition
        function chargerEchelleEnEdition(echelleId) {
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            const echelle = echelles.find(e => e.id === echelleId);

            if (echelle) {
                document.getElementById('selectEchelleTemplate').value = echelleId;
                chargerEchelleTemplate();
                fermerModalEchelles();
            }
        }

        // Dupliquer l'√©chelle actuelle
        function dupliquerEchelleActuelle() {
            if (!echelleTemplateActuelle) {
                alert('Aucune √©chelle √† dupliquer');
                return;
            }

            const nouveauNom = prompt('Nom de la nouvelle √©chelle :', echelleTemplateActuelle.nom + ' (copie)');

            if (!nouveauNom || nouveauNom.trim() === '') {
                return;
            }

            // Cr√©er la nouvelle √©chelle avec les m√™mes niveaux
            const nouvelleEchelle = {
                id: 'ECHELLE' + Date.now(),
                nom: nouveauNom.trim(),
                niveaux: echelleTemplateActuelle.niveaux.map(n => ({ ...n })),
                config: { ...echelleTemplateActuelle.config },
                dateCreation: new Date().toISOString(),
                dateModification: new Date().toISOString(),
                baseSur: echelleTemplateActuelle.nom
            };

            // Sauvegarder la nouvelle √©chelle
            let echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            echelles.push(nouvelleEchelle);
            localStorage.setItem('echellesTemplates', JSON.stringify(echelles));

            // Mettre √† jour l'interface
            echelleTemplateActuelle = nouvelleEchelle;
            chargerEchellesTemplates();
            document.getElementById('selectEchelleTemplate').value = nouvelleEchelle.id;
            document.getElementById('nomEchelleTemplate').value = nouvelleEchelle.nom;

            afficherNotificationSucces(`üìë √âchelle ¬´ ${nouvelleEchelle.nom} ¬ª cr√©√©e avec succ√®s !`);
        }

        // Supprimer une √©chelle
        function supprimerEchelle(echelleId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette √©chelle ?')) return;

            let echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            echelles = echelles.filter(e => e.id !== echelleId);
            localStorage.setItem('echellesTemplates', JSON.stringify(echelles));

            afficherEchellesPerformance();
            afficherNotificationSucces('√âchelle supprim√©e');
        }

        function genererNiveauxPersonnalises() {
            const codes = document.getElementById('codesPersonnalises').value.split(',').map(c => c.trim()).filter(c => c);

            if (codes.length === 0) return;

            const niveaux = codes.map((code, i) => ({
                code: code.substring(0, 3).toUpperCase(),
                nom: code,
                description: '',
                min: Math.floor(i * 100 / codes.length),
                max: Math.floor((i + 1) * 100 / codes.length),
                couleur: 'var(--bleu-moyen)'
            }));

            localStorage.setItem('niveauxEchelle', JSON.stringify(niveaux));
            afficherTableauNiveaux(niveaux);
            afficherApercuEchelle(niveaux);
            sauvegarderConfigEchelle();
        }

        // === GESTION DES R√âTROACTIONS ===

        let cartoucheActuel = null;

        function initialiserRetroactions() {
            chargerSelectGrillesRetroaction();
        }

        function chargerSelectGrillesRetroaction() {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const select = document.getElementById('selectGrilleRetroaction');

            select.innerHTML = '<option value="">-- Choisir une grille --</option>';
            grilles.forEach(grille => {
                select.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
            });
        }

        function chargerCartouchesRetroaction() {
            const grilleId = document.getElementById('selectGrilleRetroaction').value;
            const selectCartouche = document.getElementById('selectCartouche');

            if (!grilleId) {
                document.getElementById('aucuneEvalRetroaction').style.display = 'block';
                document.getElementById('infoCartouche').style.display = 'none';
                document.getElementById('matriceRetroaction').style.display = 'none';
                document.getElementById('apercuRetroaction').style.display = 'none';
                document.getElementById('listeCartouchesExistants').style.display = 'none';
                return;
            }

            // Charger les cartouches existants pour cette grille
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');

            selectCartouche.innerHTML = '<option value="">-- Nouvelle cartouche --</option>';
            cartouches.forEach(gab => {
                selectCartouche.innerHTML += `<option value="${gab.id}">${gab.nom}</option>`;
            });

            document.getElementById('aucuneEvalRetroaction').style.display = 'none';
            document.getElementById('infoCartouche').style.display = 'block';

            // Afficher la liste des cartouches existants
            if (cartouches.length > 0) {
                afficherListeCartouches(cartouches, grilleId);
                document.getElementById('listeCartouchesExistants').style.display = 'block';
            } else {
                document.getElementById('listeCartouchesExistants').style.display = 'none';
            }

            // Initialiser une nouvelle cartouche
            initialiserNouveauCartouche(grilleId);
        }

        function initialiserNouveauCartouche(grilleId) {
            // R√©cup√©rer la grille s√©lectionn√©e
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grille = grilles.find(g => g.id === grilleId);

            if (!grille) {
                alert('Grille introuvable');
                return;
            }

            // Les crit√®res viennent directement de la grille
            const criteres = grille.criteres || [];

            // R√©cup√©rer l'√©chelle de performance globale
            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify([
                { code: 'I', nom: 'Incomplet', min: 0, max: 64 },
                { code: 'D', nom: 'En D√©veloppement', min: 65, max: 74 },
                { code: 'M', nom: 'Ma√Ætris√©', min: 75, max: 84 },
                { code: 'E', nom: '√âtendu', min: 85, max: 100 }
            ]));

            // Mettre √† jour les compteurs
            document.getElementById('nbCriteres').textContent = criteres.length;
            document.getElementById('nbNiveaux').textContent = niveaux.length;
            document.getElementById('nbCommentaires').textContent = criteres.length * niveaux.length;
            document.getElementById('pctComplete').textContent = '0%';

            // V√©rifier si la configuration est compl√®te
            if (criteres.length === 0) {
                document.getElementById('matriceRetroaction').innerHTML = `
            <div style="padding: 20px; background: var(--orange-accent)20; border: 2px solid var(--orange-accent); 
                 border-radius: 6px; text-align: center;">
                <strong style="color: var(--orange-accent);">‚ö† Configuration incompl√®te</strong>
                <p style="margin-top: 10px;">Aucun crit√®re n'est d√©fini pour cette grille.</p>
                <p>Veuillez d'abord d√©finir les crit√®res dans la section "Grilles de crit√®res".</p>
            </div>
        `;
                document.getElementById('matriceRetroaction').style.display = 'block';
                document.getElementById('apercuRetroaction').style.display = 'none';
                return;
            }

            if (niveaux.length === 0) {
                document.getElementById('matriceRetroaction').innerHTML = `
            <div style="padding: 20px; background: var(--orange-accent)20; border: 2px solid var(--orange-accent); 
                 border-radius: 6px; text-align: center;">
                <strong style="color: var(--orange-accent);">‚ö† Configuration incompl√®te</strong>
                <p style="margin-top: 10px;">L'√©chelle de performance n'est pas d√©finie.</p>
                <p>Veuillez d'abord configurer l'√©chelle dans la section "√âchelle de performance".</p>
            </div>
        `;
                document.getElementById('matriceRetroaction').style.display = 'block';
                document.getElementById('apercuRetroaction').style.display = 'none';
                return;
            }

            // Cr√©er la nouvelle cartouche
            cartoucheActuel = {
                id: 'GAB' + Date.now(),
                grilleId: grilleId,
                nom: '',
                contexte: '',  // ‚Üê AJOUTER CETTE LIGNE
                criteres: criteres.map(c => ({ id: c.id, nom: c.nom })),
                niveaux: niveaux.map(n => ({ code: n.code, nom: n.nom })),
                commentaires: {},
                verrouille: false
            };

            // R√©initialiser le nom de la cartouche
            document.getElementById('nomCartouche').value = '';
            document.getElementById('contexteCartouche').value = '';  // ‚Üê AJOUTER CETTE LIGNE


            afficherMatriceRetroaction();
            document.getElementById('matriceRetroaction').style.display = 'block';
            document.getElementById('apercuRetroaction').style.display = 'block';
        }

        function chargerMatriceRetroaction() {
            const grilleId = document.getElementById('selectGrilleRetroaction').value;
            const cartoucheId = document.getElementById('selectCartouche').value;

            if (!cartoucheId) {
                initialiserNouveauCartouche(grilleId);
                return;
            }

            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');
            cartoucheActuel = cartouches.find(g => g.id === cartoucheId);

            if (cartoucheActuel) {
                document.getElementById('nomCartouche').value = cartoucheActuel.nom;
                document.getElementById('contexteCartouche').value = cartoucheActuel.contexte || '';  // ‚Üê AJOUTER CETTE LIGNE
                afficherMatriceRetroaction();
                calculerPourcentageComplete();
                document.getElementById('matriceRetroaction').style.display = 'block';
                document.getElementById('apercuRetroaction').style.display = 'block';
            }
        }

        function afficherMatriceRetroaction() {
            if (!cartoucheActuel) return;

            const container = document.getElementById('matriceContainer');

            let html = `
        <table class="tableau" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width: 200px; position: sticky; left: 0; background: var(--bleu-pale);">
                        Crit√®re / Niveau
                    </th>
    `;

            // En-t√™tes des niveaux
            cartoucheActuel.niveaux.forEach(niveau => {
                html += `<th style="text-align: center; background: var(--bleu-pale);">
                    ${niveau.code}<br>
                    <small style="font-weight: normal;">${niveau.nom}</small>
                 </th>`;
            });

            html += '</tr></thead><tbody>';

            // Lignes des crit√®res
            cartoucheActuel.criteres.forEach(critere => {
                html += `
            <tr>
                <td style="font-weight: bold; background: var(--bleu-tres-pale); 
                     position: sticky; left: 0;">
                    ${critere.nom}
                </td>
        `;

                cartoucheActuel.niveaux.forEach(niveau => {
                    const key = `${critere.id}_${niveau.code}`;
                    const commentaire = cartoucheActuel.commentaires[key] || '';

                    html += `
                <td style="padding: 8px;">
                    <textarea class="controle-form" 
                              id="comm_${key}"
                              data-critere="${critere.id}" 
                              data-niveau="${niveau.code}"
                              rows="3" 
                              placeholder="Commentaire pour ${critere.nom} - ${niveau.nom}"
                              onchange="sauvegarderCommentaire('${key}')"
                              style="font-size: 0.85rem; min-width: 200px;">${commentaire}</textarea>
                </td>
            `;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function sauvegarderCommentaire(key) {
            if (!cartoucheActuel) return;

            const textarea = document.getElementById(`comm_${key}`);
            cartoucheActuel.commentaires[key] = textarea.value;

            calculerPourcentageComplete();
        }

        function calculerPourcentageComplete() {
            if (!cartoucheActuel) return;

            const totalCases = cartoucheActuel.criteres.length * cartoucheActuel.niveaux.length;
            let casesRemplies = 0;

            cartoucheActuel.criteres.forEach(critere => {
                cartoucheActuel.niveaux.forEach(niveau => {
                    const key = `${critere.id}_${niveau.code}`;
                    if (cartoucheActuel.commentaires[key] && cartoucheActuel.commentaires[key].trim()) {
                        casesRemplies++;
                    }
                });
            });

            const pourcentage = Math.round((casesRemplies / totalCases) * 100);
            document.getElementById('pctComplete').textContent = pourcentage + '%';

            // Changer la couleur selon le pourcentage
            const element = document.getElementById('pctComplete').parentElement;
            if (pourcentage === 100) {
                element.style.background = 'var(--vert-pale)';
            } else if (pourcentage >= 75) {
                element.style.background = 'var(--bleu-carte)';
            } else if (pourcentage >= 50) {
                element.style.background = 'var(--orange-accent)20';
            } else {
                element.style.background = 'var(--risque-critique)20';
            }
        }

        function sauvegarderCartouche() {
            if (!cartoucheActuel) return;

            const nom = document.getElementById('nomCartouche').value.trim();
            if (!nom) {
                alert('Veuillez donner un nom √† la cartouche');
                return;
            }
            cartoucheActuel.nom = nom;
            cartoucheActuel.contexte = document.getElementById('contexteCartouche').value.trim();  // ‚Üê AJOUTER CETTE LIGNE

            cartoucheActuel.nom = nom;

            const grilleId = cartoucheActuel.grilleId;
            let cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');

            const index = cartouches.findIndex(g => g.id === cartoucheActuel.id);
            if (index >= 0) {
                cartouches[index] = cartoucheActuel;
            } else {
                cartouches.push(cartoucheActuel);
            }

            localStorage.setItem(`cartouches_${grilleId}`, JSON.stringify(cartouches));

            chargerCartouchesRetroaction();
            document.getElementById('selectCartouche').value = cartoucheActuel.id;

            afficherNotificationSucces('Cartouche sauvegard√©e avec succ√®s !');

            if (typeof initialiserEvaluationsIndividuelles === 'function') {
                initialiserEvaluationsIndividuelles();
            }
        }

        function genererApercuAleatoire() {
            if (!cartoucheActuel) return;

            let html = '<h6 style="color: var(--bleu-principal); margin-bottom: 15px;">R√©troaction g√©n√©r√©e automatiquement :</h6>';

            cartoucheActuel.criteres.forEach(critere => {
                // Choisir un niveau al√©atoire
                const niveauIndex = Math.floor(Math.random() * cartoucheActuel.niveaux.length);
                const niveau = cartoucheActuel.niveaux[niveauIndex];
                const key = `${critere.id}_${niveau.code}`;
                const commentaire = cartoucheActuel.commentaires[key] || '[Commentaire non d√©fini]';

                html += `
            <div style="margin-bottom: 15px; padding: 10px; background: var(--bleu-tres-pale); 
                 border-left: 3px solid var(--bleu-moyen); border-radius: 4px;">
                <strong>${critere.nom}</strong> - Niveau : ${niveau.nom} (${niveau.code})
                <p style="margin-top: 5px; margin-bottom: 0;">${commentaire}</p>
            </div>
        `;
            });

            document.getElementById('exempleRetroaction').innerHTML = html;
        }

        function afficherListeCartouches(cartouches, evalId) {
            const container = document.getElementById('listeCartouchesContainer');

            container.innerHTML = cartouches.map(cartouche => `
        <div style="padding: 12px; background: var(--bleu-tres-pale); border: 1px solid var(--bleu-leger); 
             border-radius: 6px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: var(--bleu-principal);">${cartouche.nom}</strong>
                    <small style="color: var(--bleu-leger); margin-left: 10px;">
                        ${Object.keys(cartouche.commentaires || {}).filter(k => cartouche.commentaires[k]).length} / 
                        ${(cartouche.criteres?.length || 0) * (cartouche.niveaux?.length || 0)} commentaires remplis
                    </small>
                </div>
                <div>
                    <label style="font-size: 0.85rem; margin-right: 10px;">
                        <input type="checkbox" id="verrou-cartouche-${cartouche.id}" 
                               onchange="basculerVerrouillageCartouche('${cartouche.id}', '${evalId}')" 
                               ${cartouche.verrouille ? 'checked' : ''}>
                        üîí
                    </label>
                    <button class="btn btn-modifier" onclick="chargerCartouchePourModif('${cartouche.id}', '${evalId}')" 
                            style="padding: 5px 12px; font-size: 0.85rem; 
                                   opacity: ${cartouche.verrouille ? '0.5' : '1'};"
                            ${cartouche.verrouille ? 'disabled' : ''}>
                        Modifier
                    </button>
                    <button class="btn btn-principal" onclick="dupliquerCartouche('${cartouche.id}', '${evalId}')" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;">
                        Dupliquer
                    </button>
                    <button class="btn btn-supprimer" onclick="supprimerCartoucheConfirm('${cartouche.id}', '${evalId}')" 
                            style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;
                                   opacity: ${cartouche.verrouille ? '0.5' : '1'};"
                            ${cartouche.verrouille ? 'disabled' : ''}>
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    `).join('');
        }

        function basculerVerrouillageCartouche(cartoucheId, evalId) {
            let cartouches = JSON.parse(localStorage.getItem(`cartouches_${evalId}`) || '[]');
            const index = cartouches.findIndex(g => g.id === cartoucheId);

            if (index !== -1) {
                cartouches[index].verrouille = document.getElementById(`verrou-cartouche-${cartoucheId}`).checked;
                localStorage.setItem(`cartouches_${evalId}`, JSON.stringify(cartouches));
                afficherListeCartouches(cartouches, evalId);
            }
        }

        function chargerCartouchePourModif(cartoucheId, evalId) {
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${evalId}`) || '[]');
            const cartouche = cartouches.find(g => g.id === cartoucheId);

            if (cartouche && !cartouche.verrouille) {
                document.getElementById('selectCartouche').value = cartoucheId;
                chargerMatriceRetroaction();
            }
        }

        function dupliquerCartouche(cartoucheId, evalId) {
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${evalId}`) || '[]');
            const cartoucheOriginal = cartouches.find(g => g.id === cartoucheId);

            if (cartoucheOriginal) {
                const nouveauCartouche = {
                    ...cartoucheOriginal,
                    id: 'GAB' + Date.now(),
                    nom: cartoucheOriginal.nom + ' (copie)',
                    verrouille: false,
                    commentaires: { ...cartoucheOriginal.commentaires }
                };

                cartouches.push(nouveauCartouche);
                localStorage.setItem(`cartouches_${evalId}`, JSON.stringify(cartouches));

                chargerCartouchesRetroaction();
                document.getElementById('selectCartouche').value = nouveauCartouche.id;
                chargerMatriceRetroaction();

                afficherNotificationSucces('Cartouche dupliqu√© avec succ√®s !');
            }
        }

        function supprimerCartoucheConfirm(cartoucheId, evalId) {
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${evalId}`) || '[]');
            const cartouche = cartouches.find(g => g.id === cartoucheId);

            if (cartouche && cartouche.verrouille) {
                alert('D√©cochez "üîí" avant de supprimer');
                return;
            }

            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la cartouche "${cartouche?.nom}" ?`)) {
                const nouveauxCartouches = cartouches.filter(g => g.id !== cartoucheId);
                localStorage.setItem(`cartouches_${evalId}`, JSON.stringify(nouveauxCartouches));

                chargerCartouchesRetroaction();
                afficherNotificationSucces('Cartouche supprim√©');
            }
        }

        function supprimerCartouche() {
            if (!cartoucheActuel) return;

            const evalId = cartoucheActuel.evalId;
            supprimerCartoucheConfirm(cartoucheActuel.id, evalId);
        }

        // === GESTION DES √âVALUATIONS INDIVIDUELLES ===

        function initialiserEvaluationsIndividuelles() {
            chargerListeEtudiantsEval();
        }

        function chargerListeEtudiantsEval() {
            const students = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const select = document.getElementById('selectEtudiantEval');

            select.innerHTML = '<option value="">-- Choisir un¬∑e √©tudiant¬∑e --</option>';
            students.forEach(student => {
                select.innerHTML += `<option value="${student.id || student.da}">
            ${student.nom}, ${student.prenom} (${student.da})
        </option>`;
            });
        }

        function chargerEvaluationsEtudiant() {
            const etudiantId = document.getElementById('selectEtudiantEval').value;

            const carteProduction = document.querySelector('#evaluations-individuelles .carte:nth-of-type(2)');
            const aucunEtudiantDiv = document.getElementById('aucunEtudiantEval');

            if (!etudiantId) {
                if (carteProduction) carteProduction.style.display = 'none';
                if (aucunEtudiantDiv) aucunEtudiantDiv.style.display = 'block';
                return;
            }

            if (carteProduction) carteProduction.style.display = 'block';
            if (aucunEtudiantDiv) aucunEtudiantDiv.style.display = 'none';

            // R√©cup√©rer la liste des productions
            const listeGrilles = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            // Peupler le select avec les productions (CORRECTION PROBL√àME 1)
            const selectProduction = document.getElementById('selectProduction1');
            if (selectProduction) {
                selectProduction.innerHTML = '<option value="">-- Choisir une √©valuation --</option>';
                listeGrilles.forEach(eval => {
                    // Correction : utiliser titre au lieu de code inexistant
                    selectProduction.innerHTML += `<option value="${eval.id}">${eval.titre}${eval.description ? ' - ' + eval.description : ''}</option>`;
                });
            }

            chargerGrillesDansSelect();
            chargerEchellePerformance();

            // CORRECTION PROBL√àME 2 : Charger depuis le nouveau format
            const toutesEvaluations = JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
            const evaluationsEleve = toutesEvaluations.filter(e => e.etudiantDA === etudiantId);

            // Charger la premi√®re √©valuation trouv√©e (si elle existe)
            if (evaluationsEleve.length > 0) {
                const eval = evaluationsEleve[0]; // Prendre la premi√®re pour l'instant

                // S√©lectionner la production dans le select
                if (selectProduction && eval.productionId) {
                    selectProduction.value = eval.productionId;
                }

                // Charger les niveaux IDME pour chaque crit√®re
                if (eval.criteres && Array.isArray(eval.criteres)) {
                    eval.criteres.forEach(critere => {
                        const selectCritere = document.getElementById(`${critere.nom.toLowerCase()}1`);
                        if (selectCritere) {
                            selectCritere.value = critere.niveau || '';
                        }
                    });
                }

                // Statut de remise
                document.getElementById('remiseProduction1').value = eval.statutRemise || 'non-remis';
                changerStatutRemise(1);
                colorerSelects(1);
                calculerNote(1);

                // R√©troaction finale
                if (eval.retroactionFinale) {
                    document.getElementById('retroactionFinale1').value = eval.retroactionFinale;
                }
            } else {
                // Pas d'√©valuation : r√©initialiser
                document.getElementById('remiseProduction1').value = 'non-remis';
                changerStatutRemise(1);
            }

            // Charger les informations contextuelles
            chargerInfosEvaluation(1);

            // CORRECTION PROBL√àME 3 : Cocher toutes les cases par d√©faut
            ['Description', 'Objectif', 'Tache', 'Adresse', 'Contexte'].forEach(type => {
                const checkbox = document.getElementById(`afficher${type}1`);
                if (checkbox) {
                    checkbox.checked = true; // Toujours coch√© par d√©faut
                }
            });
            basculerAffichageInfo(1);

            // Compter le nombre de productions
            document.getElementById('nbProductions').textContent = listeGrilles.length || '1';
        }

        function attacherEvenementsSelects(productionNum) {
            const criteres = ['structure', 'rigueur', 'plausibilite', 'nuance', 'francais'];

            criteres.forEach(critere => {
                const select = document.getElementById(`${critere}${productionNum}`);
                if (select) {
                    select.addEventListener('change', function () {
                        colorerSelects(productionNum);
                        calculerNote(productionNum);
                    });
                }
            });
        }

        function changerStatutRemise(productionNum) {
            const statut = document.getElementById(`remiseProduction${productionNum}`).value;
            const criteres = ['structure', 'rigueur', 'plausibilite', 'nuance', 'francais'];
            const btnRetro = document.getElementById(`btnRetro${productionNum}`);

            if (statut === 'remis') {
                // Activer tous les selects
                criteres.forEach(critere => {
                    const select = document.getElementById(`${critere}${productionNum}`);
                    if (select) select.disabled = false;
                });
                if (btnRetro) btnRetro.disabled = false;
            } else {
                // D√©sactiver tous les selects et r√©initialiser
                criteres.forEach(critere => {
                    const select = document.getElementById(`${critere}${productionNum}`);
                    if (select) {
                        select.disabled = true;
                        select.value = '';
                    }
                });
                if (btnRetro) btnRetro.disabled = true;
                document.getElementById(`noteProduction${productionNum}`).textContent = '0.0';
                document.getElementById(`niveauProduction${productionNum}`).textContent = 'I';
            }

            sauvegarderGrilleProduction(productionNum);
        }

        function calculerNote(productionNum) {
            const ponderations = {
                structure: 0.15,
                rigueur: 0.20,
                plausibilite: 0.10,
                nuance: 0.25,
                francais: 0.30
            };

            const valeurs = {
                'I': 1,
                'D': 2,
                'M': 3,
                'E': 4
            };

            let noteTotal = 0;
            let ponderationTotal = 0;

            for (let critere in ponderations) {
                const niveau = document.getElementById(`${critere}${productionNum}`).value;
                if (niveau && valeurs[niveau]) {
                    noteTotal += valeurs[niveau] * ponderations[critere];
                    ponderationTotal += ponderations[critere];
                }
            }

            let noteSur4 = 0;
            if (ponderationTotal > 0) {
                noteSur4 = noteTotal / ponderationTotal;
            }

            // D√©terminer le niveau global
            let niveauGlobal = 'I';
            if (noteSur4 >= 3.5) niveauGlobal = 'E';
            else if (noteSur4 >= 2.5) niveauGlobal = 'M';
            else if (noteSur4 >= 1.5) niveauGlobal = 'D';

            document.getElementById(`noteProduction${productionNum}`).textContent = noteSur4.toFixed(1);
            document.getElementById(`niveauProduction${productionNum}`).textContent = niveauGlobal;

            // Changer la couleur selon le niveau
            const noteDiv = document.getElementById(`noteProduction${productionNum}`).parentElement;
            if (niveauGlobal === 'E') {
                noteDiv.style.background = 'var(--risque-nul)';
                noteDiv.style.color = 'white';
            } else if (niveauGlobal === 'M') {
                noteDiv.style.background = 'var(--risque-minimal)';
                noteDiv.style.color = 'white';
            } else if (niveauGlobal === 'D') {
                noteDiv.style.background = 'var(--risque-modere)';
                noteDiv.style.color = 'white';
            } else if (noteSur4 > 0) {
                noteDiv.style.background = 'var(--risque-critique)';
                noteDiv.style.color = 'white';
            } else {
                noteDiv.style.background = 'var(--gris-clair)';
                noteDiv.style.color = 'inherit';
            }

            sauvegarderGrilleProduction(productionNum);
        }

        function sauvegarderGrilleProduction(productionNum) {
            const etudiantId = document.getElementById('selectEtudiantEval').value;
            if (!etudiantId) return;

            let evaluations = JSON.parse(localStorage.getItem(`eval_${etudiantId}`) || '{}');

            evaluations[`production${productionNum}`] = {
                remise: document.getElementById(`remiseProduction${productionNum}`).value,
                structure: document.getElementById(`structure${productionNum}`).value,
                rigueur: document.getElementById(`rigueur${productionNum}`).value,
                plausibilite: document.getElementById(`plausibilite${productionNum}`).value,
                nuance: document.getElementById(`nuance${productionNum}`).value,
                francais: document.getElementById(`francais${productionNum}`).value,
                typeFrancais: document.getElementById(`typeFrancais${productionNum}`).value, // <-- AJOUTER CETTE LIGNE
                note: document.getElementById(`noteProduction${productionNum}`).textContent,
                niveau: document.getElementById(`niveauProduction${productionNum}`).textContent
            };

            localStorage.setItem(`eval_${etudiantId}`, JSON.stringify(evaluations));
        }


        function colorerSelects(productionNum) {
            const criteres = ['structure', 'rigueur', 'plausibilite', 'nuance', 'francais'];
            const couleurs = {
                '': 'white',
                'I': 'var(--risque-critique)',  // Rouge
                'D': 'var(--risque-modere)',  // Orange 
                'M': 'var(--risque-minimal)',  // Vert 
                'E': 'var(--risque-nul)'   // Bleu 
            };

            criteres.forEach(critere => {
                const select = document.getElementById(`${critere}${productionNum}`);
                if (select) {
                    const valeur = select.value;
                    select.style.background = couleurs[valeur] || 'white';
                }
            });
        }

        function changerTypeFrancais(productionNum) {
            const type = document.getElementById(`typeFrancais${productionNum}`).value;

            // Si algorithmique, r√©cup√©rer la formule depuis les crit√®res
            if (type === 'algorithmique') {
                // R√©cup√©rer l'ID de l'√©valuation actuelle (premi√®re √©valuation de la liste)
                const listeGrilles = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
                if (listeGrilles[productionNum - 1]) {
                    const evalId = listeGrilles[productionNum - 1].id;
                    const criteres = JSON.parse(localStorage.getItem(`criteres_${evalId}`) || '[]');
                    const critereFrancais = criteres.find(c => c.nom.toLowerCase().includes('fran√ßais'));

                    if (critereFrancais && critereFrancais.formule) {
                        console.log('Formule algorithmique:', critereFrancais.formule);
                        // La formule sera utilis√©e pour le calcul automatique
                    }
                }
            }

            sauvegarderGrilleProduction(productionNum);
        }

        // AJOUTER ces nouvelles fonctions apr√®s la fonction calculerNote

        function sauvegarderRetroactionFinale(productionNum) {
            const etudiantId = document.getElementById('selectEtudiantEval').value;
            if (!etudiantId) return;

            let evaluations = JSON.parse(localStorage.getItem(`eval_${etudiantId}`) || '{}');
            if (!evaluations[`production${productionNum}`]) {
                evaluations[`production${productionNum}`] = {};
            }

            evaluations[`production${productionNum}`].retroactionFinale =
                document.getElementById(`retroactionFinale${productionNum}`).value;

            localStorage.setItem(`eval_${etudiantId}`, JSON.stringify(evaluations));
        }

        function mettreAJourRetroaction(productionNum) {
            // Combine les r√©troactions individuelles dans le champ final
            const retroactions = document.getElementById(`retroactionsCriteres${productionNum}`).innerText;
            if (retroactions && retroactions !== 'Aucune r√©troaction g√©n√©r√©e') {
                document.getElementById(`retroactionFinale${productionNum}`).value = retroactions;
                sauvegarderRetroactionFinale(productionNum);
            }
        }

        function reinitialiserRetroaction(productionNum) {
            if (confirm('R√©initialiser la r√©troaction finale?')) {
                document.getElementById(`retroactionFinale${productionNum}`).value = '';
                sauvegarderRetroactionFinale(productionNum);
            }
        }

        function copierRetroaction(num) {
            const texte = document.getElementById('retroactionFinale1').value;

            if (!texte || texte.trim() === '') {
                alert('Aucune r√©troaction √† copier');
                return;
            }

            navigator.clipboard.writeText(texte).then(() => {
                afficherNotificationSucces('R√©troaction copi√©e dans le presse-papier !');
            }).catch(err => {
                console.error('Erreur de copie:', err);
                alert('Erreur lors de la copie. Utilisez Cmd+A puis Cmd+C manuellement.');
            });
        }

        function basculerVerrouillageCritere(critereId) {
            if (!grilleTemplateActuelle && (!window.tempCriteres || window.tempCriteres.length === 0)) {
                return;
            }

            let criteres;
            if (grilleTemplateActuelle) {
                criteres = grilleTemplateActuelle.criteres;
            } else {
                criteres = window.tempCriteres;
            }

            const index = criteres.findIndex(c => c.id === critereId);
            if (index !== -1) {
                criteres[index].verrouille = document.getElementById(`unlock-critere-${critereId}`).checked;

                if (grilleTemplateActuelle) {
                    sauvegarderGrilleTemplate();
                }

                afficherListeCriteres(criteres, grilleTemplateActuelle?.id || null);
            }
        }

        function basculerAffichageInfo(productionNum) {
            const afficherDescription = document.getElementById(`afficherDescription${productionNum}`).checked;
            const afficherObjectif = document.getElementById(`afficherObjectif${productionNum}`).checked;
            const afficherTache = document.getElementById(`afficherTache${productionNum}`).checked;

            // Afficher/masquer le conteneur principal
            const conteneur = document.getElementById(`infoContexte${productionNum}`);
            conteneur.style.display = (afficherDescription || afficherObjectif || afficherTache) ? 'block' : 'none';

            // Afficher/masquer chaque section
            document.getElementById(`descriptionEval${productionNum}`).style.display = afficherDescription ? 'block' : 'none';
            document.getElementById(`objectifEval${productionNum}`).style.display = afficherObjectif ? 'block' : 'none';
            document.getElementById(`tacheEval${productionNum}`).style.display = afficherTache ? 'block' : 'none';

            // Sauvegarder les pr√©f√©rences
            const etudiantId = document.getElementById('selectEtudiantEval').value;
            if (etudiantId) {
                let prefs = JSON.parse(localStorage.getItem(`prefsAffichage_${etudiantId}`) || '{}');
                prefs[`production${productionNum}`] = {
                    description: afficherDescription,
                    objectif: afficherObjectif,
                    tache: afficherTache
                };
                localStorage.setItem(`prefsAffichage_${etudiantId}`, JSON.stringify(prefs));
            }
        }

        function chargerInfosEvaluation(productionNum) {
            // R√©cup√©rer les informations depuis la configuration des √©valuations
            const listeGrilles = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            if (listeGrilles[productionNum - 1]) {
                const eval = listeGrilles[productionNum - 1];

                // Mettre √† jour les contenus
                document.querySelector(`.contenuDescription${productionNum}`).textContent =
                    eval.description || 'Non d√©finie';
                document.querySelector(`.contenuObjectif${productionNum}`).textContent =
                    eval.objectif || 'Non d√©fini';
                document.querySelector(`.contenuTache${productionNum}`).textContent =
                    eval.tache || 'Non d√©finie';
            }
        }

        function chargerProduction(productionNum) {
            const evalId = document.getElementById(`selectProduction${productionNum}`).value;
            const etudiantId = document.getElementById('selectEtudiantEval').value;

            if (!evalId || !etudiantId) {
                changerStatutRemise(productionNum);
                return;
            }

            // R√©cup√©rer l'√©valuation s√©lectionn√©e
            const evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const evaluation = evaluations.find(e => e.id === evalId);

            if (!evaluation) {
                alert('√âvaluation introuvable');
                return;
            }

            // Charger la grille si elle existe
            if (evaluation.grilleId) {
                document.getElementById('selectGrille1').value = evaluation.grilleId;
                chargerGrilleSelectionnee();
            }

            // Charger les donn√©es sauvegard√©es pour cette √©valuation et cet √©tudiant
            const evaluationsEtudiant = JSON.parse(localStorage.getItem(`eval_${etudiantId}_${evalId}`) || '{}');

            if (evaluationsEtudiant[`production${productionNum}`]) {
                const eval = evaluationsEtudiant[`production${productionNum}`];
                document.getElementById(`remiseProduction${productionNum}`).value = eval.remise || 'non-remis';

                // Activer/d√©sactiver les selects selon le statut
                changerStatutRemise(productionNum);

                // Charger les valeurs sauvegard√©es dans les selects
                if (eval.criteres) {
                    for (let critereId in eval.criteres) {
                        const selectCritere = document.querySelector(`[data-critere="${critereId}"]`);
                        if (selectCritere) {
                            selectCritere.value = eval.criteres[critereId];
                        }
                    }
                }

                calculerNoteAvecGrille(productionNum);
            } else {
                // R√©initialiser
                document.getElementById(`remiseProduction${productionNum}`).value = 'non-remis';
                changerStatutRemise(productionNum);
            }
        }

        // Ajouter cette fonction pour charger les grilles dans le select
        function chargerGrillesDansSelect() {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const select = document.getElementById('productionGrille');

            select.innerHTML = '<option value="">-- Aucune grille --</option>';
            grilles.forEach(grille => {
                select.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
            });
        }

        // Modifier la fonction afficherFormProduction pour inclure la grille
        function afficherFormProduction(id = null) {
            const formulaire = document.getElementById('formulaireProduction');
            const btnAjouter = document.getElementById('btnajouterProduction');
            const titre = document.getElementById('titreFormEvaluation');
            const btnTexte = document.getElementById('btnTexteEvaluation');

            if (!formulaire || !titre || !btnTexte) {
                console.error('√âl√©ments manquants dans le formulaire');
                return;
            }

            formulaire.style.display = 'block';
            if (btnAjouter) btnAjouter.style.display = 'none';

            // Charger les grilles disponibles (dans tous les cas)
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const selectGrille = document.getElementById('productionGrille');

            if (selectGrille) {
                selectGrille.innerHTML = '<option value="">-- Aucune grille --</option>';
                grilles.forEach(grille => {
                    selectGrille.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
                });
            }

            if (id) {
                // Mode √©dition
                const evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
                const eval = evaluations.find(e => e.id === id);

                if (eval) {
                    productionEnEdition = id;
                    titre.textContent = 'Modifier l\'√©valuation';
                    btnTexte.textContent = 'Sauvegarder';

                    document.getElementById('productionTitre').value = eval.titre;
                    document.getElementById('productionDescription').value = eval.description || '';
                    document.getElementById('productionType').value = eval.type;
                    document.getElementById('productionPonderation').value = eval.ponderation;
                    if (selectGrille) selectGrille.value = eval.grilleId || '';
                    document.getElementById('productionObjectif').value = eval.objectif || '';
                    document.getElementById('productionTache').value = eval.tache || '';
                }
            } else {
                // Mode ajout
                productionEnEdition = null;
                titre.textContent = 'Nouvelle production';
                btnTexte.textContent = 'Ajouter';

                document.getElementById('productionTitre').value = '';
                document.getElementById('productionDescription').value = '';
                document.getElementById('productionType').value = '';
                document.getElementById('productionPonderation').value = '';

                if (selectGrille) selectGrille.value = '';
                document.getElementById('productionObjectif').value = '';
                document.getElementById('productionTache').value = '';
            }
        }

        // Modifier la fonction sauvegarderProduction pour sauvegarder la grille
        function sauvegarderProduction() {
            const titre = document.getElementById('productionTitre').value.trim();
            const description = document.getElementById('productionDescription').value.trim();
            const type = document.getElementById('productionType').value;
            const ponderation = parseInt(document.getElementById('productionPonderation').value) || 0;
            const objectif = document.getElementById('productionObjectif').value.trim();
            const tache = document.getElementById('productionTache').value.trim();
            const grilleId = document.getElementById('productionGrille').value;

            if (!titre || !type || (type !== 'artefact-portfolio' && ponderation === 0)) {
                alert('Veuillez remplir tous les champs obligatoires (Titre, Type et Pond√©ration)');
                return;
            }

            let evaluations = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            // Pr√©parer l'objet de base
            let productionData = {
                titre,
                description,
                type,
                ponderation,
                objectif,
                tache,
                grilleId,
                verrouille: false
            };

            // Si c'est un Portfolio, ajouter les donn√©es sp√©cifiques
            if (type === 'portfolio') {
                productionData.regles = {
                    nombreARetenir: parseInt(document.getElementById('portfolioNombreRetenir').value),
                    minimumCompletion: parseInt(document.getElementById('portfolioMinimumCompleter').value)
                };
                // Pas besoin de stocker artefactsIds - sera d√©tect√© dynamiquement
                productionData.modeCalcul = 'provisoire';
            }

            if (productionEnEdition) {
                // Modifier la production existante
                const index = evaluations.findIndex(e => e.id === productionEnEdition);
                if (index !== -1) {
                    evaluations[index] = {
                        ...evaluations[index],
                        ...productionData
                    };
                }
            } else {
                // Ajouter nouvelle production
                productionData.id = 'PROD' + Date.now();
                evaluations.push(productionData);
            }

            localStorage.setItem('listeGrilles', JSON.stringify(evaluations));

            annulerFormProduction();
            afficherTableauProductions();
            mettreAJourPonderationTotale();

            if (typeof afficherNotificationSucces === 'function') {
                afficherNotificationSucces(productionEnEdition ? 'Production modifi√©e avec succ√®s !' : 'Production ajout√©e avec succ√®s !');
            }

            if (typeof mettreAJourStatutModalites === 'function') {
                mettreAJourStatutModalites();
            }

            productionEnEdition = null;
        }

        function afficherCriteresEvaluation(productionNum, criteres) {
            // Cr√©er un conteneur pour les crit√®res s'il n'existe pas
            let containerCriteres = document.getElementById(`criteresProduction${productionNum}`);

            if (!containerCriteres) {
                // Cr√©er le conteneur et l'ins√©rer dans la structure existante
                containerCriteres = document.createElement('div');
                containerCriteres.id = `criteresProduction${productionNum}`;

                // Trouver o√π l'ins√©rer (apr√®s le statut de remise par exemple)
                const statutRemise = document.querySelector(`#remiseProduction${productionNum}`).parentElement.parentElement;
                statutRemise.parentElement.insertBefore(containerCriteres, statutRemise.nextSibling);
            }

            // G√©n√©rer le HTML pour les crit√®res
            let htmlCriteres = '<div style="margin-top: 15px;">';

            criteres.forEach((critere, index) => {
                htmlCriteres += `
            <div class="groupe-form" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <label style="flex: 1;">${critere.nom} ${critere.ponderation ? `(${critere.ponderation}%)` : ''}</label>
                <select class="controle-form critere-select" id="critere_${productionNum}_${critere.id}" 
                        style="width: 100px;" 
                        onchange="calculerNoteDynamique(${productionNum}); colorerSelectDynamique(${productionNum}, '${critere.id}')" 
                        disabled>
                    <option value="">--</option>
                    <option value="I">I</option>
                    <option value="D">D</option>
                    <option value="M">M</option>
                    <option value="E">E</option>
                </select>
            </div>
        `;
            });

            htmlCriteres += '</div>';

            // Remplacer le contenu existant
            containerCriteres.innerHTML = htmlCriteres;

            // Stocker les crit√®res pour le calcul
            window[`criteres_${productionNum}`] = criteres;
        }

        function afficherCriteresDefaut(productionNum) {
            // Utiliser les crit√®res par d√©faut (structure, rigueur, etc.)
            const criteresDefaut = [
                { id: 'structure', nom: 'Structure', ponderation: 15 },
                { id: 'rigueur', nom: 'Rigueur', ponderation: 20 },
                { id: 'plausibilite', nom: 'Plausibilit√©', ponderation: 10 },
                { id: 'nuance', nom: 'Nuance', ponderation: 25 },
                { id: 'francais', nom: 'Fran√ßais', ponderation: 30 }
            ];

            afficherCriteresEvaluation(productionNum, criteresDefaut);
        }

        function calculerNoteDynamique(productionNum) {
            const criteres = window[`criteres_${productionNum}`];

            if (!criteres) return;

            const valeurs = {
                'I': 1,
                'D': 2,
                'M': 3,
                'E': 4
            };

            let noteTotal = 0;
            let ponderationTotal = 0;

            criteres.forEach(critere => {
                const selectCritere = document.getElementById(`critere_${productionNum}_${critere.id}`);
                if (selectCritere) {
                    const niveau = selectCritere.value;
                    if (niveau && valeurs[niveau]) {
                        const ponderation = (critere.ponderation || 0) / 100;
                        noteTotal += valeurs[niveau] * ponderation;
                        ponderationTotal += ponderation;
                    }
                }
            });

            let noteSur4 = 0;
            if (ponderationTotal > 0) {
                noteSur4 = noteTotal / ponderationTotal;
            }

            // D√©terminer le niveau global
            let niveauGlobal = 'I';
            if (noteSur4 >= 3.5) niveauGlobal = 'E';
            else if (noteSur4 >= 2.5) niveauGlobal = 'M';
            else if (noteSur4 >= 1.5) niveauGlobal = 'D';

            // Mettre √† jour l'affichage
            const noteElement = document.getElementById(`noteProduction${productionNum}`);
            const niveauElement = document.getElementById(`niveauProduction${productionNum}`);

            if (noteElement) noteElement.textContent = noteSur4.toFixed(1);
            if (niveauElement) niveauElement.textContent = niveauGlobal;

            // Changer la couleur selon le niveau
            const noteDiv = noteElement?.parentElement;
            if (noteDiv) {
                if (niveauGlobal === 'E') {
                    noteDiv.style.background = 'var(--bleu-clair)';
                    noteDiv.style.color = 'white';
                } else if (niveauGlobal === 'M') {
                    noteDiv.style.background = 'var(--risque-minimal)';
                    noteDiv.style.color = 'white';
                } else if (niveauGlobal === 'D') {
                    noteDiv.style.background = 'var(--orange-accent)';
                    noteDiv.style.color = 'white';
                } else if (noteSur4 > 0) {
                    noteDiv.style.background = 'var(--risque-critique)';
                    noteDiv.style.color = 'white';
                } else {
                    noteDiv.style.background = 'var(--gris-clair)';
                    noteDiv.style.color = 'inherit';
                }
            }

            // Sauvegarder
            sauvegarderGrilleDynamique(productionNum);
        }

        function colorerSelectCritere(critereId) {
            const couleurs = {
                '': 'white',
                'I': '#ffcccc',
                'D': '#ffb366',
                'M': '#90ee90',
                'E': '#87ceeb'
            };

            const select = document.getElementById(`eval_${critereId}`);
            if (select) {
                select.style.background = couleurs[select.value] || 'white';
            }
        }

        function colorerNoteFinale() {
            const couleurs = {
                'I': '#ffcccc',
                'D': '#ffb366',
                'M': '#90ee90',
                'E': '#87ceeb'
            };

            const niveau = document.getElementById('niveauProduction1').textContent;
            const noteDiv = document.getElementById('noteFinale1');

            if (noteDiv && niveau && niveau !== '--') {
                noteDiv.style.background = couleurs[niveau] || 'var(--bleu-tres-pale)';
            }
        }

        function sauvegarderGrilleDynamique(productionNum) {
            const etudiantId = document.getElementById('selectEtudiantEval').value;
            const evalId = document.getElementById(`selectProduction${productionNum}`).value;

            if (!etudiantId || !evalId) return;

            const criteres = window[`criteres_${productionNum}`];
            if (!criteres) return;

            let evaluations = JSON.parse(localStorage.getItem(`eval_${etudiantId}_${evalId}`) || '{}');

            const criteresNotes = {};
            criteres.forEach(critere => {
                const select = document.getElementById(`critere_${productionNum}_${critere.id}`);
                if (select) {
                    criteresNotes[critere.id] = select.value;
                }
            });

            evaluations[`production${productionNum}`] = {
                remise: document.getElementById(`remiseProduction${productionNum}`).value,
                criteres: criteresNotes,
                note: document.getElementById(`noteProduction${productionNum}`).textContent,
                niveau: document.getElementById(`niveauProduction${productionNum}`).textContent
            };

            localStorage.setItem(`eval_${etudiantId}_${evalId}`, JSON.stringify(evaluations));
        }

        // Fonction pour naviguer vers la liste des √©tudiants
        function allerVersListeEtudiants() {
            // Afficher la section √âtudiant¬∑es et sa sous-navigation
            afficherSection('etudiants');
            // Afficher la sous-section Liste
            afficherSousSection('etudiants-liste');
            // Scroll vers le haut
            window.scrollTo(0, 0);
        }

        // Fonction pour charger les grilles dans le select de la section √âvaluations individuelles
        function chargerGrillesDansSelect() {
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const selectGrille = document.getElementById('selectGrille1');

            if (selectGrille) {
                selectGrille.innerHTML = '<option value="">-- Choisir une grille --</option>';

                // Ajouter les grilles sauvegard√©es
                grilles.forEach(grille => {
                    selectGrille.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
                });
            }
        }

        // Mise √† jour de la fonction afficherCriteresDeGrille pour un meilleur alignement
        function afficherCriteresDeGrille(grille, productionNum) {
            // R√©cup√©rer l'√©chelle configur√©e
            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify([
                { code: 'I', nom: 'Incomplet ou insuffisant', min: 0, max: 64 },
                { code: 'D', nom: 'En D√©veloppement', min: 65, max: 74 },
                { code: 'M', nom: 'Ma√Ætris√©', min: 75, max: 84 },
                { code: 'E', nom: '√âtendu', min: 85, max: 100 }
            ]));

            // Conteneurs
            const listeCriteresDiv = document.getElementById(`listeCriteresGrille${productionNum}`);
            const listeSelectsDiv = document.getElementById(`listeSelectsCriteres${productionNum}`);

            if (!listeCriteresDiv || !listeSelectsDiv) return;

            let criteresHTML = '';
            let selectsHTML = '';

            // Construire les options de l'√©chelle
            let optionsEchelle = '<option value="">--</option>';
            niveaux.forEach(niveau => {
                optionsEchelle += `<option value="${niveau.code}">${niveau.code}</option>`;
            });

            if (grille && grille.criteres && grille.criteres.length > 0) {
                // Ne plus afficher le nom de la grille ici

                grille.criteres.forEach((critere, index) => {
                    // Hauteur fixe pour chaque crit√®re pour assurer l'alignement
                    const hauteurCritere = critere.description ? '80px' : '45px';

                    // Colonne gauche : nom et pond√©ration
                    criteresHTML += `
                <div style="min-height: ${hauteurCritere}; display: flex; flex-direction: column; justify-content: center; 
                            padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <div>
                        <strong style="font-size: 0.9rem;">${critere.nom}</strong>
                        <span style="color: #666; margin-left: 5px; font-size: 0.85rem;">(${critere.ponderation}%)</span>
                    </div>
                    ${critere.description ? `<div style="font-size: 0.75rem; color: #999; margin-top: 3px;">${critere.description}</div>` : ''}
                </div>
            `;

                    // Colonne droite : select align√©
                    selectsHTML += `
                <div style="min-height: ${hauteurCritere}; display: flex; align-items: center; 
                            padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <select class="controle-form critere-select" 
                        id="${critere.nom.toLowerCase().replace(/[^a-z0-9]/g, '')}${productionNum}" 
                        data-critere="${critere.id}"
                        data-ponderation="${critere.ponderation}"
                        style="width: 100%;" 
                        onchange="calculerNoteAvecGrille(${productionNum})" 
                        disabled>
                        ${optionsEchelle}
                    </select>
                </div>
            `;
                });
            } else {
                // Crit√®res par d√©faut avec l'√©chelle configur√©e
                const criteresDefaut = [
                    { nom: 'Structure', ponderation: 15 },
                    { nom: 'Rigueur', ponderation: 20 },
                    { nom: 'Plausibilit√©', ponderation: 10 },
                    { nom: 'Nuance', ponderation: 25 },
                    { nom: 'Fran√ßais', ponderation: 30, special: true }
                ];

                criteresDefaut.forEach(critere => {
                    const hauteurCritere = '45px';

                    criteresHTML += `
                <div style="min-height: ${hauteurCritere}; display: flex; align-items: center; 
                            padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <div>
                        <strong style="font-size: 0.9rem;">${critere.nom}</strong>
                        <span style="color: #666; margin-left: 5px; font-size: 0.85rem;">(${critere.ponderation}%)</span>
                    </div>
                </div>
            `;

                    const critereId = critere.nom.toLowerCase();

                    if (critere.special) {
                        // Cas sp√©cial pour Fran√ßais avec le s√©lecteur H/A
                        selectsHTML += `
                    <div style="min-height: ${hauteurCritere}; display: flex; align-items: center; 
                                padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 5px; width: 100%;">
                            <select class="controle-form critere-select" 
                                id="${critereId}${productionNum}" 
                                data-ponderation="${critere.ponderation}"
                                style="flex: 1;" 
                                onchange="calculerNote(${productionNum}); colorerSelects(${productionNum})" 
                                disabled>
                                ${optionsEchelle}
                            </select>
                            <select id="typeFrancais${productionNum}" 
                                style="width: 35px; font-size: 0.75rem; padding: 4px;" 
                                onchange="changerTypeFrancais(${productionNum})"
                                title="H: Holistique, A: Algorithmique">
                                <option value="holistique">H</option>
                                <option value="algorithmique">A</option>
                            </select>
                        </div>
                    </div>
                `;
                    } else {
                        selectsHTML += `
                    <div style="min-height: ${hauteurCritere}; display: flex; align-items: center; 
                                padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <select class="controle-form critere-select" 
                            id="${critereId}${productionNum}" 
                            data-ponderation="${critere.ponderation}"
                            style="width: 100%;" 
                            onchange="calculerNote(${productionNum}); colorerSelects(${productionNum})" 
                            disabled>
                            ${optionsEchelle}
                        </select>
                    </div>
                `;
                    }
                });
            }

            // Injecter le HTML
            listeCriteresDiv.innerHTML = criteresHTML;
            listeSelectsDiv.innerHTML = selectsHTML;
        }

        // Mise √† jour de changerStatutRemise pour activer/d√©sactiver les bons selects
        function changerStatutRemise(productionNum) {
            const statut = document.getElementById(`remiseProduction${productionNum}`).value;
            const selects = document.querySelectorAll(`#listeSelectsCriteres${productionNum} select.critere-select`);

            if (statut === 'remis') {
                selects.forEach(select => {
                    select.disabled = false;
                });
            } else {
                selects.forEach(select => {
                    select.disabled = true;
                    select.value = '';
                });
                // R√©initialiser la note
                document.getElementById(`noteProduction${productionNum}`).textContent = '0.0';
                document.getElementById(`niveauProduction${productionNum}`).textContent = '--';
            }

            sauvegarderGrilleProduction(productionNum);
        }

        // Fonction pour calculer la note avec une grille personnalis√©e
        function calculerNoteAvecGrille(productionNum) {
            const valeurs = {
                'I': 1,
                'D': 2,
                'M': 3,
                'E': 4
            };

            let noteTotal = 0;
            let ponderationTotal = 0;

            // Parcourir tous les selects de crit√®res
            const selects = document.querySelectorAll('#evaluations-individuelles .critere-select');

            selects.forEach(select => {
                const niveau = select.value;
                const ponderation = parseFloat(select.getAttribute('data-ponderation')) / 100;

                if (niveau && valeurs[niveau]) {
                    noteTotal += valeurs[niveau] * ponderation;
                    ponderationTotal += ponderation;
                }
            });

            let noteSur4 = 0;
            if (ponderationTotal > 0) {
                noteSur4 = noteTotal / ponderationTotal;
            }

            // D√©terminer le niveau global
            let niveauGlobal = 'I';
            if (noteSur4 >= 3.5) niveauGlobal = 'E';
            else if (noteSur4 >= 2.5) niveauGlobal = 'M';
            else if (noteSur4 >= 1.5) niveauGlobal = 'D';

            // Mettre √† jour l'affichage
            document.getElementById(`noteProduction${productionNum}`).textContent = noteSur4.toFixed(1);
            document.getElementById(`niveauProduction${productionNum}`).textContent = niveauGlobal;

            // Mettre √† jour les couleurs
            const noteDiv = document.getElementById(`noteProduction${productionNum}`).parentElement;
            if (niveauGlobal === 'E') {
                noteDiv.style.background = 'var(--bleu-clair)';
                noteDiv.style.color = 'white';
            } else if (niveauGlobal === 'M') {
                noteDiv.style.background = 'var(--risque-minimal)';
                noteDiv.style.color = 'white';
            } else if (niveauGlobal === 'D') {
                noteDiv.style.background = 'var(--orange-accent)';
                noteDiv.style.color = 'white';
            } else if (noteSur4 > 0) {
                noteDiv.style.background = 'var(--risque-critique)';
                noteDiv.style.color = 'white';
            } else {
                noteDiv.style.background = 'var(--gris-clair)';
                noteDiv.style.color = 'inherit';
            }

            // Sauvegarder
            sauvegarderGrilleProduction(productionNum);
        }

        // Fonction pour charger l'√©chelle de performance configur√©e
        function chargerEchellePerformance() {
            // Cette fonction charge maintenant les √©chelles templates au lieu de construire une description
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            const selectEchelle = document.getElementById('selectEchelle1');

            if (!selectEchelle) return;

            selectEchelle.innerHTML = '<option value="">-- Choisir une √©chelle --</option>';
            echelles.forEach(echelle => {
                selectEchelle.innerHTML += `<option value="${echelle.id}">${echelle.nom || '√âchelle sans nom'}</option>`;
            });
        }

        // Fonction pour mettre √† jour les options des selects selon l'√©chelle
        function mettreAJourOptionsEchelle(niveaux) {
            const selects = document.querySelectorAll('#listeSelectsCriteres1 select.critere-select');

            selects.forEach(select => {
                const valeurActuelle = select.value;

                // Reconstruire les options avec les niveaux de l'√©chelle
                let optionsHTML = '<option value="">--</option>';
                niveaux.forEach(niveau => {
                    optionsHTML += `<option value="${niveau.code}">${niveau.code} - ${niveau.nom}</option>`;
                });

                select.innerHTML = optionsHTML;

                // Restaurer la valeur si elle existe toujours
                if (valeurActuelle && niveaux.find(n => n.code === valeurActuelle)) {
                    select.value = valeurActuelle;
                }
            });
        }

        // Mise √† jour de la fonction afficherCriteresDeGrille pour utiliser l'√©chelle configur√©e
        function afficherCriteresDeGrille(grille, productionNum) {
            // R√©cup√©rer l'√©chelle configur√©e
            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify([
                { code: 'I', nom: 'Incomplet ou insuffisant', min: 0, max: 64 },
                { code: 'D', nom: 'En D√©veloppement', min: 65, max: 74 },
                { code: 'M', nom: 'Ma√Ætris√©', min: 75, max: 84 },
                { code: 'E', nom: '√âtendu', min: 85, max: 100 }
            ]));

            // Conteneurs
            const listeCriteresDiv = document.getElementById(`listeCriteresGrille${productionNum}`);
            const listeSelectsDiv = document.getElementById(`listeSelectsCriteres${productionNum}`);

            if (!listeCriteresDiv || !listeSelectsDiv) return;

            let criteresHTML = '';
            let selectsHTML = '';

            // Construire les options de l'√©chelle
            let optionsEchelle = '<option value="">--</option>';
            niveaux.forEach(niveau => {
                optionsEchelle += `<option value="${niveau.code}">${niveau.code} - ${niveau.nom}</option>`;
            });

            if (grille && grille.criteres && grille.criteres.length > 0) {
                criteresHTML = `<div style="font-size: 0.9rem; color: var(--bleu-principal); margin-bottom: 5px;">
            üìä ${grille.nom}
        </div>`;

                grille.criteres.forEach(critere => {
                    // Colonne gauche : nom et pond√©ration
                    criteresHTML += `
                <div style="padding: 6px 0; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0;">
                    <strong>${critere.nom}</strong>
                    <span style="color: #666; margin-left: 5px;">(${critere.ponderation}%)</span>
                    ${critere.description ? `<div style="font-size: 0.8rem; color: #999; margin-top: 2px;">${critere.description}</div>` : ''}
                </div>
            `;

                    // Colonne droite : select avec l'√©chelle configur√©e
                    selectsHTML += `
                <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
                    <select class="controle-form critere-select" 
                        id="${critere.nom.toLowerCase().replace(/[^a-z0-9]/g, '')}${productionNum}" 
                        data-critere="${critere.id}"
                        data-ponderation="${critere.ponderation}"
                        style="width: 100%;" 
                        onchange="calculerNoteAvecGrille(${productionNum})" 
                        disabled>
                        ${optionsEchelle}
                    </select>
                </div>
            `;
                });
            } else {
                // Crit√®res par d√©faut avec l'√©chelle configur√©e
                const criteresDefaut = [
                    { nom: 'Structure', ponderation: 15 },
                    { nom: 'Rigueur', ponderation: 20 },
                    { nom: 'Plausibilit√©', ponderation: 10 },
                    { nom: 'Nuance', ponderation: 25 },
                    { nom: 'Fran√ßais', ponderation: 30, special: true }
                ];

                criteresHTML = `<div style="font-size: 0.9rem; color: var(--bleu-principal); margin-bottom: 5px;">
            üìä Crit√®res standards
        </div>`;

                criteresDefaut.forEach(critere => {
                    criteresHTML += `
                <div style="padding: 6px 0; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0;">
                    <strong>${critere.nom}</strong>
                    <span style="color: #666; margin-left: 5px;">(${critere.ponderation}%)</span>
                </div>
            `;

                    const critereId = critere.nom.toLowerCase();

                    if (critere.special) {
                        // Cas sp√©cial pour Fran√ßais avec le s√©lecteur H/A
                        selectsHTML += `
                    <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <select class="controle-form critere-select" 
                                id="${critereId}${productionNum}" 
                                data-ponderation="${critere.ponderation}"
                                style="flex: 1;" 
                                onchange="calculerNote(${productionNum}); colorerSelects(${productionNum})" 
                                disabled>
                                ${optionsEchelle}
                            </select>
                            <select id="typeFrancais${productionNum}" 
                                style="width: 40px; font-size: 0.8rem;" 
                                onchange="changerTypeFrancais(${productionNum})">
                                <option value="holistique">H</option>
                                <option value="algorithmique">A</option>
                            </select>
                        </div>
                    </div>
                `;
                    } else {
                        selectsHTML += `
                    <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
                        <select class="controle-form critere-select" 
                            id="${critereId}${productionNum}" 
                            data-ponderation="${critere.ponderation}"
                            style="width: 100%;" 
                            onchange="calculerNote(${productionNum}); colorerSelects(${productionNum})" 
                            disabled>
                            ${optionsEchelle}
                        </select>
                    </div>
                `;
                    }
                });
            }

            // Injecter le HTML
            listeCriteresDiv.innerHTML = criteresHTML;
            listeSelectsDiv.innerHTML = selectsHTML;
        }

        // Mise √† jour de calculerNoteAvecGrille pour utiliser l'√©chelle configur√©e
        function calculerNoteAvecGrille(productionNum) {
            // R√©cup√©rer l'√©chelle configur√©e
            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || JSON.stringify([
                { code: 'I', nom: 'Incomplet ou insuffisant', min: 0, max: 64 },
                { code: 'D', nom: 'En D√©veloppement', min: 65, max: 74 },
                { code: 'M', nom: 'Ma√Ætris√©', min: 75, max: 84 },
                { code: 'E', nom: '√âtendu', min: 85, max: 100 }
            ]));

            // Cr√©er un mapping des codes vers les valeurs
            const valeurs = {};
            niveaux.forEach((niveau, index) => {
                // Valeur de 1 √† N (nombre de niveaux)
                valeurs[niveau.code] = index + 1;
            });

            let noteTotal = 0;
            let ponderationTotal = 0;

            // Parcourir tous les selects de crit√®res
            const selects = document.querySelectorAll(`#listeSelectsCriteres${productionNum} select.critere-select`);

            selects.forEach(select => {
                const niveau = select.value;
                const ponderation = parseFloat(select.getAttribute('data-ponderation')) / 100;

                if (niveau && valeurs[niveau]) {
                    noteTotal += valeurs[niveau] * ponderation;
                    ponderationTotal += ponderation;
                }
            });

            let noteSur4 = 0;
            if (ponderationTotal > 0) {
                // Normaliser sur une √©chelle de 1 √† 4 (peu importe le nombre de niveaux)
                const nombreNiveaux = niveaux.length;
                noteSur4 = (noteTotal / ponderationTotal - 1) * 4 / (nombreNiveaux - 1) + 1;
            }

            // D√©terminer le niveau global bas√© sur les seuils
            let niveauGlobal = niveaux[0].code; // Par d√©faut, le plus bas
            const pourcentage = ((noteSur4 - 1) / 3) * 100; // Convertir la note sur 4 en pourcentage

            for (let i = niveaux.length - 1; i >= 0; i--) {
                if (pourcentage >= niveaux[i].min) {
                    niveauGlobal = niveaux[i].code;
                    break;
                }
            }

            // Mettre √† jour l'affichage
            document.getElementById(`noteProduction${productionNum}`).textContent = noteSur4.toFixed(1);
            document.getElementById(`niveauProduction${productionNum}`).textContent = niveauGlobal;

            // Mettre √† jour les couleurs selon le niveau
            const noteDiv = document.getElementById(`noteProduction${productionNum}`).parentElement;
            const niveauTrouve = niveaux.find(n => n.code === niveauGlobal);

            if (niveauTrouve && niveauTrouve.couleur) {
                noteDiv.style.background = niveauTrouve.couleur;
                noteDiv.style.color = 'white';
            } else {
                noteDiv.style.background = 'var(--gris-clair)';
                noteDiv.style.color = 'inherit';
            }

            // Sauvegarder
            sauvegarderGrilleProduction(productionNum);
        }

        // === AJOUT DANS LA SECTION GESTION DE L'√âCHELLE DE PERFORMANCE ===

        // Variables globales pour la gestion des √©chelles
        let echelleActuelle = null;

        // Charger les √©chelles dans le select au d√©marrage
        function chargerEchellesTemplates() {
            const select = document.getElementById('selectEchelleTemplate');
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');

            let options = '<option value="">-- Nouvelle √©chelle --</option>';
            options += '<option value="new">‚ûï Cr√©er une nouvelle √©chelle</option>';

            echelles.forEach(echelle => {
                options += `<option value="${echelle.id}">${echelle.nom}</option>`;
            });

            select.innerHTML = options;
        }

        // Fonction pour charger une √©chelle template
        function chargerEchelleTemplate() {
            const selectValue = document.getElementById('selectEchelleTemplate').value;
            const nomContainer = document.getElementById('nomEchelleContainer');

            if (!selectValue || selectValue === 'new') {
                // Nouvelle √©chelle
                nomContainer.style.display = 'block';
                document.getElementById('nomEchelleTemplate').value = '';

                // R√©initialiser aux valeurs par d√©faut
                reinitialiserNiveauxDefaut();
                echelleActuelle = null;

                // Masquer le bouton dupliquer
                document.getElementById('btnDupliquerEchelle').style.display = 'none';
            } else {
                // Charger une √©chelle existante
                const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
                const echelle = echelles.find(e => e.id === selectValue);

                if (echelle) {
                    nomContainer.style.display = 'block';
                    document.getElementById('nomEchelleTemplate').value = echelle.nom;

                    // Charger les niveaux
                    localStorage.setItem('niveauxEchelle', JSON.stringify(echelle.niveaux));
                    afficherTableauNiveaux(echelle.niveaux);
                    afficherApercuEchelle(echelle.niveaux);

                    // Charger la config
                    if (echelle.config) {
                        localStorage.setItem('configEchelle', JSON.stringify(echelle.config));
                        if (echelle.config.typeEchelle) {
                            document.getElementById('typeEchelle').value = echelle.config.typeEchelle;
                        }
                        if (echelle.config.seuilReussite !== undefined) {
                            document.getElementById('seuilReussite').value = echelle.config.seuilReussite;
                        }
                        changerTypeEchelle();
                    }

                    echelleActuelle = echelle;

                    // Afficher le bouton dupliquer
                    document.getElementById('btnDupliquerEchelle').style.display = 'inline-block';
                }
            }
        }

        // Sauvegarder le nom de l'√©chelle
        function sauvegarderNomEchelle() {
            const nom = document.getElementById('nomEchelleTemplate').value;
            if (echelleActuelle) {
                echelleActuelle.nom = nom;
            }
        }

        // Enregistrer comme √©chelle template
        function enregistrerCommeEchelle() {
            const nom = document.getElementById('nomEchelleTemplate').value;

            if (!nom || nom.trim() === '') {
                alert('Veuillez donner un nom √† cette √©chelle');
                return;
            }

            const niveaux = JSON.parse(localStorage.getItem('niveauxEchelle') || '[]');
            const config = JSON.parse(localStorage.getItem('configEchelle') || '{}');

            let echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');

            if (echelleActuelle) {
                // Mise √† jour de l'√©chelle existante
                const index = echelles.findIndex(e => e.id === echelleActuelle.id);
                if (index !== -1) {
                    echelles[index] = {
                        ...echelleActuelle,
                        nom: nom,
                        niveaux: niveaux,
                        config: config,
                        dateModification: new Date().toISOString()
                    };
                }
            } else {
                // Nouvelle √©chelle
                const nouvelleEchelle = {
                    id: 'ECH' + Date.now(),
                    nom: nom,
                    niveaux: niveaux,
                    config: config,
                    dateCreation: new Date().toISOString()
                };
                echelles.push(nouvelleEchelle);
                echelleActuelle = nouvelleEchelle;
            }

            localStorage.setItem('echellesTemplates', JSON.stringify(echelles));

            // Recharger le select
            chargerEchellesTemplates();
            document.getElementById('selectEchelleTemplate').value = echelleActuelle.id;

            // Afficher le bouton dupliquer
            document.getElementById('btnDupliquerEchelle').style.display = 'inline-block';

            // Notification de succ√®s
            afficherNotificationSucces('‚úÖ √âchelle ¬´ ' + nom + ' ¬ª sauvegard√©e avec succ√®s !');
        }

        // Afficher les √©chelles existantes dans la modal
        function afficherEchellesPerformance() {
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            const listeDiv = document.getElementById('listeEchelles');

            if (echelles.length === 0) {
                listeDiv.innerHTML = '<p style="text-align: center; color: #999;">Aucune √©chelle sauvegard√©e</p>';
            } else {
                listeDiv.innerHTML = echelles.map(echelle => `
            <div style="margin-bottom: 15px; padding: 15px; background: var(--bleu-tres-pale); 
                        border-radius: 6px; border: 1px solid var(--bleu-leger);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; color: var(--bleu-principal);">${echelle.nom}</h4>
                        <div style="font-size: 0.9rem; color: #666;">
                            Niveaux : ${echelle.niveaux.map(n => n.code).join('-')}
                        </div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">
                            Cr√©√©e le ${new Date(echelle.dateCreation).toLocaleDateString('fr-CA')}
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-modifier" onclick="chargerEchelleDepuisModal('${echelle.id}')">
                            üìù Utiliser
                        </button>
                        <button class="btn btn-supprimer" onclick="supprimerEchelle('${echelle.id}')">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
            }

            document.getElementById('modalEchelles').style.display = 'block';
        }

        // Fermer la modal
        function fermerModalEchelles() {
            document.getElementById('modalEchelles').style.display = 'none';
        }

        // Charger une √©chelle depuis la modal
        function chargerEchelleDepuisModal(echelleId) {
            document.getElementById('selectEchelleTemplate').value = echelleId;
            chargerEchelleTemplate();
            fermerModalEchelles();
        }

        // Dupliquer l'√©chelle actuelle
        function dupliquerEchelleActuelle() {
            if (!echelleActuelle) return;

            const nouveauNom = prompt('Nom de la nouvelle √©chelle :', echelleActuelle.nom + ' (copie)');
            if (!nouveauNom) return;

            const nouvelleEchelle = {
                id: 'ECH' + Date.now(),
                nom: nouveauNom,
                niveaux: [...echelleActuelle.niveaux],
                config: { ...echelleActuelle.config },
                dateCreation: new Date().toISOString()
            };

            let echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            echelles.push(nouvelleEchelle);
            localStorage.setItem('echellesTemplates', JSON.stringify(echelles));

            // Charger la nouvelle √©chelle
            chargerEchellesTemplates();
            document.getElementById('selectEchelleTemplate').value = nouvelleEchelle.id;
            chargerEchelleTemplate();

            afficherNotificationSucces('üìë √âchelle dupliqu√©e avec succ√®s !');
        }

        // Supprimer une √©chelle
        function supprimerEchelle(echelleId) {
            if (!confirm('Supprimer cette √©chelle ?')) return;

            let echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            echelles = echelles.filter(e => e.id !== echelleId);
            localStorage.setItem('echellesTemplates', JSON.stringify(echelles));

            afficherEchellesPerformance();
            afficherNotificationSucces('√âchelle supprim√©e');
        }

        // Fonction pour charger les √©chelles de performance dans le select
        function chargerEchellesPerformance() {
            const selectEchelle = document.getElementById('selectEchelle1');
            if (!selectEchelle) return;

            // Vider le select et ajouter l'option par d√©faut
            selectEchelle.innerHTML = '<option value="">-- Choisir une √©chelle --</option>';

            // Essayer diff√©rentes cl√©s possibles dans localStorage
            let echelles = [];

            // V√©rifier d'abord la cl√© 'echelles' (plus probable)
            const echellesData = localStorage.getItem('echelles');
            if (echellesData) {
                try {
                    echelles = JSON.parse(echellesData);
                    console.log('√âchelles trouv√©es sous "echelles":', echelles);
                } catch (e) {
                    console.error('Erreur parsing √©chelles:', e);
                }
            }

            // Si vide, essayer 'echellesPerformance'
            if (echelles.length === 0) {
                const echellesPerf = localStorage.getItem('echellesPerformance');
                if (echellesPerf) {
                    try {
                        echelles = JSON.parse(echellesPerf);
                        console.log('√âchelles trouv√©es sous "echellesPerformance":', echelles);
                    } catch (e) {
                        console.error('Erreur parsing echellesPerformance:', e);
                    }
                }
            }

            // Si vide, essayer 'configEchelles'
            if (echelles.length === 0) {
                const configEchelles = localStorage.getItem('configEchelles');
                if (configEchelles) {
                    try {
                        echelles = JSON.parse(configEchelles);
                        console.log('√âchelles trouv√©es sous "configEchelles":', echelles);
                    } catch (e) {
                        console.error('Erreur parsing configEchelles:', e);
                    }
                }
            }

            // Ajouter chaque √©chelle trouv√©e comme option
            if (echelles && echelles.length > 0) {
                echelles.forEach(echelle => {
                    const option = document.createElement('option');
                    // G√©rer diff√©rentes structures possibles
                    if (typeof echelle === 'string') {
                        option.value = echelle;
                        option.textContent = echelle;
                    } else if (echelle.nom || echelle.name) {
                        const nom = echelle.nom || echelle.name;
                        const desc = echelle.description || echelle.desc || '';
                        option.value = nom;
                        option.textContent = desc ? `${nom} (${desc})` : nom;
                    } else if (echelle.code) {
                        option.value = echelle.code;
                        option.textContent = echelle.libelle || echelle.code;
                    }
                    selectEchelle.appendChild(option);
                });
            } else {
                console.log('Aucune √©chelle trouv√©e dans localStorage');
                // Optionnel : ajouter des √©chelles par d√©faut pour tester
                const echellesParDefaut = [
                    { nom: 'UMRE', description: 'Unacceptable-Minimal-Raisonnable-Excellent' },
                    { nom: 'IDME', description: 'Insuffisant-D√©velopp√©-Ma√Ætris√©-Expert' }
                ];
                echellesParDefaut.forEach(echelle => {
                    const option = document.createElement('option');
                    option.value = echelle.nom;
                    option.textContent = `${echelle.nom} (${echelle.description})`;
                    selectEchelle.appendChild(option);
                });
            }
        }

        // === FONCTION DE D√âBOGAGE (TEMPORAIRE) ===
        function debugLocalStorage() {
            console.log('=== CONTENU DE LOCALSTORAGE ===');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.toLowerCase().includes('echel') || key.toLowerCase().includes('scale')) {
                    console.log(`${key}:`, localStorage.getItem(key));
                }
            }
        }

        function sauvegarderConfigCours() {
            const configCours = {
                codeCours: document.querySelector('#reglages-cours input[value="601-101-MQ"]').value,
                nomCours: document.querySelector('#reglages-cours input[value="√âcriture et litt√©rature"]').value,
                numeroCompetence: document.querySelector('#reglages-cours input[value="4EF0"]').value,
                competence: document.querySelector('#reglages-cours input[value="Analyser des textes litt√©raires"]').value,
                elementsCompetence: document.querySelector('#reglages-cours textarea').value,
                prenomEnseignant: document.querySelector('#reglages-cours input[value="Gr√©goire"]').value,
                nomEnseignant: document.querySelector('#reglages-cours input[value="B√©dard"]').value,
                departement: document.querySelector('#reglages-cours input[value="Litt√©rature et communication"]').value,
                local: document.querySelector('#reglages-cours input[value="2314"]').value,
                session: document.querySelector('#reglages-cours select').value,
                annee: document.querySelector('#reglages-cours input[type="number"][value="2025"]').value,
                heuresParSemaine: document.querySelector('#reglages-cours input[type="number"][value="4"]').value,
                dateEnregistrement: new Date().toISOString()
            };

            localStorage.setItem('configurationCours', JSON.stringify(configCours));

            afficherNotification('Configuration du cours sauvegard√©e !', 'succes');
        }

        // Variables globales
        let coursEnEdition = null;

        function afficherTableauCours() {
            const cours = JSON.parse(localStorage.getItem('listeCours') || '[]');
            const container = document.getElementById('tableauCoursContainer');

            if (cours.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucun cours configur√©.</p>';
                document.getElementById('nombreCours').textContent = '0';
                document.getElementById('resumeCours').textContent = 'Aucune configuration de cours';
                return;
            }

            let html = `
    <table class="tableau">
        <thead>
            <tr>
                <th>Code</th>
                <th>Nom du cours</th>
                <th>Enseignant¬∑e</th>
                <th>Session</th>
                <th style="width: 60px;">Actif</th>
                <th style="width: 60px;">üîí</th>
                <th style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody>
`;

            cours.forEach(c => {
                const isVerrouille = c.verrouille || false;

                html += `
        <tr style="opacity: ${isVerrouille ? '0.7' : '1'};">
            <td><strong>${c.codeCours}</strong></td>
            <td>
                ${c.nomCours}
                <br><small style="color: var(--gris-moyen);">${c.competence}</small>
            </td>
            <td>${c.prenomEnseignant} ${c.nomEnseignant}</td>
            <td>${c.session}${c.annee}</td>
            <td style="text-align: center;">
                <input type="radio" 
                       name="cours-actif" 
                       ${c.actif ? 'checked' : ''}
                       onchange="activerCours('${c.id}')"
                       title="D√©finir comme cours actif">
            </td>
            <td style="text-align: center;">
                <input type="checkbox" 
                       id="verrou-cours-${c.id}" 
                       ${isVerrouille ? 'checked' : ''}
                       onchange="basculerVerrouillageCours('${c.id}')"
                       title="Verrouiller/D√©verrouiller">
            </td>
            <td>
                <div class="btn-groupe" style="gap: 5px;">
                    <button class="btn btn-principal btn-sm" 
                            onclick="voirCours('${c.id}')"
                            title="Voir les d√©tails">
                        voir
                    </button>
                    <button class="btn btn-modifier btn-sm" 
                            onclick="modifierCours('${c.id}')"
                            ${isVerrouille ? 'disabled' : ''}
                            title="Modifier">
                        modifier
                    </button>
                    <button class="btn btn-ajouter btn-sm" 
                            onclick="dupliquerCours('${c.id}')"
                            title="Dupliquer">
                        dupliquer
                    </button>
                    <button class="btn btn-supprimer btn-sm" 
                            onclick="supprimerCours('${c.id}')"
                            ${isVerrouille ? 'disabled' : ''}
                            title="Supprimer">
                        supprimer
                    </button>
                </div>
            </td>
        </tr>
    `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Mettre √† jour les statistiques
            document.getElementById('nombreCours').textContent = cours.length;

            // Trouver le cours actif
            const coursActif = cours.find(c => c.actif) || cours[0];
            if (coursActif) {
                document.getElementById('sessionActive').textContent = coursActif.session + coursActif.annee;
                document.getElementById('resumeCours').textContent =
                    `${coursActif.codeCours} - ${coursActif.nomCours}`;
            }
        }

        // Ajouter ces fonctions apr√®s la fonction afficherTableauCours()

        function voirCours(id) {
            const cours = JSON.parse(localStorage.getItem('listeCours') || '[]');
            const c = cours.find(cours => cours.id === id);

            if (c) {
                alert(`üìö D√©tails du cours\n\n` +
                    `Code: ${c.codeCours}\n` +
                    `Nom: ${c.nomCours}\n` +
                    `Comp√©tence: ${c.competence}\n` +
                    `Enseignant¬∑e: ${c.prenomEnseignant} ${c.nomEnseignant}\n` +
                    `Session: ${c.session}${c.annee}\n` +
                    `Format: ${c.formatHoraire}`);
            }
        }

        function modifierCours(id) {
            afficherFormCours(id);
        }

        function dupliquerCours(id) {
            const cours = JSON.parse(localStorage.getItem('listeCours') || '[]');
            const coursOriginal = cours.find(c => c.id === id);

            if (coursOriginal) {
                const nouveauCours = {
                    ...coursOriginal,
                    id: 'COURS' + Date.now(),
                    codeCours: coursOriginal.codeCours + ' (copie)',
                    dateEnregistrement: new Date().toISOString(),
                    actif: false,
                    verrouille: false
                };

                cours.push(nouveauCours);
                localStorage.setItem('listeCours', JSON.stringify(cours));
                afficherTableauCours();
                afficherNotification('Cours dupliqu√© avec succ√®s !');
            }
        }

        function supprimerCours(id) {
            const cours = JSON.parse(localStorage.getItem('listeCours') || '[]');
            const coursASupprimer = cours.find(c => c.id === id);

            if (coursASupprimer && coursASupprimer.verrouille) {
                alert('D√©cochez "üîí" avant de supprimer ce cours');
                return;
            }

            if (confirm(`√ätes-vous s√ªr de vouloir supprimer le cours ${coursASupprimer?.codeCours} ?`)) {
                const coursFiltre = cours.filter(c => c.id !== id);
                localStorage.setItem('listeCours', JSON.stringify(coursFiltre));
                afficherTableauCours();
                afficherNotification('Cours supprim√©');
            }
        }

        function afficherFormCours(id = null) {
            const formulaire = document.getElementById('formulaireCours');
            const btnAjouter = document.getElementById('btnAjouterCours');
            const titre = document.getElementById('titreFormCours');
            const btnTexte = document.getElementById('btnTexteCours');

            formulaire.style.display = 'block';
            btnAjouter.style.display = 'none';

            if (id) {
                // Mode √©dition
                const cours = JSON.parse(localStorage.getItem('listeCours') || '[]');
                const c = cours.find(cours => cours.id === id);

                if (c) {
                    coursEnEdition = id;
                    titre.textContent = 'Modifier la configuration';
                    btnTexte.textContent = 'Sauvegarder';

                    // Remplir les champs
                    document.getElementById('codeCours').value = c.codeCours || '';
                    document.getElementById('nomCours').value = c.nomCours || '';
                    document.getElementById('numeroCompetence').value = c.numeroCompetence || '';
                    document.getElementById('competence').value = c.competence || '';
                    document.getElementById('elementsCompetence').value = c.elementsCompetence || '';
                    document.getElementById('prenomEnseignant').value = c.prenomEnseignant || '';
                    document.getElementById('nomEnseignant').value = c.nomEnseignant || '';
                    document.getElementById('departement').value = c.departement || '';
                    document.getElementById('local').value = c.local || '';
                    document.getElementById('session').value = c.session || 'H';
                    document.getElementById('annee').value = c.annee || '2025';
                    document.getElementById('heuresParSemaine').value = c.heuresParSemaine || '4';
                    document.getElementById('formatHoraire').value = c.formatHoraire || '2x2';
                }
            } else {
                // Mode ajout
                coursEnEdition = null;
                titre.textContent = 'Nouvelle configuration de cours';
                btnTexte.textContent = 'Ajouter';
                // R√©initialiser les champs si n√©cessaire
            }
        }

        function annulerFormCours() {
            document.getElementById('formulaireCours').style.display = 'none';
            document.getElementById('btnAjouterCours').style.display = 'inline-block';
            coursEnEdition = null;
        }

        function sauvegarderCours() {
            // D√©clarer cours AVANT de l'utiliser
            let cours = JSON.parse(localStorage.getItem('listeCours') || '[]');

            const nouveauCours = {
                id: coursEnEdition || 'COURS' + Date.now(),
                codeCours: document.getElementById('codeCours').value,
                nomCours: document.getElementById('nomCours').value,
                numeroCompetence: document.getElementById('numeroCompetence').value,
                competence: document.getElementById('competence').value,
                elementsCompetence: document.getElementById('elementsCompetence').value,
                prenomEnseignant: document.getElementById('prenomEnseignant').value,
                nomEnseignant: document.getElementById('nomEnseignant').value,
                departement: document.getElementById('departement').value,
                local: document.getElementById('local').value,
                session: document.getElementById('session').value,
                annee: document.getElementById('annee').value,
                heuresParSemaine: document.getElementById('heuresParSemaine').value,
                formatHoraire: document.getElementById('formatHoraire').value,
                verrouille: coursEnEdition ? cours.find(c => c.id === coursEnEdition)?.verrouille : true,
                dateEnregistrement: new Date().toISOString()
            };

            if (coursEnEdition) {
                // Modification
                const index = cours.findIndex(c => c.id === coursEnEdition);
                if (index !== -1) {
                    cours[index] = { ...cours[index], ...nouveauCours };
                }
            } else {
                // Ajout
                cours.push(nouveauCours);
            }

            localStorage.setItem('listeCours', JSON.stringify(cours));

            afficherTableauCours();
            annulerFormCours();

            // Notification simplifi√©e
            if (coursEnEdition) {
                afficherNotification('Configuration du cours modifi√©e avec succ√®s !');
            } else {
                afficherNotification('Configuration du cours ajout√©e avec succ√®s !');
            }
        }

        // Autres fonctions auxiliaires
        function basculerVerrouillageCours(id) {
            let cours = JSON.parse(localStorage.getItem('listeCours') || '[]');
            const index = cours.findIndex(c => c.id === id);

            if (index !== -1) {
                cours[index].verrouille = document.getElementById(`verrou-cours-${id}`).checked;
                localStorage.setItem('listeCours', JSON.stringify(cours));
                afficherTableauCours();
            }
        }

        function activerCours(id) {
            let cours = JSON.parse(localStorage.getItem('listeCours') || '[]');

            // D√©sactiver tous les cours
            cours.forEach(c => c.actif = false);

            // Activer le cours s√©lectionn√©
            const index = cours.findIndex(c => c.id === id);
            if (index !== -1) {
                cours[index].actif = true;
            }

            localStorage.setItem('listeCours', JSON.stringify(cours));
            afficherTableauCours();
            afficherNotification('Cours activ√© !');
        }

        function afficherTableauCongesPrevus() {
            const evenements = JSON.parse(localStorage.getItem('evenementsPrevus') || '[]');
            const container = document.getElementById('congesPrevusContainer');

            if (evenements.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-style: italic;">Aucun cong√© pr√©vu configur√©.</p>';
                return;
            }

            let html = `
        <table class="tableau">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Reprise</th>
                    <th style="width: 60px;">üîí</th>
                    <th style="width: 150px;">Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

            evenements.forEach(evt => {
                const isVerrouille = evt.verrouille || false;

                html += `
            <tr style="opacity: ${isVerrouille ? '0.7' : '1'};">
                <td>${formatDate(evt.dateEvenement)}</td>
                <td>${evt.description}</td>
                <td>${evt.horaireReprise} - ${formatDate(evt.dateReprise)}</td>
                <td style="text-align: center;">
                    <input type="checkbox" 
                           ${isVerrouille ? 'checked' : ''}
                           onchange="basculerVerrouillageEvenement('${evt.id}', 'prevus')">
                </td>
                <td>
                    <div class="btn-groupe" style="gap: 5px;">
                        <button class="btn btn-modifier btn-sm" 
                                onclick="modifierEvenement('${evt.id}', 'prevus')"
                                ${isVerrouille ? 'disabled' : ''}>Modifier</button>
                        <button class="btn btn-supprimer btn-sm" 
                                onclick="supprimerEvenement('${evt.id}', 'prevus')"
                                ${isVerrouille ? 'disabled' : ''}>Supprimer</button>
                    </div>
                </td>
            </tr>
        `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Afficher la zone d'import
        function afficherImportCommentaires() {
            document.getElementById('zoneImportCommentaires').style.display = 'block';
            document.getElementById('matriceRetroaction').style.display = 'none';
        }

        // Annuler l'import
        function annulerImportCommentaires() {
            document.getElementById('zoneImportCommentaires').style.display = 'none';
            document.getElementById('matriceRetroaction').style.display = 'block';
            document.getElementById('commentairesColles').value = '';
        }

        // Parser et importer les commentaires
        function importerCommentaires() {
            const texte = document.getElementById('commentairesColles').value.trim();

            if (!texte) {
                alert('Veuillez coller vos commentaires');
                return;
            }

            if (!cartoucheActuel) {
                alert('Aucune cartouche active');
                return;
            }

            try {
                // Parser le texte
                const lignes = texte.split('\n');
                let critereActuel = null;
                let compteur = 0;

                lignes.forEach(ligne => {
                    ligne = ligne.trim();

                    // D√©tecter un titre de crit√®re : ## CRIT√àRE
                    if (ligne.startsWith('##')) {
                        critereActuel = ligne.replace('##', '').trim().toUpperCase();
                        return;
                    }

                    // D√©tecter un commentaire : **CRIT√àRE (NIVEAU)** : Texte...
                    const match = ligne.match(/^\*\*(.+?)\s*\(([IDME])\)\*\*\s*:\s*(.+)$/);
                    if (match && critereActuel) {
                        const nomCritere = match[1].trim().toUpperCase();
                        const niveau = match[2].trim();
                        const commentaire = match[3].trim();

                        // V√©rifier que le crit√®re correspond
                        if (nomCritere === critereActuel) {
                            // Trouver le crit√®re correspondant dans la cartouche
                            const critere = cartoucheActuel.criteres.find(c =>
                                c.nom.toUpperCase() === critereActuel
                            );

                            if (critere) {
                                const key = `${critere.id}_${niveau}`;
                                cartoucheActuel.commentaires[key] = commentaire;
                                compteur++;
                            }
                        }
                    }
                });

                if (compteur === 0) {
                    alert('Aucun commentaire n\'a pu √™tre import√©. V√©rifiez le format.');
                    return;
                }

                // Rafra√Æchir l'affichage
                afficherMatriceRetroaction();
                calculerPourcentageComplete();
                annulerImportCommentaires();

                afficherNotificationSucces(`${compteur} commentaire(s) import√©(s) avec succ√®s !`);

            } catch (error) {
                console.error('Erreur d\'import:', error);
                alert('Erreur lors de l\'import. V√©rifiez le format de vos donn√©es.');
            }
        }

        // === √âVALUATION DES PRODUCTIONS √âTUDIANTES ===

        let evaluationEnCours = null;

        // Charger la liste des √©tudiants dans le select
        function initialiserEvaluationsIndividuelles() {
            // √âTUDIANTS
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const select = document.getElementById('selectEtudiantEval');

            select.innerHTML = '<option value="">-- Choisir un¬∑e √©tudiant¬∑e --</option>';
            etudiants.forEach(etudiant => {
                select.innerHTML += `<option value="${etudiant.id || etudiant.da}">${etudiant.nom}, ${etudiant.prenom}</option>`;
            });

            // PRODUCTIONS (stock√©es dans listeGrilles)
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const selectProduction = document.getElementById('selectProduction1');
            selectProduction.innerHTML = '<option value="">-- Choisir une production --</option>';
            productions.forEach(prod => {
                selectProduction.innerHTML += `<option value="${prod.id}">${prod.code} - ${prod.titre}</option>`;
            });

            // GRILLES
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const selectGrille = document.getElementById('selectGrille1');
            selectGrille.innerHTML = '<option value="">-- Choisir une grille --</option>';
            grilles.forEach(grille => {
                selectGrille.innerHTML += `<option value="${grille.id}">${grille.nom}</option>`;
            });

            // √âCHELLES
            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            const selectEchelle = document.getElementById('selectEchelle1');
            selectEchelle.innerHTML = '<option value="">-- Choisir une √©chelle --</option>';
            echelles.forEach(echelle => {
                selectEchelle.innerHTML += `<option value="${echelle.id}">${echelle.nom || '√âchelle sans nom'}</option>`;
            });
        }

        // Charger une production
        function chargerProduction(num) {
            const productionId = document.getElementById(`selectProduction${num}`).value;

            if (!productionId) return;

            // Initialiser l'√©valuation en cours
            evaluationEnCours = {
                etudiantId: document.getElementById('selectEtudiantEval').value,
                productionId: productionId,
                grilleId: null,
                echelleId: null,
                cartoucheId: null,
                criteres: {}
            };
        }

        // Charger la grille s√©lectionn√©e
        // Charger la grille s√©lectionn√©e
        function chargerGrilleSelectionnee() {
            const grilleId = document.getElementById('selectGrille1').value;

            if (!grilleId) return;

            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grille = grilles.find(g => g.id === grilleId);

            if (!grille) return;

            if (evaluationEnCours) {
                evaluationEnCours.grilleId = grilleId;
            }

            // Charger les cartouches disponibles pour cette grille
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');
            const selectCartouche = document.getElementById('selectCartoucheEval');

            // Sauvegarder la valeur actuelle avant de recr√©er les options
            const valeurActuelle = selectCartouche.value;

            selectCartouche.innerHTML = '<option value="">-- Choisir une cartouche --</option>';
            cartouches.forEach(cartouche => {
                selectCartouche.innerHTML += `<option value="${cartouche.id}">${cartouche.nom}</option>`;
            });

            // Restaurer la valeur si elle existe encore
            if (valeurActuelle && cartouches.find(c => c.id === valeurActuelle)) {
                selectCartouche.value = valeurActuelle;
            }

            // Afficher les crit√®res dans la colonne gauche
            const listeCriteres = document.getElementById('listeCriteresGrille1');
            listeCriteres.innerHTML = grille.criteres.map(c => `
        <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
            <strong style="font-size: 0.9rem;">${c.nom}</strong>
            <div style="font-size: 0.8rem; color: #666;">Pond√©ration: ${c.ponderation}%</div>
        </div>
    `).join('');
        }

        // Cartouche s√©lectionn√©e
        function cartoucheSelectionnee() {
            const cartoucheId = document.getElementById('selectCartoucheEval').value;

            if (!cartoucheId || !evaluationEnCours) return;

            evaluationEnCours.cartoucheId = cartoucheId;

            const statut = document.getElementById('remiseProduction1').value;
            if (statut !== 'remis') {
                document.getElementById('listeCriteresGrille1').innerHTML =
                    '<p style="color: #999; font-style: italic;">Le travail doit √™tre remis avant √©valuation</p>';
                return;
            }

            const grilleId = evaluationEnCours.grilleId;
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');
            const cartouche = cartouches.find(c => c.id === cartoucheId);
            if (!cartouche) return;

            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grille = grilles.find(g => g.id === grilleId);
            if (!grille) return;

            const html = cartouche.criteres.map(critere => {
                const critereGrille = grille.criteres.find(c => c.id === critere.id);
                const ponderation = critereGrille ? critereGrille.ponderation : '?';

                return `
    <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 4px; border-left: 3px solid var(--bleu-moyen);">
        <div style="display: grid; grid-template-columns: 150px 180px 1fr; gap: 15px; align-items: start;">
            <div>
                <strong style="font-size: 0.9rem; display: block; margin-bottom: 4px;">${critere.nom}</strong>
                <small style="color: #666; display: block;">Pond√©ration : ${ponderation}%</small>
                ${critereGrille?.description ? `<small style="display: block; color: #888; font-style: italic; margin-top: 4px; line-height: 1.3;">${critereGrille.description}</small>` : ''}
            </div>
            <select id="eval_${critere.id}" class="controle-form" 
                    onchange="niveauSelectionne('${critere.id}')" 
                    style="font-size: 0.85rem;">
                <option value="">--</option>
                ${cartouche.niveaux.map(n => `<option value="${n.code}">${n.code} - ${n.nom}</option>`).join('')}
            </select>
            <div id="comm_${critere.id}" style="font-size: 0.85rem; line-height: 1.4; color: #555; font-style: italic;">
                S√©lectionnez un niveau
            </div>
        </div>
    </div>
    `;
            }).join('');

            document.getElementById('listeCriteresGrille1').innerHTML = html;
        }

        // Niveau s√©lectionn√© pour un crit√®re
        function niveauSelectionne(critereId) {
            const niveau = document.getElementById(`eval_${critereId}`).value;

            if (!evaluationEnCours) return;

            evaluationEnCours.criteres[critereId] = niveau;

            // AJOUTER : Colorer le select
            colorerSelectCritere(critereId);

            // Afficher le commentaire √† c√¥t√©
            if (niveau && evaluationEnCours.cartoucheId) {
                const grilleId = evaluationEnCours.grilleId;
                const cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');
                const cartouche = cartouches.find(c => c.id === evaluationEnCours.cartoucheId);

                if (cartouche) {
                    const cle = `${critereId}_${niveau}`;
                    const commentaire = cartouche.commentaires[cle] || '[Non d√©fini]';

                    const commDiv = document.getElementById(`comm_${critereId}`);
                    if (commDiv) {
                        commDiv.textContent = commentaire;
                        commDiv.style.fontStyle = 'normal';
                    }
                }
            } else {
                const commDiv = document.getElementById(`comm_${critereId}`);
                if (commDiv) {
                    commDiv.textContent = 'S√©lectionnez un niveau';
                    commDiv.style.fontStyle = 'italic';
                }
            }

            calculerNoteFinale();
            genererRetroaction(1);
            colorerNoteFinale();
        }

        // Calculer la note finale
        function calculerNoteFinale() {
            console.log('üî• FONCTION APPEL√âE');
            if (!evaluationEnCours?.grilleId || !evaluationEnCours?.echelleId) return;

            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grille = grilles.find(g => g.id === evaluationEnCours.grilleId);

            const echelles = JSON.parse(localStorage.getItem('echellesTemplates') || '[]');
            const echelle = echelles.find(e => e.id === evaluationEnCours.echelleId);

            if (!grille || !echelle) return;

            // Valeurs ponctuelles par crit√®re
            const valeursNiveaux = {
                'I': 40,
                'D': 65,
                'M': 75,
                'E': 100
            };

            let totalPoints = 0;
            let totalPonderation = 0;

            grille.criteres.forEach(critere => {
                const codeNiveau = evaluationEnCours.criteres[critere.id];
                if (!codeNiveau) return;

                const valeur = valeursNiveaux[codeNiveau];
                if (valeur === undefined) return;

                const poids = parseInt(critere.ponderation) || 0;

                totalPoints += valeur * poids;
                totalPonderation += poids;
            });

            if (totalPonderation === 0) {
                document.getElementById('noteProduction1').textContent = '0.0';
                document.getElementById('niveauProduction1').textContent = '--';
                return;
            }

            const moyenne = totalPoints / totalPonderation;

            // Conversion en lettre selon plages
            const niveauFinal = echelle.niveaux.find(n => moyenne >= n.min && moyenne <= n.max);

            document.getElementById('noteProduction1').textContent = moyenne.toFixed(1);
            document.getElementById('niveauProduction1').textContent = niveauFinal?.code || '--';

            evaluationEnCours.noteMoyenne = moyenne;
            evaluationEnCours.niveauFinal = niveauFinal?.code || '';
        }

        // R√©g√©n√©rer la r√©troaction en temps r√©el
        genererRetroaction(1);

        // Changer l'√©chelle d'√©valuation
        function changerEchelleEvaluation(num) {
            const echelleId = document.getElementById(`selectEchelle${num}`).value;

            if (evaluationEnCours) {
                evaluationEnCours.echelleId = echelleId;
            }
        }

        // Changer le statut de remise
        function changerStatutRemise(num) {
            const statut = document.getElementById(`remiseProduction${num}`).value;

            if (evaluationEnCours) {
                evaluationEnCours.statutRemise = statut;
            }

            // Si on passe √† "remis" et qu'une cartouche est s√©lectionn√©e, afficher les crit√®res
            if (statut === 'remis' && evaluationEnCours?.cartoucheId) {
                cartoucheSelectionnee();
            }
            // Si on passe √† "non remis", masquer les crit√®res
            else if (statut === 'non-remis') {
                document.getElementById('listeCriteresGrille1').innerHTML =
                    '<p style="color: #999; font-style: italic;">Le travail doit √™tre remis avant √©valuation</p>';
                // R√©initialiser aussi les autres affichages
            }
        }

        // FONCTION PRINCIPALE : G√©n√©rer la r√©troaction
        function genererRetroaction(num) {
            if (!evaluationEnCours?.cartoucheId) {
                document.getElementById('retroactionFinale1').value = '';
                return;
            }

            const grilleId = evaluationEnCours.grilleId;
            const cartouches = JSON.parse(localStorage.getItem(`cartouches_${grilleId}`) || '[]');
            const cartouche = cartouches.find(c => c.id === evaluationEnCours.cartoucheId);

            if (!cartouche) return;

            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const production = productions.find(p => p.id === evaluationEnCours.productionId);

            let texte = '';

            // Options (Description, Objectif, T√¢che)
            if (document.getElementById('afficherDescription1')?.checked && production?.description) {
                texte += `Production : ${production.description}\n`;
            }
            if (document.getElementById('afficherObjectif1')?.checked && production?.objectif) {
                texte += `Objectif : ${production.objectif}\n`;
            }
            if (document.getElementById('afficherTache1')?.checked && production?.tache) {
                texte += `T√¢che : ${production.tache}\n`;
            }

            // ========== ADRESSE PERSONNALIS√âE (OPTIONNELLE) ==========
            if (document.getElementById('afficherAdresse1')?.checked) {
                const etudiantDA = document.getElementById('selectEtudiantEval').value;

                if (etudiantDA) {
                    const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
                    const etudiant = etudiants.find(e => e.da === etudiantDA);

                    if (etudiant) {
                        texte += `\nBonjour ${etudiant.prenom} ! `;
                    }
                }
            }
            // =========================================================

            // Contexte de la r√©troaction (si coch√© ET pr√©sent)
            if (document.getElementById('afficherContexte1')?.checked && cartouche.contexte) {
                texte += `${cartouche.contexte}`;
            }
            // Commentaires par crit√®re
            cartouche.criteres.forEach(critere => {
                const code = evaluationEnCours.criteres[critere.id];
                if (!code) return;

                const cle = `${critere.id}_${code}`;
                const commentaire = cartouche.commentaires[cle] || '[Non d√©fini]';

                texte += `\n\n${critere.nom.toUpperCase()} (${code}) : ${commentaire}`;
            });

            // Note finale √Ä LA FIN
            if (evaluationEnCours.niveauFinal) {
                texte += `\n\nLe niveau global de cette production est : ${evaluationEnCours.niveauFinal}`;
            }

            document.getElementById('retroactionFinale1').value = texte;
        }

        // Sauvegarder la r√©troaction finale modifi√©e
        function sauvegarderRetroactionFinale(num) {
            const texte = document.getElementById(`retroactionFinale${num} `).value;

            if (evaluationEnCours) {
                evaluationEnCours.retroactionFinale = texte;
            }
        }

        // Charger la liste des groupes √† partir des √©tudiants existants
        function chargerListeGroupes() {
            const selectGroupe = document.getElementById('selectGroupe');
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

            // Extraire les groupes uniques (en filtrant les valeurs vides)
            const groupes = [...new Set(etudiants.map(e => e.groupe).filter(g => g && g.trim() !== ''))];
            groupes.sort(); // Tri alphab√©tique

            selectGroupe.innerHTML = '<option value="">Tous les groupes</option>';
            groupes.forEach(groupe => {
                const option = document.createElement('option');
                option.value = groupe;
                option.textContent = `Groupe ${groupe}`;
                selectGroupe.appendChild(option);
            });

            // Charger tous les √©tudiants par d√©faut
            chargerEtudiantsGroupe('');
        }

        // Changer le groupe affich√©
        function changerGroupeAffiche() {
            const groupeId = document.getElementById('selectGroupe').value;
            chargerEtudiantsGroupe(groupeId);
        }

        // Charger les √©tudiants d'un groupe sp√©cifique (ou tous si vide)
        function chargerEtudiantsGroupe(groupeId) {
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const etudiantsFiltres = groupeId
                ? etudiants.filter(e => e.groupe === groupeId)
                : etudiants;

            // Mise √† jour du compteur
            const nbTotal = etudiants.length;
            const nbFiltres = etudiantsFiltres.length;
            document.getElementById('nbEtudiantsGroupe').textContent =
                groupeId
                    ? `(${nbFiltres} sur ${nbTotal})`
                    : `(${nbTotal} √©tudiant${nbTotal > 1 ? '¬∑es' : '¬∑e'})`;

            // Afficher/masquer selon si le groupe a des √©tudiants
            if (etudiantsFiltres.length > 0) {
                renderStudentsList(etudiantsFiltres);
                document.getElementById('students-list-container').style.display = 'block';
                document.getElementById('no-students-msg').style.display = 'none';
            } else {
                document.getElementById('students-tbody').innerHTML = '';
                document.getElementById('students-list-container').style.display = 'none';
                document.getElementById('no-students-msg').style.display = 'block';
            }
        }

        // Fonction pour afficher la liste des √©tudiants dans le tableau
        function renderStudentsList(etudiants) {
            const tbody = document.getElementById('students-tbody');
            tbody.innerHTML = '';

            etudiants.forEach(student => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${student.da}</td>
            <td><strong>${student.groupe}</strong></td>
            <td>${student.nom}</td>
            <td>${student.prenom}</td>
            <td>${student.programme}</td>
            <td>${student.sa || ''}</td>
            <td>${student.caf || ''}</td>
            <td>
                <button onclick="modifierEtudiant('${student.da}')" class="btn btn-modifier">Modifier</button>
                <button onclick="supprimerEtudiant('${student.da}')" class="btn btn-supprimer">Supprimer</button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Charger la liste des groupes dans le select des √©valuations
        function chargerGroupesEvaluation() {
            const selectGroupe = document.getElementById('selectGroupeEval');
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

            // Extraire les groupes uniques
            const groupes = [...new Set(etudiants.map(e => e.groupe).filter(g => g && g.trim() !== ''))];
            groupes.sort();

            selectGroupe.innerHTML = '<option value="">Tous les groupes</option>';
            groupes.forEach(groupe => {
                const option = document.createElement('option');
                option.value = groupe;
                option.textContent = `Groupe ${groupe}`;
                selectGroupe.appendChild(option);
            });
        }

        // Filtrer les √©tudiants selon le groupe s√©lectionn√©
        function filtrerEtudiantsParGroupe() {
            const groupeId = document.getElementById('selectGroupeEval').value;
            const selectEtudiant = document.getElementById('selectEtudiantEval');
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

            // Filtrer selon le groupe
            const etudiantsFiltres = groupeId
                ? etudiants.filter(e => e.groupe === groupeId)
                : etudiants;

            // Repeupler le select des √©tudiants
            selectEtudiant.innerHTML = '<option value="">-- Choisir un¬∑e √©tudiant¬∑e --</option>';
            etudiantsFiltres.forEach(etudiant => {
                const option = document.createElement('option');
                option.value = etudiant.da;
                option.textContent = `${etudiant.prenom} ${etudiant.nom} (${etudiant.da})`;
                selectEtudiant.appendChild(option);
            });

            // R√©initialiser la s√©lection
            selectEtudiant.value = '';
        }

        // Sauvegarder l'√©valuation en cours
        function sauvegarderEvaluation() {
            const etudiantDA = document.getElementById('selectEtudiantEval').value;
            const productionId = document.getElementById('selectProduction1').value;
            const grilleId = document.getElementById('selectGrille1').value;

            if (!etudiantDA || !productionId || !grilleId) {
                alert('Veuillez s√©lectionner un √©tudiant, une production et une grille avant de sauvegarder.');
                return;
            }

            // R√©cup√©rer les donn√©es de l'√©tudiant
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const etudiant = etudiants.find(e => e.da === etudiantDA);

            // R√©cup√©rer les donn√©es de la production
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const production = productions.find(p => p.id === productionId);

            // R√©cup√©rer les donn√©es de la grille
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            const grille = grilles.find(g => g.id === grilleId);

            // Collecter les √©valuations des crit√®res
            const criteres = [];
            if (grille && grille.criteres) {
                grille.criteres.forEach(critere => {
                    const selectNiveau = document.getElementById(`niveau-${critere.id}-1`);
                    const retroactionDiv = document.getElementById(`retroaction-${critere.id}-1`);

                    if (selectNiveau && selectNiveau.value) {
                        criteres.push({
                            critereId: critere.id,
                            critereNom: critere.nom,
                            niveauSelectionne: selectNiveau.value,
                            retroaction: retroactionDiv ? retroactionDiv.textContent : '',
                            ponderation: critere.ponderation || 0
                        });
                    }
                });
            }

            // Cr√©er l'objet √©valuation
            const evaluation = {
                id: 'EVAL_' + Date.now(),
                etudiantDA: etudiantDA,
                etudiantNom: etudiant ? `${etudiant.prenom} ${etudiant.nom}` : '',
                groupe: etudiant ? etudiant.groupe : '',
                productionId: productionId,
                productionNom: production ? production.titre : '',
                grilleId: grilleId,
                grilleNom: grille ? grille.nom : '',
                echelleId: document.getElementById('selectEchelle1').value,
                cartoucheId: document.getElementById('selectCartoucheEval').value,
                dateEvaluation: new Date().toISOString(),
                statutRemise: document.getElementById('remiseProduction1').value,
                criteres: criteres,
                noteFinale: parseFloat(document.getElementById('noteProduction1').textContent) || 0,
                niveauFinal: document.getElementById('niveauProduction1').textContent,
                retroactionFinale: document.getElementById('retroactionFinale1').value,
                optionsAffichage: {
                    description: document.getElementById('afficherDescription1').checked,
                    objectif: document.getElementById('afficherObjectif1').checked,
                    tache: document.getElementById('afficherTache1').checked,
                    adresse: document.getElementById('afficherAdresse1').checked,  // ‚Üê AJOUTER CETTE LIGNE
                    contexte: document.getElementById('afficherContexte1').checked  // ‚Üê AJOUTER CETTE LIGNE
                }
            };

            // Sauvegarder dans localStorage
            let evaluations = JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
            evaluations.push(evaluation);
            localStorage.setItem('evaluationsSauvegardees', JSON.stringify(evaluations));

            afficherNotificationSucces(`√âvaluation sauvegard√©e : ${evaluation.etudiantNom} - ${evaluation.productionNom}`);
        }

        // Charger une √©valuation existante
        function chargerEvaluation(evalId) {
            const evaluations = JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
            const evaluation = evaluations.find(e => e.id === evalId);

            if (!evaluation) {
                alert('√âvaluation introuvable');
                return;
            }

            // Remplir les s√©lecteurs
            document.getElementById('selectEtudiantEval').value = evaluation.etudiantDA;
            document.getElementById('selectProduction1').value = evaluation.productionId;
            document.getElementById('selectGrille1').value = evaluation.grilleId;
            document.getElementById('selectEchelle1').value = evaluation.echelleId;
            document.getElementById('selectCartoucheEval').value = evaluation.cartoucheId;
            document.getElementById('remiseProduction1').value = evaluation.statutRemise;

            // Remplir les crit√®res
            evaluation.criteres.forEach(critere => {
                const selectNiveau = document.getElementById(`niveau-${critere.critereId}-1`);
                if (selectNiveau) {
                    selectNiveau.value = critere.niveauSelectionne;
                }
            });

            // Remplir la r√©troaction finale
            document.getElementById('retroactionFinale1').value = evaluation.retroactionFinale;
            document.getElementById('noteProduction1').textContent = evaluation.noteFinale.toFixed(1);
            document.getElementById('niveauProduction1').textContent = evaluation.niveauFinal;

            // Options d'affichage
            document.getElementById('afficherDescription1').checked = evaluation.optionsAffichage.description;
            document.getElementById('afficherObjectif1').checked = evaluation.optionsAffichage.objectif;
            document.getElementById('afficherTache1').checked = evaluation.optionsAffichage.tache;
            document.getElementById('afficherAdresse1').checked = evaluation.optionsAffichage.adresse || false;  // ‚Üê AJOUTER CETTE LIGNE
            document.getElementById('afficherContexte1').checked = evaluation.optionsAffichage.contexte || false;  // ‚Üê AJOUTER CETTE LIGNE

            afficherNotificationSucces('√âvaluation charg√©e');
        }

        // === VARIABLES GLOBALES POUR LES FILTRES ===
        let filtreGroupeMemoire = '';
        let filtreTypeProductionMemoire = '';

        // === FONCTIONS D'√âVALUATION ===

        // Lister toutes les √©valuations d'un √©tudiant
        function listerEvaluationsEtudiant(da) {
            const evaluations = JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
            return evaluations.filter(e => e.etudiantDA === da);
        }

        // Lister toutes les √©valuations
        function listerToutesEvaluations() {
            return JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
        }

        // Afficher la liste des √©valuations dans une modal
        function afficherListeEvaluations() {
            const evaluations = listerToutesEvaluations();

            if (evaluations.length === 0) {
                alert('Aucune √©valuation sauvegard√©e');
                return;
            }

            // Extraire les types de productions uniques
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const typesProductions = [...new Set(productions.map(p => p.type).filter(t => t))];

            let html = `
        <div id="modalEvaluations" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
             background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 8px; max-width: 1000px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--bleu-principal);">√âvaluations sauvegard√©es (${evaluations.length})</h3>
                    <button onclick="fermerModalEvaluations()" class="btn btn-annuler" style="padding: 5px 15px;">‚úï Fermer</button>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: var(--bleu-tres-pale); border-radius: 6px;">
                    <div class="groupe-form" style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filtrer par groupe :</label>
                        <select id="filtreGroupe" class="controle-form" onchange="appliquerFiltresEvaluations()">
                            <option value="">Tous les groupes</option>
                        </select>
                    </div>
                    <div class="groupe-form" style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filtrer par type de production :</label>
                        <select id="filtreTypeProduction" class="controle-form" onchange="appliquerFiltresEvaluations()">
                            <option value="">Tous les types</option>
                        </select>
                    </div>
                </div>
                
                <div id="tableauEvaluations"></div>
            </div>
        </div>
    `;

            document.body.insertAdjacentHTML('beforeend', html);

            // Peupler les filtres
            peuplerFiltresEvaluations(evaluations, typesProductions);

            // Restaurer les filtres m√©moris√©s
            if (filtreGroupeMemoire) {
                document.getElementById('filtreGroupe').value = filtreGroupeMemoire;
            }
            if (filtreTypeProductionMemoire) {
                document.getElementById('filtreTypeProduction').value = filtreTypeProductionMemoire;
            }

            // Appliquer les filtres ou afficher tout
            if (filtreGroupeMemoire || filtreTypeProductionMemoire) {
                appliquerFiltresEvaluations();
            } else {
                afficherTableauEvaluations(evaluations);
            }
        }

        // Peupler les s√©lecteurs de filtres
        function peuplerFiltresEvaluations(evaluations, typesProductions) {
            const groupes = [...new Set(evaluations.map(e => e.groupe).filter(g => g))];
            groupes.sort();

            const selectGroupe = document.getElementById('filtreGroupe');
            groupes.forEach(groupe => {
                const option = document.createElement('option');
                option.value = groupe;
                option.textContent = `Groupe ${groupe}`;
                selectGroupe.appendChild(option);
            });

            const selectType = document.getElementById('filtreTypeProduction');
            typesProductions.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                selectType.appendChild(option);
            });
        }

        // Appliquer les filtres
        function appliquerFiltresEvaluations() {
            const groupeFiltre = document.getElementById('filtreGroupe').value;
            const typeFiltre = document.getElementById('filtreTypeProduction').value;

            // M√©moriser les filtres
            filtreGroupeMemoire = groupeFiltre;
            filtreTypeProductionMemoire = typeFiltre;

            let evaluations = listerToutesEvaluations();
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            // Filtrer par groupe
            if (groupeFiltre) {
                evaluations = evaluations.filter(e => e.groupe === groupeFiltre);
            }

            // Filtrer par type de production
            if (typeFiltre) {
                evaluations = evaluations.filter(e => {
                    const prod = productions.find(p => p.id === e.productionId);
                    return prod && prod.type === typeFiltre;
                });
            }

            afficherTableauEvaluations(evaluations);
        }

        // Afficher le tableau des √©valuations
        function afficherTableauEvaluations(evaluations) {
            const container = document.getElementById('tableauEvaluations');

            if (evaluations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucune √©valuation ne correspond aux filtres s√©lectionn√©s.</p>';
                return;
            }

            // Trier par nom de famille
            evaluations.sort((a, b) => {
                const nomA = a.etudiantNom.split(' ').pop();
                const nomB = b.etudiantNom.split(' ').pop();
                return nomA.localeCompare(nomB);
            });

            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');

            let html = `
        <table class="tableau">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>√âtudiant¬∑e</th>
                    <th>Groupe</th>
                    <th>Production</th>
                    <th>Type</th>
                    <th>Note</th>
                    <th>Niveau</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

            evaluations.forEach(eval => {
                const date = new Date(eval.dateEvaluation);
                const dateStr = date.toLocaleDateString('fr-CA') + ' ' + date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
                const prod = productions.find(p => p.id === eval.productionId);
                const typeProduction = prod ? prod.type : '‚Äî';

                html += `
            <tr>
                <td style="font-size: 0.85rem;">${dateStr}</td>
                <td><strong>${eval.etudiantNom}</strong></td>
                <td>${eval.groupe}</td>
                <td>${eval.productionNom}</td>
                <td style="font-size: 0.85rem;">${typeProduction}</td>
                <td style="text-align: center;"><strong>${eval.noteFinale.toFixed(1)}%</strong></td>
                <td style="text-align: center;"><strong>${eval.niveauFinal}</strong></td>
                <td style="white-space: nowrap;">
                    <button onclick="chargerEvaluation('${eval.id}')" class="btn btn-modifier" style="padding: 4px 8px; font-size: 0.85rem;">Charger</button>
                    <button onclick="supprimerEvaluation('${eval.id}')" class="btn btn-supprimer" style="padding: 4px 8px; font-size: 0.85rem;">Supprimer</button>
                </td>
            </tr>
        `;
            });

            html += `
            </tbody>
        </table>
        <p style="text-align: center; margin-top: 15px; font-size: 0.9rem; color: #666;">
            ${evaluations.length} √©valuation${evaluations.length > 1 ? 's' : ''} affich√©e${evaluations.length > 1 ? 's' : ''}
        </p>
    `;

            container.innerHTML = html;
        }

        // Fermer la modal
        function fermerModalEvaluations() {
            const modal = document.getElementById('modalEvaluations');
            if (modal) modal.remove();
        }

        // Supprimer une √©valuation
        function supprimerEvaluation(evalId) {
            if (!confirm('Supprimer d√©finitivement cette √©valuation ?')) return;

            let evaluations = JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
            evaluations = evaluations.filter(e => e.id !== evalId);
            localStorage.setItem('evaluationsSauvegardees', JSON.stringify(evaluations));

            appliquerFiltresEvaluations();
            afficherNotificationSucces('√âvaluation supprim√©e');
        }

        // Nouvelle √©valuation
        function nouvelleEvaluation() {
            if (evaluationEnCours && evaluationEnCours.criteres && Object.keys(evaluationEnCours.criteres).length > 0) {
                if (!confirm('√ätes-vous s√ªr de vouloir abandonner l\'√©valuation en cours ?')) return;
            }

            document.getElementById('selectGroupeEval').value = '';
            document.getElementById('selectEtudiantEval').value = '';
            document.getElementById('selectProduction1').value = '';
            document.getElementById('selectGrille1').value = '';
            document.getElementById('selectEchelle1').value = '';
            document.getElementById('selectCartoucheEval').value = '';
            document.getElementById('remiseProduction1').value = 'non-remis';
            document.getElementById('listeCriteresGrille1').innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.85rem;">S√©lectionnez une grille et une cartouche</p>';
            document.getElementById('retroactionFinale1').value = '';
            document.getElementById('noteProduction1').textContent = '0.0';
            document.getElementById('niveauProduction1').textContent = '--';
            document.getElementById('afficherDescription1').checked = false;
            document.getElementById('afficherObjectif1').checked = false;
            document.getElementById('afficherTache1').checked = false;
            document.getElementById('noteFinale1').style.background = 'var(--bleu-tres-pale)';
            chargerGroupesPresences();
            initialiserSaisiePresences();

            evaluationEnCours = null;
            filtrerEtudiantsParGroupe();
            afficherNotificationSucces('Formulaire r√©initialis√© - Pr√™t pour une nouvelle √©valuation');
        }

        /* ===============================
           GESTION SAISIE DES PR√âSENCES
           =============================== */

        /**
         * V√©rifie si le format horaire est configur√© et affiche un avertissement si n√©cessaire
         */
        function verifierConfigurationFormatHoraire() {
            const formatHoraire = localStorage.getItem('formatHoraire');
            const alerte = document.getElementById('alerteFormatHoraire');

            if (!alerte) return;

            // Afficher l'alerte si aucun format n'est configur√©
            if (!formatHoraire || formatHoraire === '') {
                alerte.style.display = 'block';
            } else {
                alerte.style.display = 'none';
            }
        }

        /**
         * R√©cup√®re la dur√©e maximale d'une s√©ance depuis les r√©glages
         * @returns {number} 2 ou 4 selon le format horaire configur√©
         */
        function obtenirDureeMaxSeance() {
            const formatHoraire = localStorage.getItem('formatHoraire');

            // Format "2x2" = s√©ances de 2h, Format "1x4" = s√©ance de 4h
            if (formatHoraire === '1x4') {
                return 4;
            } else if (formatHoraire === '2x2') {
                return 2;
            }

            // Par d√©faut, si aucun format n'est configur√©, on assume 2h
            return 2;
        }

        /**
         * Charge la liste des groupes dans le select des pr√©sences
         */
        function chargerGroupesPresences() {
            const selectGroupe = document.getElementById('selectGroupePresences');
            if (!selectGroupe) return;

            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

            // Extraire les groupes uniques (filtrer les valeurs vides)
            const groupes = [...new Set(etudiants.map(e => e.groupe).filter(g => g && g.trim() !== ''))];
            groupes.sort();

            selectGroupe.innerHTML = '<option value="">Tous les groupes</option>';
            groupes.forEach(groupe => {
                const option = document.createElement('option');
                option.value = groupe;
                option.textContent = `Groupe ${groupe}`;
                selectGroupe.appendChild(option);
            });
        }

        /**
 * Formate une date en fran√ßais avec le jour de la semaine
 * @param {string} dateStr - Date au format YYYY-MM-DD
 * @returns {string} - Ex: "mercredi 3 septembre 2025"
 */
        function formaterDateFrancais(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
            const mois = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
                'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];

            const nomJour = jours[date.getDay()];
            const numeroJour = date.getDate();
            const nomMois = mois[date.getMonth()];
            const annee = date.getFullYear();

            return `${nomJour} ${numeroJour} ${nomMois} ${annee}`;
        }

        /**
         * R√©cup√®re les heures de cours pour un jour donn√©
         * @param {string} dateStr - Date au format YYYY-MM-DD
         * @returns {string} - Ex: "10h √† 12h" ou "" si non trouv√©
         */
        function obtenirHeuresSeance(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const nomJour = jours[date.getDay()];

            // R√©cup√©rer les s√©ances configur√©es
            const seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');

            // Trouver la s√©ance qui correspond √† ce jour
            const seance = seances.find(s => s.jour === nomJour);

            if (!seance || !seance.debut || !seance.fin) {
                return '';
            }

            // Formater les heures (ex: "08:00" ‚Üí "8h", "14:30" ‚Üí "14h30")
            const formatHeure = (heure) => {
                const [h, m] = heure.split(':');
                const heureNum = parseInt(h);
                return m === '00' ? `${heureNum}h` : `${heureNum}h${m}`;
            };

            return `${formatHeure(seance.debut)} √† ${formatHeure(seance.fin)}`;
        }


        /* Valide si une date est appropri√©e pour la saisie de pr√©sences
         * @param {string} dateStr - Date au format YYYY-MM-DD
         * @returns {Object} - {valide: boolean, raison: string, verrouille: boolean}
         */
        function validerDateSaisie(dateStr) {
            if (!dateStr) {
                return { valide: false, raison: 'Aucune date s√©lectionn√©e', verrouille: false };
            }

            // V√©rifier si c'est un jour de cours
            if (!estJourDeCoursReel(dateStr)) {
                return { valide: false, raison: 'pas-cours', verrouille: false };
            }

            // V√©rifier si la date est dans le futur
            const dateSelectionnee = new Date(dateStr + 'T00:00:00');
            const aujourdhui = new Date();
            aujourdhui.setHours(0, 0, 0, 0);

            if (dateSelectionnee > aujourdhui) {
                return { valide: false, raison: 'future', verrouille: false };
            }

            // V√©rifier si la date est verrouill√©e
            const verrouille = estDateVerrouillee(dateStr);

            return { valide: !verrouille, raison: verrouille ? 'verrouille' : '', verrouille: verrouille };
        }

        /**
 * Charge les pr√©sences d√©j√† enregistr√©es pour une date donn√©e
 * @param {string} date - Date au format YYYY-MM-DD
 * @returns {Object} - Objet avec DA comme cl√© et {heures, notes} comme valeur
 */
        function chargerPresencesPourDate(date) {
            if (!date) return {};

            const toutesPresences = JSON.parse(localStorage.getItem('presences') || '[]');
            const presencesDuJour = {};

            // Filtrer les pr√©sences pour cette date et les organiser par DA
            toutesPresences.forEach(p => {
                if (p.date === date) {
                    presencesDuJour[p.da] = {
                        heures: p.heures,
                        notes: p.notes || ''
                    };
                }
            });

            return presencesDuJour;
        }


        /* Calcule le nombre total d'heures de pr√©sence pour un √©l√®ve
        * Ne compte QUE les s√©ances o√π une saisie a √©t√© effectu√©e (heures !== null)
        * @param {string} da - Num√©ro de DA de l'√©l√®ve
        * @param {string} dateExclure - Date √† exclure du calcul (optionnel)
        * @returns {number} - Total des heures de pr√©sence
        */

        function calculerTotalHeuresPresence(da, dateExclure = null) {
            const presences = JSON.parse(localStorage.getItem('presences') || '[]');

            let total = 0;
            presences.forEach(p => {
                // Exclure la date en cours de saisie
                if (dateExclure && p.date === dateExclure) return;

                // Ne compter QUE si DA correspond ET si heures a √©t√© saisi (pas null)
                if (p.da === da && p.heures !== null && p.heures !== undefined) {
                    total += parseFloat(p.heures) || 0;
                }
            });

            return total;
        }

        /**
         * Calcule le nombre de s√©ances de cours entre deux dates
         * @param {string} dateDebut - Date de d√©but au format YYYY-MM-DD
         * @param {string} dateFin - Date de fin au format YYYY-MM-DD
         * @returns {number} - Nombre de s√©ances
         */
        function calculerNombreSeances(dateDebut, dateFin) {
            if (!dateDebut || !dateFin) return 0;

            const seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');
            if (seances.length === 0) return 0;

            // Extraire les jours de cours
            const joursCoursSet = new Set(seances.map(s => s.jour));

            const debut = new Date(dateDebut + 'T12:00:00');
            const fin = new Date(dateFin + 'T12:00:00');
            const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            let compteur = 0;
            let dateActuelle = new Date(debut);

            while (dateActuelle <= fin) {
                const nomJour = jours[dateActuelle.getDay()];

                // Si c'est un jour de cours
                if (joursCoursSet.has(nomJour)) {
                    compteur++;
                }

                dateActuelle.setDate(dateActuelle.getDate() + 1);
            }

            return compteur;
        }

        /**
         * Obtient la configuration du calendrier scolaire depuis le localStorage
         * @returns {Object|null} - Configuration du calendrier ou null si non configur√©
         */
        function obtenirConfigurationCalendrier() {
            const configStr = localStorage.getItem('configurationCalendrier');
            if (!configStr) {
                // Retourner une configuration par d√©faut si rien n'existe
                return {
                    debutTrimestre: '2025-08-18',  // Ajuste selon tes besoins
                    finCours: '2025-12-20',
                    finTrimestre: '2025-12-22',
                    semainePlanification: { debut: '2025-08-11', fin: '2025-08-17' },
                    semaineExamens: { debut: '2025-12-16', fin: '2025-12-20' },
                    conges: []
                };
            }

            try {
                return JSON.parse(configStr);
            } catch (e) {
                console.error('Erreur lors du parsing de la configuration calendrier:', e);
                return null;
            }
        }

        /**
 * Calcule le taux d'assiduit√© pour un √©l√®ve jusqu'√† une date donn√©e
 * @param {string} da - Num√©ro de DA
 * @param {string} dateActuelle - Date jusqu'√† laquelle calculer (format YYYY-MM-DD)
 * @param {number} heuresSeanceActuelle - Heures de la s√©ance en cours (optionnel)
 * @returns {number} - Taux d'assiduit√© en pourcentage (0-100)
 */
        function calculerTauxAssiduite(da, dateActuelle, heuresSeanceActuelle = 0) {
            // Calculer le nombre total d'heures th√©oriques jusqu'√† cette date
            const config = obtenirConfigurationCalendrier();
            if (!config) return 0;

            // Compter le nombre de s√©ances de cours jusqu'√† dateActuelle (incluse)
            const seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');
            if (seances.length === 0) return 0;

            const joursCoursSet = new Set(seances.map(s => s.jour));

            let nombreSeances = 0;
            let dateIterante = creerDateLocale(config.debutTrimestre);
            const dateFin = creerDateLocale(dateActuelle);

            while (dateIterante <= dateFin) {
                const dateStr = formaterDate(dateIterante);
                const nomJour = obtenirNomJour(dateIterante);

                // Compter si c'est un jour de cours ET un jour ouvrable
                if (joursCoursSet.has(nomJour) && estJourDeCoursReel(dateStr)) {
                    nombreSeances++;
                }

                dateIterante.setDate(dateIterante.getDate() + 1);
            }

            if (nombreSeances === 0) return 0;

            // Calculer la dur√©e d'une s√©ance
            const dureeSeance = obtenirDureeMaxSeance();
            const heuresTheoriques = nombreSeances * dureeSeance;

            // Calculer les heures r√©elles de pr√©sence
            const heuresHistorique = calculerTotalHeuresPresence(da, dateActuelle);
            const heuresReelles = heuresHistorique + heuresSeanceActuelle;

            // Calculer le taux
            const taux = (heuresReelles / heuresTheoriques) * 100;
            return Math.round(taux);
        }

        /**
         * Met √† jour dynamiquement les colonnes Total et Assiduit√© pour une ligne
         * @param {string} da - Num√©ro DA de l'√©tudiant
         * @param {HTMLElement} ligne - Ligne du tableau (<tr>)
         */
        function mettreAJourStatistiquesLigne(da, ligne) {
            const dateInput = document.getElementById('date-cours');
            const dateSelectionnee = dateInput ? dateInput.value : '';

            if (!dateSelectionnee) return;

            // R√©cup√©rer les heures de la s√©ance actuelle
            const inputHeures = ligne.querySelector('input[type="number"]');
            const heuresActuelles = inputHeures ? parseFloat(inputHeures.value) || 0 : 0;

            // Calculer le total (historique + s√©ance actuelle)
            const heuresHistorique = calculerTotalHeuresPresence(da, dateSelectionnee);
            const totalHeures = heuresHistorique + heuresActuelles;

            // Calculer le taux d'assiduit√©
            const tauxAssiduite = calculerTauxAssiduite(da, dateSelectionnee, heuresActuelles);

            // Mettre √† jour les cellules
            const celluleTotal = ligne.querySelector('.cellule-total');
            const celluleAssiduite = ligne.querySelector('.cellule-assiduite');

            if (celluleTotal) {
                celluleTotal.textContent = `${totalHeures.toFixed(1)}h`;
            }

            if (celluleAssiduite) {
                // Colorer selon le taux
                let couleur = 'var(--risque-minimal)'; // Vert
                if (tauxAssiduite < 85) couleur = 'var(--risque-modere)'; // Jaune
                if (tauxAssiduite < 70) couleur = 'var(--risque-tres-eleve)'; // Rouge

                celluleAssiduite.innerHTML = `<strong style="color: ${couleur};">${tauxAssiduite}%</strong>`;
            }
        }

        /**
         * Met √† jour l'en-t√™te de la saisie des pr√©sences
         * @param {string} dateStr - Date au format YYYY-MM-DD
         */
        function mettreAJourEnteteDateSeance(dateStr) {
            const entete = document.getElementById('enteteDateSeance');
            const texte = document.getElementById('texteDateSeance');

            if (!entete || !texte) return;

            if (!dateStr) {
                entete.style.display = 'none';
                return;
            }

            const dateFr = formaterDateFrancais(dateStr);
            const validation = validerDateSaisie(dateStr);

            // Cr√©er le contr√¥le de verrouillage avec checkbox
            const verrouille = validation.verrouille;
            const controleVerrou = `
    <div style="display: inline-flex; align-items: center; gap: 8px; margin-left: 15px; padding: 6px 12px; background: rgba(255,255,255,0.4); border-radius: 6px; border: 1px solid rgba(0,0,0,0.1);">
        <input type="checkbox" 
               id="checkbox-verrouillage-${dateStr}" 
               ${verrouille ? 'checked' : ''}
               onchange="basculerVerrouillageDate('${dateStr}')"
               style="cursor: pointer; width: 20px; height: 20px; accent-color: var(--bleu-principal);">
        <label for="checkbox-verrouillage-${dateStr}" 
               style="cursor: pointer; user-select: none; margin: 0; font-size: 0.95rem; font-weight: 500;">
            ${verrouille ? 'üîí Verrouill√©' : 'üîì D√©verrouiller'}
        </label>
    </div>
`;

            if (!validation.valide) {
                if (validation.raison === 'future') {
                    texte.innerHTML = `‚ö†Ô∏è Oups ! Il n'y a pas encore eu de cours le ${dateFr}`;
                    entete.style.background = '#ffe6e6';
                    entete.style.borderColor = '#dc3545';
                    texte.parentElement.style.color = '#721c24';
                } else if (validation.raison === 'pas-cours') {
                    texte.innerHTML = `‚ö†Ô∏è Oups ! Il n'y a pas de cours le ${dateFr}`;
                    entete.style.background = '#ffe6e6';
                    entete.style.borderColor = '#dc3545';
                    texte.parentElement.style.color = '#721c24';
                } else if (validation.raison === 'verrouille') {
                    const heures = obtenirHeuresSeance(dateStr);
                    texte.innerHTML = `Pr√©sences au cours du ${dateFr} ${heures ? '(' + heures + ')' : ''} ${controleVerrou}`;
                    entete.style.background = '#f0f0f0';
                    entete.style.borderColor = '#999';
                    texte.parentElement.style.color = '#666';
                }
            } else {
                const heures = obtenirHeuresSeance(dateStr);
                texte.innerHTML = `Pr√©sences au cours du ${dateFr} ${heures ? '(' + heures + ')' : ''} ${controleVerrou}`;
                entete.style.background = '#fff9e6';
                entete.style.borderColor = '#ffc107';
                texte.parentElement.style.color = '#856404';
            }

            entete.style.display = 'block';
        }

        /**
 * Initialise le tableau de saisie des pr√©sences
 */
        function initialiserSaisiePresences() {
            const tbody = document.getElementById('tbody-saisie-presences');
            const selectGroupe = document.getElementById('selectGroupePresences');
            const dateInput = document.getElementById('date-cours');
            const compteur = document.getElementById('nbEtudiantsPresences');
            const titreColonne = document.getElementById('colonneHeuresTitre');

            if (!tbody) return;

            // Mettre √† jour l'en-t√™te avec la date
            if (dateInput) {
                mettreAJourEnteteDateSeance(dateInput.value);
            }

            // V√©rifier la configuration du format horaire
            verifierConfigurationFormatHoraire();

            // R√©cup√©rer la dur√©e maximale depuis les r√©glages
            const dureeMax = obtenirDureeMaxSeance();

            // Mettre √† jour le titre de la colonne selon le format
            if (titreColonne) {
                const formatHoraire = localStorage.getItem('formatHoraire');
                let texte = '';
                if (formatHoraire === '1x4') {
                    texte = 'Heures (max. 4h)';
                } else if (formatHoraire === '2x2') {
                    texte = 'Heures (max. 2h)';
                } else {
                    texte = 'Heures (par d√©faut: 2h)';
                }
                const textNode = Array.from(titreColonne.childNodes).find(node => node.nodeType === 3);
                if (textNode) {
                    textNode.textContent = texte;
                }
            }

            // Mettre √† jour le texte du bouton
            const btnTousPresents = document.getElementById('btn-tous-presents');
            if (btnTousPresents) {
                btnTousPresents.textContent = `Tous ${dureeMax}h`;
            }

            // R√©cup√©rer les donn√©es
            const groupeId = selectGroupe ? selectGroupe.value : '';
            const dateSelectionnee = dateInput ? dateInput.value : '';
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');

            // Charger les pr√©sences existantes
            const presencesExistantes = chargerPresencesPourDate(dateSelectionnee);

            // Filtrer les √©tudiants
            let etudiantsFiltres = etudiants.filter(e => e.statut === 'actif' || !e.statut);
            if (groupeId) {
                etudiantsFiltres = etudiantsFiltres.filter(e => e.groupe === groupeId);
            }

            // Trier par nom
            etudiantsFiltres.sort((a, b) => {
                const nomA = `${a.nom} ${a.prenom}`.toLowerCase();
                const nomB = `${b.nom} ${b.prenom}`.toLowerCase();
                return nomA.localeCompare(nomB);
            });

            // Mettre √† jour le compteur
            if (compteur) {
                const nbTotal = etudiants.filter(e => e.statut === 'actif' || !e.statut).length;
                const nbFiltres = etudiantsFiltres.length;
                if (groupeId) {
                    compteur.textContent = `(${nbFiltres} sur ${nbTotal})`;
                } else {
                    compteur.textContent = `(${nbTotal} √©tudiant${nbTotal > 1 ? '¬∑es' : '¬∑e'})`;
                }
            }

            // G√©n√©rer le HTML
            if (etudiantsFiltres.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">Aucun¬∑e √©tudiant¬∑e actif¬∑ve dans ce groupe</td></tr>';
                return;
            }

            tbody.innerHTML = etudiantsFiltres.map(etudiant => {
                const presenceExistante = presencesExistantes[etudiant.da];
                const heuresPresence = presenceExistante && presenceExistante.heures !== null
                    ? presenceExistante.heures
                    : '';
                const notesPresence = presenceExistante ? presenceExistante.notes : '';

                const heuresHistorique = calculerTotalHeuresPresence(etudiant.da, dateSelectionnee);
                const totalHeures = heuresHistorique + (parseFloat(heuresPresence) || 0);
                const tauxAssiduite = calculerTauxAssiduite(etudiant.da, dateSelectionnee, 0);

                let couleur = 'var(--risque-minimal)';
                if (tauxAssiduite < 85) couleur = 'var(--risque-modere)';
                if (tauxAssiduite < 70) couleur = 'var(--risque-tres-eleve)';

                return `
            <tr data-da="${etudiant.da}">
                <td>${etudiant.da}</td>
                <td>${etudiant.prenom}</td>
                <td>${etudiant.nom}</td>
                <td>
                    <input type="number" 
                           class="controle-form" 
                           min="0" 
                           max="${dureeMax}" 
                           step="0.5" 
                           value="${heuresPresence}" 
                           placeholder="0"
                           data-da="${etudiant.da}"
                           onchange="mettreAJourStatistiquesLigne('${etudiant.da}', this.closest('tr'))"
                           style="max-width: 80px; text-align: center;">
                </td>
                <td>
                    <input type="text" 
                           class="controle-form" 
                           placeholder="Notes..." 
                           value="${notesPresence}"
                           data-da="${etudiant.da}"
                           style="width: 100%;">
                </td>
                <td class="cellule-total" style="text-align: center; font-weight: 600; color: var(--bleu-principal);">
                    ${totalHeures.toFixed(1)}h
                </td>
                <td class="cellule-assiduite" style="text-align: center;">
                    <strong style="color: ${couleur};">${tauxAssiduite}%</strong>
                </td>
            </tr>
        `;
            }).join('');

            // G√©rer le verrouillage des champs
            const validation = validerDateSaisie(dateSelectionnee);
            const inputs = tbody.querySelectorAll('input');
            const btnReinit = document.getElementById('btn-reinit-saisie');
            const btnEnregistrer = document.querySelector('.btn-confirmer[onclick="enregistrerPresences()"]');

            if (!validation.valide) {
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.opacity = '0.5';
                    input.style.cursor = 'not-allowed';
                });
                if (btnTousPresents) btnTousPresents.disabled = true;
                if (btnReinit) btnReinit.disabled = true;
                if (btnEnregistrer) btnEnregistrer.disabled = true;
            } else {
                inputs.forEach(input => {
                    input.disabled = false;
                    input.style.opacity = '1';
                    input.style.cursor = 'text';
                });
                if (btnTousPresents) btnTousPresents.disabled = false;
                if (btnReinit) btnReinit.disabled = false;
                if (btnEnregistrer) btnEnregistrer.disabled = false;
            }
        }

        /**
 * Enregistre les pr√©sences saisies (cr√©ation ou mise √† jour)
 */
        function enregistrerPresences() {
            console.log('üîµ Fonction enregistrerPresences appel√©e');

            const dateInput = document.getElementById('date-cours');
            const tbody = document.getElementById('tbody-saisie-presences');

            if (!dateInput || !dateInput.value) {
                afficherNotificationErreur('Veuillez s√©lectionner une date');
                return;
            }

            if (!tbody) return;

            const dateSelectionnee = dateInput.value;

            // Valider la date avant d'enregistrer
            const validation = validerDateSaisie(dateSelectionnee);
            if (!validation.valide) {
                if (validation.raison === 'future') {
                    afficherNotificationErreur('Impossible d\'enregistrer des pr√©sences pour une date future');
                } else if (validation.raison === 'pas-cours') {
                    afficherNotificationErreur('Impossible d\'enregistrer des pr√©sences : ce n\'est pas un jour de cours');
                } else if (validation.raison === 'verrouille') {
                    afficherNotificationErreur('Cette date est verrouill√©e. D√©verrouillez-la pour modifier les pr√©sences.');
                } else {
                    afficherNotificationErreur('Date invalide pour la saisie de pr√©sences');
                }
                return;
            }

            // Collecter les donn√©es actuelles du formulaire
            const presencesFormulaire = [];
            const lignes = tbody.querySelectorAll('tr');

            lignes.forEach(ligne => {
                const inputHeures = ligne.querySelector('input[type="number"]');
                const inputNotes = ligne.querySelector('input[type="text"]');

                if (inputHeures) {
                    const valeurHeures = inputHeures.value.trim() === ''
                        ? null
                        : parseFloat(inputHeures.value);

                    presencesFormulaire.push({
                        date: dateSelectionnee,
                        da: inputHeures.getAttribute('data-da'),
                        heures: valeurHeures,
                        notes: inputNotes ? inputNotes.value.trim() : ''
                    });
                }
            });

            if (presencesFormulaire.length === 0) {
                afficherNotificationErreur('Aucune pr√©sence √† enregistrer');
                return;
            }

            // Charger toutes les pr√©sences existantes
            let toutesPresences = JSON.parse(localStorage.getItem('presences') || '[]');

            // Supprimer les anciennes pr√©sences pour cette date
            toutesPresences = toutesPresences.filter(p => p.date !== dateSelectionnee);

            // Ajouter les nouvelles pr√©sences
            toutesPresences.push(...presencesFormulaire);

            // Sauvegarder dans localStorage
            localStorage.setItem('presences', JSON.stringify(toutesPresences));

            // Afficher notification de succ√®s
            afficherNotificationSucces(
                `${presencesFormulaire.length} pr√©sence${presencesFormulaire.length > 1 ? 's' : ''} enregistr√©e${presencesFormulaire.length > 1 ? 's' : ''}`,
                `Date : ${dateSelectionnee}`
            );

            console.log('‚úÖ Pr√©sences sauvegard√©es:', presencesFormulaire);
        }

        /**
         * Remplit tous les champs √† la dur√©e maximale (2h ou 4h)
         */
        function remplirTousPresents() {
            const tbody = document.getElementById('tbody-saisie-presences');
            if (!tbody) return;

            // Obtenir la dur√©e max depuis les r√©glages
            const dureeMax = obtenirDureeMaxSeance();

            // Remplir tous les inputs
            const inputs = tbody.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = dureeMax;

                // D√©clencher l'√©v√©nement change pour mettre √† jour les stats
                const tr = input.closest('tr');
                if (tr) {
                    const da = input.getAttribute('data-da');
                    mettreAJourStatistiquesLigne(da, tr);
                }
            });

            afficherNotificationSucces(
                'Pr√©sences remplies',
                `Tous les √©l√®ves marqu√©s pr√©sents (${dureeMax}h)`
            );
        }

        /**
         * R√©initialise tous les champs √† 0
         */
        function reinitialiserSaisie() {
            const tbody = document.getElementById('tbody-saisie-presences');
            if (!tbody) return;

            if (!confirm('Remettre toutes les heures √† 0 ?')) return;

            // Remettre tous les inputs √† 0
            const inputs = tbody.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = 0;

                // D√©clencher l'√©v√©nement change pour mettre √† jour les stats
                const tr = input.closest('tr');
                if (tr) {
                    const da = input.getAttribute('data-da');
                    mettreAJourStatistiquesLigne(da, tr);
                }
            });

            afficherNotificationSucces('Saisie r√©initialis√©e', 'Toutes les heures remises √† 0');
        }

        /**
         * R√©initialise tous les champs √† 0
         */
        function reinitialiserSaisie() {
            const tbody = document.getElementById('tbody-saisie-presences');
            if (!tbody) return;

            if (!confirm('Remettre toutes les heures √† 0 ?')) return;

            // Remettre tous les inputs √† 0
            const inputs = tbody.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = 0;

                // D√©clencher l'√©v√©nement change pour mettre √† jour les stats
                const tr = input.closest('tr');
                if (tr) {
                    const da = input.getAttribute('data-da');
                    mettreAJourStatistiquesLigne(da, tr);
                }
            });

            afficherNotificationSucces('Saisie r√©initialis√©e', 'Toutes les heures remises √† 0');
        }
        /**
/**
 * Navigue vers la page de saisie des pr√©sences avec une date pr√©-remplie
 * @param {string} date - Date au format YYYY-MM-DD
 */
        function ouvrirSaisiePresence(date) {
            // S'assurer qu'on est bien dans la section Pr√©sences
            if (sectionActive !== 'presences') {
                afficherSection('presences');
            }

            // Naviguer vers la sous-section "Saisie" existante
            afficherSousSection('presences-saisie');

            // Forcer la mise √† jour visuelle des boutons de sous-navigation
            document.querySelectorAll('.sous-navigation button').forEach(btn => {
                btn.classList.remove('actif');
            });

            // Activer visuellement le bon bouton
            const boutonSaisie = Array.from(document.querySelectorAll('.sous-navigation button'))
                .find(btn => btn.getAttribute('data-sous-onglet') === 'saisie');
            if (boutonSaisie) {
                boutonSaisie.classList.add('actif');
            }

            // Pr√©-remplir le champ date avec un d√©lai pour s'assurer que le DOM est pr√™t
            setTimeout(() => {
                const dateInput = document.getElementById('date-cours');
                if (dateInput) {
                    dateInput.value = date;
                }

                // Initialiser le tableau des pr√©sences avec cette date
                initialiserSaisiePresences();
            }, 100);

            // Notification visuelle
            afficherNotificationSucces('Date s√©lectionn√©e', `Saisie des pr√©sences pour le ${date}`);
        }

        /**
 * Valide si une date est appropri√©e pour la saisie de pr√©sences
 * @param {string} dateStr - Date au format YYYY-MM-DD
 * @returns {Object} - {valide: boolean, raison: string}
 */
        function validerDateSaisie(dateStr) {
            if (!dateStr) {
                return { valide: false, raison: 'Aucune date s√©lectionn√©e' };
            }

            // V√©rifier si la date est dans le futur
            const dateSelectionnee = new Date(dateStr + 'T00:00:00');
            const aujourdhui = new Date();
            aujourdhui.setHours(0, 0, 0, 0);

            if (dateSelectionnee > aujourdhui) {
                return { valide: false, raison: 'future' };
            }

            // V√©rifier si c'est un jour de cours
            if (!estJourDeCoursReel(dateStr)) {
                return { valide: false, raison: 'pas-cours' };
            }

            return { valide: true, raison: '' };
        }

        /**
         * Bascule le verrouillage d'une date de saisie
         * @param {string} dateStr - Date au format YYYY-MM-DD
         */
        function basculerVerrouillageDate(dateStr) {
            let datesVerrouillees = JSON.parse(localStorage.getItem('datesVerrouillees') || '[]');

            const index = datesVerrouillees.indexOf(dateStr);
            if (index > -1) {
                // D√©verrouiller
                datesVerrouillees.splice(index, 1);
                afficherNotificationSucces('Date d√©verrouill√©e', 'Vous pouvez maintenant modifier les pr√©sences');
            } else {
                // Verrouiller
                datesVerrouillees.push(dateStr);
                afficherNotificationSucces('Date verrouill√©e', 'Les pr√©sences sont prot√©g√©es contre les modifications');
            }

            localStorage.setItem('datesVerrouillees', JSON.stringify(datesVerrouillees));

            // Rafra√Æchir l'affichage complet
            initialiserSaisiePresences();
        }

        /**
         * V√©rifie si une date est verrouill√©e
         * @param {string} dateStr - Date au format YYYY-MM-DD
         * @returns {boolean}
         */
        function estDateVerrouillee(dateStr) {
            const datesVerrouillees = JSON.parse(localStorage.getItem('datesVerrouillees') || '[]');
            return datesVerrouillees.includes(dateStr);
        }


        /* ===============================
           FONCTIONS UTILITAIRES
           =============================== */

        /**
         * Exporte les donn√©es en CSV
         * @param {Array} donnees - Les donn√©es √† exporter
         * @param {string} nomFichier - Le nom du fichier
         */
        function exporterCSV(donnees, nomFichier = 'export.csv') {
            // Impl√©mentation simplifi√©e pour la d√©monstration
            console.log(`Export CSV: ${nomFichier}`, donnees);
            afficherNotification('Export CSV en cours...', 'info');
        }

        /**
         * Imprime une section
         * @param {string} idSection - L'identifiant de la section √† imprimer
         */
        function imprimerSection(idSection) {
            window.print();
            afficherNotification('Impression lanc√©e', 'success');
        }

        // Fin de toutes les fonctions
        console.log('‚úÖ Script charg√© compl√®tement');

        function estJourDeCoursReel(dateStr) {
            const seances = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');

            if (seances.length === 0) return false;

            const date = creerDateLocale(dateStr);
            const nomJour = obtenirNomJour(date);

            // V√©rifier si une s√©ance correspond √† ce jour
            return seances.some(seance => seance.jour === nomJour);
        }

        /* ===============================
       GESTION APER√áU R√âGLAGES
       =============================== */

        // Calculer et afficher les statistiques
        function chargerStatistiquesApercu() {
            // === INFORMATIONS DU COURS ===
            const listeCours = JSON.parse(localStorage.getItem('listeCours') || '[]');
            const coursActif = listeCours.find(c => c.actif) || listeCours[0] || null;

            if (coursActif) {
                document.getElementById('stat-code-cours').textContent = coursActif.codeCours || '‚Äî';
                const trimestre = `${coursActif.session || ''}${coursActif.annee || ''}`;
                document.getElementById('stat-trimestre').textContent = trimestre || '‚Äî';
            } else {
                document.getElementById('stat-code-cours').textContent = '‚Äî';
                document.getElementById('stat-trimestre').textContent = '‚Äî';
            }

            // Calendrier - chercher la configuration du cadre calendrier
            const cadreCalendrier = JSON.parse(localStorage.getItem('cadreCalendrier') || 'null');
            if (cadreCalendrier && cadreCalendrier.dateDebut && cadreCalendrier.dateFin) {
                const debut = cadreCalendrier.dateDebut;
                const fin = cadreCalendrier.dateFin;

                // Calculer le nombre de semaines si non disponible
                let nbSemaines = cadreCalendrier.nombreSemaines;
                if (!nbSemaines) {
                    const dateDebut = new Date(debut);
                    const dateFin = new Date(fin);
                    const diffJours = Math.ceil((dateFin - dateDebut) / (1000 * 60 * 60 * 24));
                    nbSemaines = Math.ceil(diffJours / 7);
                }

                document.getElementById('stat-calendrier').textContent = `${debut} ‚Üí ${fin} (${nbSemaines} sem.)`;
            } else {
                document.getElementById('stat-calendrier').textContent = '‚Äî';
            }

            // Horaire - chercher les s√©ances configur√©es
            const seancesHoraire = JSON.parse(localStorage.getItem('seancesHoraire') || '[]');
            if (seancesHoraire.length > 0) {
                const horaireTexte = seancesHoraire.map(s => {
                    return `${s.jour} ${s.debut}-${s.fin}`;
                }).join(' ¬∑ ');
                document.getElementById('stat-horaire').textContent = horaireTexte;
            } else if (coursActif && coursActif.formatHoraire) {
                document.getElementById('stat-horaire').textContent = coursActif.formatHoraire;
            } else {
                document.getElementById('stat-horaire').textContent = '‚Äî';
            }

            // Nombre de groupes - pour l'instant fix√© √† 1 (sera configurable plus tard)
            document.getElementById('stat-nb-groupes').textContent = listeCours.length > 0 ? '1' : '‚Äî';

            // Nombre d'√©l√®ves
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            document.getElementById('stat-nb-eleves').textContent = etudiants.length || '0';

            // === MAT√âRIEL CONFIGUR√â ===

            // Pratique de notation
            const modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
            let pratique = 'Non configur√©e';

            if (modalites.pratique === 'sommative') {
                pratique = 'Sommative (%)';
            } else if (modalites.pratique === 'alternative' && modalites.typePAN) {
                const types = {
                    'maitrise': 'PAN - Ma√Ætrise',
                    'specifications': 'PAN - Sp√©cifications',
                    'denotation': 'PAN - D√©notation'
                };
                pratique = types[modalites.typePAN] || 'PAN';
            } else if (modalites.pratique === 'alternative') {
                pratique = 'Alternative (√† pr√©ciser)';
            }

            document.getElementById('stat-pratique').textContent = pratique;

            document.getElementById('stat-pratique').textContent = pratique;

            // Productions (stock√©es dans listeGrilles - nom historique)
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            document.getElementById('stat-productions').textContent = productions.length;

            // Grilles de crit√®res
            const grilles = JSON.parse(localStorage.getItem('grillesTemplates') || '[]');
            document.getElementById('stat-grilles').textContent = grilles.length;

            // √âchelles de performance
            const echellesConfig = JSON.parse(localStorage.getItem('configEchelle') || 'null');
            const niveauxEchelle = JSON.parse(localStorage.getItem('niveauxEchelle') || '[]');
            const nbEchelles = (echellesConfig || niveauxEchelle.length > 0) ? '1' : '0';
            document.getElementById('stat-echelles').textContent = nbEchelles;

            // Cartouches de r√©troaction - compter TOUTES les cartouches de TOUTES les grilles
            let totalCartouches = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const cle = localStorage.key(i);
                // Chercher toutes les cl√©s qui commencent par "cartouches_"
                if (cle && cle.startsWith('cartouches_')) {
                    const cartouches = JSON.parse(localStorage.getItem(cle) || '[]');
                    totalCartouches += cartouches.length;
                }
            }
            document.getElementById('stat-cartouches').textContent = totalCartouches;

            // === SYST√àME ===

            // Version - fix√©e dans le code
            document.getElementById('stat-version').textContent = 'Beta 0.35';

            // Derni√®re MAJ - maintenant
            const maintenant = new Date();
            const dateFormattee = maintenant.toLocaleDateString('fr-CA') + ' ' +
                maintenant.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('stat-derniere-maj').textContent = dateFormattee;

            // Calcul du poids des donn√©es
            let poidsTotal = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const cle = localStorage.key(i);
                const valeur = localStorage.getItem(cle);
                poidsTotal += (cle.length + valeur.length) * 2; // UTF-16 = 2 bytes par caract√®re
            }

            const poidsKo = (poidsTotal / 1024).toFixed(2);
            const poidsMo = (poidsTotal / (1024 * 1024)).toFixed(2);
            const affichagePoids = poidsTotal < 1024 * 1024 ? `${poidsKo} Ko` : `${poidsMo} Mo`;
            document.getElementById('stat-poids').textContent = affichagePoids;
        }

        /* ===============================
           EXPORT DES DONN√âES
           =============================== */

        function ouvrirModalExport() {
            const modal = document.getElementById('modalExport');
            const liste = document.getElementById('listeClesExport');

            // R√©cup√©rer toutes les cl√©s
            const cles = [];
            for (let i = 0; i < localStorage.length; i++) {
                cles.push(localStorage.key(i));
            }
            cles.sort();

            // Construire la liste de checkboxes
            let html = '';
            cles.forEach(cle => {
                const taille = localStorage.getItem(cle).length;
                const tailleKo = (taille * 2 / 1024).toFixed(2);
                html += `
            <label style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid var(--bleu-tres-pale); cursor: pointer;">
                <input type="checkbox" class="cle-export" value="${cle}" style="margin-right: 10px;">
                <span style="flex: 1;">${cle}</span>
                <span style="color: var(--bleu-leger); font-size: 0.85rem;">${tailleKo} Ko</span>
            </label>
        `;
            });
            liste.innerHTML = html;

            modal.style.display = 'flex';
        }

        function fermerModalExport() {
            document.getElementById('modalExport').style.display = 'none';
            document.getElementById('checkToutesLes').checked = false;
        }

        function toggleToutesLesCles() {
            const checkTous = document.getElementById('checkToutesLes').checked;
            document.querySelectorAll('.cle-export').forEach(cb => {
                cb.checked = checkTous;
            });
        }

        function executerExport() {
            const clesSelectionnees = [];
            document.querySelectorAll('.cle-export:checked').forEach(cb => {
                clesSelectionnees.push(cb.value);
            });

            if (clesSelectionnees.length === 0) {
                alert('Aucune cl√© s√©lectionn√©e');
                return;
            }

            // Cr√©er l'objet d'export
            const donnees = {};
            clesSelectionnees.forEach(cle => {
                donnees[cle] = localStorage.getItem(cle);
            });

            // Cr√©er le fichier JSON
            const json = JSON.stringify(donnees, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // T√©l√©charger
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().slice(0, 10);
            a.download = `export-monitorage-${dateStr}.json`;
            a.click();
            URL.revokeObjectURL(url);

            fermerModalExport();
            afficherNotification('Export r√©ussi !');
        }

        /* ===============================
           IMPORT DES DONN√âES
           =============================== */

        let donneesImportEnAttente = null;

        function ouvrirModalImport() {
            const modal = document.getElementById('modalImport');
            document.getElementById('fichierImport').value = '';
            document.getElementById('apercu-import').style.display = 'none';
            document.getElementById('btnExecuterImport').disabled = true;
            document.getElementById('btnExecuterImport').style.opacity = '0.5';
            donneesImportEnAttente = null;
            modal.style.display = 'flex';

            // Ajouter le listener
            document.getElementById('fichierImport').onchange = previsualiserImport;
        }

        function fermerModalImport() {
            document.getElementById('modalImport').style.display = 'none';
            donneesImportEnAttente = null;
        }

        function previsualiserImport(event) {
            const fichier = event.target.files[0];
            if (!fichier) return;

            const lecteur = new FileReader();
            lecteur.onload = function (e) {
                try {
                    const donnees = JSON.parse(e.target.result);
                    donneesImportEnAttente = donnees;

                    // Afficher l'aper√ßu
                    const nbCles = Object.keys(donnees).length;
                    let tailleTotale = 0;
                    Object.values(donnees).forEach(v => {
                        tailleTotale += v.length * 2;
                    });
                    const tailleKo = (tailleTotale / 1024).toFixed(2);

                    const apercu = document.getElementById('apercu-import');
                    apercu.innerHTML = `
                <strong>‚úì Fichier valide</strong><br>
                <span style="color: var(--bleu-leger); font-size: 0.9rem;">
                    ${nbCles} cl√©(s) ¬∑ ${tailleKo} Ko
                </span>
            `;
                    apercu.style.display = 'block';

                    // Activer le bouton
                    document.getElementById('btnExecuterImport').disabled = false;
                    document.getElementById('btnExecuterImport').style.opacity = '1';

                } catch (err) {
                    alert('Fichier JSON invalide');
                }
            };
            lecteur.readAsText(fichier);
        }

        function executerImport() {
            if (!donneesImportEnAttente) return;

            if (!confirm('Confirmer l\'importation ? Les donn√©es existantes seront √©cras√©es pour les cl√©s import√©es.')) {
                return;
            }

            // Importer
            let nbCles = 0;
            Object.keys(donneesImportEnAttente).forEach(cle => {
                localStorage.setItem(cle, donneesImportEnAttente[cle]);
                nbCles++;
            });

            fermerModalImport();
            afficherNotification(`Import r√©ussi : ${nbCles} cl√©(s) import√©e(s)`);

            // Recharger les stats si on est sur la page aper√ßu
            if (document.getElementById('reglages-apercu').classList.contains('active')) {
                chargerStatistiquesApercu();
            }
        }

        function afficherProfilEtudiant(da) {
            // Charger les donn√©es de l'√©l√®ve
            const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
            const eleve = etudiants.find(e => e.da === da);

            if (!eleve) {
                alert('√âl√®ve introuvable');
                return;
            }

            // Naviguer vers la sous-section profil
            afficherSousSection('etudiants-profil');

            // Afficher le profil
            const container = document.getElementById('contenuProfilEtudiant');
            container.innerHTML = `
        <h2>${eleve.prenom} ${eleve.nom}</h2>
        <p class="text-muted">DA: ${eleve.da} ¬∑ Groupe: ${eleve.groupe} ¬∑ ${eleve.programme}</p>
        
        <div class="carte">
            <h3>üìÅ Portfolio d'apprentissage (60%)</h3>
            <div id="portfolioEleveDetail"></div>
        </div>
    `;

            // Charger le portfolio
            chargerPortfolioEleveDetail(da);
        }

        function chargerPortfolioEleveDetail(da) {
            // R√©cup√©rer le portfolio
            const productions = JSON.parse(localStorage.getItem('listeGrilles') || '[]');
            const portfolio = productions.find(p => p.type === 'portfolio');

            if (!portfolio) {
                document.getElementById('portfolioEleveDetail').innerHTML =
                    '<p class="text-muted">Aucun portfolio configur√© dans les productions.</p>';
                return;
            }

            // D√©tecter AUTOMATIQUEMENT tous les artefacts-portfolio existants
            const artefactsPortfolio = productions.filter(p => p.type === 'artefact-portfolio');

            if (artefactsPortfolio.length === 0) {
                document.getElementById('portfolioEleveDetail').innerHTML =
                    '<p class="text-muted">Aucun artefact de portfolio cr√©√© pour le moment. Cr√©e-les au fil de la session.</p>';
                return;
            }

            // R√©cup√©rer les √©valuations de cet √©l√®ve
            const evaluations = JSON.parse(localStorage.getItem('evaluationsSauvegardees') || '[]');
            const evaluationsEleve = evaluations.filter(e => e.etudiantDA === da);

            // R√©cup√©rer la s√©lection actuelle
            const selectionsPortfolios = JSON.parse(localStorage.getItem('portfoliosEleves') || '{}');
            const selectionEleve = selectionsPortfolios[da]?.[portfolio.id] || { artefactsRetenus: [] };

            // Construire la liste des artefacts
            const artefacts = artefactsPortfolio.map(art => {
                const evaluation = evaluationsEleve.find(e => e.productionId === art.id);

                return {
                    id: art.id,
                    titre: art.titre,
                    description: art.description || '',
                    remis: !!evaluation,
                    note: evaluation?.noteFinale || null,
                    niveau: evaluation?.niveauFinal || null,
                    retenu: selectionEleve.artefactsRetenus.includes(art.id)
                };
            });

            // Trier : artefacts remis en premier
            artefacts.sort((a, b) => {
                if (a.remis && !b.remis) return -1;
                if (!a.remis && b.remis) return 1;
                return 0;
            });

            const nbRemis = artefacts.filter(a => a.remis).length;
            const nbRetenus = selectionEleve.artefactsRetenus.length;
            const nbTotal = artefacts.length;

            // Calculer les notes
            const noteProvisoire = artefacts.filter(a => a.remis && a.note !== null).length > 0
                ? artefacts.filter(a => a.remis && a.note !== null)
                    .reduce((sum, a) => sum + a.note, 0) / artefacts.filter(a => a.remis && a.note !== null).length
                : null;

            const noteFinale = nbRetenus === portfolio.regles.nombreARetenir
                ? artefacts.filter(a => a.retenu && a.note !== null)
                    .reduce((sum, a) => sum + a.note, 0) / portfolio.regles.nombreARetenir
                : null;

            // Afficher
            const container = document.getElementById('portfolioEleveDetail');
            container.innerHTML = `
        <p><strong>Progression :</strong> ${nbRemis}/${nbTotal} remis ¬∑ 
           ${portfolio.regles.minimumCompletion} requis minimum ¬∑ 
           ${portfolio.regles.nombreARetenir} √† retenir pour note finale</p>
        
        <div style="margin: 20px 0; padding: 15px; background: var(--bleu-pale); border-radius: 6px;">
            ${artefacts.map(art => `
                <div style="padding: 10px; margin-bottom: 10px; background: white; border-radius: 4px; 
                     ${!art.remis ? 'opacity: 0.5;' : ''}">
                    <label style="display: flex; align-items: center; cursor: ${art.remis ? 'pointer' : 'not-allowed'};">
                        <input type="checkbox" 
                               name="artefactRetenu" 
                               value="${art.id}"
                               ${art.retenu ? 'checked' : ''}
                               ${!art.remis ? 'disabled' : ''}
                               onchange="toggleArtefactPortfolio('${da}', '${portfolio.id}', ${portfolio.regles.nombreARetenir})"
                               style="margin-right: 15px; transform: scale(1.3);">
                        <div style="flex: 1;">
                            <strong>${art.titre}</strong>${art.description ? ' - ' + art.description : ''}
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                ${art.remis
                    ? `‚úì Remis ¬∑ Note: ${art.note}/100 (${art.niveau})`
                    : '‚Äî Non remis'}
                            </div>
                        </div>
                    </label>
                </div>
            `).join('')}
        </div>
        
        <div style="padding: 15px; background: var(--bleu-tres-pale); border-radius: 6px;">
            <p><strong>MODE ACTUEL :</strong> ${nbRetenus === portfolio.regles.nombreARetenir ? 'FINAL' : 'PROVISOIRE'}</p>
            ${noteProvisoire !== null ? `<p>Note provisoire : ${noteProvisoire.toFixed(2)}/100 (moyenne de ${nbRemis} artefacts)</p>` : ''}
            ${noteFinale !== null ? `<p><strong>Note finale : ${noteFinale.toFixed(2)}/100</strong> (moyenne des ${portfolio.regles.nombreARetenir} retenus)</p>` : ''}
            <p style="color: ${nbRetenus === portfolio.regles.nombreARetenir ? 'green' : 'orange'};">
                ${nbRetenus === portfolio.regles.nombreARetenir
                    ? `‚úì ${portfolio.regles.nombreARetenir} artefacts s√©lectionn√©s - Mode final actif`
                    : `‚ö†Ô∏è S√©lectionner ${portfolio.regles.nombreARetenir - nbRetenus} artefact(s) suppl√©mentaire(s) pour activer le mode FINAL`}
            </p>
        </div>
    `;
        }

        function toggleArtefactPortfolio(da, portfolioId, nombreARetenir) {
            const checkboxes = document.querySelectorAll('input[name="artefactRetenu"]:checked');
            const artefactsRetenus = Array.from(checkboxes).map(cb => cb.value);

            // Limiter au nombre d√©fini dans les r√®gles
            if (artefactsRetenus.length > nombreARetenir) {
                alert(`Tu ne peux s√©lectionner que ${nombreARetenir} artefacts maximum.`);
                event.target.checked = false;
                return;
            }

            // Sauvegarder
            let selectionsPortfolios = JSON.parse(localStorage.getItem('portfoliosEleves') || '{}');
            if (!selectionsPortfolios[da]) selectionsPortfolios[da] = {};

            selectionsPortfolios[da][portfolioId] = {
                artefactsRetenus: artefactsRetenus,
                dateSelection: new Date().toISOString()
            };

            localStorage.setItem('portfoliosEleves', JSON.stringify(selectionsPortfolios));

            // Recharger
            chargerPortfolioEleveDetail(da);
        }


    </script>
</body>

</html>