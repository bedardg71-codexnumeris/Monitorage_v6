<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse des corr√©lations - Monitorage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .correlation-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .correlation-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
        }

        .correlation-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 15px;
        }

        .correlation-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .correlation-value.positive {
            color: #4caf50;
        }

        .correlation-value.negative {
            color: #f44336;
        }

        .correlation-value.neutral {
            color: #999;
        }

        .correlation-interpretation {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 10px;
        }

        .correlation-note {
            font-size: 0.9rem;
            color: #999;
            font-style: italic;
        }

        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .alert-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        .alert-text {
            color: #856404;
            line-height: 1.6;
        }

        .distribution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .distribution-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .distribution-level {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .distribution-count {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .distribution-percent {
            font-size: 1rem;
            color: #999;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .no-data-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .no-data-text {
            font-size: 1.2rem;
        }

        .legend {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .legend-item {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #666;
        }

        .legend-item strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analyse des corr√©lations</h1>
            <p>Indices A-C-P et niveau R√†I</p>
        </div>

        <div class="content" id="content">
            <div class="no-data">
                <div class="no-data-icon">‚è≥</div>
                <div class="no-data-text">Chargement des donn√©es...</div>
            </div>
        </div>
    </div>

    <script>
        // Fonction pour calculer la corr√©lation de Pearson
        function correlationPearson(x, y) {
            const n = x.length;
            if (n === 0 || n !== y.length) return null;

            const moyX = x.reduce((a, b) => a + b, 0) / n;
            const moyY = y.reduce((a, b) => a + b, 0) / n;

            let numerateur = 0, denomX = 0, denomY = 0;

            for (let i = 0; i < n; i++) {
                const diffX = x[i] - moyX;
                const diffY = y[i] - moyY;
                numerateur += diffX * diffY;
                denomX += diffX * diffX;
                denomY += diffY * diffY;
            }

            if (denomX === 0 || denomY === 0) return null;
            return numerateur / Math.sqrt(denomX * denomY);
        }

        // Fonction pour interpr√©ter la corr√©lation
        function interpreterCorrelation(r) {
            if (r === null || r === undefined) return { force: 'Impossible √† calculer', classe: 'neutral' };

            const absR = Math.abs(r);
            let force = '';
            if (absR < 0.3) force = 'Tr√®s faible';
            else if (absR < 0.5) force = 'Faible';
            else if (absR < 0.7) force = 'Mod√©r√©e';
            else if (absR < 0.9) force = 'Forte';
            else force = 'Tr√®s forte';

            const direction = r > 0 ? 'positive' : 'n√©gative';
            const classe = r > 0 ? 'positive' : 'negative';

            return { force, direction, classe, texte: `${force} (${direction})` };
        }

        // Fonction pour afficher les r√©sultats
        function afficherResultats(donnees, correlations, stats, hasAssiduites) {
            const content = document.getElementById('content');

            if (donnees.length === 0) {
                content.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">‚ùå</div>
                        <div class="no-data-text">Aucune donn√©e disponible pour l'analyse</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // Alerte si pas d'assiduit√©s
            if (!hasAssiduites) {
                html += `
                    <div class="alert">
                        <div class="alert-title">‚ö†Ô∏è Donn√©es d'assiduit√© manquantes</div>
                        <div class="alert-text">
                            Les indices d'assiduit√© (A) n'ont pas √©t√© calcul√©s car aucune pr√©sence n'a √©t√© saisie.
                            Seule la corr√©lation entre Compl√©tion (C) et Performance (P) peut √™tre calcul√©e.
                        </div>
                    </div>
                `;
            }

            // Statistiques g√©n√©rales
            html += `
                <div class="section">
                    <h2 class="section-title">üìà Statistiques descriptives</h2>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-label">√âtudiants analys√©s</div>
                            <div class="stat-value">${donnees.length}</div>
                        </div>
                        ${hasAssiduites ? `
                        <div class="stat-card">
                            <div class="stat-label">Assiduit√© moyenne</div>
                            <div class="stat-value">${stats.A_moy.toFixed(1)}%</div>
                        </div>
                        ` : ''}
                        <div class="stat-card">
                            <div class="stat-label">Compl√©tion moyenne</div>
                            <div class="stat-value">${stats.C_moy.toFixed(1)}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Performance moyenne</div>
                            <div class="stat-value">${stats.P_moy.toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            `;

            // Corr√©lations principales
            html += `
                <div class="section">
                    <h2 class="section-title">üî¢ Corr√©lations calcul√©es</h2>
            `;

            // C ‚Üî P (toujours disponible)
            const r_CP = correlations.C_P;
            const interp_CP = interpreterCorrelation(r_CP);
            html += `
                <div class="correlation-card">
                    <div class="correlation-title">Compl√©tion (C) ‚Üî Performance (P)</div>
                    <div class="correlation-value ${interp_CP.classe}">
                        r = ${r_CP !== null ? r_CP.toFixed(3) : 'N/A'}
                    </div>
                    <div class="correlation-interpretation">${interp_CP.texte}</div>
                    <div class="correlation-note">
                        ${r_CP > 0.5
                            ? 'Les √©tudiants qui remettent plus de travaux ont tendance √† avoir de meilleures notes.'
                            : r_CP > 0.3
                            ? 'Il existe une faible relation entre la remise des travaux et les notes obtenues.'
                            : 'La remise des travaux et les notes semblent peu li√©es dans ce groupe.'}
                    </div>
                </div>
            `;

            if (hasAssiduites) {
                // A ‚Üî P
                const r_AP = correlations.A_P;
                const interp_AP = interpreterCorrelation(r_AP);
                html += `
                    <div class="correlation-card">
                        <div class="correlation-title">Assiduit√© (A) ‚Üî Performance (P)</div>
                        <div class="correlation-value ${interp_AP.classe}">
                            r = ${r_AP !== null ? r_AP.toFixed(3) : 'N/A'}
                        </div>
                        <div class="correlation-interpretation">${interp_AP.texte}</div>
                        <div class="correlation-note">
                            ${r_AP > 0.5
                                ? 'Les √©tudiants assidus ont tendance √† avoir de meilleures performances.'
                                : r_AP > 0.3
                                ? 'Il existe une faible relation entre la pr√©sence en classe et les notes.'
                                : 'La pr√©sence en classe et les notes semblent peu li√©es dans ce groupe.'}
                        </div>
                    </div>
                `;

                // A ‚Üî C
                const r_AC = correlations.A_C;
                const interp_AC = interpreterCorrelation(r_AC);
                html += `
                    <div class="correlation-card">
                        <div class="correlation-title">Assiduit√© (A) ‚Üî Compl√©tion (C)</div>
                        <div class="correlation-value ${interp_AC.classe}">
                            r = ${r_AC !== null ? r_AC.toFixed(3) : 'N/A'}
                        </div>
                        <div class="correlation-interpretation">${interp_AC.texte}</div>
                        <div class="correlation-note">
                            ${r_AC > 0.5
                                ? 'Les √©tudiants pr√©sents en classe remettent plus de travaux.'
                                : r_AC > 0.3
                                ? 'Il existe une faible relation entre la pr√©sence et la remise des travaux.'
                                : 'La pr√©sence en classe et la remise des travaux semblent peu li√©es.'}
                        </div>
                    </div>
                `;

                // R√†I ‚Üî P
                const r_RaiP = correlations.RaI_P;
                const interp_RaiP = interpreterCorrelation(r_RaiP);
                html += `
                    <div class="correlation-card">
                        <div class="correlation-title">Niveau R√†I ‚Üî Performance (P)</div>
                        <div class="correlation-value ${interp_RaiP.classe}">
                            r = ${r_RaiP !== null ? r_RaiP.toFixed(3) : 'N/A'}
                        </div>
                        <div class="correlation-interpretation">${interp_RaiP.texte}</div>
                        <div class="correlation-note">
                            Note : Corr√©lation n√©gative attendue (niveau R√†I √©lev√© = risque √©lev√© = performance faible)
                        </div>
                    </div>
                `;

                // Distribution R√†I
                html += `
                    </div>
                    <div class="section">
                        <h2 class="section-title">üìä Distribution des niveaux R√†I</h2>
                        <div class="distribution-grid">
                            <div class="distribution-item">
                                <div class="distribution-level">Niveau 1 - Universel</div>
                                <div class="distribution-count">${stats.niv1}</div>
                                <div class="distribution-percent">${stats.niv1_pct}%</div>
                            </div>
                            <div class="distribution-item">
                                <div class="distribution-level">Niveau 2 - Pr√©ventif</div>
                                <div class="distribution-count">${stats.niv2}</div>
                                <div class="distribution-percent">${stats.niv2_pct}%</div>
                            </div>
                            <div class="distribution-item">
                                <div class="distribution-level">Niveau 3 - Intensif</div>
                                <div class="distribution-count">${stats.niv3}</div>
                                <div class="distribution-percent">${stats.niv3_pct}%</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `</div>`;
            }

            // L√©gende
            html += `
                <div class="legend">
                    <div class="legend-title">üìñ Interpr√©tation des coefficients de corr√©lation</div>
                    <div class="legend-item"><strong>|r| < 0.3</strong> : Tr√®s faible (quasi absence de relation)</div>
                    <div class="legend-item"><strong>0.3 ‚â§ |r| < 0.5</strong> : Faible (relation peu marqu√©e)</div>
                    <div class="legend-item"><strong>0.5 ‚â§ |r| < 0.7</strong> : Mod√©r√©e (relation notable)</div>
                    <div class="legend-item"><strong>0.7 ‚â§ |r| < 0.9</strong> : Forte (relation marqu√©e)</div>
                    <div class="legend-item"><strong>|r| ‚â• 0.9</strong> : Tr√®s forte (relation quasi-lin√©aire)</div>
                    <div class="legend-item" style="margin-top: 15px;">
                        <strong>Signe positif (+)</strong> : Les deux variables √©voluent dans le m√™me sens<br>
                        <strong>Signe n√©gatif (‚àí)</strong> : Les deux variables √©voluent en sens inverse
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }

        // Fonction pour calculer l'assiduit√© depuis les pr√©sences brutes
        function calculerAssiduiteDepuisPresences(da, presences) {
            if (!presences || typeof presences !== 'object') return null;

            const presencesDa = [];
            for (const date in presences) {
                const seance = presences[date];
                if (seance && seance[da]) {
                    presencesDa.push({
                        date: date,
                        statut: seance[da].statut,
                        heures: seance[da].heures || 2,
                        facultatif: seance[da].facultatif || false
                    });
                }
            }

            if (presencesDa.length === 0) return null;

            // Calculer le taux global
            let heuresPresentes = 0;
            let heuresTotales = 0;

            presencesDa.forEach(p => {
                if (!p.facultatif) {
                    heuresTotales += p.heures;
                    if (p.statut === 'present' || p.statut === 'retard') {
                        heuresPresentes += p.heures;
                    }
                }
            });

            const taux = heuresTotales > 0 ? (heuresPresentes / heuresTotales) * 100 : 0;

            return { taux, heuresPresentes, heuresTotales };
        }

        // Charger et analyser les donn√©es au chargement de la page
        window.addEventListener('load', function() {
            try {
                // R√©cup√©rer les donn√©es
                let indicesAssiduites = JSON.parse(localStorage.getItem('indicesAssiduiteDetailles') || '{}');
                const indicesCP = JSON.parse(localStorage.getItem('indicesCP') || '{}');
                const etudiants = JSON.parse(localStorage.getItem('groupeEtudiants') || '[]');
                const modalites = JSON.parse(localStorage.getItem('modalitesEvaluation') || '{}');
                const pratique = (modalites.pratiqueActive || 'pan-maitrise').toUpperCase();

                // Si pas d'indices d'assiduit√©, les calculer depuis les pr√©sences
                let hasAssiduites = Object.keys(indicesAssiduites).length > 0;

                if (!hasAssiduites) {
                    console.log("üìä Calcul des indices d'assiduit√© depuis les pr√©sences...");
                    const presences = JSON.parse(localStorage.getItem('presences') || '{}');

                    if (Object.keys(presences).length > 0) {
                        indicesAssiduites = {};
                        etudiants.forEach(etudiant => {
                            const assiduiteData = calculerAssiduiteDepuisPresences(etudiant.da, presences);
                            if (assiduiteData) {
                                indicesAssiduites[etudiant.da] = {
                                    global: assiduiteData
                                };
                            }
                        });
                        hasAssiduites = Object.keys(indicesAssiduites).length > 0;
                        console.log(`‚úÖ ${Object.keys(indicesAssiduites).length} indices calcul√©s`);
                    }
                }

                // Pr√©parer les donn√©es
                const donnees = [];
                etudiants.forEach(etudiant => {
                    const da = etudiant.da;
                    const assiduiteData = indicesAssiduites[da];
                    const cpData = indicesCP[da];

                    if (!cpData || !cpData.actuel) return;

                    const pratiqueDonnees = cpData.actuel[pratique] || cpData.actuel.PAN || cpData.actuel.SOM || cpData.actuel;

                    const A = hasAssiduites && assiduiteData ? (assiduiteData.dernier12?.taux ?? assiduiteData.global?.taux ?? 0) : 0;
                    const C = pratiqueDonnees.C ?? 0;
                    const P = pratiqueDonnees.P ?? 0;
                    const E = hasAssiduites ? (A * C * P / 10000) : 0;

                    let niveauRai = 1;
                    if (hasAssiduites) {
                        if (E < 0.35) niveauRai = 3;
                        else if (E < 0.55) niveauRai = 2;
                    }

                    donnees.push({
                        nom: etudiant.prenom + ' ' + etudiant.nom,
                        A, C, P, E, niveauRai
                    });
                });

                // Calculer les corr√©lations
                const A_values = donnees.map(d => d.A);
                const C_values = donnees.map(d => d.C);
                const P_values = donnees.map(d => d.P);
                const RaI_values = donnees.map(d => d.niveauRai);

                const correlations = {
                    A_P: hasAssiduites ? correlationPearson(A_values, P_values) : null,
                    C_P: correlationPearson(C_values, P_values),
                    RaI_P: hasAssiduites ? correlationPearson(RaI_values, P_values) : null,
                    A_C: hasAssiduites ? correlationPearson(A_values, C_values) : null,
                    RaI_A: hasAssiduites ? correlationPearson(RaI_values, A_values) : null,
                    RaI_C: hasAssiduites ? correlationPearson(RaI_values, C_values) : null
                };

                // Statistiques
                const stats = {
                    A_moy: hasAssiduites ? A_values.reduce((a,b) => a+b, 0) / A_values.length : 0,
                    C_moy: C_values.reduce((a,b) => a+b, 0) / C_values.length,
                    P_moy: P_values.reduce((a,b) => a+b, 0) / P_values.length,
                    niv1: hasAssiduites ? RaI_values.filter(r => r === 1).length : 0,
                    niv2: hasAssiduites ? RaI_values.filter(r => r === 2).length : 0,
                    niv3: hasAssiduites ? RaI_values.filter(r => r === 3).length : 0
                };

                if (hasAssiduites && donnees.length > 0) {
                    stats.niv1_pct = ((stats.niv1 / donnees.length) * 100).toFixed(1);
                    stats.niv2_pct = ((stats.niv2 / donnees.length) * 100).toFixed(1);
                    stats.niv3_pct = ((stats.niv3 / donnees.length) * 100).toFixed(1);
                }

                // Afficher les r√©sultats
                afficherResultats(donnees, correlations, stats, hasAssiduites);

            } catch (error) {
                console.error('Erreur lors de l\'analyse:', error);
                document.getElementById('content').innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">‚ö†Ô∏è</div>
                        <div class="no-data-text">Erreur lors du chargement des donn√©es</div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
