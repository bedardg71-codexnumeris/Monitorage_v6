<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic LocalStorage</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #032e5c;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .cle {
            font-weight: 600;
            color: #032e5c;
            margin-top: 15px;
        }
        .valeur {
            background: #f8f9fa;
            padding: 10px;
            border-left: 3px solid #032e5c;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow: auto;
        }
        .erreur {
            color: #dc2626;
            background: #fee;
            padding: 10px;
            border-left: 3px solid #dc2626;
        }
        .ok {
            color: #16a34a;
            background: #efe;
            padding: 10px;
            border-left: 3px solid #16a34a;
        }
        .warning {
            color: #ca8a04;
            background: #fffbeb;
            padding: 10px;
            border-left: 3px solid #ca8a04;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #032e5c;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        button {
            background: #032e5c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
        }
        button:hover {
            background: #064b8f;
        }
        .danger {
            background: #dc2626;
        }
        .danger:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <h1>üîç Diagnostic LocalStorage - Monitorage Beta 0.90</h1>

    <div class="section">
        <h2>Actions rapides</h2>
        <button onclick="diagnostiquer()">üîÑ Rafra√Æchir le diagnostic</button>
        <button onclick="exporterLocalStorage()">üíæ Exporter toutes les donn√©es</button>
        <button onclick="afficherClesVides()">‚ö†Ô∏è Afficher cl√©s vides</button>
        <button class="danger" onclick="if(confirm('ATTENTION: Ceci va effacer TOUTES les donn√©es. √ätes-vous s√ªr ?')) { localStorage.clear(); location.reload(); }">üóëÔ∏è Tout effacer</button>
    </div>

    <div id="resultats"></div>

    <script>
        function diagnostiquer() {
            const resultats = document.getElementById('resultats');
            let html = '';

            // Statistiques g√©n√©rales
            html += '<div class="section">';
            html += '<h2>üìä Statistiques g√©n√©rales</h2>';
            html += '<div class="stats">';

            const nbCles = localStorage.length;
            html += `<div class="stat"><div class="stat-value">${nbCles}</div><div class="stat-label">Cl√©s totales</div></div>`;

            let tailleTotal = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const cle = localStorage.key(i);
                const valeur = localStorage.getItem(cle);
                tailleTotal += (cle.length + valeur.length) * 2; // UTF-16
            }
            const tailleMo = (tailleTotal / (1024 * 1024)).toFixed(2);
            html += `<div class="stat"><div class="stat-value">${tailleMo} MB</div><div class="stat-label">Taille utilis√©e</div></div>`;

            html += '</div>';
            html += '</div>';

            // Cl√©s critiques pour le monitorage
            const clesCritiques = [
                'groupeEtudiants',
                'productions',
                'evaluationsSauvegardees',
                'presences',
                'calendrierComplet',
                'indicesAssiduiteDetailles',
                'indicesCP',
                'interventions'
            ];

            html += '<div class="section">';
            html += '<h2>üîë Cl√©s critiques du syst√®me</h2>';

            clesCritiques.forEach(cle => {
                const valeur = localStorage.getItem(cle);
                html += `<div class="cle">${cle}</div>`;

                if (!valeur) {
                    html += `<div class="erreur">‚ùå ABSENT - Cette donn√©e n'existe pas</div>`;
                } else if (valeur === 'null' || valeur === 'undefined') {
                    html += `<div class="warning">‚ö†Ô∏è NULL - Cl√© existe mais valeur null</div>`;
                } else if (valeur === '[]' || valeur === '{}') {
                    html += `<div class="warning">‚ö†Ô∏è VIDE - Structure vide</div>`;
                } else {
                    try {
                        const parsed = JSON.parse(valeur);
                        let info = '';

                        if (Array.isArray(parsed)) {
                            info = `${parsed.length} √©l√©ment(s)`;
                            if (parsed.length > 0 && cle === 'groupeEtudiants') {
                                info += ` - Premier: ${parsed[0].prenom} ${parsed[0].nom}`;
                            }
                        } else if (typeof parsed === 'object') {
                            const nbCles = Object.keys(parsed).length;
                            info = `${nbCles} propri√©t√©(s)`;
                        }

                        html += `<div class="ok">‚úÖ OK - ${info}</div>`;
                        html += `<div class="valeur">${JSON.stringify(parsed, null, 2).substring(0, 500)}${JSON.stringify(parsed).length > 500 ? '...' : ''}</div>`;
                    } catch (e) {
                        html += `<div class="erreur">‚ùå ERREUR JSON - ${e.message}</div>`;
                        html += `<div class="valeur">${valeur.substring(0, 200)}</div>`;
                    }
                }
            });

            html += '</div>';

            // Toutes les autres cl√©s
            html += '<div class="section">';
            html += '<h2>üì¶ Toutes les cl√©s pr√©sentes</h2>';

            const toutesLesCles = [];
            for (let i = 0; i < localStorage.length; i++) {
                toutesLesCles.push(localStorage.key(i));
            }
            toutesLesCles.sort();

            html += `<p>Total: ${toutesLesCles.length} cl√©s</p>`;
            html += '<ul>';
            toutesLesCles.forEach(cle => {
                const valeur = localStorage.getItem(cle);
                const taille = ((cle.length + valeur.length) * 2 / 1024).toFixed(2);
                html += `<li><strong>${cle}</strong> (${taille} KB)</li>`;
            });
            html += '</ul>';

            html += '</div>';

            resultats.innerHTML = html;
        }

        function exporterLocalStorage() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const cle = localStorage.key(i);
                const valeur = localStorage.getItem(cle);
                try {
                    data[cle] = JSON.parse(valeur);
                } catch (e) {
                    data[cle] = valeur;
                }
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `diagnostic-localStorage-${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('‚úÖ Export termin√© !');
        }

        function afficherClesVides() {
            let html = '<div class="section"><h2>‚ö†Ô∏è Cl√©s vides ou probl√©matiques</h2>';

            let compteur = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const cle = localStorage.key(i);
                const valeur = localStorage.getItem(cle);

                if (!valeur || valeur === 'null' || valeur === 'undefined' || valeur === '[]' || valeur === '{}') {
                    html += `<div class="warning"><strong>${cle}</strong>: ${valeur}</div>`;
                    compteur++;
                }
            }

            if (compteur === 0) {
                html += '<div class="ok">‚úÖ Aucune cl√© vide trouv√©e</div>';
            } else {
                html += `<p>${compteur} cl√©(s) vide(s) trouv√©e(s)</p>`;
            }

            html += '</div>';

            document.getElementById('resultats').innerHTML = html + document.getElementById('resultats').innerHTML;
        }

        // Lancer le diagnostic au chargement
        diagnostiquer();
    </script>
</body>
</html>
