# Consignes de dÃ©veloppement : SystÃ¨me d'import/export pour Beta 91

## Contexte pour Claude Code

Tu travailles sur une application de monitorage pÃ©dagogique appelÃ©e Codex Numeris. L'application utilise IndexedDB pour stocker les donnÃ©es. Les utilisateurs peuvent crÃ©er des grilles de critÃ¨res, des Ã©chelles de performance, des cartouches de rÃ©troaction et des productions Ã©tudiantes. 

**Objectif**: Permettre aux utilisateurs de partager et d'importer ces ressources pÃ©dagogiques avec un systÃ¨me robuste qui gÃ¨re les dÃ©pendances et respecte les licences Creative Commons.

---

## PHASE 1 : Enrichir les mÃ©tadonnÃ©es d'export existantes

### TÃ¢che 1.1 : Ajouter champs mÃ©tadonnÃ©es aux exports individuels

**Fichiers Ã  modifier** : Le module qui gÃ¨re actuellement les exports JSON (probablement `export.js` ou similaire)

**Modification requise** : 

Pour chaque type d'export (grille, Ã©chelle, cartouche, production), enrichir l'objet `metadata` avec ces 3 nouveaux champs :

```javascript
metadata: {
  // ... champs existants (licence, auteur, date, etc.) ...
  
  // NOUVEAUX CHAMPS Ã€ AJOUTER :
  "discipline": [],  // Array de strings - ex: ["LittÃ©rature", "Philosophie"]
  "niveau": "",      // String - ex: "CollÃ©gial", "Universitaire", "Secondaire"
  "description_courte": ""  // String max 200 caractÃ¨res
}
```

**Interface utilisateur nÃ©cessaire** :

Lors de l'export, afficher un modal avec 3 champs Ã  remplir :
- Discipline(s) : champ texte avec possibilitÃ© d'ajouter plusieurs tags
- Niveau : dropdown (CollÃ©gial / Universitaire / Secondaire)
- Description courte : textarea (max 200 caractÃ¨res, compteur affichÃ©)

**Validation** :
- `discipline` peut Ãªtre vide mais si rempli, doit Ãªtre array
- `niveau` peut Ãªtre vide
- `description_courte` doit faire max 200 caractÃ¨res

---

## PHASE 2 : CrÃ©er le systÃ¨me d'export "Configuration complÃ¨te"

### TÃ¢che 2.1 : Nouvelle fonction d'export bundlÃ©

**Nouveau fichier suggÃ©rÃ©** : `exportConfigComplete.js`

**SpÃ©cifications fonctionnelles** :

Cette fonction doit :
1. Rassembler TOUTES les ressources du cours actif :
   - Ã‰chelles de performance utilisÃ©es
   - Grilles de critÃ¨res utilisÃ©es
   - Cartouches de rÃ©troaction utilisÃ©s
   - Productions dÃ©finies
   - ParamÃ¨tres du cours (systÃ¨me de jetons, reprises autorisÃ©es, etc.)

2. CrÃ©er un seul objet JSON avec cette structure :

```javascript
{
  "metadata": {
    "type": "configuration-complete",
    "nom": "",  // Ã€ remplir par l'utilisateur
    "auteur": "",  // RÃ©cupÃ©rÃ© des settings utilisateur ou Ã  remplir
    "discipline": [],  // Ã€ remplir
    "niveau": "",  // Ã€ remplir
    "description": "",  // Textarea longue (500 caractÃ¨res max)
    "licence": "CC BY-NC-SA 4.0",
    "licence_url": "https://creativecommons.org/licenses/by-nc-sa/4.0/",
    "version": "1.0",
    "date_creation": "YYYY-MM-DD",  // Date du jour
    "date_export": "YYYY-MM-DD",
    "application_version": "Beta 91",  // Version de l'app
    "email_auteur": "",  // Optionnel
    "site_auteur": ""  // Optionnel
  },
  "contenu": {
    "echelles": [ /* array de toutes les Ã©chelles */ ],
    "grilles": [ /* array de toutes les grilles */ ],
    "productions": [ /* array de toutes les productions */ ],
    "cartouches": [ /* array de tous les cartouches */ ],
    "parametres": {
      "systeme_jetons": true/false,
      "reprises_autorisees": true/false,
      "nombre_artefacts": 0,
      // autres paramÃ¨tres pertinents du cours
    }
  }
}
```

**Interface utilisateur** :

Nouveau bouton dans le menu principal : **"Partager ma pratique complÃ¨te"**

Au clic, ouvrir un modal avec formulaire :
- Nom de votre pratique* (requis)
- Votre nom* (requis)
- Discipline(s)* (tags multiples, requis)
- Niveau* (dropdown, requis)
- Description de votre pratique* (textarea 500 caractÃ¨res max, requis)
- Votre courriel (optionnel)
- Votre site web (optionnel)

Checkbox : "J'accepte de partager cette configuration sous licence CC BY-NC-SA 4.0" (requis pour continuer)

Boutons : [Annuler] [Exporter]

**Nom du fichier gÃ©nÃ©rÃ©** :
`PRATIQUE-COMPLETE-[NomAuteur-simplifiÃ©]-[Date].json`

Exemple : `PRATIQUE-COMPLETE-Gregoire-Bedard-2025-11-27.json`

---

### TÃ¢che 2.2 : GÃ©nÃ©rer automatiquement un fichier LISEZMOI.txt

**SpÃ©cifications** :

Quand l'utilisateur exporte une configuration complÃ¨te, gÃ©nÃ©rer automatiquement un deuxiÃ¨me fichier texte avec ce template :

```
===========================================
PRATIQUE PÃ‰DAGOGIQUE : [Nom de la pratique]
===========================================

Auteur : [Nom]
Discipline : [Discipline(s)]
Niveau : [Niveau]
Date de crÃ©ation : [Date]
Licence : CC BY-NC-SA 4.0

-------------------------------------------
DESCRIPTION
-------------------------------------------

[Description fournie par l'utilisateur]

-------------------------------------------
CONTENU DE CETTE CONFIGURATION
-------------------------------------------

Ã‰chelles de performance : [X]
Grilles de critÃ¨res : [X]
Productions dÃ©finies : [X]
Cartouches de rÃ©troaction : [X]

-------------------------------------------
COMMENT UTILISER CETTE CONFIGURATION
-------------------------------------------

1. TÃ©lÃ©chargez le fichier PRATIQUE-COMPLETE-xxx.json
2. Dans Codex Numeris, allez dans ParamÃ¨tres > Importer > Configuration complÃ¨te
3. SÃ©lectionnez le fichier tÃ©lÃ©chargÃ©
4. L'application importera automatiquement toutes les ressources
5. Vous pourrez ensuite modifier la configuration selon vos besoins

-------------------------------------------
BESOIN D'AIDE ?
-------------------------------------------

Labo Codex : https://codexnumeris.org/labocodex/
Courriel : labo@codexnumeris.org

-------------------------------------------
ATTRIBUTION
-------------------------------------------

Si vous utilisez ou adaptez cette pratique, veuillez mentionner :
"BasÃ© sur la pratique de [Nom auteur] - [Nom pratique]"
```

**Nom du fichier** : `LISEZMOI-[NomAuteur-simplifiÃ©]-[Date].txt`

**Important** : Les deux fichiers (JSON + TXT) doivent Ãªtre tÃ©lÃ©chargÃ©s ensemble, idÃ©alement dans un ZIP pour faciliter le partage.

---

## PHASE 3 : SystÃ¨me d'import avec gestion des dÃ©pendances

### TÃ¢che 3.1 : Import de configuration complÃ¨te (simple)

**Nouveau fichier suggÃ©rÃ©** : `importConfigComplete.js`

**SpÃ©cifications** :

Fonction qui :
1. Lit le fichier JSON de configuration complÃ¨te
2. Valide la structure (vÃ©rifie que `metadata.type === "configuration-complete"`)
3. Importe TOUT le contenu dans l'IndexedDB du cours actif
4. GÃ¨re les conflits d'ID (voir TÃ¢che 3.2)

**Interface utilisateur** :

Nouveau bouton dans ParamÃ¨tres : **"Importer une configuration complÃ¨te"**

Flux :
1. SÃ©lectionner fichier JSON
2. Afficher prÃ©visualisation :
   ```
   Configuration : [Nom]
   Auteur : [Nom]
   Discipline : [X]
   
   Cette configuration contient :
   - X Ã©chelles de performance
   - X grilles de critÃ¨res
   - X productions
   - X cartouches
   
   [Annuler] [Importer tout]
   ```

3. Si import rÃ©ussi :
   ```
   âœ“ Configuration importÃ©e avec succÃ¨s !
   
   Vous pouvez maintenant la modifier dans vos paramÃ¨tres.
   ```

---

### TÃ¢che 3.2 : Gestion des conflits d'ID

**ProblÃ¨me** : Les ID sont gÃ©nÃ©rÃ©s avec timestamps. Deux utilisateurs peuvent avoir des ressources avec le mÃªme ID.

**Solution pour Beta 91 (simple)** :

Lors de l'import d'une configuration complÃ¨te :

1. VÃ©rifier si des ID existent dÃ©jÃ  dans la base
2. Si collision dÃ©tectÃ©e, **TOUJOURS rÃ©gÃ©nÃ©rer un nouvel ID** pour la ressource importÃ©e
3. Mettre Ã  jour toutes les rÃ©fÃ©rences croisÃ©es dans le bundle importÃ©

**Algorithme** :

```javascript
function importAvecRemappingIDs(configComplete) {
  const mapAncienVersNouveauID = {};
  
  // 1. Ã‰chelles : rÃ©gÃ©nÃ©rer IDs si nÃ©cessaire
  for (let echelle of configComplete.contenu.echelles) {
    const ancienID = echelle.id;
    const idExiste = await verifierIDExiste('echelles', ancienID);
    
    if (idExiste) {
      const nouvelID = genererNouvelID();
      echelle.id = nouvelID;
      mapAncienVersNouveauID[ancienID] = nouvelID;
    }
    
    await sauvegarderEchelle(echelle);
  }
  
  // 2. Grilles : rÃ©gÃ©nÃ©rer IDs + mettre Ã  jour rÃ©fÃ©rences aux Ã©chelles
  for (let grille of configComplete.contenu.grilles) {
    const ancienID = grille.id;
    const idExiste = await verifierIDExiste('grilles', ancienID);
    
    if (idExiste) {
      const nouvelID = genererNouvelID();
      grille.id = nouvelID;
      mapAncienVersNouveauID[ancienID] = nouvelID;
    }
    
    // Mettre Ã  jour rÃ©fÃ©rences aux critÃ¨res si nÃ©cessaire
    // ...
    
    await sauvegarderGrille(grille);
  }
  
  // 3. Productions : mettre Ã  jour grilleId
  for (let production of configComplete.contenu.productions) {
    const ancienID = production.id;
    const idExiste = await verifierIDExiste('productions', ancienID);
    
    if (idExiste) {
      const nouvelID = genererNouvelID();
      production.id = nouvelID;
    }
    
    // Si production rÃ©fÃ©rence une grille qui a Ã©tÃ© remappÃ©e
    if (production.grilleId && mapAncienVersNouveauID[production.grilleId]) {
      production.grilleId = mapAncienVersNouveauID[production.grilleId];
    }
    
    await sauvegarderProduction(production);
  }
  
  // 4. Cartouches : mettre Ã  jour grilleId et rÃ©fÃ©rences critÃ¨res
  // ... mÃªme logique
}
```

---

### TÃ¢che 3.3 : Import de composants individuels avec dÃ©tection de dÃ©pendances

**Fichier Ã  modifier** : Module d'import existant pour grilles, productions, etc.

**Ajout de logique de validation** :

Avant d'importer un composant individuel, vÃ©rifier les dÃ©pendances :

**Exemple : Import d'une production**

```javascript
async function importerProduction(productionJSON) {
  const production = JSON.parse(productionJSON);
  
  // VÃ©rifier si la grille rÃ©fÃ©rencÃ©e existe
  if (production.contenu.grilleId) {
    const grilleExiste = await verifierIDExiste('grilles', production.contenu.grilleId);
    
    if (!grilleExiste) {
      // Afficher modal d'erreur
      afficherModalDependanceManquante({
        type: 'production',
        nom: production.metadata.nom,
        dependance: {
          type: 'grille',
          id: production.contenu.grilleId,
          nom: 'Grille de critÃ¨res requise'  // Peut Ãªtre enrichi si mÃ©tadonnÃ©es disponibles
        }
      });
      
      return false;  // Import annulÃ©
    }
  }
  
  // Si OK, procÃ©der Ã  l'import
  await sauvegarderProduction(production.contenu);
  return true;
}
```

**Modal de dÃ©pendance manquante** :

```
âš ï¸ Import impossible

Cette production nÃ©cessite la grille de critÃ¨res suivante qui n'est pas dans votre systÃ¨me :
ID : GRILLE1759529438501
Nom : [si disponible dans mÃ©tadonnÃ©es]

Options :
[Annuler l'import]
[Ouvrir le catalogue Teams]  // Ouvre l'URL du canal Teams #bibliothÃ¨que

Conseil : Importez d'abord la grille requise, puis rÃ©essayez d'importer cette production.
```

---

## PHASE 4 : Interface utilisateur - Menu Import/Export centralisÃ©

### TÃ¢che 4.1 : CrÃ©er section "BibliothÃ¨que" dans les paramÃ¨tres

**Emplacement** : Menu ParamÃ¨tres ou nouveau menu "BibliothÃ¨que"

**Structure suggÃ©rÃ©e** :

```
======================
BIBLIOTHÃˆQUE
======================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PARTAGER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ ğŸ“¦ Exporter ma pratique complÃ¨te    â”‚
â”‚    Partagez votre configuration     â”‚
â”‚    pÃ©dagogique complÃ¨te (grilles,   â”‚
â”‚    productions, Ã©chelles, etc.)     â”‚
â”‚                                     â”‚
â”‚    [Exporter la pratique complÃ¨te]  â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ ğŸ“„ Exporter des composants          â”‚
â”‚    Partagez des Ã©lÃ©ments            â”‚
â”‚    individuels                      â”‚
â”‚                                     â”‚
â”‚    [Exporter une grille]            â”‚
â”‚    [Exporter une Ã©chelle]           â”‚
â”‚    [Exporter une production]        â”‚
â”‚    [Exporter un cartouche]          â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMPORTER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ ğŸ“¥ Importer une pratique complÃ¨te   â”‚
â”‚    Importer une configuration       â”‚
â”‚    partagÃ©e par un collÃ¨gue         â”‚
â”‚                                     â”‚
â”‚    [Choisir un fichier]             â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ ğŸ“¥ Importer des composants          â”‚
â”‚    Importer des Ã©lÃ©ments            â”‚
â”‚    individuels                      â”‚
â”‚                                     â”‚
â”‚    [Importer grille/Ã©chelle/etc.]   â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ ğŸ”— AccÃ©der au catalogue             â”‚
â”‚    Consulter les ressources         â”‚
â”‚    partagÃ©es sur Teams              â”‚
â”‚                                     â”‚
â”‚    [Ouvrir le catalogue Teams]      â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## PHASE 5 : Tests et validation

### TÃ¢che 5.1 : Checklist de tests

Avant de livrer Beta 91, tester ces scÃ©narios :

**ScÃ©nario 1 : Export configuration complÃ¨te**
- [ ] CrÃ©er un cours avec 2 grilles, 1 Ã©chelle, 3 productions, 1 cartouche
- [ ] Exporter la configuration complÃ¨te
- [ ] VÃ©rifier que le JSON contient tout
- [ ] VÃ©rifier que le LISEZMOI.txt est gÃ©nÃ©rÃ©
- [ ] VÃ©rifier que les mÃ©tadonnÃ©es CC sont prÃ©sentes

**ScÃ©nario 2 : Import configuration complÃ¨te (sans conflits)**
- [ ] CrÃ©er nouveau cours vide
- [ ] Importer la config du scÃ©nario 1
- [ ] VÃ©rifier que tout est importÃ© correctement
- [ ] VÃ©rifier que les rÃ©fÃ©rences croisÃ©es fonctionnent (production â†’ grille)

**ScÃ©nario 3 : Import configuration complÃ¨te (avec conflits d'ID)**
- [ ] Importer une config dans un cours qui a dÃ©jÃ  des ressources
- [ ] VÃ©rifier que les nouveaux ID sont gÃ©nÃ©rÃ©s
- [ ] VÃ©rifier que les rÃ©fÃ©rences internes restent cohÃ©rentes

**ScÃ©nario 4 : Import composant individuel avec dÃ©pendance manquante**
- [ ] Essayer d'importer une production qui rÃ©fÃ©rence une grille absente
- [ ] VÃ©rifier que le modal d'erreur s'affiche correctement
- [ ] VÃ©rifier que l'import est annulÃ©

**ScÃ©nario 5 : Import composant individuel avec dÃ©pendance prÃ©sente**
- [ ] Importer d'abord la grille requise
- [ ] Puis importer la production
- [ ] VÃ©rifier que Ã§a fonctionne

---

## CONTRAINTES TECHNIQUES IMPORTANTES

### Architecture de fichiers

Respecte l'architecture existante. Si l'application utilise dÃ©jÃ  des modules pour l'import/export, Ã©tends-les plutÃ´t que de tout rÃ©Ã©crire.

### Gestion des erreurs

Toutes les fonctions d'import/export doivent avoir une gestion d'erreur robuste avec messages clairs pour l'utilisateur :

```javascript
try {
  await importerConfiguration(fichier);
  afficherMessage('success', 'Configuration importÃ©e avec succÃ¨s');
} catch (erreur) {
  console.error('Erreur import:', erreur);
  afficherMessage('error', `Impossible d'importer : ${erreur.message}`);
}
```

### Validation des fichiers JSON

Avant d'importer, valider la structure :

```javascript
function validerConfigComplete(json) {
  if (!json.metadata || json.metadata.type !== 'configuration-complete') {
    throw new Error('Ce fichier n\'est pas une configuration complÃ¨te valide');
  }
  
  if (!json.contenu) {
    throw new Error('Le contenu de la configuration est manquant');
  }
  
  // Autres validations...
  return true;
}
```

### Performance

Pour les grosses configurations (50+ ressources), afficher un indicateur de progression pendant l'import :

```
Importation en cours...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 45%
Ã‰chelles : âœ“
Grilles : âœ“
Productions : en cours...
```

---

## ORDRE D'IMPLÃ‰MENTATION RECOMMANDÃ‰

1. **Jour 1 matin** : TÃ¢che 1.1 (enrichir mÃ©tadonnÃ©es exports existants)
2. **Jour 1 aprÃ¨s-midi** : TÃ¢che 2.1 (export config complÃ¨te)
3. **Jour 2 matin** : TÃ¢che 2.2 (gÃ©nÃ©ration LISEZMOI) + TÃ¢che 4.1 (interface)
4. **Jour 2 aprÃ¨s-midi** : TÃ¢che 3.1 (import config complÃ¨te simple)
5. **Jour 3 matin** : TÃ¢che 3.2 (gestion conflits ID)
6. **Jour 3 aprÃ¨s-midi** : TÃ¢che 3.3 (dÃ©tection dÃ©pendances composants individuels)
7. **Tests** : TÃ¢che 5.1

---

## NOTES POUR LE DÃ‰PLOIEMENT BETA 91

### Migration des donnÃ©es existantes

Les utilisateurs actuels ont dÃ©jÃ  des exports sans les nouveaux champs mÃ©tadonnÃ©es. L'import doit gÃ©rer :

```javascript
// RÃ©trocompatibilitÃ©
if (!importedData.metadata.discipline) {
  importedData.metadata.discipline = [];  // Valeur par dÃ©faut
}
if (!importedData.metadata.niveau) {
  importedData.metadata.niveau = "";
}
// etc.
```

### Documentation utilisateur Ã  crÃ©er (GrÃ©goire s'en occupe)

- Guide "Comment partager ma pratique" (avec captures d'Ã©cran)
- Guide "Comment importer une pratique"
- FAQ sur licences Creative Commons

---

## QUESTIONS Ã€ CLARIFIER SI NÃ‰CESSAIRE

1. **Format de tÃ©lÃ©chargement** : Un seul fichier JSON ou un ZIP contenant JSON + LISEZMOI.txt ?
   - Recommandation : ZIP pour faciliter le partage

2. **Bouton "Ouvrir catalogue Teams"** : URL du canal Teams #bibliothÃ¨que Ã  hardcoder ou paramÃ¨tre configurable ?
   - Recommandation : ParamÃ¨tre configurable dans settings

3. **Anonymisation des donnÃ©es** : Si la config complÃ¨te inclut des noms d'Ã©tudiants dans des exemples, faut-il une fonction d'anonymisation ?
   - Recommandation : Pour Beta 91, avertir l'utilisateur de vÃ©rifier manuellement

---

VoilÃ  ! Ces consignes devraient permettre Ã  Claude Code de dÃ©velopper le systÃ¨me complet. Pendant ce temps, structure ton Teams et prÃ©pare le catalogue Excel. On se synchronise demain ?