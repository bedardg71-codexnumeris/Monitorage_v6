# üìã Synth√®se de la session de travail 20 octobre - Syst√®me d'indices A-C-P

## üéØ CONTEXTE DU PROJET

**Application** : Codex Numeris - Syst√®me de suivi des apprentissages (monitorage p√©dagogique)

**Architecture** : Application web modulaire avec principe "Single Source of Truth"
- Chaque module calcule **ses propres donn√©es** et les stocke dans `localStorage`
- Les modules ne se parlent **jamais directement**, uniquement via `localStorage`
- Les modules "lecteurs" (comme tableau de bord) **lisent** les donn√©es, ne les calculent pas

**Modules cl√©s** :
- `trimestre.js` ‚Üí g√©n√®re `calendrierComplet` ‚úÖ
- `horaire.js` ‚Üí g√©n√®re `seancesCompletes` ‚úÖ
- `saisie-presences.js` ‚Üí calcule `indicesAssiduite` ‚úÖ
- `tableau-bord-apercu.js` ‚Üí lit et affiche tous les indices

---

## ‚úÖ CE QUI A √âT√â R√âALIS√â CETTE SESSION

### 1. Syst√®me d'indices d'assiduit√© (Indice A) - COMPLET ‚úÖ

**Objectif** : Calculer deux indices d'assiduit√© (sommatif et alternatif) pour chaque √©tudiant.

**Impl√©mentation** :
- **Fonction orchestratrice** : `calculerEtSauvegarderIndicesAssiduite()` dans `saisie-presences.js`
- **Fonction sommatif** : `calculerAssiduiteSommative(da)` 
  - Formule : Heures pr√©sentes √∑ Heures de cours **donn√©es** (pas th√©oriques)
  - Exemple : 23h / 30h = 76.7%
- **Fonction alternatif (PAN)** : `calculerAssiduiteAlternative(da)`
  - Formule : Heures pr√©sentes sur N derniers cours √∑ (N √ó 4h)
  - Param√©trable via `modalitesEvaluation.configPAN.nombreCours` (par d√©faut : 3 cours = 6 s√©ances = 12h)
  - Mais actuellement r√©gl√© √† 4 cours = 8 s√©ances = 16h selon les logs
  - Exemple : 13h / 16h = 81.3%

**Stockage** :
```javascript
localStorage.indicesAssiduite = {
    sommatif: {
        "6345433": 0.767,  // 76.7%
        "2484602": 1.00,   // 100%
        // ...
    },
    alternatif: {
        "6345433": 0.813,  // 81.3%
        "2484602": 1.00,   // 100%
        // ...
    },
    dateCalcul: "2025-10-21T01:51:50.437Z"
}
```

**D√©clenchement** :
- Apr√®s chaque `enregistrerPresences()` dans `saisie-presences.js`
- Rechargement automatique du tableau de bord si section active

### 2. Affichage dans le tableau de bord - PARTIEL ‚úÖ

**Module modifi√©** : `tableau-bord-apercu.js`

**Fonctions modifi√©es** :
- `calculerIndicesEtudiant(da)` ‚Üí Lit les indices depuis `localStorage` (ne calcule plus)
- `afficherMetriquesGlobales()` ‚Üí Affiche selon les r√©glages (sommatif/alternatif/les deux)

**Affichage actuel** :
- Format double : `0% / 94%` ‚Üí Sommatif / Alternatif
- **Probl√®me r√©solu** : Les indices sommatifs √©taient `null` ou `NaN` √† cause d'un bug dans le calcul (division par `NaN`)
- **Solution** : Calcul bas√© sur les heures **donn√©es** (dates saisies) au lieu des heures th√©oriques totales

### 3. Rechargement automatique - COMPLET ‚úÖ

**Dans `navigation.js`** :
- Ajout du rechargement automatique quand on change de sous-section
- `afficherSousSection('tableau-bord-apercu')` ‚Üí d√©clenche `chargerTableauBordApercu()`

**Dans `saisie-presences.js`** :
- Apr√®s `enregistrerPresences()` ‚Üí rafra√Æchit le tableau de bord si actif

---

## üîß PROBL√àMES R√âSOLUS

### Bug 1 : Indice sommatif = NaN
**Cause** : `totalHeuresTheoriques` calcul√© incorrectement (tableaux vides dans `seancesCompletes`)
**Solution** : Calcul bas√© sur le nombre de dates o√π des pr√©sences ont √©t√© saisies

### Bug 2 : Logique incorrecte pour l'assiduit√© sommative
**Cause** : Calcul sur total trimestre (60h) au lieu des heures donn√©es (30h)
**Solution** : `totalHeuresDonnees = datesSaisies.length √ó 2`

### Bug 3 : Profil √©tudiant ne s'affiche pas
**Cause** : Fonction `afficherProfilEtudiant()` obsol√®te appel√©e au lieu de `afficherProfilComplet()`
**Solution sugg√©r√©e** : Modifier les boutons pour appeler `afficherProfilComplet(da)`

---

## ‚è≥ CE QUI RESTE √Ä FAIRE

### PRIORIT√â 1 : Indices C et P (Compl√©tion et Performance)

**Module √† cr√©er/modifier** : `portfolio.js` ou `productions.js`

**Fonctions √† impl√©menter** :

```javascript
/**
 * Calcule et sauvegarde les indices C et P
 * Appel√©e apr√®s chaque √©valuation d'artefact
 */
function calculerEtSauvegarderIndicesEvaluation() {
    const config = obtenirConfigurationNotation();
    const etudiants = // r√©cup√©rer √©tudiants actifs
    
    const indices = {
        sommatif: {},
        alternatif: {},
        dateCalcul: new Date().toISOString()
    };
    
    etudiants.forEach(etudiant => {
        indices.sommatif[etudiant.da] = calculerIndicesSommatifs(etudiant.da);
        indices.alternatif[etudiant.da] = calculerIndicesAlternatifs(etudiant.da);
    });
    
    localStorage.setItem('indicesEvaluation', JSON.stringify(indices));
}

/**
 * Calcule compl√©tion et performance SOMMATIFS
 */
function calculerIndicesSommatifs(da) {
    const evaluations = // r√©cup√©rer √©valuations de l'√©tudiant
    const artefacts = // r√©cup√©rer tous les artefacts attendus
    
    // Compl√©tion : artefacts remis √∑ artefacts attendus
    const completion = evaluations.length / artefacts.length;
    
    // Performance : moyenne de tous les artefacts
    const performance = calculerMoyenneIDME(evaluations);
    
    return { completion, performance };
}

/**
 * Calcule compl√©tion et performance ALTERNATIFS (PAN)
 */
function calculerIndicesAlternatifs(da) {
    const config = obtenirConfigurationNotation();
    const nombreArtefacts = config.configPAN?.nombreArtefacts || 3;
    
    const evaluations = // r√©cup√©rer √©valuations de l'√©tudiant
    
    // Trier par note d√©croissante et prendre les N meilleurs
    const meilleurs = evaluations
        .sort((a, b) => b.noteFinale - a.noteFinale)
        .slice(0, nombreArtefacts);
    
    // Compl√©tion : nombre de meilleurs √∑ nombre attendu
    const completion = meilleurs.length / nombreArtefacts;
    
    // Performance : moyenne des N meilleurs
    const performance = calculerMoyenneIDME(meilleurs);
    
    return { completion, performance };
}

/**
 * Convertit les niveaux IDME en moyenne
 * I=1, D=2, M=3, E=4 ‚Üí moyenne / 4
 */
function calculerMoyenneIDME(evaluations) {
    if (evaluations.length === 0) return 0;
    
    const valeurs = evaluations.map(e => {
        const niveau = e.niveauFinal || '';
        switch(niveau.toUpperCase()) {
            case 'E': return 4;
            case 'M': return 3;
            case 'D': return 2;
            case 'I': return 1;
            default: return 0;
        }
    });
    
    const moyenne = valeurs.reduce((sum, v) => sum + v, 0) / valeurs.length;
    return moyenne / 4; // Normaliser entre 0 et 1
}
```

**Stockage attendu** :
```javascript
localStorage.indicesEvaluation = {
    sommatif: {
        "6345433": { completion: 0.60, performance: 0.54 },
        "2484602": { completion: 0.80, performance: 0.75 },
        // ...
    },
    alternatif: {
        "6345433": { completion: 1.00, performance: 0.67 },
        "2484602": { completion: 1.00, performance: 0.83 },
        // ...
    },
    dateCalcul: "2025-10-21T..."
}
```

**D√©clenchement** :
- Apr√®s chaque sauvegarde d'√©valuation
- Rechargement du tableau de bord si actif

---

### PRIORIT√â 2 : Compl√©ter l'affichage du tableau de bord

**Modifications dans `tableau-bord-apercu.js`** :

1. **Fonction `calculerIndicesEtudiant()`** ‚Üí Lire aussi `indicesEvaluation`
2. **Fonction `afficherMetriquesGlobales()`** ‚Üí Afficher C et P en plus de A
3. **Fonction `afficherAlertesPrioritaires()`** ‚Üí Utiliser les 3 indices (A, C, P)
4. **Indices composites** :
   - Mobilisation = A √ó C
   - Rendement = C √ó P
   - Engagement = A √ó C √ó P
   - Risque d'√©chec = 1 - (A √ó C √ó P)

---

### PRIORIT√â 3 : Liste des individus (affichage double)

**Fichier √† modifier** : Code qui g√©n√®re la liste des √©tudiants dans le tableau de bord

**Action** : Modifier les colonnes pour afficher :
- `Assiduit√© (S)` et `Assiduit√© (A)` s√©par√©ment (si les deux activ√©s)
- `Compl√©tion (S)` et `Compl√©tion (A)` s√©par√©ment
- Idem pour Performance

**Selon les r√©glages** :
- Si `afficherSommatif` seulement ‚Üí 1 colonne par indice
- Si `afficherAlternatif` seulement ‚Üí 1 colonne par indice
- Si les deux ‚Üí 2 colonnes par indice (format : `85% / 90%`)

---

### PRIORIT√â 4 : Profil individuel

**Bug √† corriger** : Boutons dans la liste n'ouvrent pas le profil

**Solution** : Modifier les boutons pour appeler `afficherProfilComplet(da)` au lieu de `afficherProfilEtudiant(da)`

**Ensuite** : Afficher les indices A-C-P dans le profil avec le double affichage si activ√©

---

## üîë POINTS CL√âS √Ä RETENIR POUR LA PROCHAINE SESSION

1. **Architecture** : Toujours calculer dans le module propri√©taire, lire dans les autres
2. **Flexibilit√©** : Les param√®tres PAN viennent de `modalitesEvaluation.configPAN`
3. **Ind√©pendance** : Calculs sommatif et alternatif sont **toujours** effectu√©s, l'affichage d√©cide quoi montrer
4. **Coh√©rence** : Les formules doivent correspondre au Guide de monitorage

---

## üìÇ FICHIERS MODIFI√âS CETTE SESSION

- ‚úÖ `js/saisie-presences.js` ‚Üí Calcul des indices A
- ‚úÖ `js/tableau-bord-apercu.js` ‚Üí Affichage des indices
- ‚úÖ `js/navigation.js` ‚Üí Rechargement automatique
- ‚è≥ `js/portfolio.js` ou `js/productions.js` ‚Üí √Ä cr√©er pour indices C et P

Bon courage pour la suite ! üöÄ